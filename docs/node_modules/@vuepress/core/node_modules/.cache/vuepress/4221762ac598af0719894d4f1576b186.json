{"remainingRequest":"/Users/vaidadryzaite/vuepress-starter2/docs/node_modules/babel-loader/lib/index.js??ref--3-1!/Users/vaidadryzaite/vuepress-starter2/docs/node_modules/vue/dist/vue.runtime.esm.js","dependencies":[{"path":"/Users/vaidadryzaite/vuepress-starter2/docs/node_modules/vue/dist/vue.runtime.esm.js","mtime":499162500000},{"path":"/Users/vaidadryzaite/vuepress-starter2/docs/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/vaidadryzaite/vuepress-starter2/docs/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF90eXBlb2YgZnJvbSAiL1VzZXJzL3ZhaWRhZHJ5emFpdGUvdnVlcHJlc3Mtc3RhcnRlcjIvZG9jcy9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vdHlwZW9mIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmZyZWV6ZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zbGljZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnBhcnNlLWZsb2F0LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaXMtYXJyYXkuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5kYXRlLnRvLXN0cmluZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuY3JlYXRlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmV4ZWMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuc3BsaXQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNwbGljZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5yZXBsYWNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24uYmluZC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmV2ZXJ5LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmtleXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZGVmaW5lLXByb3BlcnR5LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLmNvbnN0cnVjdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLm1hdGNoLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sLmRlc2NyaXB0aW9uLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucmVmbGVjdC5vd24ta2V5cy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnNldC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pdGVyYXRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5uYW1lLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNvcnQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZGVmaW5lLXByb3BlcnRpZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5mb3ItZWFjaC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5nZXQtb3duLXByb3BlcnR5LW5hbWVzLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmlzLWV4dGVuc2libGUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuZ2V0LW93bi1wcm9wZXJ0eS1kZXNjcmlwdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuY29uY2F0LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubnVtYmVyLmNvbnN0cnVjdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc29tZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi50aW1lcnMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuaW1tZWRpYXRlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmlzLWZyb3plbi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2guanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wudG8tc3RyaW5nLXRhZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmpzb24udG8tc3RyaW5nLXRhZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm1hdGgudG8tc3RyaW5nLXRhZy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmRhdGUubm93LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMucGFyc2UtaW50LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnRyaW0uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5maWx0ZXIuanMiOwoKLyohCiAqIFZ1ZS5qcyB2Mi42LjEyCiAqIChjKSAyMDE0LTIwMjAgRXZhbiBZb3UKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKi8KCi8qICAqLwp2YXIgZW1wdHlPYmplY3QgPSBPYmplY3QuZnJlZXplKHt9KTsgLy8gVGhlc2UgaGVscGVycyBwcm9kdWNlIGJldHRlciBWTSBjb2RlIGluIEpTIGVuZ2luZXMgZHVlIHRvIHRoZWlyCi8vIGV4cGxpY2l0bmVzcyBhbmQgZnVuY3Rpb24gaW5saW5pbmcuCgpmdW5jdGlvbiBpc1VuZGVmKHYpIHsKICByZXR1cm4gdiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzRGVmKHYpIHsKICByZXR1cm4gdiAhPT0gdW5kZWZpbmVkICYmIHYgIT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzVHJ1ZSh2KSB7CiAgcmV0dXJuIHYgPT09IHRydWU7Cn0KCmZ1bmN0aW9uIGlzRmFsc2UodikgewogIHJldHVybiB2ID09PSBmYWxzZTsKfQovKioKICogQ2hlY2sgaWYgdmFsdWUgaXMgcHJpbWl0aXZlLgogKi8KCgpmdW5jdGlvbiBpc1ByaW1pdGl2ZSh2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgX3R5cGVvZih2YWx1ZSkgPT09ICdzeW1ib2wnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nOwp9Ci8qKgogKiBRdWljayBvYmplY3QgY2hlY2sgLSB0aGlzIGlzIHByaW1hcmlseSB1c2VkIHRvIHRlbGwKICogT2JqZWN0cyBmcm9tIHByaW1pdGl2ZSB2YWx1ZXMgd2hlbiB3ZSBrbm93IHRoZSB2YWx1ZQogKiBpcyBhIEpTT04tY29tcGxpYW50IHR5cGUuCiAqLwoKCmZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogIHJldHVybiBvYmogIT09IG51bGwgJiYgX3R5cGVvZihvYmopID09PSAnb2JqZWN0JzsKfQovKioKICogR2V0IHRoZSByYXcgdHlwZSBzdHJpbmcgb2YgYSB2YWx1ZSwgZS5nLiwgW29iamVjdCBPYmplY3RdLgogKi8KCgp2YXIgX3RvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCmZ1bmN0aW9uIHRvUmF3VHlwZSh2YWx1ZSkgewogIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpOwp9Ci8qKgogKiBTdHJpY3Qgb2JqZWN0IHR5cGUgY2hlY2suIE9ubHkgcmV0dXJucyB0cnVlCiAqIGZvciBwbGFpbiBKYXZhU2NyaXB0IG9iamVjdHMuCiAqLwoKCmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IE9iamVjdF0nOwp9CgpmdW5jdGlvbiBpc1JlZ0V4cCh2KSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKHYpID09PSAnW29iamVjdCBSZWdFeHBdJzsKfQovKioKICogQ2hlY2sgaWYgdmFsIGlzIGEgdmFsaWQgYXJyYXkgaW5kZXguCiAqLwoKCmZ1bmN0aW9uIGlzVmFsaWRBcnJheUluZGV4KHZhbCkgewogIHZhciBuID0gcGFyc2VGbG9hdChTdHJpbmcodmFsKSk7CiAgcmV0dXJuIG4gPj0gMCAmJiBNYXRoLmZsb29yKG4pID09PSBuICYmIGlzRmluaXRlKHZhbCk7Cn0KCmZ1bmN0aW9uIGlzUHJvbWlzZSh2YWwpIHsKICByZXR1cm4gaXNEZWYodmFsKSAmJiB0eXBlb2YgdmFsLnRoZW4gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIHZhbFsiY2F0Y2giXSA9PT0gJ2Z1bmN0aW9uJzsKfQovKioKICogQ29udmVydCBhIHZhbHVlIHRvIGEgc3RyaW5nIHRoYXQgaXMgYWN0dWFsbHkgcmVuZGVyZWQuCiAqLwoKCmZ1bmN0aW9uIHRvU3RyaW5nKHZhbCkgewogIHJldHVybiB2YWwgPT0gbnVsbCA/ICcnIDogQXJyYXkuaXNBcnJheSh2YWwpIHx8IGlzUGxhaW5PYmplY3QodmFsKSAmJiB2YWwudG9TdHJpbmcgPT09IF90b1N0cmluZyA/IEpTT04uc3RyaW5naWZ5KHZhbCwgbnVsbCwgMikgOiBTdHJpbmcodmFsKTsKfQovKioKICogQ29udmVydCBhbiBpbnB1dCB2YWx1ZSB0byBhIG51bWJlciBmb3IgcGVyc2lzdGVuY2UuCiAqIElmIHRoZSBjb252ZXJzaW9uIGZhaWxzLCByZXR1cm4gb3JpZ2luYWwgc3RyaW5nLgogKi8KCgpmdW5jdGlvbiB0b051bWJlcih2YWwpIHsKICB2YXIgbiA9IHBhcnNlRmxvYXQodmFsKTsKICByZXR1cm4gaXNOYU4obikgPyB2YWwgOiBuOwp9Ci8qKgogKiBNYWtlIGEgbWFwIGFuZCByZXR1cm4gYSBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYSBrZXkKICogaXMgaW4gdGhhdCBtYXAuCiAqLwoKCmZ1bmN0aW9uIG1ha2VNYXAoc3RyLCBleHBlY3RzTG93ZXJDYXNlKSB7CiAgdmFyIG1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdmFyIGxpc3QgPSBzdHIuc3BsaXQoJywnKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBtYXBbbGlzdFtpXV0gPSB0cnVlOwogIH0KCiAgcmV0dXJuIGV4cGVjdHNMb3dlckNhc2UgPyBmdW5jdGlvbiAodmFsKSB7CiAgICByZXR1cm4gbWFwW3ZhbC50b0xvd2VyQ2FzZSgpXTsKICB9IDogZnVuY3Rpb24gKHZhbCkgewogICAgcmV0dXJuIG1hcFt2YWxdOwogIH07Cn0KLyoqCiAqIENoZWNrIGlmIGEgdGFnIGlzIGEgYnVpbHQtaW4gdGFnLgogKi8KCgp2YXIgaXNCdWlsdEluVGFnID0gbWFrZU1hcCgnc2xvdCxjb21wb25lbnQnLCB0cnVlKTsKLyoqCiAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBpcyBhIHJlc2VydmVkIGF0dHJpYnV0ZS4KICovCgp2YXIgaXNSZXNlcnZlZEF0dHJpYnV0ZSA9IG1ha2VNYXAoJ2tleSxyZWYsc2xvdCxzbG90LXNjb3BlLGlzJyk7Ci8qKgogKiBSZW1vdmUgYW4gaXRlbSBmcm9tIGFuIGFycmF5LgogKi8KCmZ1bmN0aW9uIHJlbW92ZShhcnIsIGl0ZW0pIHsKICBpZiAoYXJyLmxlbmd0aCkgewogICAgdmFyIGluZGV4ID0gYXJyLmluZGV4T2YoaXRlbSk7CgogICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgcmV0dXJuIGFyci5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQogIH0KfQovKioKICogQ2hlY2sgd2hldGhlciBhbiBvYmplY3QgaGFzIHRoZSBwcm9wZXJ0eS4KICovCgoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCmZ1bmN0aW9uIGhhc093bihvYmosIGtleSkgewogIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKfQovKioKICogQ3JlYXRlIGEgY2FjaGVkIHZlcnNpb24gb2YgYSBwdXJlIGZ1bmN0aW9uLgogKi8KCgpmdW5jdGlvbiBjYWNoZWQoZm4pIHsKICB2YXIgY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHJldHVybiBmdW5jdGlvbiBjYWNoZWRGbihzdHIpIHsKICAgIHZhciBoaXQgPSBjYWNoZVtzdHJdOwogICAgcmV0dXJuIGhpdCB8fCAoY2FjaGVbc3RyXSA9IGZuKHN0cikpOwogIH07Cn0KLyoqCiAqIENhbWVsaXplIGEgaHlwaGVuLWRlbGltaXRlZCBzdHJpbmcuCiAqLwoKCnZhciBjYW1lbGl6ZVJFID0gLy0oXHcpL2c7CnZhciBjYW1lbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKGNhbWVsaXplUkUsIGZ1bmN0aW9uIChfLCBjKSB7CiAgICByZXR1cm4gYyA/IGMudG9VcHBlckNhc2UoKSA6ICcnOwogIH0pOwp9KTsKLyoqCiAqIENhcGl0YWxpemUgYSBzdHJpbmcuCiAqLwoKdmFyIGNhcGl0YWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7Cn0pOwovKioKICogSHlwaGVuYXRlIGEgY2FtZWxDYXNlIHN0cmluZy4KICovCgp2YXIgaHlwaGVuYXRlUkUgPSAvXEIoW0EtWl0pL2c7CnZhciBoeXBoZW5hdGUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZShoeXBoZW5hdGVSRSwgJy0kMScpLnRvTG93ZXJDYXNlKCk7Cn0pOwovKioKICogU2ltcGxlIGJpbmQgcG9seWZpbGwgZm9yIGVudmlyb25tZW50cyB0aGF0IGRvIG5vdCBzdXBwb3J0IGl0LAogKiBlLmcuLCBQaGFudG9tSlMgMS54LiBUZWNobmljYWxseSwgd2UgZG9uJ3QgbmVlZCB0aGlzIGFueW1vcmUKICogc2luY2UgbmF0aXZlIGJpbmQgaXMgbm93IHBlcmZvcm1hbnQgZW5vdWdoIGluIG1vc3QgYnJvd3NlcnMuCiAqIEJ1dCByZW1vdmluZyBpdCB3b3VsZCBtZWFuIGJyZWFraW5nIGNvZGUgdGhhdCB3YXMgYWJsZSB0byBydW4gaW4KICogUGhhbnRvbUpTIDEueCwgc28gdGhpcyBtdXN0IGJlIGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuCiAqLwoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCmZ1bmN0aW9uIHBvbHlmaWxsQmluZChmbiwgY3R4KSB7CiAgZnVuY3Rpb24gYm91bmRGbihhKSB7CiAgICB2YXIgbCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICByZXR1cm4gbCA/IGwgPiAxID8gZm4uYXBwbHkoY3R4LCBhcmd1bWVudHMpIDogZm4uY2FsbChjdHgsIGEpIDogZm4uY2FsbChjdHgpOwogIH0KCiAgYm91bmRGbi5fbGVuZ3RoID0gZm4ubGVuZ3RoOwogIHJldHVybiBib3VuZEZuOwp9CgpmdW5jdGlvbiBuYXRpdmVCaW5kKGZuLCBjdHgpIHsKICByZXR1cm4gZm4uYmluZChjdHgpOwp9Cgp2YXIgYmluZCA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID8gbmF0aXZlQmluZCA6IHBvbHlmaWxsQmluZDsKLyoqCiAqIENvbnZlcnQgYW4gQXJyYXktbGlrZSBvYmplY3QgdG8gYSByZWFsIEFycmF5LgogKi8KCmZ1bmN0aW9uIHRvQXJyYXkobGlzdCwgc3RhcnQpIHsKICBzdGFydCA9IHN0YXJ0IHx8IDA7CiAgdmFyIGkgPSBsaXN0Lmxlbmd0aCAtIHN0YXJ0OwogIHZhciByZXQgPSBuZXcgQXJyYXkoaSk7CgogIHdoaWxlIChpLS0pIHsKICAgIHJldFtpXSA9IGxpc3RbaSArIHN0YXJ0XTsKICB9CgogIHJldHVybiByZXQ7Cn0KLyoqCiAqIE1peCBwcm9wZXJ0aWVzIGludG8gdGFyZ2V0IG9iamVjdC4KICovCgoKZnVuY3Rpb24gZXh0ZW5kKHRvLCBfZnJvbSkgewogIGZvciAodmFyIGtleSBpbiBfZnJvbSkgewogICAgdG9ba2V5XSA9IF9mcm9tW2tleV07CiAgfQoKICByZXR1cm4gdG87Cn0KLyoqCiAqIE1lcmdlIGFuIEFycmF5IG9mIE9iamVjdHMgaW50byBhIHNpbmdsZSBPYmplY3QuCiAqLwoKCmZ1bmN0aW9uIHRvT2JqZWN0KGFycikgewogIHZhciByZXMgPSB7fTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgIGlmIChhcnJbaV0pIHsKICAgICAgZXh0ZW5kKHJlcywgYXJyW2ldKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi8KCi8qKgogKiBQZXJmb3JtIG5vIG9wZXJhdGlvbi4KICogU3R1YmJpbmcgYXJncyB0byBtYWtlIEZsb3cgaGFwcHkgd2l0aG91dCBsZWF2aW5nIHVzZWxlc3MgdHJhbnNwaWxlZCBjb2RlCiAqIHdpdGggLi4ucmVzdCAoaHR0cHM6Ly9mbG93Lm9yZy9ibG9nLzIwMTcvMDUvMDcvU3RyaWN0LUZ1bmN0aW9uLUNhbGwtQXJpdHkvKS4KICovCgoKZnVuY3Rpb24gbm9vcChhLCBiLCBjKSB7fQovKioKICogQWx3YXlzIHJldHVybiBmYWxzZS4KICovCgoKdmFyIG5vID0gZnVuY3Rpb24gbm8oYSwgYiwgYykgewogIHJldHVybiBmYWxzZTsKfTsKLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqLwoKLyoqCiAqIFJldHVybiB0aGUgc2FtZSB2YWx1ZS4KICovCgoKdmFyIGlkZW50aXR5ID0gZnVuY3Rpb24gaWRlbnRpdHkoXykgewogIHJldHVybiBfOwp9OwovKioKICogQ2hlY2sgaWYgdHdvIHZhbHVlcyBhcmUgbG9vc2VseSBlcXVhbCAtIHRoYXQgaXMsCiAqIGlmIHRoZXkgYXJlIHBsYWluIG9iamVjdHMsIGRvIHRoZXkgaGF2ZSB0aGUgc2FtZSBzaGFwZT8KICovCgoKZnVuY3Rpb24gbG9vc2VFcXVhbChhLCBiKSB7CiAgaWYgKGEgPT09IGIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgdmFyIGlzT2JqZWN0QSA9IGlzT2JqZWN0KGEpOwogIHZhciBpc09iamVjdEIgPSBpc09iamVjdChiKTsKCiAgaWYgKGlzT2JqZWN0QSAmJiBpc09iamVjdEIpIHsKICAgIHRyeSB7CiAgICAgIHZhciBpc0FycmF5QSA9IEFycmF5LmlzQXJyYXkoYSk7CiAgICAgIHZhciBpc0FycmF5QiA9IEFycmF5LmlzQXJyYXkoYik7CgogICAgICBpZiAoaXNBcnJheUEgJiYgaXNBcnJheUIpIHsKICAgICAgICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoICYmIGEuZXZlcnkoZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGUsIGJbaV0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGEgaW5zdGFuY2VvZiBEYXRlICYmIGIgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIGEuZ2V0VGltZSgpID09PSBiLmdldFRpbWUoKTsKICAgICAgfSBlbHNlIGlmICghaXNBcnJheUEgJiYgIWlzQXJyYXlCKSB7CiAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMoYSk7CiAgICAgICAgdmFyIGtleXNCID0gT2JqZWN0LmtleXMoYik7CiAgICAgICAgcmV0dXJuIGtleXNBLmxlbmd0aCA9PT0ga2V5c0IubGVuZ3RoICYmIGtleXNBLmV2ZXJ5KGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGFba2V5XSwgYltrZXldKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSBlbHNlIGlmICghaXNPYmplY3RBICYmICFpc09iamVjdEIpIHsKICAgIHJldHVybiBTdHJpbmcoYSkgPT09IFN0cmluZyhiKTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQovKioKICogUmV0dXJuIHRoZSBmaXJzdCBpbmRleCBhdCB3aGljaCBhIGxvb3NlbHkgZXF1YWwgdmFsdWUgY2FuIGJlCiAqIGZvdW5kIGluIHRoZSBhcnJheSAoaWYgdmFsdWUgaXMgYSBwbGFpbiBvYmplY3QsIHRoZSBhcnJheSBtdXN0CiAqIGNvbnRhaW4gYW4gb2JqZWN0IG9mIHRoZSBzYW1lIHNoYXBlKSwgb3IgLTEgaWYgaXQgaXMgbm90IHByZXNlbnQuCiAqLwoKCmZ1bmN0aW9uIGxvb3NlSW5kZXhPZihhcnIsIHZhbCkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAobG9vc2VFcXVhbChhcnJbaV0sIHZhbCkpIHsKICAgICAgcmV0dXJuIGk7CiAgICB9CiAgfQoKICByZXR1cm4gLTE7Cn0KLyoqCiAqIEVuc3VyZSBhIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbmx5IG9uY2UuCiAqLwoKCmZ1bmN0aW9uIG9uY2UoZm4pIHsKICB2YXIgY2FsbGVkID0gZmFsc2U7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIGlmICghY2FsbGVkKSB7CiAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfTsKfQoKdmFyIFNTUl9BVFRSID0gJ2RhdGEtc2VydmVyLXJlbmRlcmVkJzsKdmFyIEFTU0VUX1RZUEVTID0gWydjb21wb25lbnQnLCAnZGlyZWN0aXZlJywgJ2ZpbHRlciddOwp2YXIgTElGRUNZQ0xFX0hPT0tTID0gWydiZWZvcmVDcmVhdGUnLCAnY3JlYXRlZCcsICdiZWZvcmVNb3VudCcsICdtb3VudGVkJywgJ2JlZm9yZVVwZGF0ZScsICd1cGRhdGVkJywgJ2JlZm9yZURlc3Ryb3knLCAnZGVzdHJveWVkJywgJ2FjdGl2YXRlZCcsICdkZWFjdGl2YXRlZCcsICdlcnJvckNhcHR1cmVkJywgJ3NlcnZlclByZWZldGNoJ107Ci8qICAqLwoKdmFyIGNvbmZpZyA9IHsKICAvKioKICAgKiBPcHRpb24gbWVyZ2Ugc3RyYXRlZ2llcyAodXNlZCBpbiBjb3JlL3V0aWwvb3B0aW9ucykKICAgKi8KICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICBvcHRpb25NZXJnZVN0cmF0ZWdpZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogIC8qKgogICAqIFdoZXRoZXIgdG8gc3VwcHJlc3Mgd2FybmluZ3MuCiAgICovCiAgc2lsZW50OiBmYWxzZSwKCiAgLyoqCiAgICogU2hvdyBwcm9kdWN0aW9uIG1vZGUgdGlwIG1lc3NhZ2Ugb24gYm9vdD8KICAgKi8KICBwcm9kdWN0aW9uVGlwOiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nLAoKICAvKioKICAgKiBXaGV0aGVyIHRvIGVuYWJsZSBkZXZ0b29scwogICAqLwogIGRldnRvb2xzOiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nLAoKICAvKioKICAgKiBXaGV0aGVyIHRvIHJlY29yZCBwZXJmCiAgICovCiAgcGVyZm9ybWFuY2U6IGZhbHNlLAoKICAvKioKICAgKiBFcnJvciBoYW5kbGVyIGZvciB3YXRjaGVyIGVycm9ycwogICAqLwogIGVycm9ySGFuZGxlcjogbnVsbCwKCiAgLyoqCiAgICogV2FybiBoYW5kbGVyIGZvciB3YXRjaGVyIHdhcm5zCiAgICovCiAgd2FybkhhbmRsZXI6IG51bGwsCgogIC8qKgogICAqIElnbm9yZSBjZXJ0YWluIGN1c3RvbSBlbGVtZW50cwogICAqLwogIGlnbm9yZWRFbGVtZW50czogW10sCgogIC8qKgogICAqIEN1c3RvbSB1c2VyIGtleSBhbGlhc2VzIGZvciB2LW9uCiAgICovCiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAga2V5Q29kZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogIC8qKgogICAqIENoZWNrIGlmIGEgdGFnIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHJlZ2lzdGVyZWQgYXMgYQogICAqIGNvbXBvbmVudC4gVGhpcyBpcyBwbGF0Zm9ybS1kZXBlbmRlbnQgYW5kIG1heSBiZSBvdmVyd3JpdHRlbi4KICAgKi8KICBpc1Jlc2VydmVkVGFnOiBubywKCiAgLyoqCiAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgYXMgYSBjb21wb25lbnQKICAgKiBwcm9wLiBUaGlzIGlzIHBsYXRmb3JtLWRlcGVuZGVudCBhbmQgbWF5IGJlIG92ZXJ3cml0dGVuLgogICAqLwogIGlzUmVzZXJ2ZWRBdHRyOiBubywKCiAgLyoqCiAgICogQ2hlY2sgaWYgYSB0YWcgaXMgYW4gdW5rbm93biBlbGVtZW50LgogICAqIFBsYXRmb3JtLWRlcGVuZGVudC4KICAgKi8KICBpc1Vua25vd25FbGVtZW50OiBubywKCiAgLyoqCiAgICogR2V0IHRoZSBuYW1lc3BhY2Ugb2YgYW4gZWxlbWVudAogICAqLwogIGdldFRhZ05hbWVzcGFjZTogbm9vcCwKCiAgLyoqCiAgICogUGFyc2UgdGhlIHJlYWwgdGFnIG5hbWUgZm9yIHRoZSBzcGVjaWZpYyBwbGF0Zm9ybS4KICAgKi8KICBwYXJzZVBsYXRmb3JtVGFnTmFtZTogaWRlbnRpdHksCgogIC8qKgogICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBtdXN0IGJlIGJvdW5kIHVzaW5nIHByb3BlcnR5LCBlLmcuIHZhbHVlCiAgICogUGxhdGZvcm0tZGVwZW5kZW50LgogICAqLwogIG11c3RVc2VQcm9wOiBubywKCiAgLyoqCiAgICogUGVyZm9ybSB1cGRhdGVzIGFzeW5jaHJvbm91c2x5LiBJbnRlbmRlZCB0byBiZSB1c2VkIGJ5IFZ1ZSBUZXN0IFV0aWxzCiAgICogVGhpcyB3aWxsIHNpZ25pZmljYW50bHkgcmVkdWNlIHBlcmZvcm1hbmNlIGlmIHNldCB0byBmYWxzZS4KICAgKi8KICBhc3luYzogdHJ1ZSwKCiAgLyoqCiAgICogRXhwb3NlZCBmb3IgbGVnYWN5IHJlYXNvbnMKICAgKi8KICBfbGlmZWN5Y2xlSG9va3M6IExJRkVDWUNMRV9IT09LUwp9OwovKiAgKi8KCi8qKgogKiB1bmljb2RlIGxldHRlcnMgdXNlZCBmb3IgcGFyc2luZyBodG1sIHRhZ3MsIGNvbXBvbmVudCBuYW1lcyBhbmQgcHJvcGVydHkgcGF0aHMuCiAqIHVzaW5nIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9odG1sNTMvc2VtYW50aWNzLXNjcmlwdGluZy5odG1sI3BvdGVudGlhbGN1c3RvbWVsZW1lbnRuYW1lCiAqIHNraXBwaW5nIFx1MTAwMDAtXHVFRkZGRiBkdWUgdG8gaXQgZnJlZXppbmcgdXAgUGhhbnRvbUpTCiAqLwoKdmFyIHVuaWNvZGVSZWdFeHAgPSAvYS16QS1aXHUwMEI3XHUwMEMwLVx1MDBENlx1MDBEOC1cdTAwRjZcdTAwRjgtXHUwMzdEXHUwMzdGLVx1MUZGRlx1MjAwQy1cdTIwMERcdTIwM0YtXHUyMDQwXHUyMDcwLVx1MjE4Rlx1MkMwMC1cdTJGRUZcdTMwMDEtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRkQvOwovKioKICogQ2hlY2sgaWYgYSBzdHJpbmcgc3RhcnRzIHdpdGggJCBvciBfCiAqLwoKZnVuY3Rpb24gaXNSZXNlcnZlZChzdHIpIHsKICB2YXIgYyA9IChzdHIgKyAnJykuY2hhckNvZGVBdCgwKTsKICByZXR1cm4gYyA9PT0gMHgyNCB8fCBjID09PSAweDVGOwp9Ci8qKgogKiBEZWZpbmUgYSBwcm9wZXJ0eS4KICovCgoKZnVuY3Rpb24gZGVmKG9iaiwga2V5LCB2YWwsIGVudW1lcmFibGUpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgIHZhbHVlOiB2YWwsCiAgICBlbnVtZXJhYmxlOiAhIWVudW1lcmFibGUsCiAgICB3cml0YWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwp9Ci8qKgogKiBQYXJzZSBzaW1wbGUgcGF0aC4KICovCgoKdmFyIGJhaWxSRSA9IG5ldyBSZWdFeHAoIlteIiArIHVuaWNvZGVSZWdFeHAuc291cmNlICsgIi4kX1xcZF0iKTsKCmZ1bmN0aW9uIHBhcnNlUGF0aChwYXRoKSB7CiAgaWYgKGJhaWxSRS50ZXN0KHBhdGgpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFvYmopIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIG9iaiA9IG9ialtzZWdtZW50c1tpXV07CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qICAqLwovLyBjYW4gd2UgdXNlIF9fcHJvdG9fXz8KCgp2YXIgaGFzUHJvdG8gPSAoJ19fcHJvdG9fXycgaW4ge30pOyAvLyBCcm93c2VyIGVudmlyb25tZW50IHNuaWZmaW5nCgp2YXIgaW5Ccm93c2VyID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCc7CnZhciBpbldlZXggPSB0eXBlb2YgV1hFbnZpcm9ubWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgISFXWEVudmlyb25tZW50LnBsYXRmb3JtOwp2YXIgd2VleFBsYXRmb3JtID0gaW5XZWV4ICYmIFdYRW52aXJvbm1lbnQucGxhdGZvcm0udG9Mb3dlckNhc2UoKTsKdmFyIFVBID0gaW5Ccm93c2VyICYmIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CnZhciBpc0lFID0gVUEgJiYgL21zaWV8dHJpZGVudC8udGVzdChVQSk7CnZhciBpc0lFOSA9IFVBICYmIFVBLmluZGV4T2YoJ21zaWUgOS4wJykgPiAwOwp2YXIgaXNFZGdlID0gVUEgJiYgVUEuaW5kZXhPZignZWRnZS8nKSA+IDA7CnZhciBpc0FuZHJvaWQgPSBVQSAmJiBVQS5pbmRleE9mKCdhbmRyb2lkJykgPiAwIHx8IHdlZXhQbGF0Zm9ybSA9PT0gJ2FuZHJvaWQnOwp2YXIgaXNJT1MgPSBVQSAmJiAvaXBob25lfGlwYWR8aXBvZHxpb3MvLnRlc3QoVUEpIHx8IHdlZXhQbGF0Zm9ybSA9PT0gJ2lvcyc7CnZhciBpc0Nocm9tZSA9IFVBICYmIC9jaHJvbWVcL1xkKy8udGVzdChVQSkgJiYgIWlzRWRnZTsKdmFyIGlzUGhhbnRvbUpTID0gVUEgJiYgL3BoYW50b21qcy8udGVzdChVQSk7CnZhciBpc0ZGID0gVUEgJiYgVUEubWF0Y2goL2ZpcmVmb3hcLyhcZCspLyk7IC8vIEZpcmVmb3ggaGFzIGEgIndhdGNoIiBmdW5jdGlvbiBvbiBPYmplY3QucHJvdG90eXBlLi4uCgp2YXIgbmF0aXZlV2F0Y2ggPSB7fS53YXRjaDsKdmFyIHN1cHBvcnRzUGFzc2l2ZSA9IGZhbHNlOwoKaWYgKGluQnJvd3NlcikgewogIHRyeSB7CiAgICB2YXIgb3B0cyA9IHt9OwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdHMsICdwYXNzaXZlJywgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHN1cHBvcnRzUGFzc2l2ZSA9IHRydWU7CiAgICAgIH0KICAgIH0pOyAvLyBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svZmxvdy9pc3N1ZXMvMjg1CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Rlc3QtcGFzc2l2ZScsIG51bGwsIG9wdHMpOwogIH0gY2F0Y2ggKGUpIHt9Cn0gLy8gdGhpcyBuZWVkcyB0byBiZSBsYXp5LWV2YWxlZCBiZWNhdXNlIHZ1ZSBtYXkgYmUgcmVxdWlyZWQgYmVmb3JlCi8vIHZ1ZS1zZXJ2ZXItcmVuZGVyZXIgY2FuIHNldCBWVUVfRU5WCgoKdmFyIF9pc1NlcnZlcjsKCnZhciBpc1NlcnZlclJlbmRlcmluZyA9IGZ1bmN0aW9uIGlzU2VydmVyUmVuZGVyaW5nKCkgewogIGlmIChfaXNTZXJ2ZXIgPT09IHVuZGVmaW5lZCkgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoIWluQnJvd3NlciAmJiAhaW5XZWV4ICYmIHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8vIGRldGVjdCBwcmVzZW5jZSBvZiB2dWUtc2VydmVyLXJlbmRlcmVyIGFuZCBhdm9pZAogICAgICAvLyBXZWJwYWNrIHNoaW1taW5nIHRoZSBwcm9jZXNzCiAgICAgIF9pc1NlcnZlciA9IGdsb2JhbFsncHJvY2VzcyddICYmIGdsb2JhbFsncHJvY2VzcyddLmVudi5WVUVfRU5WID09PSAnc2VydmVyJzsKICAgIH0gZWxzZSB7CiAgICAgIF9pc1NlcnZlciA9IGZhbHNlOwogICAgfQogIH0KCiAgcmV0dXJuIF9pc1NlcnZlcjsKfTsgLy8gZGV0ZWN0IGRldnRvb2xzCgoKdmFyIGRldnRvb2xzID0gaW5Ccm93c2VyICYmIHdpbmRvdy5fX1ZVRV9ERVZUT09MU19HTE9CQUxfSE9PS19fOwovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKZnVuY3Rpb24gaXNOYXRpdmUoQ3RvcikgewogIHJldHVybiB0eXBlb2YgQ3RvciA9PT0gJ2Z1bmN0aW9uJyAmJiAvbmF0aXZlIGNvZGUvLnRlc3QoQ3Rvci50b1N0cmluZygpKTsKfQoKdmFyIGhhc1N5bWJvbCA9IHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFN5bWJvbCkgJiYgdHlwZW9mIFJlZmxlY3QgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFJlZmxlY3Qub3duS2V5cyk7Cgp2YXIgX1NldDsKLyogaXN0YW5idWwgaWdub3JlIGlmICovCi8vICRmbG93LWRpc2FibGUtbGluZQoKCmlmICh0eXBlb2YgU2V0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTZXQpKSB7CiAgLy8gdXNlIG5hdGl2ZSBTZXQgd2hlbiBhdmFpbGFibGUuCiAgX1NldCA9IFNldDsKfSBlbHNlIHsKICAvLyBhIG5vbi1zdGFuZGFyZCBTZXQgcG9seWZpbGwgdGhhdCBvbmx5IHdvcmtzIHdpdGggcHJpbWl0aXZlIGtleXMuCiAgX1NldCA9IC8qQF9fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBTZXQoKSB7CiAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KCiAgICBTZXQucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0W2tleV0gPT09IHRydWU7CiAgICB9OwoKICAgIFNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gYWRkKGtleSkgewogICAgICB0aGlzLnNldFtrZXldID0gdHJ1ZTsKICAgIH07CgogICAgU2V0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9OwoKICAgIHJldHVybiBTZXQ7CiAgfSgpOwp9Ci8qICAqLwoKCnZhciB3YXJuID0gbm9vcDsKdmFyIHRpcCA9IG5vb3A7CnZhciBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlID0gbm9vcDsgLy8gd29yayBhcm91bmQgZmxvdyBjaGVjawoKdmFyIGZvcm1hdENvbXBvbmVudE5hbWUgPSBub29wOwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgaGFzQ29uc29sZSA9IHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJzsKICB2YXIgY2xhc3NpZnlSRSA9IC8oPzpefFstX10pKFx3KS9nOwoKICB2YXIgY2xhc3NpZnkgPSBmdW5jdGlvbiBjbGFzc2lmeShzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShjbGFzc2lmeVJFLCBmdW5jdGlvbiAoYykgewogICAgICByZXR1cm4gYy50b1VwcGVyQ2FzZSgpOwogICAgfSkucmVwbGFjZSgvWy1fXS9nLCAnJyk7CiAgfTsKCiAgd2FybiA9IGZ1bmN0aW9uIHdhcm4obXNnLCB2bSkgewogICAgdmFyIHRyYWNlID0gdm0gPyBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSA6ICcnOwoKICAgIGlmIChjb25maWcud2FybkhhbmRsZXIpIHsKICAgICAgY29uZmlnLndhcm5IYW5kbGVyLmNhbGwobnVsbCwgbXNnLCB2bSwgdHJhY2UpOwogICAgfSBlbHNlIGlmIChoYXNDb25zb2xlICYmICFjb25maWcuc2lsZW50KSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIltWdWUgd2Fybl06ICIgKyBtc2cgKyB0cmFjZSk7CiAgICB9CiAgfTsKCiAgdGlwID0gZnVuY3Rpb24gdGlwKG1zZywgdm0pIHsKICAgIGlmIChoYXNDb25zb2xlICYmICFjb25maWcuc2lsZW50KSB7CiAgICAgIGNvbnNvbGUud2FybigiW1Z1ZSB0aXBdOiAiICsgbXNnICsgKHZtID8gZ2VuZXJhdGVDb21wb25lbnRUcmFjZSh2bSkgOiAnJykpOwogICAgfQogIH07CgogIGZvcm1hdENvbXBvbmVudE5hbWUgPSBmdW5jdGlvbiBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBpbmNsdWRlRmlsZSkgewogICAgaWYgKHZtLiRyb290ID09PSB2bSkgewogICAgICByZXR1cm4gJzxSb290Pic7CiAgICB9CgogICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygdm0gPT09ICdmdW5jdGlvbicgJiYgdm0uY2lkICE9IG51bGwgPyB2bS5vcHRpb25zIDogdm0uX2lzVnVlID8gdm0uJG9wdGlvbnMgfHwgdm0uY29uc3RydWN0b3Iub3B0aW9ucyA6IHZtOwogICAgdmFyIG5hbWUgPSBvcHRpb25zLm5hbWUgfHwgb3B0aW9ucy5fY29tcG9uZW50VGFnOwogICAgdmFyIGZpbGUgPSBvcHRpb25zLl9fZmlsZTsKCiAgICBpZiAoIW5hbWUgJiYgZmlsZSkgewogICAgICB2YXIgbWF0Y2ggPSBmaWxlLm1hdGNoKC8oW14vXFxdKylcLnZ1ZSQvKTsKICAgICAgbmFtZSA9IG1hdGNoICYmIG1hdGNoWzFdOwogICAgfQoKICAgIHJldHVybiAobmFtZSA/ICI8IiArIGNsYXNzaWZ5KG5hbWUpICsgIj4iIDogIjxBbm9ueW1vdXM+IikgKyAoZmlsZSAmJiBpbmNsdWRlRmlsZSAhPT0gZmFsc2UgPyAiIGF0ICIgKyBmaWxlIDogJycpOwogIH07CgogIHZhciByZXBlYXQgPSBmdW5jdGlvbiByZXBlYXQoc3RyLCBuKSB7CiAgICB2YXIgcmVzID0gJyc7CgogICAgd2hpbGUgKG4pIHsKICAgICAgaWYgKG4gJSAyID09PSAxKSB7CiAgICAgICAgcmVzICs9IHN0cjsKICAgICAgfQoKICAgICAgaWYgKG4gPiAxKSB7CiAgICAgICAgc3RyICs9IHN0cjsKICAgICAgfQoKICAgICAgbiA+Pj0gMTsKICAgIH0KCiAgICByZXR1cm4gcmVzOwogIH07CgogIGdlbmVyYXRlQ29tcG9uZW50VHJhY2UgPSBmdW5jdGlvbiBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSB7CiAgICBpZiAodm0uX2lzVnVlICYmIHZtLiRwYXJlbnQpIHsKICAgICAgdmFyIHRyZWUgPSBbXTsKICAgICAgdmFyIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CgogICAgICB3aGlsZSAodm0pIHsKICAgICAgICBpZiAodHJlZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgbGFzdCA9IHRyZWVbdHJlZS5sZW5ndGggLSAxXTsKCiAgICAgICAgICBpZiAobGFzdC5jb25zdHJ1Y3RvciA9PT0gdm0uY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlKys7CiAgICAgICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA+IDApIHsKICAgICAgICAgICAgdHJlZVt0cmVlLmxlbmd0aCAtIDFdID0gW2xhc3QsIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZV07CiAgICAgICAgICAgIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0cmVlLnB1c2godm0pOwogICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuICdcblxuZm91bmQgaW5cblxuJyArIHRyZWUubWFwKGZ1bmN0aW9uICh2bSwgaSkgewogICAgICAgIHJldHVybiAiIiArIChpID09PSAwID8gJy0tLT4gJyA6IHJlcGVhdCgnICcsIDUgKyBpICogMikpICsgKEFycmF5LmlzQXJyYXkodm0pID8gZm9ybWF0Q29tcG9uZW50TmFtZSh2bVswXSkgKyAiLi4uICgiICsgdm1bMV0gKyAiIHJlY3Vyc2l2ZSBjYWxscykiIDogZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkpOwogICAgICB9KS5qb2luKCdcbicpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICJcblxuKGZvdW5kIGluICIgKyBmb3JtYXRDb21wb25lbnROYW1lKHZtKSArICIpIjsKICAgIH0KICB9Owp9Ci8qICAqLwoKCnZhciB1aWQgPSAwOwovKioKICogQSBkZXAgaXMgYW4gb2JzZXJ2YWJsZSB0aGF0IGNhbiBoYXZlIG11bHRpcGxlCiAqIGRpcmVjdGl2ZXMgc3Vic2NyaWJpbmcgdG8gaXQuCiAqLwoKdmFyIERlcCA9IGZ1bmN0aW9uIERlcCgpIHsKICB0aGlzLmlkID0gdWlkKys7CiAgdGhpcy5zdWJzID0gW107Cn07CgpEZXAucHJvdG90eXBlLmFkZFN1YiA9IGZ1bmN0aW9uIGFkZFN1YihzdWIpIHsKICB0aGlzLnN1YnMucHVzaChzdWIpOwp9OwoKRGVwLnByb3RvdHlwZS5yZW1vdmVTdWIgPSBmdW5jdGlvbiByZW1vdmVTdWIoc3ViKSB7CiAgcmVtb3ZlKHRoaXMuc3Vicywgc3ViKTsKfTsKCkRlcC5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gZGVwZW5kKCkgewogIGlmIChEZXAudGFyZ2V0KSB7CiAgICBEZXAudGFyZ2V0LmFkZERlcCh0aGlzKTsKICB9Cn07CgpEZXAucHJvdG90eXBlLm5vdGlmeSA9IGZ1bmN0aW9uIG5vdGlmeSgpIHsKICAvLyBzdGFiaWxpemUgdGhlIHN1YnNjcmliZXIgbGlzdCBmaXJzdAogIHZhciBzdWJzID0gdGhpcy5zdWJzLnNsaWNlKCk7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb25maWcuYXN5bmMpIHsKICAgIC8vIHN1YnMgYXJlbid0IHNvcnRlZCBpbiBzY2hlZHVsZXIgaWYgbm90IHJ1bm5pbmcgYXN5bmMKICAgIC8vIHdlIG5lZWQgdG8gc29ydCB0aGVtIG5vdyB0byBtYWtlIHN1cmUgdGhleSBmaXJlIGluIGNvcnJlY3QKICAgIC8vIG9yZGVyCiAgICBzdWJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEuaWQgLSBiLmlkOwogICAgfSk7CiAgfQoKICBmb3IgKHZhciBpID0gMCwgbCA9IHN1YnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBzdWJzW2ldLnVwZGF0ZSgpOwogIH0KfTsgLy8gVGhlIGN1cnJlbnQgdGFyZ2V0IHdhdGNoZXIgYmVpbmcgZXZhbHVhdGVkLgovLyBUaGlzIGlzIGdsb2JhbGx5IHVuaXF1ZSBiZWNhdXNlIG9ubHkgb25lIHdhdGNoZXIKLy8gY2FuIGJlIGV2YWx1YXRlZCBhdCBhIHRpbWUuCgoKRGVwLnRhcmdldCA9IG51bGw7CnZhciB0YXJnZXRTdGFjayA9IFtdOwoKZnVuY3Rpb24gcHVzaFRhcmdldCh0YXJnZXQpIHsKICB0YXJnZXRTdGFjay5wdXNoKHRhcmdldCk7CiAgRGVwLnRhcmdldCA9IHRhcmdldDsKfQoKZnVuY3Rpb24gcG9wVGFyZ2V0KCkgewogIHRhcmdldFN0YWNrLnBvcCgpOwogIERlcC50YXJnZXQgPSB0YXJnZXRTdGFja1t0YXJnZXRTdGFjay5sZW5ndGggLSAxXTsKfQovKiAgKi8KCgp2YXIgVk5vZGUgPSBmdW5jdGlvbiBWTm9kZSh0YWcsIGRhdGEsIGNoaWxkcmVuLCB0ZXh0LCBlbG0sIGNvbnRleHQsIGNvbXBvbmVudE9wdGlvbnMsIGFzeW5jRmFjdG9yeSkgewogIHRoaXMudGFnID0gdGFnOwogIHRoaXMuZGF0YSA9IGRhdGE7CiAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogIHRoaXMudGV4dCA9IHRleHQ7CiAgdGhpcy5lbG0gPSBlbG07CiAgdGhpcy5ucyA9IHVuZGVmaW5lZDsKICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogIHRoaXMuZm5Db250ZXh0ID0gdW5kZWZpbmVkOwogIHRoaXMuZm5PcHRpb25zID0gdW5kZWZpbmVkOwogIHRoaXMuZm5TY29wZUlkID0gdW5kZWZpbmVkOwogIHRoaXMua2V5ID0gZGF0YSAmJiBkYXRhLmtleTsKICB0aGlzLmNvbXBvbmVudE9wdGlvbnMgPSBjb21wb25lbnRPcHRpb25zOwogIHRoaXMuY29tcG9uZW50SW5zdGFuY2UgPSB1bmRlZmluZWQ7CiAgdGhpcy5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgdGhpcy5yYXcgPSBmYWxzZTsKICB0aGlzLmlzU3RhdGljID0gZmFsc2U7CiAgdGhpcy5pc1Jvb3RJbnNlcnQgPSB0cnVlOwogIHRoaXMuaXNDb21tZW50ID0gZmFsc2U7CiAgdGhpcy5pc0Nsb25lZCA9IGZhbHNlOwogIHRoaXMuaXNPbmNlID0gZmFsc2U7CiAgdGhpcy5hc3luY0ZhY3RvcnkgPSBhc3luY0ZhY3Rvcnk7CiAgdGhpcy5hc3luY01ldGEgPSB1bmRlZmluZWQ7CiAgdGhpcy5pc0FzeW5jUGxhY2Vob2xkZXIgPSBmYWxzZTsKfTsKCnZhciBwcm90b3R5cGVBY2Nlc3NvcnMgPSB7CiAgY2hpbGQ6IHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0KfTsgLy8gREVQUkVDQVRFRDogYWxpYXMgZm9yIGNvbXBvbmVudEluc3RhbmNlIGZvciBiYWNrd2FyZHMgY29tcGF0LgoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCnByb3RvdHlwZUFjY2Vzc29ycy5jaGlsZC5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuY29tcG9uZW50SW5zdGFuY2U7Cn07CgpPYmplY3QuZGVmaW5lUHJvcGVydGllcyhWTm9kZS5wcm90b3R5cGUsIHByb3RvdHlwZUFjY2Vzc29ycyk7Cgp2YXIgY3JlYXRlRW1wdHlWTm9kZSA9IGZ1bmN0aW9uIGNyZWF0ZUVtcHR5Vk5vZGUodGV4dCkgewogIGlmICh0ZXh0ID09PSB2b2lkIDApIHRleHQgPSAnJzsKICB2YXIgbm9kZSA9IG5ldyBWTm9kZSgpOwogIG5vZGUudGV4dCA9IHRleHQ7CiAgbm9kZS5pc0NvbW1lbnQgPSB0cnVlOwogIHJldHVybiBub2RlOwp9OwoKZnVuY3Rpb24gY3JlYXRlVGV4dFZOb2RlKHZhbCkgewogIHJldHVybiBuZXcgVk5vZGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgU3RyaW5nKHZhbCkpOwp9IC8vIG9wdGltaXplZCBzaGFsbG93IGNsb25lCi8vIHVzZWQgZm9yIHN0YXRpYyBub2RlcyBhbmQgc2xvdCBub2RlcyBiZWNhdXNlIHRoZXkgbWF5IGJlIHJldXNlZCBhY3Jvc3MKLy8gbXVsdGlwbGUgcmVuZGVycywgY2xvbmluZyB0aGVtIGF2b2lkcyBlcnJvcnMgd2hlbiBET00gbWFuaXB1bGF0aW9ucyByZWx5Ci8vIG9uIHRoZWlyIGVsbSByZWZlcmVuY2UuCgoKZnVuY3Rpb24gY2xvbmVWTm9kZSh2bm9kZSkgewogIHZhciBjbG9uZWQgPSBuZXcgVk5vZGUodm5vZGUudGFnLCB2bm9kZS5kYXRhLCAvLyAjNzk3NQogIC8vIGNsb25lIGNoaWxkcmVuIGFycmF5IHRvIGF2b2lkIG11dGF0aW5nIG9yaWdpbmFsIGluIGNhc2Ugb2YgY2xvbmluZwogIC8vIGEgY2hpbGQuCiAgdm5vZGUuY2hpbGRyZW4gJiYgdm5vZGUuY2hpbGRyZW4uc2xpY2UoKSwgdm5vZGUudGV4dCwgdm5vZGUuZWxtLCB2bm9kZS5jb250ZXh0LCB2bm9kZS5jb21wb25lbnRPcHRpb25zLCB2bm9kZS5hc3luY0ZhY3RvcnkpOwogIGNsb25lZC5ucyA9IHZub2RlLm5zOwogIGNsb25lZC5pc1N0YXRpYyA9IHZub2RlLmlzU3RhdGljOwogIGNsb25lZC5rZXkgPSB2bm9kZS5rZXk7CiAgY2xvbmVkLmlzQ29tbWVudCA9IHZub2RlLmlzQ29tbWVudDsKICBjbG9uZWQuZm5Db250ZXh0ID0gdm5vZGUuZm5Db250ZXh0OwogIGNsb25lZC5mbk9wdGlvbnMgPSB2bm9kZS5mbk9wdGlvbnM7CiAgY2xvbmVkLmZuU2NvcGVJZCA9IHZub2RlLmZuU2NvcGVJZDsKICBjbG9uZWQuYXN5bmNNZXRhID0gdm5vZGUuYXN5bmNNZXRhOwogIGNsb25lZC5pc0Nsb25lZCA9IHRydWU7CiAgcmV0dXJuIGNsb25lZDsKfQovKgogKiBub3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgcGxheSB3ZWxsIHdpdGgKICogZHluYW1pY2FsbHkgYWNjZXNzaW5nIG1ldGhvZHMgb24gQXJyYXkgcHJvdG90eXBlCiAqLwoKCnZhciBhcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlOwp2YXIgYXJyYXlNZXRob2RzID0gT2JqZWN0LmNyZWF0ZShhcnJheVByb3RvKTsKdmFyIG1ldGhvZHNUb1BhdGNoID0gWydwdXNoJywgJ3BvcCcsICdzaGlmdCcsICd1bnNoaWZ0JywgJ3NwbGljZScsICdzb3J0JywgJ3JldmVyc2UnXTsKLyoqCiAqIEludGVyY2VwdCBtdXRhdGluZyBtZXRob2RzIGFuZCBlbWl0IGV2ZW50cwogKi8KCm1ldGhvZHNUb1BhdGNoLmZvckVhY2goZnVuY3Rpb24gKG1ldGhvZCkgewogIC8vIGNhY2hlIG9yaWdpbmFsIG1ldGhvZAogIHZhciBvcmlnaW5hbCA9IGFycmF5UHJvdG9bbWV0aG9kXTsKICBkZWYoYXJyYXlNZXRob2RzLCBtZXRob2QsIGZ1bmN0aW9uIG11dGF0b3IoKSB7CiAgICB2YXIgYXJncyA9IFtdLAogICAgICAgIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgd2hpbGUgKGxlbi0tKSB7CiAgICAgIGFyZ3NbbGVuXSA9IGFyZ3VtZW50c1tsZW5dOwogICAgfQoKICAgIHZhciByZXN1bHQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgIHZhciBvYiA9IHRoaXMuX19vYl9fOwogICAgdmFyIGluc2VydGVkOwoKICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgJ3B1c2gnOgogICAgICBjYXNlICd1bnNoaWZ0JzoKICAgICAgICBpbnNlcnRlZCA9IGFyZ3M7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzcGxpY2UnOgogICAgICAgIGluc2VydGVkID0gYXJncy5zbGljZSgyKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICBpZiAoaW5zZXJ0ZWQpIHsKICAgICAgb2Iub2JzZXJ2ZUFycmF5KGluc2VydGVkKTsKICAgIH0gLy8gbm90aWZ5IGNoYW5nZQoKCiAgICBvYi5kZXAubm90aWZ5KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0pOwp9KTsKLyogICovCgp2YXIgYXJyYXlLZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoYXJyYXlNZXRob2RzKTsKLyoqCiAqIEluIHNvbWUgY2FzZXMgd2UgbWF5IHdhbnQgdG8gZGlzYWJsZSBvYnNlcnZhdGlvbiBpbnNpZGUgYSBjb21wb25lbnQncwogKiB1cGRhdGUgY29tcHV0YXRpb24uCiAqLwoKdmFyIHNob3VsZE9ic2VydmUgPSB0cnVlOwoKZnVuY3Rpb24gdG9nZ2xlT2JzZXJ2aW5nKHZhbHVlKSB7CiAgc2hvdWxkT2JzZXJ2ZSA9IHZhbHVlOwp9Ci8qKgogKiBPYnNlcnZlciBjbGFzcyB0aGF0IGlzIGF0dGFjaGVkIHRvIGVhY2ggb2JzZXJ2ZWQKICogb2JqZWN0LiBPbmNlIGF0dGFjaGVkLCB0aGUgb2JzZXJ2ZXIgY29udmVydHMgdGhlIHRhcmdldAogKiBvYmplY3QncyBwcm9wZXJ0eSBrZXlzIGludG8gZ2V0dGVyL3NldHRlcnMgdGhhdAogKiBjb2xsZWN0IGRlcGVuZGVuY2llcyBhbmQgZGlzcGF0Y2ggdXBkYXRlcy4KICovCgoKdmFyIE9ic2VydmVyID0gZnVuY3Rpb24gT2JzZXJ2ZXIodmFsdWUpIHsKICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgdGhpcy5kZXAgPSBuZXcgRGVwKCk7CiAgdGhpcy52bUNvdW50ID0gMDsKICBkZWYodmFsdWUsICdfX29iX18nLCB0aGlzKTsKCiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICBpZiAoaGFzUHJvdG8pIHsKICAgICAgcHJvdG9BdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMpOwogICAgfSBlbHNlIHsKICAgICAgY29weUF1Z21lbnQodmFsdWUsIGFycmF5TWV0aG9kcywgYXJyYXlLZXlzKTsKICAgIH0KCiAgICB0aGlzLm9ic2VydmVBcnJheSh2YWx1ZSk7CiAgfSBlbHNlIHsKICAgIHRoaXMud2Fsayh2YWx1ZSk7CiAgfQp9OwovKioKICogV2FsayB0aHJvdWdoIGFsbCBwcm9wZXJ0aWVzIGFuZCBjb252ZXJ0IHRoZW0gaW50bwogKiBnZXR0ZXIvc2V0dGVycy4gVGhpcyBtZXRob2Qgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIHdoZW4KICogdmFsdWUgdHlwZSBpcyBPYmplY3QuCiAqLwoKCk9ic2VydmVyLnByb3RvdHlwZS53YWxrID0gZnVuY3Rpb24gd2FsayhvYmopIHsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgZGVmaW5lUmVhY3RpdmUkJDEob2JqLCBrZXlzW2ldKTsKICB9Cn07Ci8qKgogKiBPYnNlcnZlIGEgbGlzdCBvZiBBcnJheSBpdGVtcy4KICovCgoKT2JzZXJ2ZXIucHJvdG90eXBlLm9ic2VydmVBcnJheSA9IGZ1bmN0aW9uIG9ic2VydmVBcnJheShpdGVtcykgewogIGZvciAodmFyIGkgPSAwLCBsID0gaXRlbXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBvYnNlcnZlKGl0ZW1zW2ldKTsKICB9Cn07IC8vIGhlbHBlcnMKCi8qKgogKiBBdWdtZW50IGEgdGFyZ2V0IE9iamVjdCBvciBBcnJheSBieSBpbnRlcmNlcHRpbmcKICogdGhlIHByb3RvdHlwZSBjaGFpbiB1c2luZyBfX3Byb3RvX18KICovCgoKZnVuY3Rpb24gcHJvdG9BdWdtZW50KHRhcmdldCwgc3JjKSB7CiAgLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KICB0YXJnZXQuX19wcm90b19fID0gc3JjOwogIC8qIGVzbGludC1lbmFibGUgbm8tcHJvdG8gKi8KfQovKioKICogQXVnbWVudCBhIHRhcmdldCBPYmplY3Qgb3IgQXJyYXkgYnkgZGVmaW5pbmcKICogaGlkZGVuIHByb3BlcnRpZXMuCiAqLwoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgpmdW5jdGlvbiBjb3B5QXVnbWVudCh0YXJnZXQsIHNyYywga2V5cykgewogIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgZGVmKHRhcmdldCwga2V5LCBzcmNba2V5XSk7CiAgfQp9Ci8qKgogKiBBdHRlbXB0IHRvIGNyZWF0ZSBhbiBvYnNlcnZlciBpbnN0YW5jZSBmb3IgYSB2YWx1ZSwKICogcmV0dXJucyB0aGUgbmV3IG9ic2VydmVyIGlmIHN1Y2Nlc3NmdWxseSBvYnNlcnZlZCwKICogb3IgdGhlIGV4aXN0aW5nIG9ic2VydmVyIGlmIHRoZSB2YWx1ZSBhbHJlYWR5IGhhcyBvbmUuCiAqLwoKCmZ1bmN0aW9uIG9ic2VydmUodmFsdWUsIGFzUm9vdERhdGEpIHsKICBpZiAoIWlzT2JqZWN0KHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb2I7CgogIGlmIChoYXNPd24odmFsdWUsICdfX29iX18nKSAmJiB2YWx1ZS5fX29iX18gaW5zdGFuY2VvZiBPYnNlcnZlcikgewogICAgb2IgPSB2YWx1ZS5fX29iX187CiAgfSBlbHNlIGlmIChzaG91bGRPYnNlcnZlICYmICFpc1NlcnZlclJlbmRlcmluZygpICYmIChBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BsYWluT2JqZWN0KHZhbHVlKSkgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZSh2YWx1ZSkgJiYgIXZhbHVlLl9pc1Z1ZSkgewogICAgb2IgPSBuZXcgT2JzZXJ2ZXIodmFsdWUpOwogIH0KCiAgaWYgKGFzUm9vdERhdGEgJiYgb2IpIHsKICAgIG9iLnZtQ291bnQrKzsKICB9CgogIHJldHVybiBvYjsKfQovKioKICogRGVmaW5lIGEgcmVhY3RpdmUgcHJvcGVydHkgb24gYW4gT2JqZWN0LgogKi8KCgpmdW5jdGlvbiBkZWZpbmVSZWFjdGl2ZSQkMShvYmosIGtleSwgdmFsLCBjdXN0b21TZXR0ZXIsIHNoYWxsb3cpIHsKICB2YXIgZGVwID0gbmV3IERlcCgpOwogIHZhciBwcm9wZXJ0eSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwoKICBpZiAocHJvcGVydHkgJiYgcHJvcGVydHkuY29uZmlndXJhYmxlID09PSBmYWxzZSkgewogICAgcmV0dXJuOwogIH0gLy8gY2F0ZXIgZm9yIHByZS1kZWZpbmVkIGdldHRlci9zZXR0ZXJzCgoKICB2YXIgZ2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0OwogIHZhciBzZXR0ZXIgPSBwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5zZXQ7CgogIGlmICgoIWdldHRlciB8fCBzZXR0ZXIpICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHZhbCA9IG9ialtrZXldOwogIH0KCiAgdmFyIGNoaWxkT2IgPSAhc2hhbGxvdyAmJiBvYnNlcnZlKHZhbCk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiByZWFjdGl2ZUdldHRlcigpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKCiAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgZGVwLmRlcGVuZCgpOwoKICAgICAgICBpZiAoY2hpbGRPYikgewogICAgICAgICAgY2hpbGRPYi5kZXAuZGVwZW5kKCk7CgogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGRlcGVuZEFycmF5KHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHJlYWN0aXZlU2V0dGVyKG5ld1ZhbCkgewogICAgICB2YXIgdmFsdWUgPSBnZXR0ZXIgPyBnZXR0ZXIuY2FsbChvYmopIDogdmFsOwogICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1zZWxmLWNvbXBhcmUgKi8KCiAgICAgIGlmIChuZXdWYWwgPT09IHZhbHVlIHx8IG5ld1ZhbCAhPT0gbmV3VmFsICYmIHZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXNlbGYtY29tcGFyZSAqLwoKCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGN1c3RvbVNldHRlcikgewogICAgICAgIGN1c3RvbVNldHRlcigpOwogICAgICB9IC8vICM3OTgxOiBmb3IgYWNjZXNzb3IgcHJvcGVydGllcyB3aXRob3V0IHNldHRlcgoKCiAgICAgIGlmIChnZXR0ZXIgJiYgIXNldHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHNldHRlcikgewogICAgICAgIHNldHRlci5jYWxsKG9iaiwgbmV3VmFsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWwgPSBuZXdWYWw7CiAgICAgIH0KCiAgICAgIGNoaWxkT2IgPSAhc2hhbGxvdyAmJiBvYnNlcnZlKG5ld1ZhbCk7CiAgICAgIGRlcC5ub3RpZnkoKTsKICAgIH0KICB9KTsKfQovKioKICogU2V0IGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBBZGRzIHRoZSBuZXcgcHJvcGVydHkgYW5kCiAqIHRyaWdnZXJzIGNoYW5nZSBub3RpZmljYXRpb24gaWYgdGhlIHByb3BlcnR5IGRvZXNuJ3QKICogYWxyZWFkeSBleGlzdC4KICovCgoKZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCB2YWwpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkpKSB7CiAgICB3YXJuKCJDYW5ub3Qgc2V0IHJlYWN0aXZlIHByb3BlcnR5IG9uIHVuZGVmaW5lZCwgbnVsbCwgb3IgcHJpbWl0aXZlIHZhbHVlOiAiICsgdGFyZ2V0KTsKICB9CgogIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgdGFyZ2V0Lmxlbmd0aCA9IE1hdGgubWF4KHRhcmdldC5sZW5ndGgsIGtleSk7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSwgdmFsKTsKICAgIHJldHVybiB2YWw7CiAgfQoKICBpZiAoa2V5IGluIHRhcmdldCAmJiAhKGtleSBpbiBPYmplY3QucHJvdG90eXBlKSkgewogICAgdGFyZ2V0W2tleV0gPSB2YWw7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgdmFyIG9iID0gdGFyZ2V0Ll9fb2JfXzsKCiAgaWYgKHRhcmdldC5faXNWdWUgfHwgb2IgJiYgb2Iudm1Db3VudCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdBdm9pZCBhZGRpbmcgcmVhY3RpdmUgcHJvcGVydGllcyB0byBhIFZ1ZSBpbnN0YW5jZSBvciBpdHMgcm9vdCAkZGF0YSAnICsgJ2F0IHJ1bnRpbWUgLSBkZWNsYXJlIGl0IHVwZnJvbnQgaW4gdGhlIGRhdGEgb3B0aW9uLicpOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGlmICghb2IpIHsKICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGRlZmluZVJlYWN0aXZlJCQxKG9iLnZhbHVlLCBrZXksIHZhbCk7CiAgb2IuZGVwLm5vdGlmeSgpOwogIHJldHVybiB2YWw7Cn0KLyoqCiAqIERlbGV0ZSBhIHByb3BlcnR5IGFuZCB0cmlnZ2VyIGNoYW5nZSBpZiBuZWNlc3NhcnkuCiAqLwoKCmZ1bmN0aW9uIGRlbCh0YXJnZXQsIGtleSkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIChpc1VuZGVmKHRhcmdldCkgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkpIHsKICAgIHdhcm4oIkNhbm5vdCBkZWxldGUgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIgKyB0YXJnZXQpOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSAmJiBpc1ZhbGlkQXJyYXlJbmRleChrZXkpKSB7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb2IgPSB0YXJnZXQuX19vYl9fOwoKICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCBvYiAmJiBvYi52bUNvdW50KSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0F2b2lkIGRlbGV0aW5nIHByb3BlcnRpZXMgb24gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArICctIGp1c3Qgc2V0IGl0IHRvIG51bGwuJyk7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIWhhc093bih0YXJnZXQsIGtleSkpIHsKICAgIHJldHVybjsKICB9CgogIGRlbGV0ZSB0YXJnZXRba2V5XTsKCiAgaWYgKCFvYikgewogICAgcmV0dXJuOwogIH0KCiAgb2IuZGVwLm5vdGlmeSgpOwp9Ci8qKgogKiBDb2xsZWN0IGRlcGVuZGVuY2llcyBvbiBhcnJheSBlbGVtZW50cyB3aGVuIHRoZSBhcnJheSBpcyB0b3VjaGVkLCBzaW5jZQogKiB3ZSBjYW5ub3QgaW50ZXJjZXB0IGFycmF5IGVsZW1lbnQgYWNjZXNzIGxpa2UgcHJvcGVydHkgZ2V0dGVycy4KICovCgoKZnVuY3Rpb24gZGVwZW5kQXJyYXkodmFsdWUpIHsKICBmb3IgKHZhciBlID0gdm9pZCAwLCBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgZSA9IHZhbHVlW2ldOwogICAgZSAmJiBlLl9fb2JfXyAmJiBlLl9fb2JfXy5kZXAuZGVwZW5kKCk7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZSkpIHsKICAgICAgZGVwZW5kQXJyYXkoZSk7CiAgICB9CiAgfQp9Ci8qICAqLwoKLyoqCiAqIE9wdGlvbiBvdmVyd3JpdGluZyBzdHJhdGVnaWVzIGFyZSBmdW5jdGlvbnMgdGhhdCBoYW5kbGUKICogaG93IHRvIG1lcmdlIGEgcGFyZW50IG9wdGlvbiB2YWx1ZSBhbmQgYSBjaGlsZCBvcHRpb24KICogdmFsdWUgaW50byB0aGUgZmluYWwgdmFsdWUuCiAqLwoKCnZhciBzdHJhdHMgPSBjb25maWcub3B0aW9uTWVyZ2VTdHJhdGVnaWVzOwovKioKICogT3B0aW9ucyB3aXRoIHJlc3RyaWN0aW9ucwogKi8KCmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgc3RyYXRzLmVsID0gc3RyYXRzLnByb3BzRGF0YSA9IGZ1bmN0aW9uIChwYXJlbnQsIGNoaWxkLCB2bSwga2V5KSB7CiAgICBpZiAoIXZtKSB7CiAgICAgIHdhcm4oIm9wdGlvbiBcIiIgKyBrZXkgKyAiXCIgY2FuIG9ubHkgYmUgdXNlZCBkdXJpbmcgaW5zdGFuY2UgIiArICdjcmVhdGlvbiB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkLicpOwogICAgfQoKICAgIHJldHVybiBkZWZhdWx0U3RyYXQocGFyZW50LCBjaGlsZCk7CiAgfTsKfQovKioKICogSGVscGVyIHRoYXQgcmVjdXJzaXZlbHkgbWVyZ2VzIHR3byBkYXRhIG9iamVjdHMgdG9nZXRoZXIuCiAqLwoKCmZ1bmN0aW9uIG1lcmdlRGF0YSh0bywgZnJvbSkgewogIGlmICghZnJvbSkgewogICAgcmV0dXJuIHRvOwogIH0KCiAgdmFyIGtleSwgdG9WYWwsIGZyb21WYWw7CiAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoZnJvbSkgOiBPYmplY3Qua2V5cyhmcm9tKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBrZXkgPSBrZXlzW2ldOyAvLyBpbiBjYXNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBvYnNlcnZlZC4uLgoKICAgIGlmIChrZXkgPT09ICdfX29iX18nKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIHRvVmFsID0gdG9ba2V5XTsKICAgIGZyb21WYWwgPSBmcm9tW2tleV07CgogICAgaWYgKCFoYXNPd24odG8sIGtleSkpIHsKICAgICAgc2V0KHRvLCBrZXksIGZyb21WYWwpOwogICAgfSBlbHNlIGlmICh0b1ZhbCAhPT0gZnJvbVZhbCAmJiBpc1BsYWluT2JqZWN0KHRvVmFsKSAmJiBpc1BsYWluT2JqZWN0KGZyb21WYWwpKSB7CiAgICAgIG1lcmdlRGF0YSh0b1ZhbCwgZnJvbVZhbCk7CiAgICB9CiAgfQoKICByZXR1cm4gdG87Cn0KLyoqCiAqIERhdGEKICovCgoKZnVuY3Rpb24gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSkgewogIGlmICghdm0pIHsKICAgIC8vIGluIGEgVnVlLmV4dGVuZCBtZXJnZSwgYm90aCBzaG91bGQgYmUgZnVuY3Rpb25zCiAgICBpZiAoIWNoaWxkVmFsKSB7CiAgICAgIHJldHVybiBwYXJlbnRWYWw7CiAgICB9CgogICAgaWYgKCFwYXJlbnRWYWwpIHsKICAgICAgcmV0dXJuIGNoaWxkVmFsOwogICAgfSAvLyB3aGVuIHBhcmVudFZhbCAmIGNoaWxkVmFsIGFyZSBib3RoIHByZXNlbnQsCiAgICAvLyB3ZSBuZWVkIHRvIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAgIC8vIG1lcmdlZCByZXN1bHQgb2YgYm90aCBmdW5jdGlvbnMuLi4gbm8gbmVlZCB0bwogICAgLy8gY2hlY2sgaWYgcGFyZW50VmFsIGlzIGEgZnVuY3Rpb24gaGVyZSBiZWNhdXNlCiAgICAvLyBpdCBoYXMgdG8gYmUgYSBmdW5jdGlvbiB0byBwYXNzIHByZXZpb3VzIG1lcmdlcy4KCgogICAgcmV0dXJuIGZ1bmN0aW9uIG1lcmdlZERhdGFGbigpIHsKICAgICAgcmV0dXJuIG1lcmdlRGF0YSh0eXBlb2YgY2hpbGRWYWwgPT09ICdmdW5jdGlvbicgPyBjaGlsZFZhbC5jYWxsKHRoaXMsIHRoaXMpIDogY2hpbGRWYWwsIHR5cGVvZiBwYXJlbnRWYWwgPT09ICdmdW5jdGlvbicgPyBwYXJlbnRWYWwuY2FsbCh0aGlzLCB0aGlzKSA6IHBhcmVudFZhbCk7CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkSW5zdGFuY2VEYXRhRm4oKSB7CiAgICAgIC8vIGluc3RhbmNlIG1lcmdlCiAgICAgIHZhciBpbnN0YW5jZURhdGEgPSB0eXBlb2YgY2hpbGRWYWwgPT09ICdmdW5jdGlvbicgPyBjaGlsZFZhbC5jYWxsKHZtLCB2bSkgOiBjaGlsZFZhbDsKICAgICAgdmFyIGRlZmF1bHREYXRhID0gdHlwZW9mIHBhcmVudFZhbCA9PT0gJ2Z1bmN0aW9uJyA/IHBhcmVudFZhbC5jYWxsKHZtLCB2bSkgOiBwYXJlbnRWYWw7CgogICAgICBpZiAoaW5zdGFuY2VEYXRhKSB7CiAgICAgICAgcmV0dXJuIG1lcmdlRGF0YShpbnN0YW5jZURhdGEsIGRlZmF1bHREYXRhKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZGVmYXVsdERhdGE7CiAgICAgIH0KICAgIH07CiAgfQp9CgpzdHJhdHMuZGF0YSA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSkgewogIGlmICghdm0pIHsKICAgIGlmIChjaGlsZFZhbCAmJiB0eXBlb2YgY2hpbGRWYWwgIT09ICdmdW5jdGlvbicpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdUaGUgImRhdGEiIG9wdGlvbiBzaG91bGQgYmUgYSBmdW5jdGlvbiAnICsgJ3RoYXQgcmV0dXJucyBhIHBlci1pbnN0YW5jZSB2YWx1ZSBpbiBjb21wb25lbnQgJyArICdkZWZpbml0aW9ucy4nLCB2bSk7CiAgICAgIHJldHVybiBwYXJlbnRWYWw7CiAgICB9CgogICAgcmV0dXJuIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCk7CiAgfQoKICByZXR1cm4gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSk7Cn07Ci8qKgogKiBIb29rcyBhbmQgcHJvcHMgYXJlIG1lcmdlZCBhcyBhcnJheXMuCiAqLwoKCmZ1bmN0aW9uIG1lcmdlSG9vayhwYXJlbnRWYWwsIGNoaWxkVmFsKSB7CiAgdmFyIHJlcyA9IGNoaWxkVmFsID8gcGFyZW50VmFsID8gcGFyZW50VmFsLmNvbmNhdChjaGlsZFZhbCkgOiBBcnJheS5pc0FycmF5KGNoaWxkVmFsKSA/IGNoaWxkVmFsIDogW2NoaWxkVmFsXSA6IHBhcmVudFZhbDsKICByZXR1cm4gcmVzID8gZGVkdXBlSG9va3MocmVzKSA6IHJlczsKfQoKZnVuY3Rpb24gZGVkdXBlSG9va3MoaG9va3MpIHsKICB2YXIgcmVzID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspIHsKICAgIGlmIChyZXMuaW5kZXhPZihob29rc1tpXSkgPT09IC0xKSB7CiAgICAgIHJlcy5wdXNoKGhvb2tzW2ldKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCkxJRkVDWUNMRV9IT09LUy5mb3JFYWNoKGZ1bmN0aW9uIChob29rKSB7CiAgc3RyYXRzW2hvb2tdID0gbWVyZ2VIb29rOwp9KTsKLyoqCiAqIEFzc2V0cwogKgogKiBXaGVuIGEgdm0gaXMgcHJlc2VudCAoaW5zdGFuY2UgY3JlYXRpb24pLCB3ZSBuZWVkIHRvIGRvCiAqIGEgdGhyZWUtd2F5IG1lcmdlIGJldHdlZW4gY29uc3RydWN0b3Igb3B0aW9ucywgaW5zdGFuY2UKICogb3B0aW9ucyBhbmQgcGFyZW50IG9wdGlvbnMuCiAqLwoKZnVuY3Rpb24gbWVyZ2VBc3NldHMocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIHZhciByZXMgPSBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKCiAgaWYgKGNoaWxkVmFsKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogICAgcmV0dXJuIGV4dGVuZChyZXMsIGNoaWxkVmFsKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHJlczsKICB9Cn0KCkFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICBzdHJhdHNbdHlwZSArICdzJ10gPSBtZXJnZUFzc2V0czsKfSk7Ci8qKgogKiBXYXRjaGVycy4KICoKICogV2F0Y2hlcnMgaGFzaGVzIHNob3VsZCBub3Qgb3ZlcndyaXRlIG9uZQogKiBhbm90aGVyLCBzbyB3ZSBtZXJnZSB0aGVtIGFzIGFycmF5cy4KICovCgpzdHJhdHMud2F0Y2ggPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIC8vIHdvcmsgYXJvdW5kIEZpcmVmb3gncyBPYmplY3QucHJvdG90eXBlLndhdGNoLi4uCiAgaWYgKHBhcmVudFZhbCA9PT0gbmF0aXZlV2F0Y2gpIHsKICAgIHBhcmVudFZhbCA9IHVuZGVmaW5lZDsKICB9CgogIGlmIChjaGlsZFZhbCA9PT0gbmF0aXZlV2F0Y2gpIHsKICAgIGNoaWxkVmFsID0gdW5kZWZpbmVkOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmICghY2hpbGRWYWwpIHsKICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICB9CgogIGlmICghcGFyZW50VmFsKSB7CiAgICByZXR1cm4gY2hpbGRWYWw7CiAgfQoKICB2YXIgcmV0ID0ge307CiAgZXh0ZW5kKHJldCwgcGFyZW50VmFsKTsKCiAgZm9yICh2YXIga2V5JDEgaW4gY2hpbGRWYWwpIHsKICAgIHZhciBwYXJlbnQgPSByZXRba2V5JDFdOwogICAgdmFyIGNoaWxkID0gY2hpbGRWYWxba2V5JDFdOwoKICAgIGlmIChwYXJlbnQgJiYgIUFycmF5LmlzQXJyYXkocGFyZW50KSkgewogICAgICBwYXJlbnQgPSBbcGFyZW50XTsKICAgIH0KCiAgICByZXRba2V5JDFdID0gcGFyZW50ID8gcGFyZW50LmNvbmNhdChjaGlsZCkgOiBBcnJheS5pc0FycmF5KGNoaWxkKSA/IGNoaWxkIDogW2NoaWxkXTsKICB9CgogIHJldHVybiByZXQ7Cn07Ci8qKgogKiBPdGhlciBvYmplY3QgaGFzaGVzLgogKi8KCgpzdHJhdHMucHJvcHMgPSBzdHJhdHMubWV0aG9kcyA9IHN0cmF0cy5pbmplY3QgPSBzdHJhdHMuY29tcHV0ZWQgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIGlmIChjaGlsZFZhbCAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICB9CgogIGlmICghcGFyZW50VmFsKSB7CiAgICByZXR1cm4gY2hpbGRWYWw7CiAgfQoKICB2YXIgcmV0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICBleHRlbmQocmV0LCBwYXJlbnRWYWwpOwoKICBpZiAoY2hpbGRWYWwpIHsKICAgIGV4dGVuZChyZXQsIGNoaWxkVmFsKTsKICB9CgogIHJldHVybiByZXQ7Cn07CgpzdHJhdHMucHJvdmlkZSA9IG1lcmdlRGF0YU9yRm47Ci8qKgogKiBEZWZhdWx0IHN0cmF0ZWd5LgogKi8KCnZhciBkZWZhdWx0U3RyYXQgPSBmdW5jdGlvbiBkZWZhdWx0U3RyYXQocGFyZW50VmFsLCBjaGlsZFZhbCkgewogIHJldHVybiBjaGlsZFZhbCA9PT0gdW5kZWZpbmVkID8gcGFyZW50VmFsIDogY2hpbGRWYWw7Cn07Ci8qKgogKiBWYWxpZGF0ZSBjb21wb25lbnQgbmFtZXMKICovCgoKZnVuY3Rpb24gY2hlY2tDb21wb25lbnRzKG9wdGlvbnMpIHsKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5jb21wb25lbnRzKSB7CiAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUoa2V5KTsKICB9Cn0KCmZ1bmN0aW9uIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lKSB7CiAgaWYgKCFuZXcgUmVnRXhwKCJeW2EtekEtWl1bXFwtXFwuMC05XyIgKyB1bmljb2RlUmVnRXhwLnNvdXJjZSArICJdKiQiKS50ZXN0KG5hbWUpKSB7CiAgICB3YXJuKCdJbnZhbGlkIGNvbXBvbmVudCBuYW1lOiAiJyArIG5hbWUgKyAnIi4gQ29tcG9uZW50IG5hbWVzICcgKyAnc2hvdWxkIGNvbmZvcm0gdG8gdmFsaWQgY3VzdG9tIGVsZW1lbnQgbmFtZSBpbiBodG1sNSBzcGVjaWZpY2F0aW9uLicpOwogIH0KCiAgaWYgKGlzQnVpbHRJblRhZyhuYW1lKSB8fCBjb25maWcuaXNSZXNlcnZlZFRhZyhuYW1lKSkgewogICAgd2FybignRG8gbm90IHVzZSBidWlsdC1pbiBvciByZXNlcnZlZCBIVE1MIGVsZW1lbnRzIGFzIGNvbXBvbmVudCAnICsgJ2lkOiAnICsgbmFtZSk7CiAgfQp9Ci8qKgogKiBFbnN1cmUgYWxsIHByb3BzIG9wdGlvbiBzeW50YXggYXJlIG5vcm1hbGl6ZWQgaW50byB0aGUKICogT2JqZWN0LWJhc2VkIGZvcm1hdC4KICovCgoKZnVuY3Rpb24gbm9ybWFsaXplUHJvcHMob3B0aW9ucywgdm0pIHsKICB2YXIgcHJvcHMgPSBvcHRpb25zLnByb3BzOwoKICBpZiAoIXByb3BzKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgcmVzID0ge307CiAgdmFyIGksIHZhbCwgbmFtZTsKCiAgaWYgKEFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICBpID0gcHJvcHMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdmFsID0gcHJvcHNbaV07CgogICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBuYW1lID0gY2FtZWxpemUodmFsKTsKICAgICAgICByZXNbbmFtZV0gPSB7CiAgICAgICAgICB0eXBlOiBudWxsCiAgICAgICAgfTsKICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgd2FybigncHJvcHMgbXVzdCBiZSBzdHJpbmdzIHdoZW4gdXNpbmcgYXJyYXkgc3ludGF4LicpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHByb3BzKSkgewogICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgIHZhbCA9IHByb3BzW2tleV07CiAgICAgIG5hbWUgPSBjYW1lbGl6ZShrZXkpOwogICAgICByZXNbbmFtZV0gPSBpc1BsYWluT2JqZWN0KHZhbCkgPyB2YWwgOiB7CiAgICAgICAgdHlwZTogdmFsCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJwcm9wc1wiOiBleHBlY3RlZCBhbiBBcnJheSBvciBhbiBPYmplY3QsICIgKyAiYnV0IGdvdCAiICsgdG9SYXdUeXBlKHByb3BzKSArICIuIiwgdm0pOwogIH0KCiAgb3B0aW9ucy5wcm9wcyA9IHJlczsKfQovKioKICogTm9ybWFsaXplIGFsbCBpbmplY3Rpb25zIGludG8gT2JqZWN0LWJhc2VkIGZvcm1hdAogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVJbmplY3Qob3B0aW9ucywgdm0pIHsKICB2YXIgaW5qZWN0ID0gb3B0aW9ucy5pbmplY3Q7CgogIGlmICghaW5qZWN0KSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgbm9ybWFsaXplZCA9IG9wdGlvbnMuaW5qZWN0ID0ge307CgogIGlmIChBcnJheS5pc0FycmF5KGluamVjdCkpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5qZWN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIG5vcm1hbGl6ZWRbaW5qZWN0W2ldXSA9IHsKICAgICAgICBmcm9tOiBpbmplY3RbaV0KICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QoaW5qZWN0KSkgewogICAgZm9yICh2YXIga2V5IGluIGluamVjdCkgewogICAgICB2YXIgdmFsID0gaW5qZWN0W2tleV07CiAgICAgIG5vcm1hbGl6ZWRba2V5XSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IGV4dGVuZCh7CiAgICAgICAgZnJvbToga2V5CiAgICAgIH0sIHZhbCkgOiB7CiAgICAgICAgZnJvbTogdmFsCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJpbmplY3RcIjogZXhwZWN0ZWQgYW4gQXJyYXkgb3IgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIiArIHRvUmF3VHlwZShpbmplY3QpICsgIi4iLCB2bSk7CiAgfQp9Ci8qKgogKiBOb3JtYWxpemUgcmF3IGZ1bmN0aW9uIGRpcmVjdGl2ZXMgaW50byBvYmplY3QgZm9ybWF0LgogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzKG9wdGlvbnMpIHsKICB2YXIgZGlycyA9IG9wdGlvbnMuZGlyZWN0aXZlczsKCiAgaWYgKGRpcnMpIHsKICAgIGZvciAodmFyIGtleSBpbiBkaXJzKSB7CiAgICAgIHZhciBkZWYkJDEgPSBkaXJzW2tleV07CgogICAgICBpZiAodHlwZW9mIGRlZiQkMSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGRpcnNba2V5XSA9IHsKICAgICAgICAgIGJpbmQ6IGRlZiQkMSwKICAgICAgICAgIHVwZGF0ZTogZGVmJCQxCiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gYXNzZXJ0T2JqZWN0VHlwZShuYW1lLCB2YWx1ZSwgdm0pIHsKICBpZiAoIWlzUGxhaW5PYmplY3QodmFsdWUpKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCIiICsgbmFtZSArICJcIjogZXhwZWN0ZWQgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIiArIHRvUmF3VHlwZSh2YWx1ZSkgKyAiLiIsIHZtKTsKICB9Cn0KLyoqCiAqIE1lcmdlIHR3byBvcHRpb24gb2JqZWN0cyBpbnRvIGEgbmV3IG9uZS4KICogQ29yZSB1dGlsaXR5IHVzZWQgaW4gYm90aCBpbnN0YW50aWF0aW9uIGFuZCBpbmhlcml0YW5jZS4KICovCgoKZnVuY3Rpb24gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQsIHZtKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNoZWNrQ29tcG9uZW50cyhjaGlsZCk7CiAgfQoKICBpZiAodHlwZW9mIGNoaWxkID09PSAnZnVuY3Rpb24nKSB7CiAgICBjaGlsZCA9IGNoaWxkLm9wdGlvbnM7CiAgfQoKICBub3JtYWxpemVQcm9wcyhjaGlsZCwgdm0pOwogIG5vcm1hbGl6ZUluamVjdChjaGlsZCwgdm0pOwogIG5vcm1hbGl6ZURpcmVjdGl2ZXMoY2hpbGQpOyAvLyBBcHBseSBleHRlbmRzIGFuZCBtaXhpbnMgb24gdGhlIGNoaWxkIG9wdGlvbnMsCiAgLy8gYnV0IG9ubHkgaWYgaXQgaXMgYSByYXcgb3B0aW9ucyBvYmplY3QgdGhhdCBpc24ndAogIC8vIHRoZSByZXN1bHQgb2YgYW5vdGhlciBtZXJnZU9wdGlvbnMgY2FsbC4KICAvLyBPbmx5IG1lcmdlZCBvcHRpb25zIGhhcyB0aGUgX2Jhc2UgcHJvcGVydHkuCgogIGlmICghY2hpbGQuX2Jhc2UpIHsKICAgIGlmIChjaGlsZFsiZXh0ZW5kcyJdKSB7CiAgICAgIHBhcmVudCA9IG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkWyJleHRlbmRzIl0sIHZtKTsKICAgIH0KCiAgICBpZiAoY2hpbGQubWl4aW5zKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hpbGQubWl4aW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHBhcmVudCA9IG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkLm1peGluc1tpXSwgdm0pOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgb3B0aW9ucyA9IHt9OwogIHZhciBrZXk7CgogIGZvciAoa2V5IGluIHBhcmVudCkgewogICAgbWVyZ2VGaWVsZChrZXkpOwogIH0KCiAgZm9yIChrZXkgaW4gY2hpbGQpIHsKICAgIGlmICghaGFzT3duKHBhcmVudCwga2V5KSkgewogICAgICBtZXJnZUZpZWxkKGtleSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBtZXJnZUZpZWxkKGtleSkgewogICAgdmFyIHN0cmF0ID0gc3RyYXRzW2tleV0gfHwgZGVmYXVsdFN0cmF0OwogICAgb3B0aW9uc1trZXldID0gc3RyYXQocGFyZW50W2tleV0sIGNoaWxkW2tleV0sIHZtLCBrZXkpOwogIH0KCiAgcmV0dXJuIG9wdGlvbnM7Cn0KLyoqCiAqIFJlc29sdmUgYW4gYXNzZXQuCiAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBiZWNhdXNlIGNoaWxkIGluc3RhbmNlcyBuZWVkIGFjY2VzcwogKiB0byBhc3NldHMgZGVmaW5lZCBpbiBpdHMgYW5jZXN0b3IgY2hhaW4uCiAqLwoKCmZ1bmN0aW9uIHJlc29sdmVBc3NldChvcHRpb25zLCB0eXBlLCBpZCwgd2Fybk1pc3NpbmcpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAodHlwZW9mIGlkICE9PSAnc3RyaW5nJykgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGFzc2V0cyA9IG9wdGlvbnNbdHlwZV07IC8vIGNoZWNrIGxvY2FsIHJlZ2lzdHJhdGlvbiB2YXJpYXRpb25zIGZpcnN0CgogIGlmIChoYXNPd24oYXNzZXRzLCBpZCkpIHsKICAgIHJldHVybiBhc3NldHNbaWRdOwogIH0KCiAgdmFyIGNhbWVsaXplZElkID0gY2FtZWxpemUoaWQpOwoKICBpZiAoaGFzT3duKGFzc2V0cywgY2FtZWxpemVkSWQpKSB7CiAgICByZXR1cm4gYXNzZXRzW2NhbWVsaXplZElkXTsKICB9CgogIHZhciBQYXNjYWxDYXNlSWQgPSBjYXBpdGFsaXplKGNhbWVsaXplZElkKTsKCiAgaWYgKGhhc093bihhc3NldHMsIFBhc2NhbENhc2VJZCkpIHsKICAgIHJldHVybiBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKICB9IC8vIGZhbGxiYWNrIHRvIHByb3RvdHlwZSBjaGFpbgoKCiAgdmFyIHJlcyA9IGFzc2V0c1tpZF0gfHwgYXNzZXRzW2NhbWVsaXplZElkXSB8fCBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2Fybk1pc3NpbmcgJiYgIXJlcykgewogICAgd2FybignRmFpbGVkIHRvIHJlc29sdmUgJyArIHR5cGUuc2xpY2UoMCwgLTEpICsgJzogJyArIGlkLCBvcHRpb25zKTsKICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKZnVuY3Rpb24gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSwgdm0pIHsKICB2YXIgcHJvcCA9IHByb3BPcHRpb25zW2tleV07CiAgdmFyIGFic2VudCA9ICFoYXNPd24ocHJvcHNEYXRhLCBrZXkpOwogIHZhciB2YWx1ZSA9IHByb3BzRGF0YVtrZXldOyAvLyBib29sZWFuIGNhc3RpbmcKCiAgdmFyIGJvb2xlYW5JbmRleCA9IGdldFR5cGVJbmRleChCb29sZWFuLCBwcm9wLnR5cGUpOwoKICBpZiAoYm9vbGVhbkluZGV4ID4gLTEpIHsKICAgIGlmIChhYnNlbnQgJiYgIWhhc093bihwcm9wLCAnZGVmYXVsdCcpKSB7CiAgICAgIHZhbHVlID0gZmFsc2U7CiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gaHlwaGVuYXRlKGtleSkpIHsKICAgICAgLy8gb25seSBjYXN0IGVtcHR5IHN0cmluZyAvIHNhbWUgbmFtZSB0byBib29sZWFuIGlmCiAgICAgIC8vIGJvb2xlYW4gaGFzIGhpZ2hlciBwcmlvcml0eQogICAgICB2YXIgc3RyaW5nSW5kZXggPSBnZXRUeXBlSW5kZXgoU3RyaW5nLCBwcm9wLnR5cGUpOwoKICAgICAgaWYgKHN0cmluZ0luZGV4IDwgMCB8fCBib29sZWFuSW5kZXggPCBzdHJpbmdJbmRleCkgewogICAgICAgIHZhbHVlID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH0gLy8gY2hlY2sgZGVmYXVsdCB2YWx1ZQoKCiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgIHZhbHVlID0gZ2V0UHJvcERlZmF1bHRWYWx1ZSh2bSwgcHJvcCwga2V5KTsgLy8gc2luY2UgdGhlIGRlZmF1bHQgdmFsdWUgaXMgYSBmcmVzaCBjb3B5LAogICAgLy8gbWFrZSBzdXJlIHRvIG9ic2VydmUgaXQuCgogICAgdmFyIHByZXZTaG91bGRPYnNlcnZlID0gc2hvdWxkT2JzZXJ2ZTsKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICAgIG9ic2VydmUodmFsdWUpOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHByZXZTaG91bGRPYnNlcnZlKTsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIC8vIHNraXAgdmFsaWRhdGlvbiBmb3Igd2VleCByZWN5Y2xlLWxpc3QgY2hpbGQgY29tcG9uZW50IHByb3BzCiAgIWZhbHNlKSB7CiAgICBhc3NlcnRQcm9wKHByb3AsIGtleSwgdmFsdWUsIHZtLCBhYnNlbnQpOwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9Ci8qKgogKiBHZXQgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYSBwcm9wLgogKi8KCgpmdW5jdGlvbiBnZXRQcm9wRGVmYXVsdFZhbHVlKHZtLCBwcm9wLCBrZXkpIHsKICAvLyBubyBkZWZhdWx0LCByZXR1cm4gdW5kZWZpbmVkCiAgaWYgKCFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgcmV0dXJuIHVuZGVmaW5lZDsKICB9CgogIHZhciBkZWYgPSBwcm9wWyJkZWZhdWx0Il07IC8vIHdhcm4gYWdhaW5zdCBub24tZmFjdG9yeSBkZWZhdWx0cyBmb3IgT2JqZWN0ICYgQXJyYXkKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNPYmplY3QoZGVmKSkgewogICAgd2FybignSW52YWxpZCBkZWZhdWx0IHZhbHVlIGZvciBwcm9wICInICsga2V5ICsgJyI6ICcgKyAnUHJvcHMgd2l0aCB0eXBlIE9iamVjdC9BcnJheSBtdXN0IHVzZSBhIGZhY3RvcnkgZnVuY3Rpb24gJyArICd0byByZXR1cm4gdGhlIGRlZmF1bHQgdmFsdWUuJywgdm0pOwogIH0gLy8gdGhlIHJhdyBwcm9wIHZhbHVlIHdhcyBhbHNvIHVuZGVmaW5lZCBmcm9tIHByZXZpb3VzIHJlbmRlciwKICAvLyByZXR1cm4gcHJldmlvdXMgZGVmYXVsdCB2YWx1ZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSB3YXRjaGVyIHRyaWdnZXIKCgogIGlmICh2bSAmJiB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgJiYgdm0uJG9wdGlvbnMucHJvcHNEYXRhW2tleV0gPT09IHVuZGVmaW5lZCAmJiB2bS5fcHJvcHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICByZXR1cm4gdm0uX3Byb3BzW2tleV07CiAgfSAvLyBjYWxsIGZhY3RvcnkgZnVuY3Rpb24gZm9yIG5vbi1GdW5jdGlvbiB0eXBlcwogIC8vIGEgdmFsdWUgaXMgRnVuY3Rpb24gaWYgaXRzIHByb3RvdHlwZSBpcyBmdW5jdGlvbiBldmVuIGFjcm9zcyBkaWZmZXJlbnQgZXhlY3V0aW9uIGNvbnRleHQKCgogIHJldHVybiB0eXBlb2YgZGVmID09PSAnZnVuY3Rpb24nICYmIGdldFR5cGUocHJvcC50eXBlKSAhPT0gJ0Z1bmN0aW9uJyA/IGRlZi5jYWxsKHZtKSA6IGRlZjsKfQovKioKICogQXNzZXJ0IHdoZXRoZXIgYSBwcm9wIGlzIHZhbGlkLgogKi8KCgpmdW5jdGlvbiBhc3NlcnRQcm9wKHByb3AsIG5hbWUsIHZhbHVlLCB2bSwgYWJzZW50KSB7CiAgaWYgKHByb3AucmVxdWlyZWQgJiYgYWJzZW50KSB7CiAgICB3YXJuKCdNaXNzaW5nIHJlcXVpcmVkIHByb3A6ICInICsgbmFtZSArICciJywgdm0pOwogICAgcmV0dXJuOwogIH0KCiAgaWYgKHZhbHVlID09IG51bGwgJiYgIXByb3AucmVxdWlyZWQpIHsKICAgIHJldHVybjsKICB9CgogIHZhciB0eXBlID0gcHJvcC50eXBlOwogIHZhciB2YWxpZCA9ICF0eXBlIHx8IHR5cGUgPT09IHRydWU7CiAgdmFyIGV4cGVjdGVkVHlwZXMgPSBbXTsKCiAgaWYgKHR5cGUpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheSh0eXBlKSkgewogICAgICB0eXBlID0gW3R5cGVdOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZS5sZW5ndGggJiYgIXZhbGlkOyBpKyspIHsKICAgICAgdmFyIGFzc2VydGVkVHlwZSA9IGFzc2VydFR5cGUodmFsdWUsIHR5cGVbaV0pOwogICAgICBleHBlY3RlZFR5cGVzLnB1c2goYXNzZXJ0ZWRUeXBlLmV4cGVjdGVkVHlwZSB8fCAnJyk7CiAgICAgIHZhbGlkID0gYXNzZXJ0ZWRUeXBlLnZhbGlkOwogICAgfQogIH0KCiAgaWYgKCF2YWxpZCkgewogICAgd2FybihnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpLCB2bSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdmFsaWRhdG9yID0gcHJvcC52YWxpZGF0b3I7CgogIGlmICh2YWxpZGF0b3IpIHsKICAgIGlmICghdmFsaWRhdG9yKHZhbHVlKSkgewogICAgICB3YXJuKCdJbnZhbGlkIHByb3A6IGN1c3RvbSB2YWxpZGF0b3IgY2hlY2sgZmFpbGVkIGZvciBwcm9wICInICsgbmFtZSArICciLicsIHZtKTsKICAgIH0KICB9Cn0KCnZhciBzaW1wbGVDaGVja1JFID0gL14oU3RyaW5nfE51bWJlcnxCb29sZWFufEZ1bmN0aW9ufFN5bWJvbCkkLzsKCmZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUpIHsKICB2YXIgdmFsaWQ7CiAgdmFyIGV4cGVjdGVkVHlwZSA9IGdldFR5cGUodHlwZSk7CgogIGlmIChzaW1wbGVDaGVja1JFLnRlc3QoZXhwZWN0ZWRUeXBlKSkgewogICAgdmFyIHQgPSBfdHlwZW9mKHZhbHVlKTsKCiAgICB2YWxpZCA9IHQgPT09IGV4cGVjdGVkVHlwZS50b0xvd2VyQ2FzZSgpOyAvLyBmb3IgcHJpbWl0aXZlIHdyYXBwZXIgb2JqZWN0cwoKICAgIGlmICghdmFsaWQgJiYgdCA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFsaWQgPSB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CiAgICB9CiAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdPYmplY3QnKSB7CiAgICB2YWxpZCA9IGlzUGxhaW5PYmplY3QodmFsdWUpOwogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnQXJyYXknKSB7CiAgICB2YWxpZCA9IEFycmF5LmlzQXJyYXkodmFsdWUpOwogIH0gZWxzZSB7CiAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICB9CgogIHJldHVybiB7CiAgICB2YWxpZDogdmFsaWQsCiAgICBleHBlY3RlZFR5cGU6IGV4cGVjdGVkVHlwZQogIH07Cn0KLyoqCiAqIFVzZSBmdW5jdGlvbiBzdHJpbmcgbmFtZSB0byBjaGVjayBidWlsdC1pbiB0eXBlcywKICogYmVjYXVzZSBhIHNpbXBsZSBlcXVhbGl0eSBjaGVjayB3aWxsIGZhaWwgd2hlbiBydW5uaW5nCiAqIGFjcm9zcyBkaWZmZXJlbnQgdm1zIC8gaWZyYW1lcy4KICovCgoKZnVuY3Rpb24gZ2V0VHlwZShmbikgewogIHZhciBtYXRjaCA9IGZuICYmIGZuLnRvU3RyaW5nKCkubWF0Y2goL15ccypmdW5jdGlvbiAoXHcrKS8pOwogIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7Cn0KCmZ1bmN0aW9uIGlzU2FtZVR5cGUoYSwgYikgewogIHJldHVybiBnZXRUeXBlKGEpID09PSBnZXRUeXBlKGIpOwp9CgpmdW5jdGlvbiBnZXRUeXBlSW5kZXgodHlwZSwgZXhwZWN0ZWRUeXBlcykgewogIGlmICghQXJyYXkuaXNBcnJheShleHBlY3RlZFR5cGVzKSkgewogICAgcmV0dXJuIGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlcywgdHlwZSkgPyAwIDogLTE7CiAgfQoKICBmb3IgKHZhciBpID0gMCwgbGVuID0gZXhwZWN0ZWRUeXBlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgaWYgKGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlc1tpXSwgdHlwZSkpIHsKICAgICAgcmV0dXJuIGk7CiAgICB9CiAgfQoKICByZXR1cm4gLTE7Cn0KCmZ1bmN0aW9uIGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcykgewogIHZhciBtZXNzYWdlID0gIkludmFsaWQgcHJvcDogdHlwZSBjaGVjayBmYWlsZWQgZm9yIHByb3AgXCIiICsgbmFtZSArICJcIi4iICsgIiBFeHBlY3RlZCAiICsgZXhwZWN0ZWRUeXBlcy5tYXAoY2FwaXRhbGl6ZSkuam9pbignLCAnKTsKICB2YXIgZXhwZWN0ZWRUeXBlID0gZXhwZWN0ZWRUeXBlc1swXTsKICB2YXIgcmVjZWl2ZWRUeXBlID0gdG9SYXdUeXBlKHZhbHVlKTsKICB2YXIgZXhwZWN0ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSk7CiAgdmFyIHJlY2VpdmVkVmFsdWUgPSBzdHlsZVZhbHVlKHZhbHVlLCByZWNlaXZlZFR5cGUpOyAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgZXhwZWN0ZWQgdmFsdWUKCiAgaWYgKGV4cGVjdGVkVHlwZXMubGVuZ3RoID09PSAxICYmIGlzRXhwbGljYWJsZShleHBlY3RlZFR5cGUpICYmICFpc0Jvb2xlYW4oZXhwZWN0ZWRUeXBlLCByZWNlaXZlZFR5cGUpKSB7CiAgICBtZXNzYWdlICs9ICIgd2l0aCB2YWx1ZSAiICsgZXhwZWN0ZWRWYWx1ZTsKICB9CgogIG1lc3NhZ2UgKz0gIiwgZ290ICIgKyByZWNlaXZlZFR5cGUgKyAiICI7IC8vIGNoZWNrIGlmIHdlIG5lZWQgdG8gc3BlY2lmeSByZWNlaXZlZCB2YWx1ZQoKICBpZiAoaXNFeHBsaWNhYmxlKHJlY2VpdmVkVHlwZSkpIHsKICAgIG1lc3NhZ2UgKz0gIndpdGggdmFsdWUgIiArIHJlY2VpdmVkVmFsdWUgKyAiLiI7CiAgfQoKICByZXR1cm4gbWVzc2FnZTsKfQoKZnVuY3Rpb24gc3R5bGVWYWx1ZSh2YWx1ZSwgdHlwZSkgewogIGlmICh0eXBlID09PSAnU3RyaW5nJykgewogICAgcmV0dXJuICJcIiIgKyB2YWx1ZSArICJcIiI7CiAgfSBlbHNlIGlmICh0eXBlID09PSAnTnVtYmVyJykgewogICAgcmV0dXJuICIiICsgTnVtYmVyKHZhbHVlKTsKICB9IGVsc2UgewogICAgcmV0dXJuICIiICsgdmFsdWU7CiAgfQp9CgpmdW5jdGlvbiBpc0V4cGxpY2FibGUodmFsdWUpIHsKICB2YXIgZXhwbGljaXRUeXBlcyA9IFsnc3RyaW5nJywgJ251bWJlcicsICdib29sZWFuJ107CiAgcmV0dXJuIGV4cGxpY2l0VHlwZXMuc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIHZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IGVsZW07CiAgfSk7Cn0KCmZ1bmN0aW9uIGlzQm9vbGVhbigpIHsKICB2YXIgYXJncyA9IFtdLAogICAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwoKICB3aGlsZSAobGVuLS0pIHsKICAgIGFyZ3NbbGVuXSA9IGFyZ3VtZW50c1tsZW5dOwogIH0KCiAgcmV0dXJuIGFyZ3Muc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGVsZW0udG9Mb3dlckNhc2UoKSA9PT0gJ2Jvb2xlYW4nOwogIH0pOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pIHsKICAvLyBEZWFjdGl2YXRlIGRlcHMgdHJhY2tpbmcgd2hpbGUgcHJvY2Vzc2luZyBlcnJvciBoYW5kbGVyIHRvIGF2b2lkIHBvc3NpYmxlIGluZmluaXRlIHJlbmRlcmluZy4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWV4L2lzc3Vlcy8xNTA1CiAgcHVzaFRhcmdldCgpOwoKICB0cnkgewogICAgaWYgKHZtKSB7CiAgICAgIHZhciBjdXIgPSB2bTsKCiAgICAgIHdoaWxlIChjdXIgPSBjdXIuJHBhcmVudCkgewogICAgICAgIHZhciBob29rcyA9IGN1ci4kb3B0aW9ucy5lcnJvckNhcHR1cmVkOwoKICAgICAgICBpZiAoaG9va3MpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZSA9IGhvb2tzW2ldLmNhbGwoY3VyLCBlcnIsIHZtLCBpbmZvKSA9PT0gZmFsc2U7CgogICAgICAgICAgICAgIGlmIChjYXB0dXJlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgZ2xvYmFsSGFuZGxlRXJyb3IoZSwgY3VyLCAnZXJyb3JDYXB0dXJlZCBob29rJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBnbG9iYWxIYW5kbGVFcnJvcihlcnIsIHZtLCBpbmZvKTsKICB9IGZpbmFsbHkgewogICAgcG9wVGFyZ2V0KCk7CiAgfQp9CgpmdW5jdGlvbiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhoYW5kbGVyLCBjb250ZXh0LCBhcmdzLCB2bSwgaW5mbykgewogIHZhciByZXM7CgogIHRyeSB7CiAgICByZXMgPSBhcmdzID8gaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKSA6IGhhbmRsZXIuY2FsbChjb250ZXh0KTsKCiAgICBpZiAocmVzICYmICFyZXMuX2lzVnVlICYmIGlzUHJvbWlzZShyZXMpICYmICFyZXMuX2hhbmRsZWQpIHsKICAgICAgcmVzWyJjYXRjaCJdKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZUVycm9yKGUsIHZtLCBpbmZvICsgIiAoUHJvbWlzZS9hc3luYykiKTsKICAgICAgfSk7IC8vIGlzc3VlICM5NTExCiAgICAgIC8vIGF2b2lkIGNhdGNoIHRyaWdnZXJpbmcgbXVsdGlwbGUgdGltZXMgd2hlbiBuZXN0ZWQgY2FsbHMKCiAgICAgIHJlcy5faGFuZGxlZCA9IHRydWU7CiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8pOwogIH0KCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gZ2xvYmFsSGFuZGxlRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIGlmIChjb25maWcuZXJyb3JIYW5kbGVyKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gY29uZmlnLmVycm9ySGFuZGxlci5jYWxsKG51bGwsIGVyciwgdm0sIGluZm8pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAvLyBpZiB0aGUgdXNlciBpbnRlbnRpb25hbGx5IHRocm93cyB0aGUgb3JpZ2luYWwgZXJyb3IgaW4gdGhlIGhhbmRsZXIsCiAgICAgIC8vIGRvIG5vdCBsb2cgaXQgdHdpY2UKICAgICAgaWYgKGUgIT09IGVycikgewogICAgICAgIGxvZ0Vycm9yKGUsIG51bGwsICdjb25maWcuZXJyb3JIYW5kbGVyJyk7CiAgICAgIH0KICAgIH0KICB9CgogIGxvZ0Vycm9yKGVyciwgdm0sIGluZm8pOwp9CgpmdW5jdGlvbiBsb2dFcnJvcihlcnIsIHZtLCBpbmZvKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkVycm9yIGluICIgKyBpbmZvICsgIjogXCIiICsgZXJyLnRvU3RyaW5nKCkgKyAiXCIiLCB2bSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoKGluQnJvd3NlciB8fCBpbldlZXgpICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgY29uc29sZS5lcnJvcihlcnIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9Ci8qICAqLwoKCnZhciBpc1VzaW5nTWljcm9UYXNrID0gZmFsc2U7CnZhciBjYWxsYmFja3MgPSBbXTsKdmFyIHBlbmRpbmcgPSBmYWxzZTsKCmZ1bmN0aW9uIGZsdXNoQ2FsbGJhY2tzKCkgewogIHBlbmRpbmcgPSBmYWxzZTsKICB2YXIgY29waWVzID0gY2FsbGJhY2tzLnNsaWNlKDApOwogIGNhbGxiYWNrcy5sZW5ndGggPSAwOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvcGllcy5sZW5ndGg7IGkrKykgewogICAgY29waWVzW2ldKCk7CiAgfQp9IC8vIEhlcmUgd2UgaGF2ZSBhc3luYyBkZWZlcnJpbmcgd3JhcHBlcnMgdXNpbmcgbWljcm90YXNrcy4KLy8gSW4gMi41IHdlIHVzZWQgKG1hY3JvKSB0YXNrcyAoaW4gY29tYmluYXRpb24gd2l0aCBtaWNyb3Rhc2tzKS4KLy8gSG93ZXZlciwgaXQgaGFzIHN1YnRsZSBwcm9ibGVtcyB3aGVuIHN0YXRlIGlzIGNoYW5nZWQgcmlnaHQgYmVmb3JlIHJlcGFpbnQKLy8gKGUuZy4gIzY4MTMsIG91dC1pbiB0cmFuc2l0aW9ucykuCi8vIEFsc28sIHVzaW5nIChtYWNybykgdGFza3MgaW4gZXZlbnQgaGFuZGxlciB3b3VsZCBjYXVzZSBzb21lIHdlaXJkIGJlaGF2aW9ycwovLyB0aGF0IGNhbm5vdCBiZSBjaXJjdW12ZW50ZWQgKGUuZy4gIzcxMDksICM3MTUzLCAjNzU0NiwgIzc4MzQsICM4MTA5KS4KLy8gU28gd2Ugbm93IHVzZSBtaWNyb3Rhc2tzIGV2ZXJ5d2hlcmUsIGFnYWluLgovLyBBIG1ham9yIGRyYXdiYWNrIG9mIHRoaXMgdHJhZGVvZmYgaXMgdGhhdCB0aGVyZSBhcmUgc29tZSBzY2VuYXJpb3MKLy8gd2hlcmUgbWljcm90YXNrcyBoYXZlIHRvbyBoaWdoIGEgcHJpb3JpdHkgYW5kIGZpcmUgaW4gYmV0d2VlbiBzdXBwb3NlZGx5Ci8vIHNlcXVlbnRpYWwgZXZlbnRzIChlLmcuICM0NTIxLCAjNjY5MCwgd2hpY2ggaGF2ZSB3b3JrYXJvdW5kcykKLy8gb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lIGV2ZW50ICgjNjU2NikuCgoKdmFyIHRpbWVyRnVuYzsgLy8gVGhlIG5leHRUaWNrIGJlaGF2aW9yIGxldmVyYWdlcyB0aGUgbWljcm90YXNrIHF1ZXVlLCB3aGljaCBjYW4gYmUgYWNjZXNzZWQKLy8gdmlhIGVpdGhlciBuYXRpdmUgUHJvbWlzZS50aGVuIG9yIE11dGF0aW9uT2JzZXJ2ZXIuCi8vIE11dGF0aW9uT2JzZXJ2ZXIgaGFzIHdpZGVyIHN1cHBvcnQsIGhvd2V2ZXIgaXQgaXMgc2VyaW91c2x5IGJ1Z2dlZCBpbgovLyBVSVdlYlZpZXcgaW4gaU9TID49IDkuMy4zIHdoZW4gdHJpZ2dlcmVkIGluIHRvdWNoIGV2ZW50IGhhbmRsZXJzLiBJdAovLyBjb21wbGV0ZWx5IHN0b3BzIHdvcmtpbmcgYWZ0ZXIgdHJpZ2dlcmluZyBhIGZldyB0aW1lcy4uLiBzbywgaWYgbmF0aXZlCi8vIFByb21pc2UgaXMgYXZhaWxhYmxlLCB3ZSB3aWxsIHVzZSBpdDoKCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0LCAkZmxvdy1kaXNhYmxlLWxpbmUgKi8KCmlmICh0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJvbWlzZSkpIHsKICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSgpOwoKICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBwLnRoZW4oZmx1c2hDYWxsYmFja3MpOyAvLyBJbiBwcm9ibGVtYXRpYyBVSVdlYlZpZXdzLCBQcm9taXNlLnRoZW4gZG9lc24ndCBjb21wbGV0ZWx5IGJyZWFrLCBidXQKICAgIC8vIGl0IGNhbiBnZXQgc3R1Y2sgaW4gYSB3ZWlyZCBzdGF0ZSB3aGVyZSBjYWxsYmFja3MgYXJlIHB1c2hlZCBpbnRvIHRoZQogICAgLy8gbWljcm90YXNrIHF1ZXVlIGJ1dCB0aGUgcXVldWUgaXNuJ3QgYmVpbmcgZmx1c2hlZCwgdW50aWwgdGhlIGJyb3dzZXIKICAgIC8vIG5lZWRzIHRvIGRvIHNvbWUgb3RoZXIgd29yaywgZS5nLiBoYW5kbGUgYSB0aW1lci4gVGhlcmVmb3JlIHdlIGNhbgogICAgLy8gImZvcmNlIiB0aGUgbWljcm90YXNrIHF1ZXVlIHRvIGJlIGZsdXNoZWQgYnkgYWRkaW5nIGFuIGVtcHR5IHRpbWVyLgoKICAgIGlmIChpc0lPUykgewogICAgICBzZXRUaW1lb3V0KG5vb3ApOwogICAgfQogIH07CgogIGlzVXNpbmdNaWNyb1Rhc2sgPSB0cnVlOwp9IGVsc2UgaWYgKCFpc0lFICYmIHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyICE9PSAndW5kZWZpbmVkJyAmJiAoaXNOYXRpdmUoTXV0YXRpb25PYnNlcnZlcikgfHwgLy8gUGhhbnRvbUpTIGFuZCBpT1MgNy54Ck11dGF0aW9uT2JzZXJ2ZXIudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgTXV0YXRpb25PYnNlcnZlckNvbnN0cnVjdG9yXScpKSB7CiAgLy8gVXNlIE11dGF0aW9uT2JzZXJ2ZXIgd2hlcmUgbmF0aXZlIFByb21pc2UgaXMgbm90IGF2YWlsYWJsZSwKICAvLyBlLmcuIFBoYW50b21KUywgaU9TNywgQW5kcm9pZCA0LjQKICAvLyAoIzY0NjYgTXV0YXRpb25PYnNlcnZlciBpcyB1bnJlbGlhYmxlIGluIElFMTEpCiAgdmFyIGNvdW50ZXIgPSAxOwogIHZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZsdXNoQ2FsbGJhY2tzKTsKICB2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShTdHJpbmcoY291bnRlcikpOwogIG9ic2VydmVyLm9ic2VydmUodGV4dE5vZGUsIHsKICAgIGNoYXJhY3RlckRhdGE6IHRydWUKICB9KTsKCiAgdGltZXJGdW5jID0gZnVuY3Rpb24gdGltZXJGdW5jKCkgewogICAgY291bnRlciA9IChjb3VudGVyICsgMSkgJSAyOwogICAgdGV4dE5vZGUuZGF0YSA9IFN0cmluZyhjb3VudGVyKTsKICB9OwoKICBpc1VzaW5nTWljcm9UYXNrID0gdHJ1ZTsKfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShzZXRJbW1lZGlhdGUpKSB7CiAgLy8gRmFsbGJhY2sgdG8gc2V0SW1tZWRpYXRlLgogIC8vIFRlY2huaWNhbGx5IGl0IGxldmVyYWdlcyB0aGUgKG1hY3JvKSB0YXNrIHF1ZXVlLAogIC8vIGJ1dCBpdCBpcyBzdGlsbCBhIGJldHRlciBjaG9pY2UgdGhhbiBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHNldEltbWVkaWF0ZShmbHVzaENhbGxiYWNrcyk7CiAgfTsKfSBlbHNlIHsKICAvLyBGYWxsYmFjayB0byBzZXRUaW1lb3V0LgogIHRpbWVyRnVuYyA9IGZ1bmN0aW9uIHRpbWVyRnVuYygpIHsKICAgIHNldFRpbWVvdXQoZmx1c2hDYWxsYmFja3MsIDApOwogIH07Cn0KCmZ1bmN0aW9uIG5leHRUaWNrKGNiLCBjdHgpIHsKICB2YXIgX3Jlc29sdmU7CgogIGNhbGxiYWNrcy5wdXNoKGZ1bmN0aW9uICgpIHsKICAgIGlmIChjYikgewogICAgICB0cnkgewogICAgICAgIGNiLmNhbGwoY3R4KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGhhbmRsZUVycm9yKGUsIGN0eCwgJ25leHRUaWNrJyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoX3Jlc29sdmUpIHsKICAgICAgX3Jlc29sdmUoY3R4KTsKICAgIH0KICB9KTsKCiAgaWYgKCFwZW5kaW5nKSB7CiAgICBwZW5kaW5nID0gdHJ1ZTsKICAgIHRpbWVyRnVuYygpOwogIH0gLy8gJGZsb3ctZGlzYWJsZS1saW5lCgoKICBpZiAoIWNiICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgIF9yZXNvbHZlID0gcmVzb2x2ZTsKICAgIH0pOwogIH0KfQovKiAgKi8KCi8qIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aCBQcm94eSAqLwoKCnZhciBpbml0UHJveHk7CgppZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogIHZhciBhbGxvd2VkR2xvYmFscyA9IG1ha2VNYXAoJ0luZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4sJyArICdwYXJzZUZsb2F0LHBhcnNlSW50LGRlY29kZVVSSSxkZWNvZGVVUklDb21wb25lbnQsZW5jb2RlVVJJLGVuY29kZVVSSUNvbXBvbmVudCwnICsgJ01hdGgsTnVtYmVyLERhdGUsQXJyYXksT2JqZWN0LEJvb2xlYW4sU3RyaW5nLFJlZ0V4cCxNYXAsU2V0LEpTT04sSW50bCwnICsgJ3JlcXVpcmUnIC8vIGZvciBXZWJwYWNrL0Jyb3dzZXJpZnkKICApOwoKICB2YXIgd2Fybk5vblByZXNlbnQgPSBmdW5jdGlvbiB3YXJuTm9uUHJlc2VudCh0YXJnZXQsIGtleSkgewogICAgd2FybigiUHJvcGVydHkgb3IgbWV0aG9kIFwiIiArIGtleSArICJcIiBpcyBub3QgZGVmaW5lZCBvbiB0aGUgaW5zdGFuY2UgYnV0ICIgKyAncmVmZXJlbmNlZCBkdXJpbmcgcmVuZGVyLiBNYWtlIHN1cmUgdGhhdCB0aGlzIHByb3BlcnR5IGlzIHJlYWN0aXZlLCAnICsgJ2VpdGhlciBpbiB0aGUgZGF0YSBvcHRpb24sIG9yIGZvciBjbGFzcy1iYXNlZCBjb21wb25lbnRzLCBieSAnICsgJ2luaXRpYWxpemluZyB0aGUgcHJvcGVydHkuICcgKyAnU2VlOiBodHRwczovL3Z1ZWpzLm9yZy92Mi9ndWlkZS9yZWFjdGl2aXR5Lmh0bWwjRGVjbGFyaW5nLVJlYWN0aXZlLVByb3BlcnRpZXMuJywgdGFyZ2V0KTsKICB9OwoKICB2YXIgd2FyblJlc2VydmVkUHJlZml4ID0gZnVuY3Rpb24gd2FyblJlc2VydmVkUHJlZml4KHRhcmdldCwga2V5KSB7CiAgICB3YXJuKCJQcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgbXVzdCBiZSBhY2Nlc3NlZCB3aXRoIFwiJGRhdGEuIiArIGtleSArICJcIiBiZWNhdXNlICIgKyAncHJvcGVydGllcyBzdGFydGluZyB3aXRoICIkIiBvciAiXyIgYXJlIG5vdCBwcm94aWVkIGluIHRoZSBWdWUgaW5zdGFuY2UgdG8gJyArICdwcmV2ZW50IGNvbmZsaWN0cyB3aXRoIFZ1ZSBpbnRlcm5hbHMuICcgKyAnU2VlOiBodHRwczovL3Z1ZWpzLm9yZy92Mi9hcGkvI2RhdGEnLCB0YXJnZXQpOwogIH07CgogIHZhciBoYXNQcm94eSA9IHR5cGVvZiBQcm94eSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJveHkpOwoKICBpZiAoaGFzUHJveHkpIHsKICAgIHZhciBpc0J1aWx0SW5Nb2RpZmllciA9IG1ha2VNYXAoJ3N0b3AscHJldmVudCxzZWxmLGN0cmwsc2hpZnQsYWx0LG1ldGEsZXhhY3QnKTsKICAgIGNvbmZpZy5rZXlDb2RlcyA9IG5ldyBQcm94eShjb25maWcua2V5Q29kZXMsIHsKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodGFyZ2V0LCBrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGlzQnVpbHRJbk1vZGlmaWVyKGtleSkpIHsKICAgICAgICAgIHdhcm4oIkF2b2lkIG92ZXJ3cml0aW5nIGJ1aWx0LWluIG1vZGlmaWVyIGluIGNvbmZpZy5rZXlDb2RlczogLiIgKyBrZXkpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0YXJnZXRba2V5XSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIHZhciBoYXNIYW5kbGVyID0gewogICAgaGFzOiBmdW5jdGlvbiBoYXModGFyZ2V0LCBrZXkpIHsKICAgICAgdmFyIGhhcyA9IChrZXkgaW4gdGFyZ2V0KTsKICAgICAgdmFyIGlzQWxsb3dlZCA9IGFsbG93ZWRHbG9iYWxzKGtleSkgfHwgdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJ18nICYmICEoa2V5IGluIHRhcmdldC4kZGF0YSk7CgogICAgICBpZiAoIWhhcyAmJiAhaXNBbGxvd2VkKSB7CiAgICAgICAgaWYgKGtleSBpbiB0YXJnZXQuJGRhdGEpIHsKICAgICAgICAgIHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm5Ob25QcmVzZW50KHRhcmdldCwga2V5KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBoYXMgfHwgIWlzQWxsb3dlZDsKICAgIH0KICB9OwogIHZhciBnZXRIYW5kbGVyID0gewogICAgZ2V0OiBmdW5jdGlvbiBnZXQodGFyZ2V0LCBrZXkpIHsKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmICEoa2V5IGluIHRhcmdldCkpIHsKICAgICAgICBpZiAoa2V5IGluIHRhcmdldC4kZGF0YSkgewogICAgICAgICAgd2FyblJlc2VydmVkUHJlZml4KHRhcmdldCwga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2Fybk5vblByZXNlbnQodGFyZ2V0LCBrZXkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldFtrZXldOwogICAgfQogIH07CgogIGluaXRQcm94eSA9IGZ1bmN0aW9uIGluaXRQcm94eSh2bSkgewogICAgaWYgKGhhc1Byb3h5KSB7CiAgICAgIC8vIGRldGVybWluZSB3aGljaCBwcm94eSBoYW5kbGVyIHRvIHVzZQogICAgICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogICAgICB2YXIgaGFuZGxlcnMgPSBvcHRpb25zLnJlbmRlciAmJiBvcHRpb25zLnJlbmRlci5fd2l0aFN0cmlwcGVkID8gZ2V0SGFuZGxlciA6IGhhc0hhbmRsZXI7CiAgICAgIHZtLl9yZW5kZXJQcm94eSA9IG5ldyBQcm94eSh2bSwgaGFuZGxlcnMpOwogICAgfSBlbHNlIHsKICAgICAgdm0uX3JlbmRlclByb3h5ID0gdm07CiAgICB9CiAgfTsKfQovKiAgKi8KCgp2YXIgc2Vlbk9iamVjdHMgPSBuZXcgX1NldCgpOwovKioKICogUmVjdXJzaXZlbHkgdHJhdmVyc2UgYW4gb2JqZWN0IHRvIGV2b2tlIGFsbCBjb252ZXJ0ZWQKICogZ2V0dGVycywgc28gdGhhdCBldmVyeSBuZXN0ZWQgcHJvcGVydHkgaW5zaWRlIHRoZSBvYmplY3QKICogaXMgY29sbGVjdGVkIGFzIGEgImRlZXAiIGRlcGVuZGVuY3kuCiAqLwoKZnVuY3Rpb24gdHJhdmVyc2UodmFsKSB7CiAgX3RyYXZlcnNlKHZhbCwgc2Vlbk9iamVjdHMpOwoKICBzZWVuT2JqZWN0cy5jbGVhcigpOwp9CgpmdW5jdGlvbiBfdHJhdmVyc2UodmFsLCBzZWVuKSB7CiAgdmFyIGksIGtleXM7CiAgdmFyIGlzQSA9IEFycmF5LmlzQXJyYXkodmFsKTsKCiAgaWYgKCFpc0EgJiYgIWlzT2JqZWN0KHZhbCkgfHwgT2JqZWN0LmlzRnJvemVuKHZhbCkgfHwgdmFsIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybjsKICB9CgogIGlmICh2YWwuX19vYl9fKSB7CiAgICB2YXIgZGVwSWQgPSB2YWwuX19vYl9fLmRlcC5pZDsKCiAgICBpZiAoc2Vlbi5oYXMoZGVwSWQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBzZWVuLmFkZChkZXBJZCk7CiAgfQoKICBpZiAoaXNBKSB7CiAgICBpID0gdmFsLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIF90cmF2ZXJzZSh2YWxbaV0sIHNlZW4pOwogICAgfQogIH0gZWxzZSB7CiAgICBrZXlzID0gT2JqZWN0LmtleXModmFsKTsKICAgIGkgPSBrZXlzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIF90cmF2ZXJzZSh2YWxba2V5c1tpXV0sIHNlZW4pOwogICAgfQogIH0KfQoKdmFyIG1hcms7CnZhciBtZWFzdXJlOwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgcGVyZiA9IGluQnJvd3NlciAmJiB3aW5kb3cucGVyZm9ybWFuY2U7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChwZXJmICYmIHBlcmYubWFyayAmJiBwZXJmLm1lYXN1cmUgJiYgcGVyZi5jbGVhck1hcmtzICYmIHBlcmYuY2xlYXJNZWFzdXJlcykgewogICAgbWFyayA9IGZ1bmN0aW9uIG1hcmsodGFnKSB7CiAgICAgIHJldHVybiBwZXJmLm1hcmsodGFnKTsKICAgIH07CgogICAgbWVhc3VyZSA9IGZ1bmN0aW9uIG1lYXN1cmUobmFtZSwgc3RhcnRUYWcsIGVuZFRhZykgewogICAgICBwZXJmLm1lYXN1cmUobmFtZSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIHBlcmYuY2xlYXJNYXJrcyhzdGFydFRhZyk7CiAgICAgIHBlcmYuY2xlYXJNYXJrcyhlbmRUYWcpOyAvLyBwZXJmLmNsZWFyTWVhc3VyZXMobmFtZSkKICAgIH07CiAgfQp9Ci8qICAqLwoKCnZhciBub3JtYWxpemVFdmVudCA9IGNhY2hlZChmdW5jdGlvbiAobmFtZSkgewogIHZhciBwYXNzaXZlID0gbmFtZS5jaGFyQXQoMCkgPT09ICcmJzsKICBuYW1lID0gcGFzc2l2ZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHZhciBvbmNlJCQxID0gbmFtZS5jaGFyQXQoMCkgPT09ICd+JzsgLy8gUHJlZml4ZWQgbGFzdCwgY2hlY2tlZCBmaXJzdAoKICBuYW1lID0gb25jZSQkMSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHZhciBjYXB0dXJlID0gbmFtZS5jaGFyQXQoMCkgPT09ICchJzsKICBuYW1lID0gY2FwdHVyZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHJldHVybiB7CiAgICBuYW1lOiBuYW1lLAogICAgb25jZTogb25jZSQkMSwKICAgIGNhcHR1cmU6IGNhcHR1cmUsCiAgICBwYXNzaXZlOiBwYXNzaXZlCiAgfTsKfSk7CgpmdW5jdGlvbiBjcmVhdGVGbkludm9rZXIoZm5zLCB2bSkgewogIGZ1bmN0aW9uIGludm9rZXIoKSB7CiAgICB2YXIgYXJndW1lbnRzJDEgPSBhcmd1bWVudHM7CiAgICB2YXIgZm5zID0gaW52b2tlci5mbnM7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZm5zKSkgewogICAgICB2YXIgY2xvbmVkID0gZm5zLnNsaWNlKCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsb25lZC5sZW5ndGg7IGkrKykgewogICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNsb25lZFtpXSwgbnVsbCwgYXJndW1lbnRzJDEsIHZtLCAidi1vbiBoYW5kbGVyIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIHJldHVybiBoYW5kbGVyIHJldHVybiB2YWx1ZSBmb3Igc2luZ2xlIGhhbmRsZXJzCiAgICAgIHJldHVybiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhmbnMsIG51bGwsIGFyZ3VtZW50cywgdm0sICJ2LW9uIGhhbmRsZXIiKTsKICAgIH0KICB9CgogIGludm9rZXIuZm5zID0gZm5zOwogIHJldHVybiBpbnZva2VyOwp9CgpmdW5jdGlvbiB1cGRhdGVMaXN0ZW5lcnMob24sIG9sZE9uLCBhZGQsIHJlbW92ZSQkMSwgY3JlYXRlT25jZUhhbmRsZXIsIHZtKSB7CiAgdmFyIG5hbWUsIGRlZiQkMSwgY3VyLCBvbGQsIGV2ZW50OwoKICBmb3IgKG5hbWUgaW4gb24pIHsKICAgIGRlZiQkMSA9IGN1ciA9IG9uW25hbWVdOwogICAgb2xkID0gb2xkT25bbmFtZV07CiAgICBldmVudCA9IG5vcm1hbGl6ZUV2ZW50KG5hbWUpOwoKICAgIGlmIChpc1VuZGVmKGN1cikpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJJbnZhbGlkIGhhbmRsZXIgZm9yIGV2ZW50IFwiIiArIGV2ZW50Lm5hbWUgKyAiXCI6IGdvdCAiICsgU3RyaW5nKGN1ciksIHZtKTsKICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGQpKSB7CiAgICAgIGlmIChpc1VuZGVmKGN1ci5mbnMpKSB7CiAgICAgICAgY3VyID0gb25bbmFtZV0gPSBjcmVhdGVGbkludm9rZXIoY3VyLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChpc1RydWUoZXZlbnQub25jZSkpIHsKICAgICAgICBjdXIgPSBvbltuYW1lXSA9IGNyZWF0ZU9uY2VIYW5kbGVyKGV2ZW50Lm5hbWUsIGN1ciwgZXZlbnQuY2FwdHVyZSk7CiAgICAgIH0KCiAgICAgIGFkZChldmVudC5uYW1lLCBjdXIsIGV2ZW50LmNhcHR1cmUsIGV2ZW50LnBhc3NpdmUsIGV2ZW50LnBhcmFtcyk7CiAgICB9IGVsc2UgaWYgKGN1ciAhPT0gb2xkKSB7CiAgICAgIG9sZC5mbnMgPSBjdXI7CiAgICAgIG9uW25hbWVdID0gb2xkOwogICAgfQogIH0KCiAgZm9yIChuYW1lIGluIG9sZE9uKSB7CiAgICBpZiAoaXNVbmRlZihvbltuYW1lXSkpIHsKICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgcmVtb3ZlJCQxKGV2ZW50Lm5hbWUsIG9sZE9uW25hbWVdLCBldmVudC5jYXB0dXJlKTsKICAgIH0KICB9Cn0KLyogICovCgoKZnVuY3Rpb24gbWVyZ2VWTm9kZUhvb2soZGVmLCBob29rS2V5LCBob29rKSB7CiAgaWYgKGRlZiBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICBkZWYgPSBkZWYuZGF0YS5ob29rIHx8IChkZWYuZGF0YS5ob29rID0ge30pOwogIH0KCiAgdmFyIGludm9rZXI7CiAgdmFyIG9sZEhvb2sgPSBkZWZbaG9va0tleV07CgogIGZ1bmN0aW9uIHdyYXBwZWRIb29rKCkgewogICAgaG9vay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyAvLyBpbXBvcnRhbnQ6IHJlbW92ZSBtZXJnZWQgaG9vayB0byBlbnN1cmUgaXQncyBjYWxsZWQgb25seSBvbmNlCiAgICAvLyBhbmQgcHJldmVudCBtZW1vcnkgbGVhawoKICAgIHJlbW92ZShpbnZva2VyLmZucywgd3JhcHBlZEhvb2spOwogIH0KCiAgaWYgKGlzVW5kZWYob2xkSG9vaykpIHsKICAgIC8vIG5vIGV4aXN0aW5nIGhvb2sKICAgIGludm9rZXIgPSBjcmVhdGVGbkludm9rZXIoW3dyYXBwZWRIb29rXSk7CiAgfSBlbHNlIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKG9sZEhvb2suZm5zKSAmJiBpc1RydWUob2xkSG9vay5tZXJnZWQpKSB7CiAgICAgIC8vIGFscmVhZHkgYSBtZXJnZWQgaW52b2tlcgogICAgICBpbnZva2VyID0gb2xkSG9vazsKICAgICAgaW52b2tlci5mbnMucHVzaCh3cmFwcGVkSG9vayk7CiAgICB9IGVsc2UgewogICAgICAvLyBleGlzdGluZyBwbGFpbiBob29rCiAgICAgIGludm9rZXIgPSBjcmVhdGVGbkludm9rZXIoW29sZEhvb2ssIHdyYXBwZWRIb29rXSk7CiAgICB9CiAgfQoKICBpbnZva2VyLm1lcmdlZCA9IHRydWU7CiAgZGVmW2hvb2tLZXldID0gaW52b2tlcjsKfQovKiAgKi8KCgpmdW5jdGlvbiBleHRyYWN0UHJvcHNGcm9tVk5vZGVEYXRhKGRhdGEsIEN0b3IsIHRhZykgewogIC8vIHdlIGFyZSBvbmx5IGV4dHJhY3RpbmcgcmF3IHZhbHVlcyBoZXJlLgogIC8vIHZhbGlkYXRpb24gYW5kIGRlZmF1bHQgdmFsdWVzIGFyZSBoYW5kbGVkIGluIHRoZSBjaGlsZAogIC8vIGNvbXBvbmVudCBpdHNlbGYuCiAgdmFyIHByb3BPcHRpb25zID0gQ3Rvci5vcHRpb25zLnByb3BzOwoKICBpZiAoaXNVbmRlZihwcm9wT3B0aW9ucykpIHsKICAgIHJldHVybjsKICB9CgogIHZhciByZXMgPSB7fTsKICB2YXIgYXR0cnMgPSBkYXRhLmF0dHJzOwogIHZhciBwcm9wcyA9IGRhdGEucHJvcHM7CgogIGlmIChpc0RlZihhdHRycykgfHwgaXNEZWYocHJvcHMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcE9wdGlvbnMpIHsKICAgICAgdmFyIGFsdEtleSA9IGh5cGhlbmF0ZShrZXkpOwoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB2YXIga2V5SW5Mb3dlckNhc2UgPSBrZXkudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgaWYgKGtleSAhPT0ga2V5SW5Mb3dlckNhc2UgJiYgYXR0cnMgJiYgaGFzT3duKGF0dHJzLCBrZXlJbkxvd2VyQ2FzZSkpIHsKICAgICAgICAgIHRpcCgiUHJvcCBcIiIgKyBrZXlJbkxvd2VyQ2FzZSArICJcIiBpcyBwYXNzZWQgdG8gY29tcG9uZW50ICIgKyBmb3JtYXRDb21wb25lbnROYW1lKHRhZyB8fCBDdG9yKSArICIsIGJ1dCB0aGUgZGVjbGFyZWQgcHJvcCBuYW1lIGlzIiArICIgXCIiICsga2V5ICsgIlwiLiAiICsgIk5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIGNhbWVsQ2FzZWQgIiArICJwcm9wcyBuZWVkIHRvIHVzZSB0aGVpciBrZWJhYi1jYXNlIGVxdWl2YWxlbnRzIHdoZW4gdXNpbmcgaW4tRE9NICIgKyAidGVtcGxhdGVzLiBZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIgKyBhbHRLZXkgKyAiXCIgaW5zdGVhZCBvZiBcIiIgKyBrZXkgKyAiXCIuIik7CiAgICAgICAgfQogICAgICB9CgogICAgICBjaGVja1Byb3AocmVzLCBwcm9wcywga2V5LCBhbHRLZXksIHRydWUpIHx8IGNoZWNrUHJvcChyZXMsIGF0dHJzLCBrZXksIGFsdEtleSwgZmFsc2UpOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gY2hlY2tQcm9wKHJlcywgaGFzaCwga2V5LCBhbHRLZXksIHByZXNlcnZlKSB7CiAgaWYgKGlzRGVmKGhhc2gpKSB7CiAgICBpZiAoaGFzT3duKGhhc2gsIGtleSkpIHsKICAgICAgcmVzW2tleV0gPSBoYXNoW2tleV07CgogICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKGhhc093bihoYXNoLCBhbHRLZXkpKSB7CiAgICAgIHJlc1trZXldID0gaGFzaFthbHRLZXldOwoKICAgICAgaWYgKCFwcmVzZXJ2ZSkgewogICAgICAgIGRlbGV0ZSBoYXNoW2FsdEtleV07CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KCiAgcmV0dXJuIGZhbHNlOwp9Ci8qICAqLwovLyBUaGUgdGVtcGxhdGUgY29tcGlsZXIgYXR0ZW1wdHMgdG8gbWluaW1pemUgdGhlIG5lZWQgZm9yIG5vcm1hbGl6YXRpb24gYnkKLy8gc3RhdGljYWxseSBhbmFseXppbmcgdGhlIHRlbXBsYXRlIGF0IGNvbXBpbGUgdGltZS4KLy8KLy8gRm9yIHBsYWluIEhUTUwgbWFya3VwLCBub3JtYWxpemF0aW9uIGNhbiBiZSBjb21wbGV0ZWx5IHNraXBwZWQgYmVjYXVzZSB0aGUKLy8gZ2VuZXJhdGVkIHJlbmRlciBmdW5jdGlvbiBpcyBndWFyYW50ZWVkIHRvIHJldHVybiBBcnJheTxWTm9kZT4uIFRoZXJlIGFyZQovLyB0d28gY2FzZXMgd2hlcmUgZXh0cmEgbm9ybWFsaXphdGlvbiBpcyBuZWVkZWQ6Ci8vIDEuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbXBvbmVudHMgLSBiZWNhdXNlIGEgZnVuY3Rpb25hbCBjb21wb25lbnQKLy8gbWF5IHJldHVybiBhbiBBcnJheSBpbnN0ZWFkIG9mIGEgc2luZ2xlIHJvb3QuIEluIHRoaXMgY2FzZSwganVzdCBhIHNpbXBsZQovLyBub3JtYWxpemF0aW9uIGlzIG5lZWRlZCAtIGlmIGFueSBjaGlsZCBpcyBhbiBBcnJheSwgd2UgZmxhdHRlbiB0aGUgd2hvbGUKLy8gdGhpbmcgd2l0aCBBcnJheS5wcm90b3R5cGUuY29uY2F0LiBJdCBpcyBndWFyYW50ZWVkIHRvIGJlIG9ubHkgMS1sZXZlbCBkZWVwCi8vIGJlY2F1c2UgZnVuY3Rpb25hbCBjb21wb25lbnRzIGFscmVhZHkgbm9ybWFsaXplIHRoZWlyIG93biBjaGlsZHJlbi4KCgpmdW5jdGlvbiBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuW2ldKSkgewogICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSwgY2hpbGRyZW4pOwogICAgfQogIH0KCiAgcmV0dXJuIGNoaWxkcmVuOwp9IC8vIDIuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbnN0cnVjdHMgdGhhdCBhbHdheXMgZ2VuZXJhdGVkIG5lc3RlZCBBcnJheXMsCi8vIGUuZy4gPHRlbXBsYXRlPiwgPHNsb3Q+LCB2LWZvciwgb3Igd2hlbiB0aGUgY2hpbGRyZW4gaXMgcHJvdmlkZWQgYnkgdXNlcgovLyB3aXRoIGhhbmQtd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zIC8gSlNYLiBJbiBzdWNoIGNhc2VzIGEgZnVsbCBub3JtYWxpemF0aW9uCi8vIGlzIG5lZWRlZCB0byBjYXRlciB0byBhbGwgcG9zc2libGUgdHlwZXMgb2YgY2hpbGRyZW4gdmFsdWVzLgoKCmZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKSB7CiAgcmV0dXJuIGlzUHJpbWl0aXZlKGNoaWxkcmVuKSA/IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXSA6IEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbikgOiB1bmRlZmluZWQ7Cn0KCmZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogIHJldHVybiBpc0RlZihub2RlKSAmJiBpc0RlZihub2RlLnRleHQpICYmIGlzRmFsc2Uobm9kZS5pc0NvbW1lbnQpOwp9CgpmdW5jdGlvbiBub3JtYWxpemVBcnJheUNoaWxkcmVuKGNoaWxkcmVuLCBuZXN0ZWRJbmRleCkgewogIHZhciByZXMgPSBbXTsKICB2YXIgaSwgYywgbGFzdEluZGV4LCBsYXN0OwoKICBmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGMgPSBjaGlsZHJlbltpXTsKCiAgICBpZiAoaXNVbmRlZihjKSB8fCB0eXBlb2YgYyA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGxhc3RJbmRleCA9IHJlcy5sZW5ndGggLSAxOwogICAgbGFzdCA9IHJlc1tsYXN0SW5kZXhdOyAvLyAgbmVzdGVkCgogICAgaWYgKEFycmF5LmlzQXJyYXkoYykpIHsKICAgICAgaWYgKGMubGVuZ3RoID4gMCkgewogICAgICAgIGMgPSBub3JtYWxpemVBcnJheUNoaWxkcmVuKGMsIChuZXN0ZWRJbmRleCB8fCAnJykgKyAiXyIgKyBpKTsgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwoKICAgICAgICBpZiAoaXNUZXh0Tm9kZShjWzBdKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgICByZXNbbGFzdEluZGV4XSA9IGNyZWF0ZVRleHRWTm9kZShsYXN0LnRleHQgKyBjWzBdLnRleHQpOwogICAgICAgICAgYy5zaGlmdCgpOwogICAgICAgIH0KCiAgICAgICAgcmVzLnB1c2guYXBwbHkocmVzLCBjKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZShjKSkgewogICAgICBpZiAoaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgIC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMKICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgU1NSIGh5ZHJhdGlvbiBiZWNhdXNlIHRleHQgbm9kZXMgYXJlCiAgICAgICAgLy8gZXNzZW50aWFsbHkgbWVyZ2VkIHdoZW4gcmVuZGVyZWQgdG8gSFRNTCBzdHJpbmdzCiAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgYyk7CiAgICAgIH0gZWxzZSBpZiAoYyAhPT0gJycpIHsKICAgICAgICAvLyBjb252ZXJ0IHByaW1pdGl2ZSB0byB2bm9kZQogICAgICAgIHJlcy5wdXNoKGNyZWF0ZVRleHRWTm9kZShjKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChpc1RleHROb2RlKGMpICYmIGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgYy50ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkZWZhdWx0IGtleSBmb3IgbmVzdGVkIGFycmF5IGNoaWxkcmVuIChsaWtlbHkgZ2VuZXJhdGVkIGJ5IHYtZm9yKQogICAgICAgIGlmIChpc1RydWUoY2hpbGRyZW4uX2lzVkxpc3QpICYmIGlzRGVmKGMudGFnKSAmJiBpc1VuZGVmKGMua2V5KSAmJiBpc0RlZihuZXN0ZWRJbmRleCkpIHsKICAgICAgICAgIGMua2V5ID0gIl9fdmxpc3QiICsgbmVzdGVkSW5kZXggKyAiXyIgKyBpICsgIl9fIjsKICAgICAgICB9CgogICAgICAgIHJlcy5wdXNoKGMpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRQcm92aWRlKHZtKSB7CiAgdmFyIHByb3ZpZGUgPSB2bS4kb3B0aW9ucy5wcm92aWRlOwoKICBpZiAocHJvdmlkZSkgewogICAgdm0uX3Byb3ZpZGVkID0gdHlwZW9mIHByb3ZpZGUgPT09ICdmdW5jdGlvbicgPyBwcm92aWRlLmNhbGwodm0pIDogcHJvdmlkZTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRJbmplY3Rpb25zKHZtKSB7CiAgdmFyIHJlc3VsdCA9IHJlc29sdmVJbmplY3Qodm0uJG9wdGlvbnMuaW5qZWN0LCB2bSk7CgogIGlmIChyZXN1bHQpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCBrZXksIHJlc3VsdFtrZXldLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBtdXRhdGluZyBhbiBpbmplY3RlZCB2YWx1ZSBkaXJlY3RseSBzaW5jZSB0aGUgY2hhbmdlcyB3aWxsIGJlICIgKyAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHByb3ZpZGVkIGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsgImluamVjdGlvbiBiZWluZyBtdXRhdGVkOiBcIiIgKyBrZXkgKyAiXCIiLCB2bSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sIGtleSwgcmVzdWx0W2tleV0pOwogICAgICB9CiAgICB9KTsKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVJbmplY3QoaW5qZWN0LCB2bSkgewogIGlmIChpbmplY3QpIHsKICAgIC8vIGluamVjdCBpcyA6YW55IGJlY2F1c2UgZmxvdyBpcyBub3Qgc21hcnQgZW5vdWdoIHRvIGZpZ3VyZSBvdXQgY2FjaGVkCiAgICB2YXIgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBrZXlzID0gaGFzU3ltYm9sID8gUmVmbGVjdC5vd25LZXlzKGluamVjdCkgOiBPYmplY3Qua2V5cyhpbmplY3QpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsgLy8gIzY1NzQgaW4gY2FzZSB0aGUgaW5qZWN0IG9iamVjdCBpcyBvYnNlcnZlZC4uLgoKICAgICAgaWYgKGtleSA9PT0gJ19fb2JfXycpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIHByb3ZpZGVLZXkgPSBpbmplY3Rba2V5XS5mcm9tOwogICAgICB2YXIgc291cmNlID0gdm07CgogICAgICB3aGlsZSAoc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZS5fcHJvdmlkZWQgJiYgaGFzT3duKHNvdXJjZS5fcHJvdmlkZWQsIHByb3ZpZGVLZXkpKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHNvdXJjZS5fcHJvdmlkZWRbcHJvdmlkZUtleV07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHNvdXJjZSA9IHNvdXJjZS4kcGFyZW50OwogICAgICB9CgogICAgICBpZiAoIXNvdXJjZSkgewogICAgICAgIGlmICgnZGVmYXVsdCcgaW4gaW5qZWN0W2tleV0pIHsKICAgICAgICAgIHZhciBwcm92aWRlRGVmYXVsdCA9IGluamVjdFtrZXldWyJkZWZhdWx0Il07CiAgICAgICAgICByZXN1bHRba2V5XSA9IHR5cGVvZiBwcm92aWRlRGVmYXVsdCA9PT0gJ2Z1bmN0aW9uJyA/IHByb3ZpZGVEZWZhdWx0LmNhbGwodm0pIDogcHJvdmlkZURlZmF1bHQ7CiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB3YXJuKCJJbmplY3Rpb24gXCIiICsga2V5ICsgIlwiIG5vdCBmb3VuZCIsIHZtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIHJhdyBjaGlsZHJlbiBWTm9kZXMgaW50byBhIHNsb3Qgb2JqZWN0LgogKi8KCgpmdW5jdGlvbiByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIGNvbnRleHQpIHsKICBpZiAoIWNoaWxkcmVuIHx8ICFjaGlsZHJlbi5sZW5ndGgpIHsKICAgIHJldHVybiB7fTsKICB9CgogIHZhciBzbG90cyA9IHt9OwoKICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICB2YXIgZGF0YSA9IGNoaWxkLmRhdGE7IC8vIHJlbW92ZSBzbG90IGF0dHJpYnV0ZSBpZiB0aGUgbm9kZSBpcyByZXNvbHZlZCBhcyBhIFZ1ZSBzbG90IG5vZGUKCiAgICBpZiAoZGF0YSAmJiBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMuc2xvdCkgewogICAgICBkZWxldGUgZGF0YS5hdHRycy5zbG90OwogICAgfSAvLyBuYW1lZCBzbG90cyBzaG91bGQgb25seSBiZSByZXNwZWN0ZWQgaWYgdGhlIHZub2RlIHdhcyByZW5kZXJlZCBpbiB0aGUKICAgIC8vIHNhbWUgY29udGV4dC4KCgogICAgaWYgKChjaGlsZC5jb250ZXh0ID09PSBjb250ZXh0IHx8IGNoaWxkLmZuQ29udGV4dCA9PT0gY29udGV4dCkgJiYgZGF0YSAmJiBkYXRhLnNsb3QgIT0gbnVsbCkgewogICAgICB2YXIgbmFtZSA9IGRhdGEuc2xvdDsKICAgICAgdmFyIHNsb3QgPSBzbG90c1tuYW1lXSB8fCAoc2xvdHNbbmFtZV0gPSBbXSk7CgogICAgICBpZiAoY2hpbGQudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgc2xvdC5wdXNoLmFwcGx5KHNsb3QsIGNoaWxkLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzbG90LnB1c2goY2hpbGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAoc2xvdHNbImRlZmF1bHQiXSB8fCAoc2xvdHNbImRlZmF1bHQiXSA9IFtdKSkucHVzaChjaGlsZCk7CiAgICB9CiAgfSAvLyBpZ25vcmUgc2xvdHMgdGhhdCBjb250YWlucyBvbmx5IHdoaXRlc3BhY2UKCgogIGZvciAodmFyIG5hbWUkMSBpbiBzbG90cykgewogICAgaWYgKHNsb3RzW25hbWUkMV0uZXZlcnkoaXNXaGl0ZXNwYWNlKSkgewogICAgICBkZWxldGUgc2xvdHNbbmFtZSQxXTsKICAgIH0KICB9CgogIHJldHVybiBzbG90czsKfQoKZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKG5vZGUpIHsKICByZXR1cm4gbm9kZS5pc0NvbW1lbnQgJiYgIW5vZGUuYXN5bmNGYWN0b3J5IHx8IG5vZGUudGV4dCA9PT0gJyAnOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKHNsb3RzLCBub3JtYWxTbG90cywgcHJldlNsb3RzKSB7CiAgdmFyIHJlczsKICB2YXIgaGFzTm9ybWFsU2xvdHMgPSBPYmplY3Qua2V5cyhub3JtYWxTbG90cykubGVuZ3RoID4gMDsKICB2YXIgaXNTdGFibGUgPSBzbG90cyA/ICEhc2xvdHMuJHN0YWJsZSA6ICFoYXNOb3JtYWxTbG90czsKICB2YXIga2V5ID0gc2xvdHMgJiYgc2xvdHMuJGtleTsKCiAgaWYgKCFzbG90cykgewogICAgcmVzID0ge307CiAgfSBlbHNlIGlmIChzbG90cy5fbm9ybWFsaXplZCkgewogICAgLy8gZmFzdCBwYXRoIDE6IGNoaWxkIGNvbXBvbmVudCByZS1yZW5kZXIgb25seSwgcGFyZW50IGRpZCBub3QgY2hhbmdlCiAgICByZXR1cm4gc2xvdHMuX25vcm1hbGl6ZWQ7CiAgfSBlbHNlIGlmIChpc1N0YWJsZSAmJiBwcmV2U2xvdHMgJiYgcHJldlNsb3RzICE9PSBlbXB0eU9iamVjdCAmJiBrZXkgPT09IHByZXZTbG90cy4ka2V5ICYmICFoYXNOb3JtYWxTbG90cyAmJiAhcHJldlNsb3RzLiRoYXNOb3JtYWwpIHsKICAgIC8vIGZhc3QgcGF0aCAyOiBzdGFibGUgc2NvcGVkIHNsb3RzIHcvIG5vIG5vcm1hbCBzbG90cyB0byBwcm94eSwKICAgIC8vIG9ubHkgbmVlZCB0byBub3JtYWxpemUgb25jZQogICAgcmV0dXJuIHByZXZTbG90czsKICB9IGVsc2UgewogICAgcmVzID0ge307CgogICAgZm9yICh2YXIga2V5JDEgaW4gc2xvdHMpIHsKICAgICAgaWYgKHNsb3RzW2tleSQxXSAmJiBrZXkkMVswXSAhPT0gJyQnKSB7CiAgICAgICAgcmVzW2tleSQxXSA9IG5vcm1hbGl6ZVNjb3BlZFNsb3Qobm9ybWFsU2xvdHMsIGtleSQxLCBzbG90c1trZXkkMV0pOwogICAgICB9CiAgICB9CiAgfSAvLyBleHBvc2Ugbm9ybWFsIHNsb3RzIG9uIHNjb3BlZFNsb3RzCgoKICBmb3IgKHZhciBrZXkkMiBpbiBub3JtYWxTbG90cykgewogICAgaWYgKCEoa2V5JDIgaW4gcmVzKSkgewogICAgICByZXNba2V5JDJdID0gcHJveHlOb3JtYWxTbG90KG5vcm1hbFNsb3RzLCBrZXkkMik7CiAgICB9CiAgfSAvLyBhdm9yaWF6IHNlZW1zIHRvIG1vY2sgYSBub24tZXh0ZW5zaWJsZSAkc2NvcGVkU2xvdHMgb2JqZWN0CiAgLy8gYW5kIHdoZW4gdGhhdCBpcyBwYXNzZWQgZG93biB0aGlzIHdvdWxkIGNhdXNlIGFuIGVycm9yCgoKICBpZiAoc2xvdHMgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZShzbG90cykpIHsKICAgIHNsb3RzLl9ub3JtYWxpemVkID0gcmVzOwogIH0KCiAgZGVmKHJlcywgJyRzdGFibGUnLCBpc1N0YWJsZSk7CiAgZGVmKHJlcywgJyRrZXknLCBrZXkpOwogIGRlZihyZXMsICckaGFzTm9ybWFsJywgaGFzTm9ybWFsU2xvdHMpOwogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3Qobm9ybWFsU2xvdHMsIGtleSwgZm4pIHsKICB2YXIgbm9ybWFsaXplZCA9IGZ1bmN0aW9uIG5vcm1hbGl6ZWQoKSB7CiAgICB2YXIgcmVzID0gYXJndW1lbnRzLmxlbmd0aCA/IGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cykgOiBmbih7fSk7CiAgICByZXMgPSByZXMgJiYgX3R5cGVvZihyZXMpID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShyZXMpID8gW3Jlc10gLy8gc2luZ2xlIHZub2RlCiAgICA6IG5vcm1hbGl6ZUNoaWxkcmVuKHJlcyk7CiAgICByZXR1cm4gcmVzICYmIChyZXMubGVuZ3RoID09PSAwIHx8IHJlcy5sZW5ndGggPT09IDEgJiYgcmVzWzBdLmlzQ29tbWVudCAvLyAjOTY1OAogICAgKSA/IHVuZGVmaW5lZCA6IHJlczsKICB9OyAvLyB0aGlzIGlzIGEgc2xvdCB1c2luZyB0aGUgbmV3IHYtc2xvdCBzeW50YXggd2l0aG91dCBzY29wZS4gYWx0aG91Z2ggaXQgaXMKICAvLyBjb21waWxlZCBhcyBhIHNjb3BlZCBzbG90LCByZW5kZXIgZm4gdXNlcnMgd291bGQgZXhwZWN0IGl0IHRvIGJlIHByZXNlbnQKICAvLyBvbiB0aGlzLiRzbG90cyBiZWNhdXNlIHRoZSB1c2FnZSBpcyBzZW1hbnRpY2FsbHkgYSBub3JtYWwgc2xvdC4KCgogIGlmIChmbi5wcm94eSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vcm1hbFNsb3RzLCBrZXksIHsKICAgICAgZ2V0OiBub3JtYWxpemVkLAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogIH0KCiAgcmV0dXJuIG5vcm1hbGl6ZWQ7Cn0KCmZ1bmN0aW9uIHByb3h5Tm9ybWFsU2xvdChzbG90cywga2V5KSB7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBzbG90c1trZXldOwogIH07Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyB2LWZvciBsaXN0cy4KICovCgoKZnVuY3Rpb24gcmVuZGVyTGlzdCh2YWwsIHJlbmRlcikgewogIHZhciByZXQsIGksIGwsIGtleXMsIGtleTsKCiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSB8fCB0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgcmV0ID0gbmV3IEFycmF5KHZhbC5sZW5ndGgpOwoKICAgIGZvciAoaSA9IDAsIGwgPSB2YWwubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHJldFtpXSA9IHJlbmRlcih2YWxbaV0sIGkpOwogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgIHJldCA9IG5ldyBBcnJheSh2YWwpOwoKICAgIGZvciAoaSA9IDA7IGkgPCB2YWw7IGkrKykgewogICAgICByZXRbaV0gPSByZW5kZXIoaSArIDEsIGkpOwogICAgfQogIH0gZWxzZSBpZiAoaXNPYmplY3QodmFsKSkgewogICAgaWYgKGhhc1N5bWJvbCAmJiB2YWxbU3ltYm9sLml0ZXJhdG9yXSkgewogICAgICByZXQgPSBbXTsKICAgICAgdmFyIGl0ZXJhdG9yID0gdmFsW1N5bWJvbC5pdGVyYXRvcl0oKTsKICAgICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKCiAgICAgIHdoaWxlICghcmVzdWx0LmRvbmUpIHsKICAgICAgICByZXQucHVzaChyZW5kZXIocmVzdWx0LnZhbHVlLCByZXQubGVuZ3RoKSk7CiAgICAgICAgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBrZXlzID0gT2JqZWN0LmtleXModmFsKTsKICAgICAgcmV0ID0gbmV3IEFycmF5KGtleXMubGVuZ3RoKTsKCiAgICAgIGZvciAoaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgcmV0W2ldID0gcmVuZGVyKHZhbFtrZXldLCBrZXksIGkpOwogICAgICB9CiAgICB9CiAgfQoKICBpZiAoIWlzRGVmKHJldCkpIHsKICAgIHJldCA9IFtdOwogIH0KCiAgcmV0Ll9pc1ZMaXN0ID0gdHJ1ZTsKICByZXR1cm4gcmV0Owp9Ci8qICAqLwoKLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZW5kZXJpbmcgPHNsb3Q+CiAqLwoKCmZ1bmN0aW9uIHJlbmRlclNsb3QobmFtZSwgZmFsbGJhY2ssIHByb3BzLCBiaW5kT2JqZWN0KSB7CiAgdmFyIHNjb3BlZFNsb3RGbiA9IHRoaXMuJHNjb3BlZFNsb3RzW25hbWVdOwogIHZhciBub2RlczsKCiAgaWYgKHNjb3BlZFNsb3RGbikgewogICAgLy8gc2NvcGVkIHNsb3QKICAgIHByb3BzID0gcHJvcHMgfHwge307CgogICAgaWYgKGJpbmRPYmplY3QpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWlzT2JqZWN0KGJpbmRPYmplY3QpKSB7CiAgICAgICAgd2Fybignc2xvdCB2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCcsIHRoaXMpOwogICAgICB9CgogICAgICBwcm9wcyA9IGV4dGVuZChleHRlbmQoe30sIGJpbmRPYmplY3QpLCBwcm9wcyk7CiAgICB9CgogICAgbm9kZXMgPSBzY29wZWRTbG90Rm4ocHJvcHMpIHx8IGZhbGxiYWNrOwogIH0gZWxzZSB7CiAgICBub2RlcyA9IHRoaXMuJHNsb3RzW25hbWVdIHx8IGZhbGxiYWNrOwogIH0KCiAgdmFyIHRhcmdldCA9IHByb3BzICYmIHByb3BzLnNsb3Q7CgogIGlmICh0YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScsIHsKICAgICAgc2xvdDogdGFyZ2V0CiAgICB9LCBub2Rlcyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBub2RlczsKICB9Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlc29sdmluZyBmaWx0ZXJzCiAqLwoKCmZ1bmN0aW9uIHJlc29sdmVGaWx0ZXIoaWQpIHsKICByZXR1cm4gcmVzb2x2ZUFzc2V0KHRoaXMuJG9wdGlvbnMsICdmaWx0ZXJzJywgaWQsIHRydWUpIHx8IGlkZW50aXR5Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGlzS2V5Tm90TWF0Y2goZXhwZWN0LCBhY3R1YWwpIHsKICBpZiAoQXJyYXkuaXNBcnJheShleHBlY3QpKSB7CiAgICByZXR1cm4gZXhwZWN0LmluZGV4T2YoYWN0dWFsKSA9PT0gLTE7CiAgfSBlbHNlIHsKICAgIHJldHVybiBleHBlY3QgIT09IGFjdHVhbDsKICB9Cn0KLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciBjaGVja2luZyBrZXlDb2RlcyBmcm9tIGNvbmZpZy4KICogZXhwb3NlZCBhcyBWdWUucHJvdG90eXBlLl9rCiAqIHBhc3NpbmcgaW4gZXZlbnRLZXlOYW1lIGFzIGxhc3QgYXJndW1lbnQgc2VwYXJhdGVseSBmb3IgYmFja3dhcmRzIGNvbXBhdAogKi8KCgpmdW5jdGlvbiBjaGVja0tleUNvZGVzKGV2ZW50S2V5Q29kZSwga2V5LCBidWlsdEluS2V5Q29kZSwgZXZlbnRLZXlOYW1lLCBidWlsdEluS2V5TmFtZSkgewogIHZhciBtYXBwZWRLZXlDb2RlID0gY29uZmlnLmtleUNvZGVzW2tleV0gfHwgYnVpbHRJbktleUNvZGU7CgogIGlmIChidWlsdEluS2V5TmFtZSAmJiBldmVudEtleU5hbWUgJiYgIWNvbmZpZy5rZXlDb2Rlc1trZXldKSB7CiAgICByZXR1cm4gaXNLZXlOb3RNYXRjaChidWlsdEluS2V5TmFtZSwgZXZlbnRLZXlOYW1lKTsKICB9IGVsc2UgaWYgKG1hcHBlZEtleUNvZGUpIHsKICAgIHJldHVybiBpc0tleU5vdE1hdGNoKG1hcHBlZEtleUNvZGUsIGV2ZW50S2V5Q29kZSk7CiAgfSBlbHNlIGlmIChldmVudEtleU5hbWUpIHsKICAgIHJldHVybiBoeXBoZW5hdGUoZXZlbnRLZXlOYW1lKSAhPT0ga2V5OwogIH0KfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgbWVyZ2luZyB2LWJpbmQ9Im9iamVjdCIgaW50byBhIFZOb2RlJ3MgZGF0YS4KICovCgoKZnVuY3Rpb24gYmluZE9iamVjdFByb3BzKGRhdGEsIHRhZywgdmFsdWUsIGFzUHJvcCwgaXNTeW5jKSB7CiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ3YtYmluZCB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0IG9yIEFycmF5IHZhbHVlJywgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IHRvT2JqZWN0KHZhbHVlKTsKICAgICAgfQoKICAgICAgdmFyIGhhc2g7CgogICAgICB2YXIgbG9vcCA9IGZ1bmN0aW9uIGxvb3Aoa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ2NsYXNzJyB8fCBrZXkgPT09ICdzdHlsZScgfHwgaXNSZXNlcnZlZEF0dHJpYnV0ZShrZXkpKSB7CiAgICAgICAgICBoYXNoID0gZGF0YTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHR5cGUgPSBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMudHlwZTsKICAgICAgICAgIGhhc2ggPSBhc1Byb3AgfHwgY29uZmlnLm11c3RVc2VQcm9wKHRhZywgdHlwZSwga2V5KSA/IGRhdGEuZG9tUHJvcHMgfHwgKGRhdGEuZG9tUHJvcHMgPSB7fSkgOiBkYXRhLmF0dHJzIHx8IChkYXRhLmF0dHJzID0ge30pOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNhbWVsaXplZEtleSA9IGNhbWVsaXplKGtleSk7CiAgICAgICAgdmFyIGh5cGhlbmF0ZWRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKCiAgICAgICAgaWYgKCEoY2FtZWxpemVkS2V5IGluIGhhc2gpICYmICEoaHlwaGVuYXRlZEtleSBpbiBoYXNoKSkgewogICAgICAgICAgaGFzaFtrZXldID0gdmFsdWVba2V5XTsKCiAgICAgICAgICBpZiAoaXNTeW5jKSB7CiAgICAgICAgICAgIHZhciBvbiA9IGRhdGEub24gfHwgKGRhdGEub24gPSB7fSk7CgogICAgICAgICAgICBvblsidXBkYXRlOiIgKyBrZXldID0gZnVuY3Rpb24gKCRldmVudCkgewogICAgICAgICAgICAgIHZhbHVlW2tleV0gPSAkZXZlbnQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgbG9vcChrZXkpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gZGF0YTsKfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHN0YXRpYyB0cmVlcy4KICovCgoKZnVuY3Rpb24gcmVuZGVyU3RhdGljKGluZGV4LCBpc0luRm9yKSB7CiAgdmFyIGNhY2hlZCA9IHRoaXMuX3N0YXRpY1RyZWVzIHx8ICh0aGlzLl9zdGF0aWNUcmVlcyA9IFtdKTsKICB2YXIgdHJlZSA9IGNhY2hlZFtpbmRleF07IC8vIGlmIGhhcyBhbHJlYWR5LXJlbmRlcmVkIHN0YXRpYyB0cmVlIGFuZCBub3QgaW5zaWRlIHYtZm9yLAogIC8vIHdlIGNhbiByZXVzZSB0aGUgc2FtZSB0cmVlLgoKICBpZiAodHJlZSAmJiAhaXNJbkZvcikgewogICAgcmV0dXJuIHRyZWU7CiAgfSAvLyBvdGhlcndpc2UsIHJlbmRlciBhIGZyZXNoIHRyZWUuCgoKICB0cmVlID0gY2FjaGVkW2luZGV4XSA9IHRoaXMuJG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zW2luZGV4XS5jYWxsKHRoaXMuX3JlbmRlclByb3h5LCBudWxsLCB0aGlzIC8vIGZvciByZW5kZXIgZm5zIGdlbmVyYXRlZCBmb3IgZnVuY3Rpb25hbCBjb21wb25lbnQgdGVtcGxhdGVzCiAgKTsKICBtYXJrU3RhdGljKHRyZWUsICJfX3N0YXRpY19fIiArIGluZGV4LCBmYWxzZSk7CiAgcmV0dXJuIHRyZWU7Cn0KLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciB2LW9uY2UuCiAqIEVmZmVjdGl2ZWx5IGl0IG1lYW5zIG1hcmtpbmcgdGhlIG5vZGUgYXMgc3RhdGljIHdpdGggYSB1bmlxdWUga2V5LgogKi8KCgpmdW5jdGlvbiBtYXJrT25jZSh0cmVlLCBpbmRleCwga2V5KSB7CiAgbWFya1N0YXRpYyh0cmVlLCAiX19vbmNlX18iICsgaW5kZXggKyAoa2V5ID8gIl8iICsga2V5IDogIiIpLCB0cnVlKTsKICByZXR1cm4gdHJlZTsKfQoKZnVuY3Rpb24gbWFya1N0YXRpYyh0cmVlLCBrZXksIGlzT25jZSkgewogIGlmIChBcnJheS5pc0FycmF5KHRyZWUpKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyZWUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRyZWVbaV0gJiYgdHlwZW9mIHRyZWVbaV0gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgbWFya1N0YXRpY05vZGUodHJlZVtpXSwga2V5ICsgIl8iICsgaSwgaXNPbmNlKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBtYXJrU3RhdGljTm9kZSh0cmVlLCBrZXksIGlzT25jZSk7CiAgfQp9CgpmdW5jdGlvbiBtYXJrU3RhdGljTm9kZShub2RlLCBrZXksIGlzT25jZSkgewogIG5vZGUuaXNTdGF0aWMgPSB0cnVlOwogIG5vZGUua2V5ID0ga2V5OwogIG5vZGUuaXNPbmNlID0gaXNPbmNlOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGJpbmRPYmplY3RMaXN0ZW5lcnMoZGF0YSwgdmFsdWUpIHsKICBpZiAodmFsdWUpIHsKICAgIGlmICghaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCd2LW9uIHdpdGhvdXQgYXJndW1lbnQgZXhwZWN0cyBhbiBPYmplY3QgdmFsdWUnLCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBvbiA9IGRhdGEub24gPSBkYXRhLm9uID8gZXh0ZW5kKHt9LCBkYXRhLm9uKSA6IHt9OwoKICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgdmFyIGV4aXN0aW5nID0gb25ba2V5XTsKICAgICAgICB2YXIgb3VycyA9IHZhbHVlW2tleV07CiAgICAgICAgb25ba2V5XSA9IGV4aXN0aW5nID8gW10uY29uY2F0KGV4aXN0aW5nLCBvdXJzKSA6IG91cnM7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBkYXRhOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIHJlc29sdmVTY29wZWRTbG90cyhmbnMsIC8vIHNlZSBmbG93L3Zub2RlCnJlcywgLy8gdGhlIGZvbGxvd2luZyBhcmUgYWRkZWQgaW4gMi42Cmhhc0R5bmFtaWNLZXlzLCBjb250ZW50SGFzaEtleSkgewogIHJlcyA9IHJlcyB8fCB7CiAgICAkc3RhYmxlOiAhaGFzRHluYW1pY0tleXMKICB9OwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGZucy5sZW5ndGg7IGkrKykgewogICAgdmFyIHNsb3QgPSBmbnNbaV07CgogICAgaWYgKEFycmF5LmlzQXJyYXkoc2xvdCkpIHsKICAgICAgcmVzb2x2ZVNjb3BlZFNsb3RzKHNsb3QsIHJlcywgaGFzRHluYW1pY0tleXMpOwogICAgfSBlbHNlIGlmIChzbG90KSB7CiAgICAgIC8vIG1hcmtlciBmb3IgcmV2ZXJzZSBwcm94eWluZyB2LXNsb3Qgd2l0aG91dCBzY29wZSBvbiB0aGlzLiRzbG90cwogICAgICBpZiAoc2xvdC5wcm94eSkgewogICAgICAgIHNsb3QuZm4ucHJveHkgPSB0cnVlOwogICAgICB9CgogICAgICByZXNbc2xvdC5rZXldID0gc2xvdC5mbjsKICAgIH0KICB9CgogIGlmIChjb250ZW50SGFzaEtleSkgewogICAgcmVzLiRrZXkgPSBjb250ZW50SGFzaEtleTsKICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKZnVuY3Rpb24gYmluZER5bmFtaWNLZXlzKGJhc2VPYmosIHZhbHVlcykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICB2YXIga2V5ID0gdmFsdWVzW2ldOwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkpIHsKICAgICAgYmFzZU9ialt2YWx1ZXNbaV1dID0gdmFsdWVzW2kgKyAxXTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBrZXkgIT09ICcnICYmIGtleSAhPT0gbnVsbCkgewogICAgICAvLyBudWxsIGlzIGEgc3BlY2lhbCB2YWx1ZSBmb3IgZXhwbGljaXRseSByZW1vdmluZyBhIGJpbmRpbmcKICAgICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3IgZHluYW1pYyBkaXJlY3RpdmUgYXJndW1lbnQgKGV4cGVjdGVkIHN0cmluZyBvciBudWxsKTogIiArIGtleSwgdGhpcyk7CiAgICB9CiAgfQoKICByZXR1cm4gYmFzZU9iajsKfSAvLyBoZWxwZXIgdG8gZHluYW1pY2FsbHkgYXBwZW5kIG1vZGlmaWVyIHJ1bnRpbWUgbWFya2VycyB0byBldmVudCBuYW1lcy4KLy8gZW5zdXJlIG9ubHkgYXBwZW5kIHdoZW4gdmFsdWUgaXMgYWxyZWFkeSBzdHJpbmcsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGNhc3QKLy8gdG8gc3RyaW5nIGFuZCBjYXVzZSB0aGUgdHlwZSBjaGVjayB0byBtaXNzLgoKCmZ1bmN0aW9uIHByZXBlbmRNb2RpZmllcih2YWx1ZSwgc3ltYm9sKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBzeW1ib2wgKyB2YWx1ZSA6IHZhbHVlOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluc3RhbGxSZW5kZXJIZWxwZXJzKHRhcmdldCkgewogIHRhcmdldC5fbyA9IG1hcmtPbmNlOwogIHRhcmdldC5fbiA9IHRvTnVtYmVyOwogIHRhcmdldC5fcyA9IHRvU3RyaW5nOwogIHRhcmdldC5fbCA9IHJlbmRlckxpc3Q7CiAgdGFyZ2V0Ll90ID0gcmVuZGVyU2xvdDsKICB0YXJnZXQuX3EgPSBsb29zZUVxdWFsOwogIHRhcmdldC5faSA9IGxvb3NlSW5kZXhPZjsKICB0YXJnZXQuX20gPSByZW5kZXJTdGF0aWM7CiAgdGFyZ2V0Ll9mID0gcmVzb2x2ZUZpbHRlcjsKICB0YXJnZXQuX2sgPSBjaGVja0tleUNvZGVzOwogIHRhcmdldC5fYiA9IGJpbmRPYmplY3RQcm9wczsKICB0YXJnZXQuX3YgPSBjcmVhdGVUZXh0Vk5vZGU7CiAgdGFyZ2V0Ll9lID0gY3JlYXRlRW1wdHlWTm9kZTsKICB0YXJnZXQuX3UgPSByZXNvbHZlU2NvcGVkU2xvdHM7CiAgdGFyZ2V0Ll9nID0gYmluZE9iamVjdExpc3RlbmVyczsKICB0YXJnZXQuX2QgPSBiaW5kRHluYW1pY0tleXM7CiAgdGFyZ2V0Ll9wID0gcHJlcGVuZE1vZGlmaWVyOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0KGRhdGEsIHByb3BzLCBjaGlsZHJlbiwgcGFyZW50LCBDdG9yKSB7CiAgdmFyIHRoaXMkMSA9IHRoaXM7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7IC8vIGVuc3VyZSB0aGUgY3JlYXRlRWxlbWVudCBmdW5jdGlvbiBpbiBmdW5jdGlvbmFsIGNvbXBvbmVudHMKICAvLyBnZXRzIGEgdW5pcXVlIGNvbnRleHQgLSB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgY29ycmVjdCBuYW1lZCBzbG90IGNoZWNrCgogIHZhciBjb250ZXh0Vm07CgogIGlmIChoYXNPd24ocGFyZW50LCAnX3VpZCcpKSB7CiAgICBjb250ZXh0Vm0gPSBPYmplY3QuY3JlYXRlKHBhcmVudCk7IC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgIGNvbnRleHRWbS5fb3JpZ2luYWwgPSBwYXJlbnQ7CiAgfSBlbHNlIHsKICAgIC8vIHRoZSBjb250ZXh0IHZtIHBhc3NlZCBpbiBpcyBhIGZ1bmN0aW9uYWwgY29udGV4dCBhcyB3ZWxsLgogICAgLy8gaW4gdGhpcyBjYXNlIHdlIHdhbnQgdG8gbWFrZSBzdXJlIHdlIGFyZSBhYmxlIHRvIGdldCBhIGhvbGQgdG8gdGhlCiAgICAvLyByZWFsIGNvbnRleHQgaW5zdGFuY2UuCiAgICBjb250ZXh0Vm0gPSBwYXJlbnQ7IC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgIHBhcmVudCA9IHBhcmVudC5fb3JpZ2luYWw7CiAgfQoKICB2YXIgaXNDb21waWxlZCA9IGlzVHJ1ZShvcHRpb25zLl9jb21waWxlZCk7CiAgdmFyIG5lZWROb3JtYWxpemF0aW9uID0gIWlzQ29tcGlsZWQ7CiAgdGhpcy5kYXRhID0gZGF0YTsKICB0aGlzLnByb3BzID0gcHJvcHM7CiAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogIHRoaXMucGFyZW50ID0gcGFyZW50OwogIHRoaXMubGlzdGVuZXJzID0gZGF0YS5vbiB8fCBlbXB0eU9iamVjdDsKICB0aGlzLmluamVjdGlvbnMgPSByZXNvbHZlSW5qZWN0KG9wdGlvbnMuaW5qZWN0LCBwYXJlbnQpOwoKICB0aGlzLnNsb3RzID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzJDEuJHNsb3RzKSB7CiAgICAgIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMkMS4kc2xvdHMgPSByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIHBhcmVudCkpOwogICAgfQoKICAgIHJldHVybiB0aGlzJDEuJHNsb3RzOwogIH07CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnc2NvcGVkU2xvdHMnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBub3JtYWxpemVTY29wZWRTbG90cyhkYXRhLnNjb3BlZFNsb3RzLCB0aGlzLnNsb3RzKCkpOwogICAgfQogIH0pOyAvLyBzdXBwb3J0IGZvciBjb21waWxlZCBmdW5jdGlvbmFsIHRlbXBsYXRlCgogIGlmIChpc0NvbXBpbGVkKSB7CiAgICAvLyBleHBvc2luZyAkb3B0aW9ucyBmb3IgcmVuZGVyU3RhdGljKCkKICAgIHRoaXMuJG9wdGlvbnMgPSBvcHRpb25zOyAvLyBwcmUtcmVzb2x2ZSBzbG90cyBmb3IgcmVuZGVyU2xvdCgpCgogICAgdGhpcy4kc2xvdHMgPSB0aGlzLnNsb3RzKCk7CiAgICB0aGlzLiRzY29wZWRTbG90cyA9IG5vcm1hbGl6ZVNjb3BlZFNsb3RzKGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMuJHNsb3RzKTsKICB9CgogIGlmIChvcHRpb25zLl9zY29wZUlkKSB7CiAgICB0aGlzLl9jID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgICAgdmFyIHZub2RlID0gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKCiAgICAgIGlmICh2bm9kZSAmJiAhQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgICAgICB2bm9kZS5mblNjb3BlSWQgPSBvcHRpb25zLl9zY29wZUlkOwogICAgICAgIHZub2RlLmZuQ29udGV4dCA9IHBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuIHZub2RlOwogICAgfTsKICB9IGVsc2UgewogICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgIHJldHVybiBjcmVhdGVFbGVtZW50KGNvbnRleHRWbSwgYSwgYiwgYywgZCwgbmVlZE5vcm1hbGl6YXRpb24pOwogICAgfTsKICB9Cn0KCmluc3RhbGxSZW5kZXJIZWxwZXJzKEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0LnByb3RvdHlwZSk7CgpmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbmFsQ29tcG9uZW50KEN0b3IsIHByb3BzRGF0YSwgZGF0YSwgY29udGV4dFZtLCBjaGlsZHJlbikgewogIHZhciBvcHRpb25zID0gQ3Rvci5vcHRpb25zOwogIHZhciBwcm9wcyA9IHt9OwogIHZhciBwcm9wT3B0aW9ucyA9IG9wdGlvbnMucHJvcHM7CgogIGlmIChpc0RlZihwcm9wT3B0aW9ucykpIHsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICBwcm9wc1trZXldID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSB8fCBlbXB0eU9iamVjdCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChpc0RlZihkYXRhLmF0dHJzKSkgewogICAgICBtZXJnZVByb3BzKHByb3BzLCBkYXRhLmF0dHJzKTsKICAgIH0KCiAgICBpZiAoaXNEZWYoZGF0YS5wcm9wcykpIHsKICAgICAgbWVyZ2VQcm9wcyhwcm9wcywgZGF0YS5wcm9wcyk7CiAgICB9CiAgfQoKICB2YXIgcmVuZGVyQ29udGV4dCA9IG5ldyBGdW5jdGlvbmFsUmVuZGVyQ29udGV4dChkYXRhLCBwcm9wcywgY2hpbGRyZW4sIGNvbnRleHRWbSwgQ3Rvcik7CiAgdmFyIHZub2RlID0gb3B0aW9ucy5yZW5kZXIuY2FsbChudWxsLCByZW5kZXJDb250ZXh0Ll9jLCByZW5kZXJDb250ZXh0KTsKCiAgaWYgKHZub2RlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCk7CiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgdmFyIHZub2RlcyA9IG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlKSB8fCBbXTsKICAgIHZhciByZXMgPSBuZXcgQXJyYXkodm5vZGVzLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzW2ldID0gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZXNbaV0sIGRhdGEsIHJlbmRlckNvbnRleHQucGFyZW50LCBvcHRpb25zLCByZW5kZXJDb250ZXh0KTsKICAgIH0KCiAgICByZXR1cm4gcmVzOwogIH0KfQoKZnVuY3Rpb24gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZSwgZGF0YSwgY29udGV4dFZtLCBvcHRpb25zLCByZW5kZXJDb250ZXh0KSB7CiAgLy8gIzc4MTcgY2xvbmUgbm9kZSBiZWZvcmUgc2V0dGluZyBmbkNvbnRleHQsIG90aGVyd2lzZSBpZiB0aGUgbm9kZSBpcyByZXVzZWQKICAvLyAoZS5nLiBpdCB3YXMgZnJvbSBhIGNhY2hlZCBub3JtYWwgc2xvdCkgdGhlIGZuQ29udGV4dCBjYXVzZXMgbmFtZWQgc2xvdHMKICAvLyB0aGF0IHNob3VsZCBub3QgYmUgbWF0Y2hlZCB0byBtYXRjaC4KICB2YXIgY2xvbmUgPSBjbG9uZVZOb2RlKHZub2RlKTsKICBjbG9uZS5mbkNvbnRleHQgPSBjb250ZXh0Vm07CiAgY2xvbmUuZm5PcHRpb25zID0gb3B0aW9uczsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIChjbG9uZS5kZXZ0b29sc01ldGEgPSBjbG9uZS5kZXZ0b29sc01ldGEgfHwge30pLnJlbmRlckNvbnRleHQgPSByZW5kZXJDb250ZXh0OwogIH0KCiAgaWYgKGRhdGEuc2xvdCkgewogICAgKGNsb25lLmRhdGEgfHwgKGNsb25lLmRhdGEgPSB7fSkpLnNsb3QgPSBkYXRhLnNsb3Q7CiAgfQoKICByZXR1cm4gY2xvbmU7Cn0KCmZ1bmN0aW9uIG1lcmdlUHJvcHModG8sIGZyb20pIHsKICBmb3IgKHZhciBrZXkgaW4gZnJvbSkgewogICAgdG9bY2FtZWxpemUoa2V5KV0gPSBmcm9tW2tleV07CiAgfQp9Ci8qICAqLwoKLyogICovCgovKiAgKi8KCi8qICAqLwovLyBpbmxpbmUgaG9va3MgdG8gYmUgaW52b2tlZCBvbiBjb21wb25lbnQgVk5vZGVzIGR1cmluZyBwYXRjaAoKCnZhciBjb21wb25lbnRWTm9kZUhvb2tzID0gewogIGluaXQ6IGZ1bmN0aW9uIGluaXQodm5vZGUsIGh5ZHJhdGluZykgewogICAgaWYgKHZub2RlLmNvbXBvbmVudEluc3RhbmNlICYmICF2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5faXNEZXN0cm95ZWQgJiYgdm5vZGUuZGF0YS5rZWVwQWxpdmUpIHsKICAgICAgLy8ga2VwdC1hbGl2ZSBjb21wb25lbnRzLCB0cmVhdCBhcyBhIHBhdGNoCiAgICAgIHZhciBtb3VudGVkTm9kZSA9IHZub2RlOyAvLyB3b3JrIGFyb3VuZCBmbG93CgogICAgICBjb21wb25lbnRWTm9kZUhvb2tzLnByZXBhdGNoKG1vdW50ZWROb2RlLCBtb3VudGVkTm9kZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlRm9yVm5vZGUodm5vZGUsIGFjdGl2ZUluc3RhbmNlKTsKICAgICAgY2hpbGQuJG1vdW50KGh5ZHJhdGluZyA/IHZub2RlLmVsbSA6IHVuZGVmaW5lZCwgaHlkcmF0aW5nKTsKICAgIH0KICB9LAogIHByZXBhdGNoOiBmdW5jdGlvbiBwcmVwYXRjaChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBvcHRpb25zID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICB1cGRhdGVDaGlsZENvbXBvbmVudChjaGlsZCwgb3B0aW9ucy5wcm9wc0RhdGEsIC8vIHVwZGF0ZWQgcHJvcHMKICAgIG9wdGlvbnMubGlzdGVuZXJzLCAvLyB1cGRhdGVkIGxpc3RlbmVycwogICAgdm5vZGUsIC8vIG5ldyBwYXJlbnQgdm5vZGUKICAgIG9wdGlvbnMuY2hpbGRyZW4gLy8gbmV3IGNoaWxkcmVuCiAgICApOwogIH0sCiAgaW5zZXJ0OiBmdW5jdGlvbiBpbnNlcnQodm5vZGUpIHsKICAgIHZhciBjb250ZXh0ID0gdm5vZGUuY29udGV4dDsKICAgIHZhciBjb21wb25lbnRJbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwoKICAgIGlmICghY29tcG9uZW50SW5zdGFuY2UuX2lzTW91bnRlZCkgewogICAgICBjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkID0gdHJ1ZTsKICAgICAgY2FsbEhvb2soY29tcG9uZW50SW5zdGFuY2UsICdtb3VudGVkJyk7CiAgICB9CgogICAgaWYgKHZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgIGlmIChjb250ZXh0Ll9pc01vdW50ZWQpIHsKICAgICAgICAvLyB2dWUtcm91dGVyIzEyMTIKICAgICAgICAvLyBEdXJpbmcgdXBkYXRlcywgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCdzIGNoaWxkIGNvbXBvbmVudHMgbWF5CiAgICAgICAgLy8gY2hhbmdlLCBzbyBkaXJlY3RseSB3YWxraW5nIHRoZSB0cmVlIGhlcmUgbWF5IGNhbGwgYWN0aXZhdGVkIGhvb2tzCiAgICAgICAgLy8gb24gaW5jb3JyZWN0IGNoaWxkcmVuLiBJbnN0ZWFkIHdlIHB1c2ggdGhlbSBpbnRvIGEgcXVldWUgd2hpY2ggd2lsbAogICAgICAgIC8vIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgd2hvbGUgcGF0Y2ggcHJvY2VzcyBlbmRlZC4KICAgICAgICBxdWV1ZUFjdGl2YXRlZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZQogICAgICAgIC8qIGRpcmVjdCAqLwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9LAogIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3kodm5vZGUpIHsKICAgIHZhciBjb21wb25lbnRJbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwoKICAgIGlmICghY29tcG9uZW50SW5zdGFuY2UuX2lzRGVzdHJveWVkKSB7CiAgICAgIGlmICghdm5vZGUuZGF0YS5rZWVwQWxpdmUpIHsKICAgICAgICBjb21wb25lbnRJbnN0YW5jZS4kZGVzdHJveSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGRlYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZQogICAgICAgIC8qIGRpcmVjdCAqLwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9Cn07CnZhciBob29rc1RvTWVyZ2UgPSBPYmplY3Qua2V5cyhjb21wb25lbnRWTm9kZUhvb2tzKTsKCmZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudChDdG9yLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbiwgdGFnKSB7CiAgaWYgKGlzVW5kZWYoQ3RvcikpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBiYXNlQ3RvciA9IGNvbnRleHQuJG9wdGlvbnMuX2Jhc2U7IC8vIHBsYWluIG9wdGlvbnMgb2JqZWN0OiB0dXJuIGl0IGludG8gYSBjb25zdHJ1Y3RvcgoKICBpZiAoaXNPYmplY3QoQ3RvcikpIHsKICAgIEN0b3IgPSBiYXNlQ3Rvci5leHRlbmQoQ3Rvcik7CiAgfSAvLyBpZiBhdCB0aGlzIHN0YWdlIGl0J3Mgbm90IGEgY29uc3RydWN0b3Igb3IgYW4gYXN5bmMgY29tcG9uZW50IGZhY3RvcnksCiAgLy8gcmVqZWN0LgoKCiAgaWYgKHR5cGVvZiBDdG9yICE9PSAnZnVuY3Rpb24nKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKCJJbnZhbGlkIENvbXBvbmVudCBkZWZpbml0aW9uOiAiICsgU3RyaW5nKEN0b3IpLCBjb250ZXh0KTsKICAgIH0KCiAgICByZXR1cm47CiAgfSAvLyBhc3luYyBjb21wb25lbnQKCgogIHZhciBhc3luY0ZhY3Rvcnk7CgogIGlmIChpc1VuZGVmKEN0b3IuY2lkKSkgewogICAgYXN5bmNGYWN0b3J5ID0gQ3RvcjsKICAgIEN0b3IgPSByZXNvbHZlQXN5bmNDb21wb25lbnQoYXN5bmNGYWN0b3J5LCBiYXNlQ3Rvcik7CgogICAgaWYgKEN0b3IgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciBub2RlIGZvciBhc3luYyBjb21wb25lbnQsIHdoaWNoIGlzIHJlbmRlcmVkCiAgICAgIC8vIGFzIGEgY29tbWVudCBub2RlIGJ1dCBwcmVzZXJ2ZXMgYWxsIHRoZSByYXcgaW5mb3JtYXRpb24gZm9yIHRoZSBub2RlLgogICAgICAvLyB0aGUgaW5mb3JtYXRpb24gd2lsbCBiZSB1c2VkIGZvciBhc3luYyBzZXJ2ZXItcmVuZGVyaW5nIGFuZCBoeWRyYXRpb24uCiAgICAgIHJldHVybiBjcmVhdGVBc3luY1BsYWNlaG9sZGVyKGFzeW5jRmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZyk7CiAgICB9CiAgfQoKICBkYXRhID0gZGF0YSB8fCB7fTsgLy8gcmVzb2x2ZSBjb25zdHJ1Y3RvciBvcHRpb25zIGluIGNhc2UgZ2xvYmFsIG1peGlucyBhcmUgYXBwbGllZCBhZnRlcgogIC8vIGNvbXBvbmVudCBjb25zdHJ1Y3RvciBjcmVhdGlvbgoKICByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3IpOyAvLyB0cmFuc2Zvcm0gY29tcG9uZW50IHYtbW9kZWwgZGF0YSBpbnRvIHByb3BzICYgZXZlbnRzCgogIGlmIChpc0RlZihkYXRhLm1vZGVsKSkgewogICAgdHJhbnNmb3JtTW9kZWwoQ3Rvci5vcHRpb25zLCBkYXRhKTsKICB9IC8vIGV4dHJhY3QgcHJvcHMKCgogIHZhciBwcm9wc0RhdGEgPSBleHRyYWN0UHJvcHNGcm9tVk5vZGVEYXRhKGRhdGEsIEN0b3IsIHRhZyk7IC8vIGZ1bmN0aW9uYWwgY29tcG9uZW50CgogIGlmIChpc1RydWUoQ3Rvci5vcHRpb25zLmZ1bmN0aW9uYWwpKSB7CiAgICByZXR1cm4gY3JlYXRlRnVuY3Rpb25hbENvbXBvbmVudChDdG9yLCBwcm9wc0RhdGEsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuKTsKICB9IC8vIGV4dHJhY3QgbGlzdGVuZXJzLCBzaW5jZSB0aGVzZSBuZWVkcyB0byBiZSB0cmVhdGVkIGFzCiAgLy8gY2hpbGQgY29tcG9uZW50IGxpc3RlbmVycyBpbnN0ZWFkIG9mIERPTSBsaXN0ZW5lcnMKCgogIHZhciBsaXN0ZW5lcnMgPSBkYXRhLm9uOyAvLyByZXBsYWNlIHdpdGggbGlzdGVuZXJzIHdpdGggLm5hdGl2ZSBtb2RpZmllcgogIC8vIHNvIGl0IGdldHMgcHJvY2Vzc2VkIGR1cmluZyBwYXJlbnQgY29tcG9uZW50IHBhdGNoLgoKICBkYXRhLm9uID0gZGF0YS5uYXRpdmVPbjsKCiAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnNbImFic3RyYWN0Il0pKSB7CiAgICAvLyBhYnN0cmFjdCBjb21wb25lbnRzIGRvIG5vdCBrZWVwIGFueXRoaW5nCiAgICAvLyBvdGhlciB0aGFuIHByb3BzICYgbGlzdGVuZXJzICYgc2xvdAogICAgLy8gd29yayBhcm91bmQgZmxvdwogICAgdmFyIHNsb3QgPSBkYXRhLnNsb3Q7CiAgICBkYXRhID0ge307CgogICAgaWYgKHNsb3QpIHsKICAgICAgZGF0YS5zbG90ID0gc2xvdDsKICAgIH0KICB9IC8vIGluc3RhbGwgY29tcG9uZW50IG1hbmFnZW1lbnQgaG9va3Mgb250byB0aGUgcGxhY2Vob2xkZXIgbm9kZQoKCiAgaW5zdGFsbENvbXBvbmVudEhvb2tzKGRhdGEpOyAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciB2bm9kZQoKICB2YXIgbmFtZSA9IEN0b3Iub3B0aW9ucy5uYW1lIHx8IHRhZzsKICB2YXIgdm5vZGUgPSBuZXcgVk5vZGUoInZ1ZS1jb21wb25lbnQtIiArIEN0b3IuY2lkICsgKG5hbWUgPyAiLSIgKyBuYW1lIDogJycpLCBkYXRhLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0LCB7CiAgICBDdG9yOiBDdG9yLAogICAgcHJvcHNEYXRhOiBwcm9wc0RhdGEsCiAgICBsaXN0ZW5lcnM6IGxpc3RlbmVycywKICAgIHRhZzogdGFnLAogICAgY2hpbGRyZW46IGNoaWxkcmVuCiAgfSwgYXN5bmNGYWN0b3J5KTsKICByZXR1cm4gdm5vZGU7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlRm9yVm5vZGUodm5vZGUsIC8vIHdlIGtub3cgaXQncyBNb3VudGVkQ29tcG9uZW50Vk5vZGUgYnV0IGZsb3cgZG9lc24ndApwYXJlbnQgLy8gYWN0aXZlSW5zdGFuY2UgaW4gbGlmZWN5Y2xlIHN0YXRlCikgewogIHZhciBvcHRpb25zID0gewogICAgX2lzQ29tcG9uZW50OiB0cnVlLAogICAgX3BhcmVudFZub2RlOiB2bm9kZSwKICAgIHBhcmVudDogcGFyZW50CiAgfTsgLy8gY2hlY2sgaW5saW5lLXRlbXBsYXRlIHJlbmRlciBmdW5jdGlvbnMKCiAgdmFyIGlubGluZVRlbXBsYXRlID0gdm5vZGUuZGF0YS5pbmxpbmVUZW1wbGF0ZTsKCiAgaWYgKGlzRGVmKGlubGluZVRlbXBsYXRlKSkgewogICAgb3B0aW9ucy5yZW5kZXIgPSBpbmxpbmVUZW1wbGF0ZS5yZW5kZXI7CiAgICBvcHRpb25zLnN0YXRpY1JlbmRlckZucyA9IGlubGluZVRlbXBsYXRlLnN0YXRpY1JlbmRlckZuczsKICB9CgogIHJldHVybiBuZXcgdm5vZGUuY29tcG9uZW50T3B0aW9ucy5DdG9yKG9wdGlvbnMpOwp9CgpmdW5jdGlvbiBpbnN0YWxsQ29tcG9uZW50SG9va3MoZGF0YSkgewogIHZhciBob29rcyA9IGRhdGEuaG9vayB8fCAoZGF0YS5ob29rID0ge30pOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzVG9NZXJnZS5sZW5ndGg7IGkrKykgewogICAgdmFyIGtleSA9IGhvb2tzVG9NZXJnZVtpXTsKICAgIHZhciBleGlzdGluZyA9IGhvb2tzW2tleV07CiAgICB2YXIgdG9NZXJnZSA9IGNvbXBvbmVudFZOb2RlSG9va3Nba2V5XTsKCiAgICBpZiAoZXhpc3RpbmcgIT09IHRvTWVyZ2UgJiYgIShleGlzdGluZyAmJiBleGlzdGluZy5fbWVyZ2VkKSkgewogICAgICBob29rc1trZXldID0gZXhpc3RpbmcgPyBtZXJnZUhvb2skMSh0b01lcmdlLCBleGlzdGluZykgOiB0b01lcmdlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gbWVyZ2VIb29rJDEoZjEsIGYyKSB7CiAgdmFyIG1lcmdlZCA9IGZ1bmN0aW9uIG1lcmdlZChhLCBiKSB7CiAgICAvLyBmbG93IGNvbXBsYWlucyBhYm91dCBleHRyYSBhcmdzIHdoaWNoIGlzIHdoeSB3ZSB1c2UgYW55CiAgICBmMShhLCBiKTsKICAgIGYyKGEsIGIpOwogIH07CgogIG1lcmdlZC5fbWVyZ2VkID0gdHJ1ZTsKICByZXR1cm4gbWVyZ2VkOwp9IC8vIHRyYW5zZm9ybSBjb21wb25lbnQgdi1tb2RlbCBpbmZvICh2YWx1ZSBhbmQgY2FsbGJhY2spIGludG8KLy8gcHJvcCBhbmQgZXZlbnQgaGFuZGxlciByZXNwZWN0aXZlbHkuCgoKZnVuY3Rpb24gdHJhbnNmb3JtTW9kZWwob3B0aW9ucywgZGF0YSkgewogIHZhciBwcm9wID0gb3B0aW9ucy5tb2RlbCAmJiBvcHRpb25zLm1vZGVsLnByb3AgfHwgJ3ZhbHVlJzsKICB2YXIgZXZlbnQgPSBvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwuZXZlbnQgfHwgJ2lucHV0JzsKICAoZGF0YS5hdHRycyB8fCAoZGF0YS5hdHRycyA9IHt9KSlbcHJvcF0gPSBkYXRhLm1vZGVsLnZhbHVlOwogIHZhciBvbiA9IGRhdGEub24gfHwgKGRhdGEub24gPSB7fSk7CiAgdmFyIGV4aXN0aW5nID0gb25bZXZlbnRdOwogIHZhciBjYWxsYmFjayA9IGRhdGEubW9kZWwuY2FsbGJhY2s7CgogIGlmIChpc0RlZihleGlzdGluZykpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGV4aXN0aW5nKSA/IGV4aXN0aW5nLmluZGV4T2YoY2FsbGJhY2spID09PSAtMSA6IGV4aXN0aW5nICE9PSBjYWxsYmFjaykgewogICAgICBvbltldmVudF0gPSBbY2FsbGJhY2tdLmNvbmNhdChleGlzdGluZyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIG9uW2V2ZW50XSA9IGNhbGxiYWNrOwogIH0KfQovKiAgKi8KCgp2YXIgU0lNUExFX05PUk1BTElaRSA9IDE7CnZhciBBTFdBWVNfTk9STUFMSVpFID0gMjsgLy8gd3JhcHBlciBmdW5jdGlvbiBmb3IgcHJvdmlkaW5nIGEgbW9yZSBmbGV4aWJsZSBpbnRlcmZhY2UKLy8gd2l0aG91dCBnZXR0aW5nIHllbGxlZCBhdCBieSBmbG93CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50KGNvbnRleHQsIHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlLCBhbHdheXNOb3JtYWxpemUpIHsKICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSB8fCBpc1ByaW1pdGl2ZShkYXRhKSkgewogICAgbm9ybWFsaXphdGlvblR5cGUgPSBjaGlsZHJlbjsKICAgIGNoaWxkcmVuID0gZGF0YTsKICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAoaXNUcnVlKGFsd2F5c05vcm1hbGl6ZSkpIHsKICAgIG5vcm1hbGl6YXRpb25UeXBlID0gQUxXQVlTX05PUk1BTElaRTsKICB9CgogIHJldHVybiBfY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSk7Cn0KCmZ1bmN0aW9uIF9jcmVhdGVFbGVtZW50KGNvbnRleHQsIHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlKSB7CiAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuX19vYl9fKSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJBdm9pZCB1c2luZyBvYnNlcnZlZCBkYXRhIG9iamVjdCBhcyB2bm9kZSBkYXRhOiAiICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkgKyAiXG4iICsgJ0Fsd2F5cyBjcmVhdGUgZnJlc2ggdm5vZGUgZGF0YSBvYmplY3RzIGluIGVhY2ggcmVuZGVyIScsIGNvbnRleHQpOwogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9IC8vIG9iamVjdCBzeW50YXggaW4gdi1iaW5kCgoKICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5pcykpIHsKICAgIHRhZyA9IGRhdGEuaXM7CiAgfQoKICBpZiAoIXRhZykgewogICAgLy8gaW4gY2FzZSBvZiBjb21wb25lbnQgOmlzIHNldCB0byBmYWxzeSB2YWx1ZQogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9IC8vIHdhcm4gYWdhaW5zdCBub24tcHJpbWl0aXZlIGtleQoKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5rZXkpICYmICFpc1ByaW1pdGl2ZShkYXRhLmtleSkpIHsKICAgIHsKICAgICAgd2FybignQXZvaWQgdXNpbmcgbm9uLXByaW1pdGl2ZSB2YWx1ZSBhcyBrZXksICcgKyAndXNlIHN0cmluZy9udW1iZXIgdmFsdWUgaW5zdGVhZC4nLCBjb250ZXh0KTsKICAgIH0KICB9IC8vIHN1cHBvcnQgc2luZ2xlIGZ1bmN0aW9uIGNoaWxkcmVuIGFzIGRlZmF1bHQgc2NvcGVkIHNsb3QKCgogIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSAmJiB0eXBlb2YgY2hpbGRyZW5bMF0gPT09ICdmdW5jdGlvbicpIHsKICAgIGRhdGEgPSBkYXRhIHx8IHt9OwogICAgZGF0YS5zY29wZWRTbG90cyA9IHsKICAgICAgImRlZmF1bHQiOiBjaGlsZHJlblswXQogICAgfTsKICAgIGNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgfQoKICBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IEFMV0FZU19OT1JNQUxJWkUpIHsKICAgIGNoaWxkcmVuID0gbm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogIH0gZWxzZSBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IFNJTVBMRV9OT1JNQUxJWkUpIHsKICAgIGNoaWxkcmVuID0gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogIH0KCiAgdmFyIHZub2RlLCBuczsKCiAgaWYgKHR5cGVvZiB0YWcgPT09ICdzdHJpbmcnKSB7CiAgICB2YXIgQ3RvcjsKICAgIG5zID0gY29udGV4dC4kdm5vZGUgJiYgY29udGV4dC4kdm5vZGUubnMgfHwgY29uZmlnLmdldFRhZ05hbWVzcGFjZSh0YWcpOwoKICAgIGlmIChjb25maWcuaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICAgIC8vIHBsYXRmb3JtIGJ1aWx0LWluIGVsZW1lbnRzCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEubmF0aXZlT24pKSB7CiAgICAgICAgd2FybigiVGhlIC5uYXRpdmUgbW9kaWZpZXIgZm9yIHYtb24gaXMgb25seSB2YWxpZCBvbiBjb21wb25lbnRzIGJ1dCBpdCB3YXMgdXNlZCBvbiA8IiArIHRhZyArICI+LiIsIGNvbnRleHQpOwogICAgICB9CgogICAgICB2bm9kZSA9IG5ldyBWTm9kZShjb25maWcucGFyc2VQbGF0Zm9ybVRhZ05hbWUodGFnKSwgZGF0YSwgY2hpbGRyZW4sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0KTsKICAgIH0gZWxzZSBpZiAoKCFkYXRhIHx8ICFkYXRhLnByZSkgJiYgaXNEZWYoQ3RvciA9IHJlc29sdmVBc3NldChjb250ZXh0LiRvcHRpb25zLCAnY29tcG9uZW50cycsIHRhZykpKSB7CiAgICAgIC8vIGNvbXBvbmVudAogICAgICB2bm9kZSA9IGNyZWF0ZUNvbXBvbmVudChDdG9yLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbiwgdGFnKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHVua25vd24gb3IgdW5saXN0ZWQgbmFtZXNwYWNlZCBlbGVtZW50cwogICAgICAvLyBjaGVjayBhdCBydW50aW1lIGJlY2F1c2UgaXQgbWF5IGdldCBhc3NpZ25lZCBhIG5hbWVzcGFjZSB3aGVuIGl0cwogICAgICAvLyBwYXJlbnQgbm9ybWFsaXplcyBjaGlsZHJlbgogICAgICB2bm9kZSA9IG5ldyBWTm9kZSh0YWcsIGRhdGEsIGNoaWxkcmVuLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGV4dCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIGRpcmVjdCBjb21wb25lbnQgb3B0aW9ucyAvIGNvbnN0cnVjdG9yCiAgICB2bm9kZSA9IGNyZWF0ZUNvbXBvbmVudCh0YWcsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuKTsKICB9CgogIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgcmV0dXJuIHZub2RlOwogIH0gZWxzZSBpZiAoaXNEZWYodm5vZGUpKSB7CiAgICBpZiAoaXNEZWYobnMpKSB7CiAgICAgIGFwcGx5TlModm5vZGUsIG5zKTsKICAgIH0KCiAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgcmVnaXN0ZXJEZWVwQmluZGluZ3MoZGF0YSk7CiAgICB9CgogICAgcmV0dXJuIHZub2RlOwogIH0gZWxzZSB7CiAgICByZXR1cm4gY3JlYXRlRW1wdHlWTm9kZSgpOwogIH0KfQoKZnVuY3Rpb24gYXBwbHlOUyh2bm9kZSwgbnMsIGZvcmNlKSB7CiAgdm5vZGUubnMgPSBuczsKCiAgaWYgKHZub2RlLnRhZyA9PT0gJ2ZvcmVpZ25PYmplY3QnKSB7CiAgICAvLyB1c2UgZGVmYXVsdCBuYW1lc3BhY2UgaW5zaWRlIGZvcmVpZ25PYmplY3QKICAgIG5zID0gdW5kZWZpbmVkOwogICAgZm9yY2UgPSB0cnVlOwogIH0KCiAgaWYgKGlzRGVmKHZub2RlLmNoaWxkcmVuKSkgewogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2bm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIGNoaWxkID0gdm5vZGUuY2hpbGRyZW5baV07CgogICAgICBpZiAoaXNEZWYoY2hpbGQudGFnKSAmJiAoaXNVbmRlZihjaGlsZC5ucykgfHwgaXNUcnVlKGZvcmNlKSAmJiBjaGlsZC50YWcgIT09ICdzdmcnKSkgewogICAgICAgIGFwcGx5TlMoY2hpbGQsIG5zLCBmb3JjZSk7CiAgICAgIH0KICAgIH0KICB9Cn0gLy8gcmVmICM1MzE4Ci8vIG5lY2Vzc2FyeSB0byBlbnN1cmUgcGFyZW50IHJlLXJlbmRlciB3aGVuIGRlZXAgYmluZGluZ3MgbGlrZSA6c3R5bGUgYW5kCi8vIDpjbGFzcyBhcmUgdXNlZCBvbiBzbG90IG5vZGVzCgoKZnVuY3Rpb24gcmVnaXN0ZXJEZWVwQmluZGluZ3MoZGF0YSkgewogIGlmIChpc09iamVjdChkYXRhLnN0eWxlKSkgewogICAgdHJhdmVyc2UoZGF0YS5zdHlsZSk7CiAgfQoKICBpZiAoaXNPYmplY3QoZGF0YVsiY2xhc3MiXSkpIHsKICAgIHRyYXZlcnNlKGRhdGFbImNsYXNzIl0pOwogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0UmVuZGVyKHZtKSB7CiAgdm0uX3Zub2RlID0gbnVsbDsgLy8gdGhlIHJvb3Qgb2YgdGhlIGNoaWxkIHRyZWUKCiAgdm0uX3N0YXRpY1RyZWVzID0gbnVsbDsgLy8gdi1vbmNlIGNhY2hlZCB0cmVlcwoKICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogIHZhciBwYXJlbnRWbm9kZSA9IHZtLiR2bm9kZSA9IG9wdGlvbnMuX3BhcmVudFZub2RlOyAvLyB0aGUgcGxhY2Vob2xkZXIgbm9kZSBpbiBwYXJlbnQgdHJlZQoKICB2YXIgcmVuZGVyQ29udGV4dCA9IHBhcmVudFZub2RlICYmIHBhcmVudFZub2RlLmNvbnRleHQ7CiAgdm0uJHNsb3RzID0gcmVzb2x2ZVNsb3RzKG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuLCByZW5kZXJDb250ZXh0KTsKICB2bS4kc2NvcGVkU2xvdHMgPSBlbXB0eU9iamVjdDsgLy8gYmluZCB0aGUgY3JlYXRlRWxlbWVudCBmbiB0byB0aGlzIGluc3RhbmNlCiAgLy8gc28gdGhhdCB3ZSBnZXQgcHJvcGVyIHJlbmRlciBjb250ZXh0IGluc2lkZSBpdC4KICAvLyBhcmdzIG9yZGVyOiB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSwgYWx3YXlzTm9ybWFsaXplCiAgLy8gaW50ZXJuYWwgdmVyc2lvbiBpcyB1c2VkIGJ5IHJlbmRlciBmdW5jdGlvbnMgY29tcGlsZWQgZnJvbSB0ZW1wbGF0ZXMKCiAgdm0uX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQodm0sIGEsIGIsIGMsIGQsIGZhbHNlKTsKICB9OyAvLyBub3JtYWxpemF0aW9uIGlzIGFsd2F5cyBhcHBsaWVkIGZvciB0aGUgcHVibGljIHZlcnNpb24sIHVzZWQgaW4KICAvLyB1c2VyLXdyaXR0ZW4gcmVuZGVyIGZ1bmN0aW9ucy4KCgogIHZtLiRjcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgIHJldHVybiBjcmVhdGVFbGVtZW50KHZtLCBhLCBiLCBjLCBkLCB0cnVlKTsKICB9OyAvLyAkYXR0cnMgJiAkbGlzdGVuZXJzIGFyZSBleHBvc2VkIGZvciBlYXNpZXIgSE9DIGNyZWF0aW9uLgogIC8vIHRoZXkgbmVlZCB0byBiZSByZWFjdGl2ZSBzbyB0aGF0IEhPQ3MgdXNpbmcgdGhlbSBhcmUgYWx3YXlzIHVwZGF0ZWQKCgogIHZhciBwYXJlbnREYXRhID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuZGF0YTsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sICckYXR0cnMnLCBwYXJlbnREYXRhICYmIHBhcmVudERhdGEuYXR0cnMgfHwgZW1wdHlPYmplY3QsIGZ1bmN0aW9uICgpIHsKICAgICAgIWlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCAmJiB3YXJuKCIkYXR0cnMgaXMgcmVhZG9ubHkuIiwgdm0pOwogICAgfSwgdHJ1ZSk7CiAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRsaXN0ZW5lcnMnLCBvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3QsIGZ1bmN0aW9uICgpIHsKICAgICAgIWlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCAmJiB3YXJuKCIkbGlzdGVuZXJzIGlzIHJlYWRvbmx5LiIsIHZtKTsKICAgIH0sIHRydWUpOwogIH0gZWxzZSB7CiAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRhdHRycycsIHBhcmVudERhdGEgJiYgcGFyZW50RGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdCwgbnVsbCwgdHJ1ZSk7CiAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRsaXN0ZW5lcnMnLCBvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3QsIG51bGwsIHRydWUpOwogIH0KfQoKdmFyIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CgpmdW5jdGlvbiByZW5kZXJNaXhpbihWdWUpIHsKICAvLyBpbnN0YWxsIHJ1bnRpbWUgY29udmVuaWVuY2UgaGVscGVycwogIGluc3RhbGxSZW5kZXJIZWxwZXJzKFZ1ZS5wcm90b3R5cGUpOwoKICBWdWUucHJvdG90eXBlLiRuZXh0VGljayA9IGZ1bmN0aW9uIChmbikgewogICAgcmV0dXJuIG5leHRUaWNrKGZuLCB0aGlzKTsKICB9OwoKICBWdWUucHJvdG90eXBlLl9yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgdmFyIHJlZiA9IHZtLiRvcHRpb25zOwogICAgdmFyIHJlbmRlciA9IHJlZi5yZW5kZXI7CiAgICB2YXIgX3BhcmVudFZub2RlID0gcmVmLl9wYXJlbnRWbm9kZTsKCiAgICBpZiAoX3BhcmVudFZub2RlKSB7CiAgICAgIHZtLiRzY29wZWRTbG90cyA9IG5vcm1hbGl6ZVNjb3BlZFNsb3RzKF9wYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzLCB2bS4kc2xvdHMsIHZtLiRzY29wZWRTbG90cyk7CiAgICB9IC8vIHNldCBwYXJlbnQgdm5vZGUuIHRoaXMgYWxsb3dzIHJlbmRlciBmdW5jdGlvbnMgdG8gaGF2ZSBhY2Nlc3MKICAgIC8vIHRvIHRoZSBkYXRhIG9uIHRoZSBwbGFjZWhvbGRlciBub2RlLgoKCiAgICB2bS4kdm5vZGUgPSBfcGFyZW50Vm5vZGU7IC8vIHJlbmRlciBzZWxmCgogICAgdmFyIHZub2RlOwoKICAgIHRyeSB7CiAgICAgIC8vIFRoZXJlJ3Mgbm8gbmVlZCB0byBtYWludGFpbiBhIHN0YWNrIGJlY2F1c2UgYWxsIHJlbmRlciBmbnMgYXJlIGNhbGxlZAogICAgICAvLyBzZXBhcmF0ZWx5IGZyb20gb25lIGFub3RoZXIuIE5lc3RlZCBjb21wb25lbnQncyByZW5kZXIgZm5zIGFyZSBjYWxsZWQKICAgICAgLy8gd2hlbiBwYXJlbnQgY29tcG9uZW50IGlzIHBhdGNoZWQuCiAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IHZtOwogICAgICB2bm9kZSA9IHJlbmRlci5jYWxsKHZtLl9yZW5kZXJQcm94eSwgdm0uJGNyZWF0ZUVsZW1lbnQpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBoYW5kbGVFcnJvcihlLCB2bSwgInJlbmRlciIpOyAvLyByZXR1cm4gZXJyb3IgcmVuZGVyIHJlc3VsdCwKICAgICAgLy8gb3IgcHJldmlvdXMgdm5vZGUgdG8gcHJldmVudCByZW5kZXIgZXJyb3IgY2F1c2luZyBibGFuayBjb21wb25lbnQKCiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB2bS4kb3B0aW9ucy5yZW5kZXJFcnJvcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2bm9kZSA9IHZtLiRvcHRpb25zLnJlbmRlckVycm9yLmNhbGwodm0uX3JlbmRlclByb3h5LCB2bS4kY3JlYXRlRWxlbWVudCwgZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJyZW5kZXJFcnJvciIpOwogICAgICAgICAgdm5vZGUgPSB2bS5fdm5vZGU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZub2RlID0gdm0uX3Zub2RlOwogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgPSBudWxsOwogICAgfSAvLyBpZiB0aGUgcmV0dXJuZWQgYXJyYXkgY29udGFpbnMgb25seSBhIHNpbmdsZSBub2RlLCBhbGxvdyBpdAoKCiAgICBpZiAoQXJyYXkuaXNBcnJheSh2bm9kZSkgJiYgdm5vZGUubGVuZ3RoID09PSAxKSB7CiAgICAgIHZub2RlID0gdm5vZGVbMF07CiAgICB9IC8vIHJldHVybiBlbXB0eSB2bm9kZSBpbiBjYXNlIHRoZSByZW5kZXIgZnVuY3Rpb24gZXJyb3JlZCBvdXQKCgogICAgaWYgKCEodm5vZGUgaW5zdGFuY2VvZiBWTm9kZSkpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgICAgICB3YXJuKCdNdWx0aXBsZSByb290IG5vZGVzIHJldHVybmVkIGZyb20gcmVuZGVyIGZ1bmN0aW9uLiBSZW5kZXIgZnVuY3Rpb24gJyArICdzaG91bGQgcmV0dXJuIGEgc2luZ2xlIHJvb3Qgbm9kZS4nLCB2bSk7CiAgICAgIH0KCiAgICAgIHZub2RlID0gY3JlYXRlRW1wdHlWTm9kZSgpOwogICAgfSAvLyBzZXQgcGFyZW50CgoKICAgIHZub2RlLnBhcmVudCA9IF9wYXJlbnRWbm9kZTsKICAgIHJldHVybiB2bm9kZTsKICB9Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGVuc3VyZUN0b3IoY29tcCwgYmFzZSkgewogIGlmIChjb21wLl9fZXNNb2R1bGUgfHwgaGFzU3ltYm9sICYmIGNvbXBbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gJ01vZHVsZScpIHsKICAgIGNvbXAgPSBjb21wWyJkZWZhdWx0Il07CiAgfQoKICByZXR1cm4gaXNPYmplY3QoY29tcCkgPyBiYXNlLmV4dGVuZChjb21wKSA6IGNvbXA7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUFzeW5jUGxhY2Vob2xkZXIoZmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZykgewogIHZhciBub2RlID0gY3JlYXRlRW1wdHlWTm9kZSgpOwogIG5vZGUuYXN5bmNGYWN0b3J5ID0gZmFjdG9yeTsKICBub2RlLmFzeW5jTWV0YSA9IHsKICAgIGRhdGE6IGRhdGEsCiAgICBjb250ZXh0OiBjb250ZXh0LAogICAgY2hpbGRyZW46IGNoaWxkcmVuLAogICAgdGFnOiB0YWcKICB9OwogIHJldHVybiBub2RlOwp9CgpmdW5jdGlvbiByZXNvbHZlQXN5bmNDb21wb25lbnQoZmFjdG9yeSwgYmFzZUN0b3IpIHsKICBpZiAoaXNUcnVlKGZhY3RvcnkuZXJyb3IpICYmIGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgcmV0dXJuIGZhY3RvcnkuZXJyb3JDb21wOwogIH0KCiAgaWYgKGlzRGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICByZXR1cm4gZmFjdG9yeS5yZXNvbHZlZDsKICB9CgogIHZhciBvd25lciA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKCiAgaWYgKG93bmVyICYmIGlzRGVmKGZhY3Rvcnkub3duZXJzKSAmJiBmYWN0b3J5Lm93bmVycy5pbmRleE9mKG93bmVyKSA9PT0gLTEpIHsKICAgIC8vIGFscmVhZHkgcGVuZGluZwogICAgZmFjdG9yeS5vd25lcnMucHVzaChvd25lcik7CiAgfQoKICBpZiAoaXNUcnVlKGZhY3RvcnkubG9hZGluZykgJiYgaXNEZWYoZmFjdG9yeS5sb2FkaW5nQ29tcCkpIHsKICAgIHJldHVybiBmYWN0b3J5LmxvYWRpbmdDb21wOwogIH0KCiAgaWYgKG93bmVyICYmICFpc0RlZihmYWN0b3J5Lm93bmVycykpIHsKICAgIHZhciBvd25lcnMgPSBmYWN0b3J5Lm93bmVycyA9IFtvd25lcl07CiAgICB2YXIgc3luYyA9IHRydWU7CiAgICB2YXIgdGltZXJMb2FkaW5nID0gbnVsbDsKICAgIHZhciB0aW1lclRpbWVvdXQgPSBudWxsOwogICAgb3duZXIuJG9uKCdob29rOmRlc3Ryb3llZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHJlbW92ZShvd25lcnMsIG93bmVyKTsKICAgIH0pOwoKICAgIHZhciBmb3JjZVJlbmRlciA9IGZ1bmN0aW9uIGZvcmNlUmVuZGVyKHJlbmRlckNvbXBsZXRlZCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG93bmVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvd25lcnNbaV0uJGZvcmNlVXBkYXRlKCk7CiAgICAgIH0KCiAgICAgIGlmIChyZW5kZXJDb21wbGV0ZWQpIHsKICAgICAgICBvd25lcnMubGVuZ3RoID0gMDsKCiAgICAgICAgaWYgKHRpbWVyTG9hZGluZyAhPT0gbnVsbCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyTG9hZGluZyk7CiAgICAgICAgICB0aW1lckxvYWRpbmcgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRpbWVyVGltZW91dCAhPT0gbnVsbCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyVGltZW91dCk7CiAgICAgICAgICB0aW1lclRpbWVvdXQgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICB2YXIgcmVzb2x2ZSA9IG9uY2UoZnVuY3Rpb24gKHJlcykgewogICAgICAvLyBjYWNoZSByZXNvbHZlZAogICAgICBmYWN0b3J5LnJlc29sdmVkID0gZW5zdXJlQ3RvcihyZXMsIGJhc2VDdG9yKTsgLy8gaW52b2tlIGNhbGxiYWNrcyBvbmx5IGlmIHRoaXMgaXMgbm90IGEgc3luY2hyb25vdXMgcmVzb2x2ZQogICAgICAvLyAoYXN5bmMgcmVzb2x2ZXMgYXJlIHNoaW1tZWQgYXMgc3luY2hyb25vdXMgZHVyaW5nIFNTUikKCiAgICAgIGlmICghc3luYykgewogICAgICAgIGZvcmNlUmVuZGVyKHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgIG93bmVycy5sZW5ndGggPSAwOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZWplY3QgPSBvbmNlKGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJGYWlsZWQgdG8gcmVzb2x2ZSBhc3luYyBjb21wb25lbnQ6ICIgKyBTdHJpbmcoZmFjdG9yeSkgKyAocmVhc29uID8gIlxuUmVhc29uOiAiICsgcmVhc29uIDogJycpKTsKCiAgICAgIGlmIChpc0RlZihmYWN0b3J5LmVycm9yQ29tcCkpIHsKICAgICAgICBmYWN0b3J5LmVycm9yID0gdHJ1ZTsKICAgICAgICBmb3JjZVJlbmRlcih0cnVlKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgcmVzID0gZmFjdG9yeShyZXNvbHZlLCByZWplY3QpOwoKICAgIGlmIChpc09iamVjdChyZXMpKSB7CiAgICAgIGlmIChpc1Byb21pc2UocmVzKSkgewogICAgICAgIC8vICgpID0+IFByb21pc2UKICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgcmVzLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNQcm9taXNlKHJlcy5jb21wb25lbnQpKSB7CiAgICAgICAgcmVzLmNvbXBvbmVudC50aGVuKHJlc29sdmUsIHJlamVjdCk7CgogICAgICAgIGlmIChpc0RlZihyZXMuZXJyb3IpKSB7CiAgICAgICAgICBmYWN0b3J5LmVycm9yQ29tcCA9IGVuc3VyZUN0b3IocmVzLmVycm9yLCBiYXNlQ3Rvcik7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWYocmVzLmxvYWRpbmcpKSB7CiAgICAgICAgICBmYWN0b3J5LmxvYWRpbmdDb21wID0gZW5zdXJlQ3RvcihyZXMubG9hZGluZywgYmFzZUN0b3IpOwoKICAgICAgICAgIGlmIChyZXMuZGVsYXkgPT09IDApIHsKICAgICAgICAgICAgZmFjdG9yeS5sb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRpbWVyTG9hZGluZyA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHRpbWVyTG9hZGluZyA9IG51bGw7CgogICAgICAgICAgICAgIGlmIChpc1VuZGVmKGZhY3RvcnkucmVzb2x2ZWQpICYmIGlzVW5kZWYoZmFjdG9yeS5lcnJvcikpIHsKICAgICAgICAgICAgICAgIGZhY3RvcnkubG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICBmb3JjZVJlbmRlcihmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCByZXMuZGVsYXkgfHwgMjAwKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChpc0RlZihyZXMudGltZW91dCkpIHsKICAgICAgICAgIHRpbWVyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aW1lclRpbWVvdXQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICAgICAgICByZWplY3QocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/ICJ0aW1lb3V0ICgiICsgcmVzLnRpbWVvdXQgKyAibXMpIiA6IG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCByZXMudGltZW91dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgc3luYyA9IGZhbHNlOyAvLyByZXR1cm4gaW4gY2FzZSByZXNvbHZlZCBzeW5jaHJvbm91c2x5CgogICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZyA/IGZhY3RvcnkubG9hZGluZ0NvbXAgOiBmYWN0b3J5LnJlc29sdmVkOwogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBpc0FzeW5jUGxhY2Vob2xkZXIobm9kZSkgewogIHJldHVybiBub2RlLmlzQ29tbWVudCAmJiBub2RlLmFzeW5jRmFjdG9yeTsKfQovKiAgKi8KCgpmdW5jdGlvbiBnZXRGaXJzdENvbXBvbmVudENoaWxkKGNoaWxkcmVuKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBjID0gY2hpbGRyZW5baV07CgogICAgICBpZiAoaXNEZWYoYykgJiYgKGlzRGVmKGMuY29tcG9uZW50T3B0aW9ucykgfHwgaXNBc3luY1BsYWNlaG9sZGVyKGMpKSkgewogICAgICAgIHJldHVybiBjOwogICAgICB9CiAgICB9CiAgfQp9Ci8qICAqLwoKLyogICovCgoKZnVuY3Rpb24gaW5pdEV2ZW50cyh2bSkgewogIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHZtLl9oYXNIb29rRXZlbnQgPSBmYWxzZTsgLy8gaW5pdCBwYXJlbnQgYXR0YWNoZWQgZXZlbnRzCgogIHZhciBsaXN0ZW5lcnMgPSB2bS4kb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzOwoKICBpZiAobGlzdGVuZXJzKSB7CiAgICB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycyk7CiAgfQp9Cgp2YXIgdGFyZ2V0OwoKZnVuY3Rpb24gYWRkKGV2ZW50LCBmbikgewogIHRhcmdldC4kb24oZXZlbnQsIGZuKTsKfQoKZnVuY3Rpb24gcmVtb3ZlJDEoZXZlbnQsIGZuKSB7CiAgdGFyZ2V0LiRvZmYoZXZlbnQsIGZuKTsKfQoKZnVuY3Rpb24gY3JlYXRlT25jZUhhbmRsZXIoZXZlbnQsIGZuKSB7CiAgdmFyIF90YXJnZXQgPSB0YXJnZXQ7CiAgcmV0dXJuIGZ1bmN0aW9uIG9uY2VIYW5kbGVyKCkgewogICAgdmFyIHJlcyA9IGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CgogICAgaWYgKHJlcyAhPT0gbnVsbCkgewogICAgICBfdGFyZ2V0LiRvZmYoZXZlbnQsIG9uY2VIYW5kbGVyKTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycywgb2xkTGlzdGVuZXJzKSB7CiAgdGFyZ2V0ID0gdm07CiAgdXBkYXRlTGlzdGVuZXJzKGxpc3RlbmVycywgb2xkTGlzdGVuZXJzIHx8IHt9LCBhZGQsIHJlbW92ZSQxLCBjcmVhdGVPbmNlSGFuZGxlciwgdm0pOwogIHRhcmdldCA9IHVuZGVmaW5lZDsKfQoKZnVuY3Rpb24gZXZlbnRzTWl4aW4oVnVlKSB7CiAgdmFyIGhvb2tSRSA9IC9eaG9vazovOwoKICBWdWUucHJvdG90eXBlLiRvbiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZXZlbnQpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gZXZlbnQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdm0uJG9uKGV2ZW50W2ldLCBmbik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICh2bS5fZXZlbnRzW2V2ZW50XSB8fCAodm0uX2V2ZW50c1tldmVudF0gPSBbXSkpLnB1c2goZm4pOyAvLyBvcHRpbWl6ZSBob29rOmV2ZW50IGNvc3QgYnkgdXNpbmcgYSBib29sZWFuIGZsYWcgbWFya2VkIGF0IHJlZ2lzdHJhdGlvbgogICAgICAvLyBpbnN0ZWFkIG9mIGEgaGFzaCBsb29rdXAKCiAgICAgIGlmIChob29rUkUudGVzdChldmVudCkpIHsKICAgICAgICB2bS5faGFzSG9va0V2ZW50ID0gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB2bTsKICB9OwoKICBWdWUucHJvdG90eXBlLiRvbmNlID0gZnVuY3Rpb24gKGV2ZW50LCBmbikgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBmdW5jdGlvbiBvbigpIHsKICAgICAgdm0uJG9mZihldmVudCwgb24pOwogICAgICBmbi5hcHBseSh2bSwgYXJndW1lbnRzKTsKICAgIH0KCiAgICBvbi5mbiA9IGZuOwogICAgdm0uJG9uKGV2ZW50LCBvbik7CiAgICByZXR1cm4gdm07CiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kb2ZmID0gZnVuY3Rpb24gKGV2ZW50LCBmbikgewogICAgdmFyIHZtID0gdGhpczsgLy8gYWxsCgogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICByZXR1cm4gdm07CiAgICB9IC8vIGFycmF5IG9mIGV2ZW50cwoKCiAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudCkpIHsKICAgICAgZm9yICh2YXIgaSQxID0gMCwgbCA9IGV2ZW50Lmxlbmd0aDsgaSQxIDwgbDsgaSQxKyspIHsKICAgICAgICB2bS4kb2ZmKGV2ZW50W2kkMV0sIGZuKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHZtOwogICAgfSAvLyBzcGVjaWZpYyBldmVudAoKCiAgICB2YXIgY2JzID0gdm0uX2V2ZW50c1tldmVudF07CgogICAgaWYgKCFjYnMpIHsKICAgICAgcmV0dXJuIHZtOwogICAgfQoKICAgIGlmICghZm4pIHsKICAgICAgdm0uX2V2ZW50c1tldmVudF0gPSBudWxsOwogICAgICByZXR1cm4gdm07CiAgICB9IC8vIHNwZWNpZmljIGhhbmRsZXIKCgogICAgdmFyIGNiOwogICAgdmFyIGkgPSBjYnMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgY2IgPSBjYnNbaV07CgogICAgICBpZiAoY2IgPT09IGZuIHx8IGNiLmZuID09PSBmbikgewogICAgICAgIGNicy5zcGxpY2UoaSwgMSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdm07CiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kZW1pdCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB2YXIgbG93ZXJDYXNlRXZlbnQgPSBldmVudC50b0xvd2VyQ2FzZSgpOwoKICAgICAgaWYgKGxvd2VyQ2FzZUV2ZW50ICE9PSBldmVudCAmJiB2bS5fZXZlbnRzW2xvd2VyQ2FzZUV2ZW50XSkgewogICAgICAgIHRpcCgiRXZlbnQgXCIiICsgbG93ZXJDYXNlRXZlbnQgKyAiXCIgaXMgZW1pdHRlZCBpbiBjb21wb25lbnQgIiArIGZvcm1hdENvbXBvbmVudE5hbWUodm0pICsgIiBidXQgdGhlIGhhbmRsZXIgaXMgcmVnaXN0ZXJlZCBmb3IgXCIiICsgZXZlbnQgKyAiXCIuICIgKyAiTm90ZSB0aGF0IEhUTUwgYXR0cmlidXRlcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZSBhbmQgeW91IGNhbm5vdCB1c2UgIiArICJ2LW9uIHRvIGxpc3RlbiB0byBjYW1lbENhc2UgZXZlbnRzIHdoZW4gdXNpbmcgaW4tRE9NIHRlbXBsYXRlcy4gIiArICJZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIgKyBoeXBoZW5hdGUoZXZlbnQpICsgIlwiIGluc3RlYWQgb2YgXCIiICsgZXZlbnQgKyAiXCIuIik7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgY2JzID0gdm0uX2V2ZW50c1tldmVudF07CgogICAgaWYgKGNicykgewogICAgICBjYnMgPSBjYnMubGVuZ3RoID4gMSA/IHRvQXJyYXkoY2JzKSA6IGNiczsKICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cywgMSk7CiAgICAgIHZhciBpbmZvID0gImV2ZW50IGhhbmRsZXIgZm9yIFwiIiArIGV2ZW50ICsgIlwiIjsKCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2JzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNic1tpXSwgdm0sIGFyZ3MsIHZtLCBpbmZvKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB2bTsKICB9Owp9Ci8qICAqLwoKCnZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CnZhciBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSBmYWxzZTsKCmZ1bmN0aW9uIHNldEFjdGl2ZUluc3RhbmNlKHZtKSB7CiAgdmFyIHByZXZBY3RpdmVJbnN0YW5jZSA9IGFjdGl2ZUluc3RhbmNlOwogIGFjdGl2ZUluc3RhbmNlID0gdm07CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIGFjdGl2ZUluc3RhbmNlID0gcHJldkFjdGl2ZUluc3RhbmNlOwogIH07Cn0KCmZ1bmN0aW9uIGluaXRMaWZlY3ljbGUodm0pIHsKICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOyAvLyBsb2NhdGUgZmlyc3Qgbm9uLWFic3RyYWN0IHBhcmVudAoKICB2YXIgcGFyZW50ID0gb3B0aW9ucy5wYXJlbnQ7CgogIGlmIChwYXJlbnQgJiYgIW9wdGlvbnNbImFic3RyYWN0Il0pIHsKICAgIHdoaWxlIChwYXJlbnQuJG9wdGlvbnNbImFic3RyYWN0Il0gJiYgcGFyZW50LiRwYXJlbnQpIHsKICAgICAgcGFyZW50ID0gcGFyZW50LiRwYXJlbnQ7CiAgICB9CgogICAgcGFyZW50LiRjaGlsZHJlbi5wdXNoKHZtKTsKICB9CgogIHZtLiRwYXJlbnQgPSBwYXJlbnQ7CiAgdm0uJHJvb3QgPSBwYXJlbnQgPyBwYXJlbnQuJHJvb3QgOiB2bTsKICB2bS4kY2hpbGRyZW4gPSBbXTsKICB2bS4kcmVmcyA9IHt9OwogIHZtLl93YXRjaGVyID0gbnVsbDsKICB2bS5faW5hY3RpdmUgPSBudWxsOwogIHZtLl9kaXJlY3RJbmFjdGl2ZSA9IGZhbHNlOwogIHZtLl9pc01vdW50ZWQgPSBmYWxzZTsKICB2bS5faXNEZXN0cm95ZWQgPSBmYWxzZTsKICB2bS5faXNCZWluZ0Rlc3Ryb3llZCA9IGZhbHNlOwp9CgpmdW5jdGlvbiBsaWZlY3ljbGVNaXhpbihWdWUpIHsKICBWdWUucHJvdG90eXBlLl91cGRhdGUgPSBmdW5jdGlvbiAodm5vZGUsIGh5ZHJhdGluZykgewogICAgdmFyIHZtID0gdGhpczsKICAgIHZhciBwcmV2RWwgPSB2bS4kZWw7CiAgICB2YXIgcHJldlZub2RlID0gdm0uX3Zub2RlOwogICAgdmFyIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSA9IHNldEFjdGl2ZUluc3RhbmNlKHZtKTsKICAgIHZtLl92bm9kZSA9IHZub2RlOyAvLyBWdWUucHJvdG90eXBlLl9fcGF0Y2hfXyBpcyBpbmplY3RlZCBpbiBlbnRyeSBwb2ludHMKICAgIC8vIGJhc2VkIG9uIHRoZSByZW5kZXJpbmcgYmFja2VuZCB1c2VkLgoKICAgIGlmICghcHJldlZub2RlKSB7CiAgICAgIC8vIGluaXRpYWwgcmVuZGVyCiAgICAgIHZtLiRlbCA9IHZtLl9fcGF0Y2hfXyh2bS4kZWwsIHZub2RlLCBoeWRyYXRpbmcsIGZhbHNlCiAgICAgIC8qIHJlbW92ZU9ubHkgKi8KICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHVwZGF0ZXMKICAgICAgdm0uJGVsID0gdm0uX19wYXRjaF9fKHByZXZWbm9kZSwgdm5vZGUpOwogICAgfQoKICAgIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSgpOyAvLyB1cGRhdGUgX192dWVfXyByZWZlcmVuY2UKCiAgICBpZiAocHJldkVsKSB7CiAgICAgIHByZXZFbC5fX3Z1ZV9fID0gbnVsbDsKICAgIH0KCiAgICBpZiAodm0uJGVsKSB7CiAgICAgIHZtLiRlbC5fX3Z1ZV9fID0gdm07CiAgICB9IC8vIGlmIHBhcmVudCBpcyBhbiBIT0MsIHVwZGF0ZSBpdHMgJGVsIGFzIHdlbGwKCgogICAgaWYgKHZtLiR2bm9kZSAmJiB2bS4kcGFyZW50ICYmIHZtLiR2bm9kZSA9PT0gdm0uJHBhcmVudC5fdm5vZGUpIHsKICAgICAgdm0uJHBhcmVudC4kZWwgPSB2bS4kZWw7CiAgICB9IC8vIHVwZGF0ZWQgaG9vayBpcyBjYWxsZWQgYnkgdGhlIHNjaGVkdWxlciB0byBlbnN1cmUgdGhhdCBjaGlsZHJlbiBhcmUKICAgIC8vIHVwZGF0ZWQgaW4gYSBwYXJlbnQncyB1cGRhdGVkIGhvb2suCgogIH07CgogIFZ1ZS5wcm90b3R5cGUuJGZvcmNlVXBkYXRlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAodm0uX3dhdGNoZXIpIHsKICAgICAgdm0uX3dhdGNoZXIudXBkYXRlKCk7CiAgICB9CiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgaWYgKHZtLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjYWxsSG9vayh2bSwgJ2JlZm9yZURlc3Ryb3knKTsKICAgIHZtLl9pc0JlaW5nRGVzdHJveWVkID0gdHJ1ZTsgLy8gcmVtb3ZlIHNlbGYgZnJvbSBwYXJlbnQKCiAgICB2YXIgcGFyZW50ID0gdm0uJHBhcmVudDsKCiAgICBpZiAocGFyZW50ICYmICFwYXJlbnQuX2lzQmVpbmdEZXN0cm95ZWQgJiYgIXZtLiRvcHRpb25zWyJhYnN0cmFjdCJdKSB7CiAgICAgIHJlbW92ZShwYXJlbnQuJGNoaWxkcmVuLCB2bSk7CiAgICB9IC8vIHRlYXJkb3duIHdhdGNoZXJzCgoKICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlci50ZWFyZG93bigpOwogICAgfQoKICAgIHZhciBpID0gdm0uX3dhdGNoZXJzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHZtLl93YXRjaGVyc1tpXS50ZWFyZG93bigpOwogICAgfSAvLyByZW1vdmUgcmVmZXJlbmNlIGZyb20gZGF0YSBvYgogICAgLy8gZnJvemVuIG9iamVjdCBtYXkgbm90IGhhdmUgb2JzZXJ2ZXIuCgoKICAgIGlmICh2bS5fZGF0YS5fX29iX18pIHsKICAgICAgdm0uX2RhdGEuX19vYl9fLnZtQ291bnQtLTsKICAgIH0gLy8gY2FsbCB0aGUgbGFzdCBob29rLi4uCgoKICAgIHZtLl9pc0Rlc3Ryb3llZCA9IHRydWU7IC8vIGludm9rZSBkZXN0cm95IGhvb2tzIG9uIGN1cnJlbnQgcmVuZGVyZWQgdHJlZQoKICAgIHZtLl9fcGF0Y2hfXyh2bS5fdm5vZGUsIG51bGwpOyAvLyBmaXJlIGRlc3Ryb3llZCBob29rCgoKICAgIGNhbGxIb29rKHZtLCAnZGVzdHJveWVkJyk7IC8vIHR1cm4gb2ZmIGFsbCBpbnN0YW5jZSBsaXN0ZW5lcnMuCgogICAgdm0uJG9mZigpOyAvLyByZW1vdmUgX192dWVfXyByZWZlcmVuY2UKCiAgICBpZiAodm0uJGVsKSB7CiAgICAgIHZtLiRlbC5fX3Z1ZV9fID0gbnVsbDsKICAgIH0gLy8gcmVsZWFzZSBjaXJjdWxhciByZWZlcmVuY2UgKCM2NzU5KQoKCiAgICBpZiAodm0uJHZub2RlKSB7CiAgICAgIHZtLiR2bm9kZS5wYXJlbnQgPSBudWxsOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIG1vdW50Q29tcG9uZW50KHZtLCBlbCwgaHlkcmF0aW5nKSB7CiAgdm0uJGVsID0gZWw7CgogIGlmICghdm0uJG9wdGlvbnMucmVuZGVyKSB7CiAgICB2bS4kb3B0aW9ucy5yZW5kZXIgPSBjcmVhdGVFbXB0eVZOb2RlOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAodm0uJG9wdGlvbnMudGVtcGxhdGUgJiYgdm0uJG9wdGlvbnMudGVtcGxhdGUuY2hhckF0KDApICE9PSAnIycgfHwgdm0uJG9wdGlvbnMuZWwgfHwgZWwpIHsKICAgICAgICB3YXJuKCdZb3UgYXJlIHVzaW5nIHRoZSBydW50aW1lLW9ubHkgYnVpbGQgb2YgVnVlIHdoZXJlIHRoZSB0ZW1wbGF0ZSAnICsgJ2NvbXBpbGVyIGlzIG5vdCBhdmFpbGFibGUuIEVpdGhlciBwcmUtY29tcGlsZSB0aGUgdGVtcGxhdGVzIGludG8gJyArICdyZW5kZXIgZnVuY3Rpb25zLCBvciB1c2UgdGhlIGNvbXBpbGVyLWluY2x1ZGVkIGJ1aWxkLicsIHZtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKCdGYWlsZWQgdG8gbW91bnQgY29tcG9uZW50OiB0ZW1wbGF0ZSBvciByZW5kZXIgZnVuY3Rpb24gbm90IGRlZmluZWQuJywgdm0pOwogICAgICB9CiAgICB9CiAgfQoKICBjYWxsSG9vayh2bSwgJ2JlZm9yZU1vdW50Jyk7CiAgdmFyIHVwZGF0ZUNvbXBvbmVudDsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgIHVwZGF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudCgpIHsKICAgICAgdmFyIG5hbWUgPSB2bS5fbmFtZTsKICAgICAgdmFyIGlkID0gdm0uX3VpZDsKICAgICAgdmFyIHN0YXJ0VGFnID0gInZ1ZS1wZXJmLXN0YXJ0OiIgKyBpZDsKICAgICAgdmFyIGVuZFRhZyA9ICJ2dWUtcGVyZi1lbmQ6IiArIGlkOwogICAgICBtYXJrKHN0YXJ0VGFnKTsKCiAgICAgIHZhciB2bm9kZSA9IHZtLl9yZW5kZXIoKTsKCiAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgbWVhc3VyZSgidnVlICIgKyBuYW1lICsgIiByZW5kZXIiLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgbWFyayhzdGFydFRhZyk7CgogICAgICB2bS5fdXBkYXRlKHZub2RlLCBoeWRyYXRpbmcpOwoKICAgICAgbWFyayhlbmRUYWcpOwogICAgICBtZWFzdXJlKCJ2dWUgIiArIG5hbWUgKyAiIHBhdGNoIiwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9OwogIH0gZWxzZSB7CiAgICB1cGRhdGVDb21wb25lbnQgPSBmdW5jdGlvbiB1cGRhdGVDb21wb25lbnQoKSB7CiAgICAgIHZtLl91cGRhdGUodm0uX3JlbmRlcigpLCBoeWRyYXRpbmcpOwogICAgfTsKICB9IC8vIHdlIHNldCB0aGlzIHRvIHZtLl93YXRjaGVyIGluc2lkZSB0aGUgd2F0Y2hlcidzIGNvbnN0cnVjdG9yCiAgLy8gc2luY2UgdGhlIHdhdGNoZXIncyBpbml0aWFsIHBhdGNoIG1heSBjYWxsICRmb3JjZVVwZGF0ZSAoZS5nLiBpbnNpZGUgY2hpbGQKICAvLyBjb21wb25lbnQncyBtb3VudGVkIGhvb2spLCB3aGljaCByZWxpZXMgb24gdm0uX3dhdGNoZXIgYmVpbmcgYWxyZWFkeSBkZWZpbmVkCgoKICBuZXcgV2F0Y2hlcih2bSwgdXBkYXRlQ29tcG9uZW50LCBub29wLCB7CiAgICBiZWZvcmU6IGZ1bmN0aW9uIGJlZm9yZSgpIHsKICAgICAgaWYgKHZtLl9pc01vdW50ZWQgJiYgIXZtLl9pc0Rlc3Ryb3llZCkgewogICAgICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlVXBkYXRlJyk7CiAgICAgIH0KICAgIH0KICB9LCB0cnVlCiAgLyogaXNSZW5kZXJXYXRjaGVyICovCiAgKTsKICBoeWRyYXRpbmcgPSBmYWxzZTsgLy8gbWFudWFsbHkgbW91bnRlZCBpbnN0YW5jZSwgY2FsbCBtb3VudGVkIG9uIHNlbGYKICAvLyBtb3VudGVkIGlzIGNhbGxlZCBmb3IgcmVuZGVyLWNyZWF0ZWQgY2hpbGQgY29tcG9uZW50cyBpbiBpdHMgaW5zZXJ0ZWQgaG9vawoKICBpZiAodm0uJHZub2RlID09IG51bGwpIHsKICAgIHZtLl9pc01vdW50ZWQgPSB0cnVlOwogICAgY2FsbEhvb2sodm0sICdtb3VudGVkJyk7CiAgfQoKICByZXR1cm4gdm07Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNoaWxkQ29tcG9uZW50KHZtLCBwcm9wc0RhdGEsIGxpc3RlbmVycywgcGFyZW50Vm5vZGUsIHJlbmRlckNoaWxkcmVuKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IHRydWU7CiAgfSAvLyBkZXRlcm1pbmUgd2hldGhlciBjb21wb25lbnQgaGFzIHNsb3QgY2hpbGRyZW4KICAvLyB3ZSBuZWVkIHRvIGRvIHRoaXMgYmVmb3JlIG92ZXJ3cml0aW5nICRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbi4KICAvLyBjaGVjayBpZiB0aGVyZSBhcmUgZHluYW1pYyBzY29wZWRTbG90cyAoaGFuZC13cml0dGVuIG9yIGNvbXBpbGVkIGJ1dCB3aXRoCiAgLy8gZHluYW1pYyBzbG90IG5hbWVzKS4gU3RhdGljIHNjb3BlZCBzbG90cyBjb21waWxlZCBmcm9tIHRlbXBsYXRlIGhhcyB0aGUKICAvLyAiJHN0YWJsZSIgbWFya2VyLgoKCiAgdmFyIG5ld1Njb3BlZFNsb3RzID0gcGFyZW50Vm5vZGUuZGF0YS5zY29wZWRTbG90czsKICB2YXIgb2xkU2NvcGVkU2xvdHMgPSB2bS4kc2NvcGVkU2xvdHM7CiAgdmFyIGhhc0R5bmFtaWNTY29wZWRTbG90ID0gISEobmV3U2NvcGVkU2xvdHMgJiYgIW5ld1Njb3BlZFNsb3RzLiRzdGFibGUgfHwgb2xkU2NvcGVkU2xvdHMgIT09IGVtcHR5T2JqZWN0ICYmICFvbGRTY29wZWRTbG90cy4kc3RhYmxlIHx8IG5ld1Njb3BlZFNsb3RzICYmIHZtLiRzY29wZWRTbG90cy4ka2V5ICE9PSBuZXdTY29wZWRTbG90cy4ka2V5KTsgLy8gQW55IHN0YXRpYyBzbG90IGNoaWxkcmVuIGZyb20gdGhlIHBhcmVudCBtYXkgaGF2ZSBjaGFuZ2VkIGR1cmluZyBwYXJlbnQncwogIC8vIHVwZGF0ZS4gRHluYW1pYyBzY29wZWQgc2xvdHMgbWF5IGFsc28gaGF2ZSBjaGFuZ2VkLiBJbiBzdWNoIGNhc2VzLCBhIGZvcmNlZAogIC8vIHVwZGF0ZSBpcyBuZWNlc3NhcnkgdG8gZW5zdXJlIGNvcnJlY3RuZXNzLgoKICB2YXIgbmVlZHNGb3JjZVVwZGF0ZSA9ICEhKHJlbmRlckNoaWxkcmVuIHx8IC8vIGhhcyBuZXcgc3RhdGljIHNsb3RzCiAgdm0uJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuIHx8IC8vIGhhcyBvbGQgc3RhdGljIHNsb3RzCiAgaGFzRHluYW1pY1Njb3BlZFNsb3QpOwogIHZtLiRvcHRpb25zLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwogIHZtLiR2bm9kZSA9IHBhcmVudFZub2RlOyAvLyB1cGRhdGUgdm0ncyBwbGFjZWhvbGRlciBub2RlIHdpdGhvdXQgcmUtcmVuZGVyCgogIGlmICh2bS5fdm5vZGUpIHsKICAgIC8vIHVwZGF0ZSBjaGlsZCB0cmVlJ3MgcGFyZW50CiAgICB2bS5fdm5vZGUucGFyZW50ID0gcGFyZW50Vm5vZGU7CiAgfQoKICB2bS4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4gPSByZW5kZXJDaGlsZHJlbjsgLy8gdXBkYXRlICRhdHRycyBhbmQgJGxpc3RlbmVycyBoYXNoCiAgLy8gdGhlc2UgYXJlIGFsc28gcmVhY3RpdmUgc28gdGhleSBtYXkgdHJpZ2dlciBjaGlsZCB1cGRhdGUgaWYgdGhlIGNoaWxkCiAgLy8gdXNlZCB0aGVtIGR1cmluZyByZW5kZXIKCiAgdm0uJGF0dHJzID0gcGFyZW50Vm5vZGUuZGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdDsKICB2bS4kbGlzdGVuZXJzID0gbGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0OyAvLyB1cGRhdGUgcHJvcHMKCiAgaWYgKHByb3BzRGF0YSAmJiB2bS4kb3B0aW9ucy5wcm9wcykgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICAgIHZhciBwcm9wcyA9IHZtLl9wcm9wczsKICAgIHZhciBwcm9wS2V5cyA9IHZtLiRvcHRpb25zLl9wcm9wS2V5cyB8fCBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBwcm9wS2V5c1tpXTsKICAgICAgdmFyIHByb3BPcHRpb25zID0gdm0uJG9wdGlvbnMucHJvcHM7IC8vIHd0ZiBmbG93PwoKICAgICAgcHJvcHNba2V5XSA9IHZhbGlkYXRlUHJvcChrZXksIHByb3BPcHRpb25zLCBwcm9wc0RhdGEsIHZtKTsKICAgIH0KCiAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7IC8vIGtlZXAgYSBjb3B5IG9mIHJhdyBwcm9wc0RhdGEKCiAgICB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgPSBwcm9wc0RhdGE7CiAgfSAvLyB1cGRhdGUgbGlzdGVuZXJzCgoKICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3Q7CiAgdmFyIG9sZExpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CiAgdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyA9IGxpc3RlbmVyczsKICB1cGRhdGVDb21wb25lbnRMaXN0ZW5lcnModm0sIGxpc3RlbmVycywgb2xkTGlzdGVuZXJzKTsgLy8gcmVzb2x2ZSBzbG90cyArIGZvcmNlIHVwZGF0ZSBpZiBoYXMgY2hpbGRyZW4KCiAgaWYgKG5lZWRzRm9yY2VVcGRhdGUpIHsKICAgIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhyZW5kZXJDaGlsZHJlbiwgcGFyZW50Vm5vZGUuY29udGV4dCk7CiAgICB2bS4kZm9yY2VVcGRhdGUoKTsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSBmYWxzZTsKICB9Cn0KCmZ1bmN0aW9uIGlzSW5JbmFjdGl2ZVRyZWUodm0pIHsKICB3aGlsZSAodm0gJiYgKHZtID0gdm0uJHBhcmVudCkpIHsKICAgIGlmICh2bS5faW5hY3RpdmUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQoKICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0sIGRpcmVjdCkgewogIGlmIChkaXJlY3QpIHsKICAgIHZtLl9kaXJlY3RJbmFjdGl2ZSA9IGZhbHNlOwoKICAgIGlmIChpc0luSW5hY3RpdmVUcmVlKHZtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgfSBlbHNlIGlmICh2bS5fZGlyZWN0SW5hY3RpdmUpIHsKICAgIHJldHVybjsKICB9CgogIGlmICh2bS5faW5hY3RpdmUgfHwgdm0uX2luYWN0aXZlID09PSBudWxsKSB7CiAgICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZtLiRjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CgogICAgY2FsbEhvb2sodm0sICdhY3RpdmF0ZWQnKTsKICB9Cn0KCmZ1bmN0aW9uIGRlYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bSwgZGlyZWN0KSB7CiAgaWYgKGRpcmVjdCkgewogICAgdm0uX2RpcmVjdEluYWN0aXZlID0gdHJ1ZTsKCiAgICBpZiAoaXNJbkluYWN0aXZlVHJlZSh2bSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogIH0KCiAgaWYgKCF2bS5faW5hY3RpdmUpIHsKICAgIHZtLl9pbmFjdGl2ZSA9IHRydWU7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bS4kY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICB9CgogICAgY2FsbEhvb2sodm0sICdkZWFjdGl2YXRlZCcpOwogIH0KfQoKZnVuY3Rpb24gY2FsbEhvb2sodm0sIGhvb2spIHsKICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgbGlmZWN5Y2xlIGhvb2tzCiAgcHVzaFRhcmdldCgpOwogIHZhciBoYW5kbGVycyA9IHZtLiRvcHRpb25zW2hvb2tdOwogIHZhciBpbmZvID0gaG9vayArICIgaG9vayI7CgogIGlmIChoYW5kbGVycykgewogICAgZm9yICh2YXIgaSA9IDAsIGogPSBoYW5kbGVycy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoaGFuZGxlcnNbaV0sIHZtLCBudWxsLCB2bSwgaW5mbyk7CiAgICB9CiAgfQoKICBpZiAodm0uX2hhc0hvb2tFdmVudCkgewogICAgdm0uJGVtaXQoJ2hvb2s6JyArIGhvb2spOwogIH0KCiAgcG9wVGFyZ2V0KCk7Cn0KLyogICovCgoKdmFyIE1BWF9VUERBVEVfQ09VTlQgPSAxMDA7CnZhciBxdWV1ZSA9IFtdOwp2YXIgYWN0aXZhdGVkQ2hpbGRyZW4gPSBbXTsKdmFyIGhhcyA9IHt9Owp2YXIgY2lyY3VsYXIgPSB7fTsKdmFyIHdhaXRpbmcgPSBmYWxzZTsKdmFyIGZsdXNoaW5nID0gZmFsc2U7CnZhciBpbmRleCA9IDA7Ci8qKgogKiBSZXNldCB0aGUgc2NoZWR1bGVyJ3Mgc3RhdGUuCiAqLwoKZnVuY3Rpb24gcmVzZXRTY2hlZHVsZXJTdGF0ZSgpIHsKICBpbmRleCA9IHF1ZXVlLmxlbmd0aCA9IGFjdGl2YXRlZENoaWxkcmVuLmxlbmd0aCA9IDA7CiAgaGFzID0ge307CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBjaXJjdWxhciA9IHt9OwogIH0KCiAgd2FpdGluZyA9IGZsdXNoaW5nID0gZmFsc2U7Cn0gLy8gQXN5bmMgZWRnZSBjYXNlICM2NTY2IHJlcXVpcmVzIHNhdmluZyB0aGUgdGltZXN0YW1wIHdoZW4gZXZlbnQgbGlzdGVuZXJzIGFyZQovLyBhdHRhY2hlZC4gSG93ZXZlciwgY2FsbGluZyBwZXJmb3JtYW5jZS5ub3coKSBoYXMgYSBwZXJmIG92ZXJoZWFkIGVzcGVjaWFsbHkKLy8gaWYgdGhlIHBhZ2UgaGFzIHRob3VzYW5kcyBvZiBldmVudCBsaXN0ZW5lcnMuIEluc3RlYWQsIHdlIHRha2UgYSB0aW1lc3RhbXAKLy8gZXZlcnkgdGltZSB0aGUgc2NoZWR1bGVyIGZsdXNoZXMgYW5kIHVzZSB0aGF0IGZvciBhbGwgZXZlbnQgbGlzdGVuZXJzCi8vIGF0dGFjaGVkIGR1cmluZyB0aGF0IGZsdXNoLgoKCnZhciBjdXJyZW50Rmx1c2hUaW1lc3RhbXAgPSAwOyAvLyBBc3luYyBlZGdlIGNhc2UgZml4IHJlcXVpcmVzIHN0b3JpbmcgYW4gZXZlbnQgbGlzdGVuZXIncyBhdHRhY2ggdGltZXN0YW1wLgoKdmFyIGdldE5vdyA9IERhdGUubm93OyAvLyBEZXRlcm1pbmUgd2hhdCBldmVudCB0aW1lc3RhbXAgdGhlIGJyb3dzZXIgaXMgdXNpbmcuIEFubm95aW5nbHksIHRoZQovLyB0aW1lc3RhbXAgY2FuIGVpdGhlciBiZSBoaS1yZXMgKHJlbGF0aXZlIHRvIHBhZ2UgbG9hZCkgb3IgbG93LXJlcwovLyAocmVsYXRpdmUgdG8gVU5JWCBlcG9jaCksIHNvIGluIG9yZGVyIHRvIGNvbXBhcmUgdGltZSB3ZSBoYXZlIHRvIHVzZSB0aGUKLy8gc2FtZSB0aW1lc3RhbXAgdHlwZSB3aGVuIHNhdmluZyB0aGUgZmx1c2ggdGltZXN0YW1wLgovLyBBbGwgSUUgdmVyc2lvbnMgdXNlIGxvdy1yZXMgZXZlbnQgdGltZXN0YW1wcywgYW5kIGhhdmUgcHJvYmxlbWF0aWMgY2xvY2sKLy8gaW1wbGVtZW50YXRpb25zICgjOTYzMikKCmlmIChpbkJyb3dzZXIgJiYgIWlzSUUpIHsKICB2YXIgcGVyZm9ybWFuY2UgPSB3aW5kb3cucGVyZm9ybWFuY2U7CgogIGlmIChwZXJmb3JtYW5jZSAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nICYmIGdldE5vdygpID4gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50JykudGltZVN0YW1wKSB7CiAgICAvLyBpZiB0aGUgZXZlbnQgdGltZXN0YW1wLCBhbHRob3VnaCBldmFsdWF0ZWQgQUZURVIgdGhlIERhdGUubm93KCksIGlzCiAgICAvLyBzbWFsbGVyIHRoYW4gaXQsIGl0IG1lYW5zIHRoZSBldmVudCBpcyB1c2luZyBhIGhpLXJlcyB0aW1lc3RhbXAsCiAgICAvLyBhbmQgd2UgbmVlZCB0byB1c2UgdGhlIGhpLXJlcyB2ZXJzaW9uIGZvciBldmVudCBsaXN0ZW5lciB0aW1lc3RhbXBzIGFzCiAgICAvLyB3ZWxsLgogICAgZ2V0Tm93ID0gZnVuY3Rpb24gZ2V0Tm93KCkgewogICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB9OwogIH0KfQovKioKICogRmx1c2ggYm90aCBxdWV1ZXMgYW5kIHJ1biB0aGUgd2F0Y2hlcnMuCiAqLwoKCmZ1bmN0aW9uIGZsdXNoU2NoZWR1bGVyUXVldWUoKSB7CiAgY3VycmVudEZsdXNoVGltZXN0YW1wID0gZ2V0Tm93KCk7CiAgZmx1c2hpbmcgPSB0cnVlOwogIHZhciB3YXRjaGVyLCBpZDsgLy8gU29ydCBxdWV1ZSBiZWZvcmUgZmx1c2guCiAgLy8gVGhpcyBlbnN1cmVzIHRoYXQ6CiAgLy8gMS4gQ29tcG9uZW50cyBhcmUgdXBkYXRlZCBmcm9tIHBhcmVudCB0byBjaGlsZC4gKGJlY2F1c2UgcGFyZW50IGlzIGFsd2F5cwogIC8vICAgIGNyZWF0ZWQgYmVmb3JlIHRoZSBjaGlsZCkKICAvLyAyLiBBIGNvbXBvbmVudCdzIHVzZXIgd2F0Y2hlcnMgYXJlIHJ1biBiZWZvcmUgaXRzIHJlbmRlciB3YXRjaGVyIChiZWNhdXNlCiAgLy8gICAgdXNlciB3YXRjaGVycyBhcmUgY3JlYXRlZCBiZWZvcmUgdGhlIHJlbmRlciB3YXRjaGVyKQogIC8vIDMuIElmIGEgY29tcG9uZW50IGlzIGRlc3Ryb3llZCBkdXJpbmcgYSBwYXJlbnQgY29tcG9uZW50J3Mgd2F0Y2hlciBydW4sCiAgLy8gICAgaXRzIHdhdGNoZXJzIGNhbiBiZSBza2lwcGVkLgoKICBxdWV1ZS5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gYS5pZCAtIGIuaWQ7CiAgfSk7IC8vIGRvIG5vdCBjYWNoZSBsZW5ndGggYmVjYXVzZSBtb3JlIHdhdGNoZXJzIG1pZ2h0IGJlIHB1c2hlZAogIC8vIGFzIHdlIHJ1biBleGlzdGluZyB3YXRjaGVycwoKICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBxdWV1ZS5sZW5ndGg7IGluZGV4KyspIHsKICAgIHdhdGNoZXIgPSBxdWV1ZVtpbmRleF07CgogICAgaWYgKHdhdGNoZXIuYmVmb3JlKSB7CiAgICAgIHdhdGNoZXIuYmVmb3JlKCk7CiAgICB9CgogICAgaWQgPSB3YXRjaGVyLmlkOwogICAgaGFzW2lkXSA9IG51bGw7CiAgICB3YXRjaGVyLnJ1bigpOyAvLyBpbiBkZXYgYnVpbGQsIGNoZWNrIGFuZCBzdG9wIGNpcmN1bGFyIHVwZGF0ZXMuCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaGFzW2lkXSAhPSBudWxsKSB7CiAgICAgIGNpcmN1bGFyW2lkXSA9IChjaXJjdWxhcltpZF0gfHwgMCkgKyAxOwoKICAgICAgaWYgKGNpcmN1bGFyW2lkXSA+IE1BWF9VUERBVEVfQ09VTlQpIHsKICAgICAgICB3YXJuKCdZb3UgbWF5IGhhdmUgYW4gaW5maW5pdGUgdXBkYXRlIGxvb3AgJyArICh3YXRjaGVyLnVzZXIgPyAiaW4gd2F0Y2hlciB3aXRoIGV4cHJlc3Npb24gXCIiICsgd2F0Y2hlci5leHByZXNzaW9uICsgIlwiIiA6ICJpbiBhIGNvbXBvbmVudCByZW5kZXIgZnVuY3Rpb24uIiksIHdhdGNoZXIudm0pOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfSAvLyBrZWVwIGNvcGllcyBvZiBwb3N0IHF1ZXVlcyBiZWZvcmUgcmVzZXR0aW5nIHN0YXRlCgoKICB2YXIgYWN0aXZhdGVkUXVldWUgPSBhY3RpdmF0ZWRDaGlsZHJlbi5zbGljZSgpOwogIHZhciB1cGRhdGVkUXVldWUgPSBxdWV1ZS5zbGljZSgpOwogIHJlc2V0U2NoZWR1bGVyU3RhdGUoKTsgLy8gY2FsbCBjb21wb25lbnQgdXBkYXRlZCBhbmQgYWN0aXZhdGVkIGhvb2tzCgogIGNhbGxBY3RpdmF0ZWRIb29rcyhhY3RpdmF0ZWRRdWV1ZSk7CiAgY2FsbFVwZGF0ZWRIb29rcyh1cGRhdGVkUXVldWUpOyAvLyBkZXZ0b29sIGhvb2sKCiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChkZXZ0b29scyAmJiBjb25maWcuZGV2dG9vbHMpIHsKICAgIGRldnRvb2xzLmVtaXQoJ2ZsdXNoJyk7CiAgfQp9CgpmdW5jdGlvbiBjYWxsVXBkYXRlZEhvb2tzKHF1ZXVlKSB7CiAgdmFyIGkgPSBxdWV1ZS5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHZhciB3YXRjaGVyID0gcXVldWVbaV07CiAgICB2YXIgdm0gPSB3YXRjaGVyLnZtOwoKICAgIGlmICh2bS5fd2F0Y2hlciA9PT0gd2F0Y2hlciAmJiB2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgY2FsbEhvb2sodm0sICd1cGRhdGVkJyk7CiAgICB9CiAgfQp9Ci8qKgogKiBRdWV1ZSBhIGtlcHQtYWxpdmUgY29tcG9uZW50IHRoYXQgd2FzIGFjdGl2YXRlZCBkdXJpbmcgcGF0Y2guCiAqIFRoZSBxdWV1ZSB3aWxsIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgZW50aXJlIHRyZWUgaGFzIGJlZW4gcGF0Y2hlZC4KICovCgoKZnVuY3Rpb24gcXVldWVBY3RpdmF0ZWRDb21wb25lbnQodm0pIHsKICAvLyBzZXR0aW5nIF9pbmFjdGl2ZSB0byBmYWxzZSBoZXJlIHNvIHRoYXQgYSByZW5kZXIgZnVuY3Rpb24gY2FuCiAgLy8gcmVseSBvbiBjaGVja2luZyB3aGV0aGVyIGl0J3MgaW4gYW4gaW5hY3RpdmUgdHJlZSAoZS5nLiByb3V0ZXItdmlldykKICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKICBhY3RpdmF0ZWRDaGlsZHJlbi5wdXNoKHZtKTsKfQoKZnVuY3Rpb24gY2FsbEFjdGl2YXRlZEhvb2tzKHF1ZXVlKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgcXVldWVbaV0uX2luYWN0aXZlID0gdHJ1ZTsKICAgIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQocXVldWVbaV0sIHRydWUKICAgIC8qIHRydWUgKi8KICAgICk7CiAgfQp9Ci8qKgogKiBQdXNoIGEgd2F0Y2hlciBpbnRvIHRoZSB3YXRjaGVyIHF1ZXVlLgogKiBKb2JzIHdpdGggZHVwbGljYXRlIElEcyB3aWxsIGJlIHNraXBwZWQgdW5sZXNzIGl0J3MKICogcHVzaGVkIHdoZW4gdGhlIHF1ZXVlIGlzIGJlaW5nIGZsdXNoZWQuCiAqLwoKCmZ1bmN0aW9uIHF1ZXVlV2F0Y2hlcih3YXRjaGVyKSB7CiAgdmFyIGlkID0gd2F0Y2hlci5pZDsKCiAgaWYgKGhhc1tpZF0gPT0gbnVsbCkgewogICAgaGFzW2lkXSA9IHRydWU7CgogICAgaWYgKCFmbHVzaGluZykgewogICAgICBxdWV1ZS5wdXNoKHdhdGNoZXIpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgYWxyZWFkeSBmbHVzaGluZywgc3BsaWNlIHRoZSB3YXRjaGVyIGJhc2VkIG9uIGl0cyBpZAogICAgICAvLyBpZiBhbHJlYWR5IHBhc3QgaXRzIGlkLCBpdCB3aWxsIGJlIHJ1biBuZXh0IGltbWVkaWF0ZWx5LgogICAgICB2YXIgaSA9IHF1ZXVlLmxlbmd0aCAtIDE7CgogICAgICB3aGlsZSAoaSA+IGluZGV4ICYmIHF1ZXVlW2ldLmlkID4gd2F0Y2hlci5pZCkgewogICAgICAgIGktLTsKICAgICAgfQoKICAgICAgcXVldWUuc3BsaWNlKGkgKyAxLCAwLCB3YXRjaGVyKTsKICAgIH0gLy8gcXVldWUgdGhlIGZsdXNoCgoKICAgIGlmICghd2FpdGluZykgewogICAgICB3YWl0aW5nID0gdHJ1ZTsKCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb25maWcuYXN5bmMpIHsKICAgICAgICBmbHVzaFNjaGVkdWxlclF1ZXVlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBuZXh0VGljayhmbHVzaFNjaGVkdWxlclF1ZXVlKTsKICAgIH0KICB9Cn0KLyogICovCgoKdmFyIHVpZCQyID0gMDsKLyoqCiAqIEEgd2F0Y2hlciBwYXJzZXMgYW4gZXhwcmVzc2lvbiwgY29sbGVjdHMgZGVwZW5kZW5jaWVzLAogKiBhbmQgZmlyZXMgY2FsbGJhY2sgd2hlbiB0aGUgZXhwcmVzc2lvbiB2YWx1ZSBjaGFuZ2VzLgogKiBUaGlzIGlzIHVzZWQgZm9yIGJvdGggdGhlICR3YXRjaCgpIGFwaSBhbmQgZGlyZWN0aXZlcy4KICovCgp2YXIgV2F0Y2hlciA9IGZ1bmN0aW9uIFdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zLCBpc1JlbmRlcldhdGNoZXIpIHsKICB0aGlzLnZtID0gdm07CgogIGlmIChpc1JlbmRlcldhdGNoZXIpIHsKICAgIHZtLl93YXRjaGVyID0gdGhpczsKICB9CgogIHZtLl93YXRjaGVycy5wdXNoKHRoaXMpOyAvLyBvcHRpb25zCgoKICBpZiAob3B0aW9ucykgewogICAgdGhpcy5kZWVwID0gISFvcHRpb25zLmRlZXA7CiAgICB0aGlzLnVzZXIgPSAhIW9wdGlvbnMudXNlcjsKICAgIHRoaXMubGF6eSA9ICEhb3B0aW9ucy5sYXp5OwogICAgdGhpcy5zeW5jID0gISFvcHRpb25zLnN5bmM7CiAgICB0aGlzLmJlZm9yZSA9IG9wdGlvbnMuYmVmb3JlOwogIH0gZWxzZSB7CiAgICB0aGlzLmRlZXAgPSB0aGlzLnVzZXIgPSB0aGlzLmxhenkgPSB0aGlzLnN5bmMgPSBmYWxzZTsKICB9CgogIHRoaXMuY2IgPSBjYjsKICB0aGlzLmlkID0gKyt1aWQkMjsgLy8gdWlkIGZvciBiYXRjaGluZwoKICB0aGlzLmFjdGl2ZSA9IHRydWU7CiAgdGhpcy5kaXJ0eSA9IHRoaXMubGF6eTsgLy8gZm9yIGxhenkgd2F0Y2hlcnMKCiAgdGhpcy5kZXBzID0gW107CiAgdGhpcy5uZXdEZXBzID0gW107CiAgdGhpcy5kZXBJZHMgPSBuZXcgX1NldCgpOwogIHRoaXMubmV3RGVwSWRzID0gbmV3IF9TZXQoKTsKICB0aGlzLmV4cHJlc3Npb24gPSBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gZXhwT3JGbi50b1N0cmluZygpIDogJyc7IC8vIHBhcnNlIGV4cHJlc3Npb24gZm9yIGdldHRlcgoKICBpZiAodHlwZW9mIGV4cE9yRm4gPT09ICdmdW5jdGlvbicpIHsKICAgIHRoaXMuZ2V0dGVyID0gZXhwT3JGbjsKICB9IGVsc2UgewogICAgdGhpcy5nZXR0ZXIgPSBwYXJzZVBhdGgoZXhwT3JGbik7CgogICAgaWYgKCF0aGlzLmdldHRlcikgewogICAgICB0aGlzLmdldHRlciA9IG5vb3A7CiAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiRmFpbGVkIHdhdGNoaW5nIHBhdGg6IFwiIiArIGV4cE9yRm4gKyAiXCIgIiArICdXYXRjaGVyIG9ubHkgYWNjZXB0cyBzaW1wbGUgZG90LWRlbGltaXRlZCBwYXRocy4gJyArICdGb3IgZnVsbCBjb250cm9sLCB1c2UgYSBmdW5jdGlvbiBpbnN0ZWFkLicsIHZtKTsKICAgIH0KICB9CgogIHRoaXMudmFsdWUgPSB0aGlzLmxhenkgPyB1bmRlZmluZWQgOiB0aGlzLmdldCgpOwp9OwovKioKICogRXZhbHVhdGUgdGhlIGdldHRlciwgYW5kIHJlLWNvbGxlY3QgZGVwZW5kZW5jaWVzLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQoKSB7CiAgcHVzaFRhcmdldCh0aGlzKTsKICB2YXIgdmFsdWU7CiAgdmFyIHZtID0gdGhpcy52bTsKCiAgdHJ5IHsKICAgIHZhbHVlID0gdGhpcy5nZXR0ZXIuY2FsbCh2bSwgdm0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmICh0aGlzLnVzZXIpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJnZXR0ZXIgZm9yIHdhdGNoZXIgXCIiICsgdGhpcy5leHByZXNzaW9uICsgIlwiIik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBlOwogICAgfQogIH0gZmluYWxseSB7CiAgICAvLyAidG91Y2giIGV2ZXJ5IHByb3BlcnR5IHNvIHRoZXkgYXJlIGFsbCB0cmFja2VkIGFzCiAgICAvLyBkZXBlbmRlbmNpZXMgZm9yIGRlZXAgd2F0Y2hpbmcKICAgIGlmICh0aGlzLmRlZXApIHsKICAgICAgdHJhdmVyc2UodmFsdWUpOwogICAgfQoKICAgIHBvcFRhcmdldCgpOwogICAgdGhpcy5jbGVhbnVwRGVwcygpOwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9OwovKioKICogQWRkIGEgZGVwZW5kZW5jeSB0byB0aGlzIGRpcmVjdGl2ZS4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUuYWRkRGVwID0gZnVuY3Rpb24gYWRkRGVwKGRlcCkgewogIHZhciBpZCA9IGRlcC5pZDsKCiAgaWYgKCF0aGlzLm5ld0RlcElkcy5oYXMoaWQpKSB7CiAgICB0aGlzLm5ld0RlcElkcy5hZGQoaWQpOwogICAgdGhpcy5uZXdEZXBzLnB1c2goZGVwKTsKCiAgICBpZiAoIXRoaXMuZGVwSWRzLmhhcyhpZCkpIHsKICAgICAgZGVwLmFkZFN1Yih0aGlzKTsKICAgIH0KICB9Cn07Ci8qKgogKiBDbGVhbiB1cCBmb3IgZGVwZW5kZW5jeSBjb2xsZWN0aW9uLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5jbGVhbnVwRGVwcyA9IGZ1bmN0aW9uIGNsZWFudXBEZXBzKCkgewogIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgdmFyIGRlcCA9IHRoaXMuZGVwc1tpXTsKCiAgICBpZiAoIXRoaXMubmV3RGVwSWRzLmhhcyhkZXAuaWQpKSB7CiAgICAgIGRlcC5yZW1vdmVTdWIodGhpcyk7CiAgICB9CiAgfQoKICB2YXIgdG1wID0gdGhpcy5kZXBJZHM7CiAgdGhpcy5kZXBJZHMgPSB0aGlzLm5ld0RlcElkczsKICB0aGlzLm5ld0RlcElkcyA9IHRtcDsKICB0aGlzLm5ld0RlcElkcy5jbGVhcigpOwogIHRtcCA9IHRoaXMuZGVwczsKICB0aGlzLmRlcHMgPSB0aGlzLm5ld0RlcHM7CiAgdGhpcy5uZXdEZXBzID0gdG1wOwogIHRoaXMubmV3RGVwcy5sZW5ndGggPSAwOwp9OwovKioKICogU3Vic2NyaWJlciBpbnRlcmZhY2UuCiAqIFdpbGwgYmUgY2FsbGVkIHdoZW4gYSBkZXBlbmRlbmN5IGNoYW5nZXMuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogIGlmICh0aGlzLmxhenkpIHsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwogIH0gZWxzZSBpZiAodGhpcy5zeW5jKSB7CiAgICB0aGlzLnJ1bigpOwogIH0gZWxzZSB7CiAgICBxdWV1ZVdhdGNoZXIodGhpcyk7CiAgfQp9OwovKioKICogU2NoZWR1bGVyIGpvYiBpbnRlcmZhY2UuCiAqIFdpbGwgYmUgY2FsbGVkIGJ5IHRoZSBzY2hlZHVsZXIuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIHJ1bigpIHsKICBpZiAodGhpcy5hY3RpdmUpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CgogICAgaWYgKHZhbHVlICE9PSB0aGlzLnZhbHVlIHx8IC8vIERlZXAgd2F0Y2hlcnMgYW5kIHdhdGNoZXJzIG9uIE9iamVjdC9BcnJheXMgc2hvdWxkIGZpcmUgZXZlbgogICAgLy8gd2hlbiB0aGUgdmFsdWUgaXMgdGhlIHNhbWUsIGJlY2F1c2UgdGhlIHZhbHVlIG1heQogICAgLy8gaGF2ZSBtdXRhdGVkLgogICAgaXNPYmplY3QodmFsdWUpIHx8IHRoaXMuZGVlcCkgewogICAgICAvLyBzZXQgbmV3IHZhbHVlCiAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMudmFsdWU7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKCiAgICAgIGlmICh0aGlzLnVzZXIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdGhpcy5jYi5jYWxsKHRoaXMudm0sIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgaGFuZGxlRXJyb3IoZSwgdGhpcy52bSwgImNhbGxiYWNrIGZvciB3YXRjaGVyIFwiIiArIHRoaXMuZXhwcmVzc2lvbiArICJcIiIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmNiLmNhbGwodGhpcy52bSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgfQogICAgfQogIH0KfTsKLyoqCiAqIEV2YWx1YXRlIHRoZSB2YWx1ZSBvZiB0aGUgd2F0Y2hlci4KICogVGhpcyBvbmx5IGdldHMgY2FsbGVkIGZvciBsYXp5IHdhdGNoZXJzLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogIHRoaXMudmFsdWUgPSB0aGlzLmdldCgpOwogIHRoaXMuZGlydHkgPSBmYWxzZTsKfTsKLyoqCiAqIERlcGVuZCBvbiBhbGwgZGVwcyBjb2xsZWN0ZWQgYnkgdGhpcyB3YXRjaGVyLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5kZXBlbmQgPSBmdW5jdGlvbiBkZXBlbmQoKSB7CiAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwoKICB3aGlsZSAoaS0tKSB7CiAgICB0aGlzLmRlcHNbaV0uZGVwZW5kKCk7CiAgfQp9OwovKioKICogUmVtb3ZlIHNlbGYgZnJvbSBhbGwgZGVwZW5kZW5jaWVzJyBzdWJzY3JpYmVyIGxpc3QuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gdGVhcmRvd24oKSB7CiAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAvLyByZW1vdmUgc2VsZiBmcm9tIHZtJ3Mgd2F0Y2hlciBsaXN0CiAgICAvLyB0aGlzIGlzIGEgc29tZXdoYXQgZXhwZW5zaXZlIG9wZXJhdGlvbiBzbyB3ZSBza2lwIGl0CiAgICAvLyBpZiB0aGUgdm0gaXMgYmVpbmcgZGVzdHJveWVkLgogICAgaWYgKCF0aGlzLnZtLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgIHJlbW92ZSh0aGlzLnZtLl93YXRjaGVycywgdGhpcyk7CiAgICB9CgogICAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdGhpcy5kZXBzW2ldLnJlbW92ZVN1Yih0aGlzKTsKICAgIH0KCiAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogIH0KfTsKLyogICovCgoKdmFyIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbiA9IHsKICBlbnVtZXJhYmxlOiB0cnVlLAogIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICBnZXQ6IG5vb3AsCiAgc2V0OiBub29wCn07CgpmdW5jdGlvbiBwcm94eSh0YXJnZXQsIHNvdXJjZUtleSwga2V5KSB7CiAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IGZ1bmN0aW9uIHByb3h5R2V0dGVyKCkgewogICAgcmV0dXJuIHRoaXNbc291cmNlS2V5XVtrZXldOwogIH07CgogIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBmdW5jdGlvbiBwcm94eVNldHRlcih2YWwpIHsKICAgIHRoaXNbc291cmNlS2V5XVtrZXldID0gdmFsOwogIH07CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uKTsKfQoKZnVuY3Rpb24gaW5pdFN0YXRlKHZtKSB7CiAgdm0uX3dhdGNoZXJzID0gW107CiAgdmFyIG9wdHMgPSB2bS4kb3B0aW9uczsKCiAgaWYgKG9wdHMucHJvcHMpIHsKICAgIGluaXRQcm9wcyh2bSwgb3B0cy5wcm9wcyk7CiAgfQoKICBpZiAob3B0cy5tZXRob2RzKSB7CiAgICBpbml0TWV0aG9kcyh2bSwgb3B0cy5tZXRob2RzKTsKICB9CgogIGlmIChvcHRzLmRhdGEpIHsKICAgIGluaXREYXRhKHZtKTsKICB9IGVsc2UgewogICAgb2JzZXJ2ZSh2bS5fZGF0YSA9IHt9LCB0cnVlCiAgICAvKiBhc1Jvb3REYXRhICovCiAgICApOwogIH0KCiAgaWYgKG9wdHMuY29tcHV0ZWQpIHsKICAgIGluaXRDb21wdXRlZCh2bSwgb3B0cy5jb21wdXRlZCk7CiAgfQoKICBpZiAob3B0cy53YXRjaCAmJiBvcHRzLndhdGNoICE9PSBuYXRpdmVXYXRjaCkgewogICAgaW5pdFdhdGNoKHZtLCBvcHRzLndhdGNoKTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRQcm9wcyh2bSwgcHJvcHNPcHRpb25zKSB7CiAgdmFyIHByb3BzRGF0YSA9IHZtLiRvcHRpb25zLnByb3BzRGF0YSB8fCB7fTsKICB2YXIgcHJvcHMgPSB2bS5fcHJvcHMgPSB7fTsgLy8gY2FjaGUgcHJvcCBrZXlzIHNvIHRoYXQgZnV0dXJlIHByb3BzIHVwZGF0ZXMgY2FuIGl0ZXJhdGUgdXNpbmcgQXJyYXkKICAvLyBpbnN0ZWFkIG9mIGR5bmFtaWMgb2JqZWN0IGtleSBlbnVtZXJhdGlvbi4KCiAgdmFyIGtleXMgPSB2bS4kb3B0aW9ucy5fcHJvcEtleXMgPSBbXTsKICB2YXIgaXNSb290ID0gIXZtLiRwYXJlbnQ7IC8vIHJvb3QgaW5zdGFuY2UgcHJvcHMgc2hvdWxkIGJlIGNvbnZlcnRlZAoKICBpZiAoIWlzUm9vdCkgewogICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICB9CgogIHZhciBsb29wID0gZnVuY3Rpb24gbG9vcChrZXkpIHsKICAgIGtleXMucHVzaChrZXkpOwogICAgdmFyIHZhbHVlID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcHNPcHRpb25zLCBwcm9wc0RhdGEsIHZtKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgdmFyIGh5cGhlbmF0ZWRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKCiAgICAgIGlmIChpc1Jlc2VydmVkQXR0cmlidXRlKGh5cGhlbmF0ZWRLZXkpIHx8IGNvbmZpZy5pc1Jlc2VydmVkQXR0cihoeXBoZW5hdGVkS2V5KSkgewogICAgICAgIHdhcm4oIlwiIiArIGh5cGhlbmF0ZWRLZXkgKyAiXCIgaXMgYSByZXNlcnZlZCBhdHRyaWJ1dGUgYW5kIGNhbm5vdCBiZSB1c2VkIGFzIGNvbXBvbmVudCBwcm9wLiIsIHZtKTsKICAgICAgfQoKICAgICAgZGVmaW5lUmVhY3RpdmUkJDEocHJvcHMsIGtleSwgdmFsdWUsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIWlzUm9vdCAmJiAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50KSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBtdXRhdGluZyBhIHByb3AgZGlyZWN0bHkgc2luY2UgdGhlIHZhbHVlIHdpbGwgYmUgIiArICJvdmVyd3JpdHRlbiB3aGVuZXZlciB0aGUgcGFyZW50IGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsgIkluc3RlYWQsIHVzZSBhIGRhdGEgb3IgY29tcHV0ZWQgcHJvcGVydHkgYmFzZWQgb24gdGhlIHByb3AncyAiICsgInZhbHVlLiBQcm9wIGJlaW5nIG11dGF0ZWQ6IFwiIiArIGtleSArICJcIiIsIHZtKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZGVmaW5lUmVhY3RpdmUkJDEocHJvcHMsIGtleSwgdmFsdWUpOwogICAgfSAvLyBzdGF0aWMgcHJvcHMgYXJlIGFscmVhZHkgcHJveGllZCBvbiB0aGUgY29tcG9uZW50J3MgcHJvdG90eXBlCiAgICAvLyBkdXJpbmcgVnVlLmV4dGVuZCgpLiBXZSBvbmx5IG5lZWQgdG8gcHJveHkgcHJvcHMgZGVmaW5lZCBhdAogICAgLy8gaW5zdGFudGlhdGlvbiBoZXJlLgoKCiAgICBpZiAoIShrZXkgaW4gdm0pKSB7CiAgICAgIHByb3h5KHZtLCAiX3Byb3BzIiwga2V5KTsKICAgIH0KICB9OwoKICBmb3IgKHZhciBrZXkgaW4gcHJvcHNPcHRpb25zKSB7CiAgICBsb29wKGtleSk7CiAgfQoKICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7Cn0KCmZ1bmN0aW9uIGluaXREYXRhKHZtKSB7CiAgdmFyIGRhdGEgPSB2bS4kb3B0aW9ucy5kYXRhOwogIGRhdGEgPSB2bS5fZGF0YSA9IHR5cGVvZiBkYXRhID09PSAnZnVuY3Rpb24nID8gZ2V0RGF0YShkYXRhLCB2bSkgOiBkYXRhIHx8IHt9OwoKICBpZiAoIWlzUGxhaW5PYmplY3QoZGF0YSkpIHsKICAgIGRhdGEgPSB7fTsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybignZGF0YSBmdW5jdGlvbnMgc2hvdWxkIHJldHVybiBhbiBvYmplY3Q6XG4nICsgJ2h0dHBzOi8vdnVlanMub3JnL3YyL2d1aWRlL2NvbXBvbmVudHMuaHRtbCNkYXRhLU11c3QtQmUtYS1GdW5jdGlvbicsIHZtKTsKICB9IC8vIHByb3h5IGRhdGEgb24gaW5zdGFuY2UKCgogIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZGF0YSk7CiAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CiAgdmFyIG1ldGhvZHMgPSB2bS4kb3B0aW9ucy5tZXRob2RzOwogIHZhciBpID0ga2V5cy5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChtZXRob2RzICYmIGhhc093bihtZXRob2RzLCBrZXkpKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIiArIGtleSArICJcIiBoYXMgYWxyZWFkeSBiZWVuIGRlZmluZWQgYXMgYSBkYXRhIHByb3BlcnR5LiIsIHZtKTsKICAgICAgfQogICAgfQoKICAgIGlmIChwcm9wcyAmJiBoYXNPd24ocHJvcHMsIGtleSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJUaGUgZGF0YSBwcm9wZXJ0eSBcIiIgKyBrZXkgKyAiXCIgaXMgYWxyZWFkeSBkZWNsYXJlZCBhcyBhIHByb3AuICIgKyAiVXNlIHByb3AgZGVmYXVsdCB2YWx1ZSBpbnN0ZWFkLiIsIHZtKTsKICAgIH0gZWxzZSBpZiAoIWlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICBwcm94eSh2bSwgIl9kYXRhIiwga2V5KTsKICAgIH0KICB9IC8vIG9ic2VydmUgZGF0YQoKCiAgb2JzZXJ2ZShkYXRhLCB0cnVlCiAgLyogYXNSb290RGF0YSAqLwogICk7Cn0KCmZ1bmN0aW9uIGdldERhdGEoZGF0YSwgdm0pIHsKICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgZGF0YSBnZXR0ZXJzCiAgcHVzaFRhcmdldCgpOwoKICB0cnkgewogICAgcmV0dXJuIGRhdGEuY2FsbCh2bSwgdm0pOwogIH0gY2F0Y2ggKGUpIHsKICAgIGhhbmRsZUVycm9yKGUsIHZtLCAiZGF0YSgpIik7CiAgICByZXR1cm4ge307CiAgfSBmaW5hbGx5IHsKICAgIHBvcFRhcmdldCgpOwogIH0KfQoKdmFyIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMgPSB7CiAgbGF6eTogdHJ1ZQp9OwoKZnVuY3Rpb24gaW5pdENvbXB1dGVkKHZtLCBjb21wdXRlZCkgewogIC8vICRmbG93LWRpc2FibGUtbGluZQogIHZhciB3YXRjaGVycyA9IHZtLl9jb21wdXRlZFdhdGNoZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsgLy8gY29tcHV0ZWQgcHJvcGVydGllcyBhcmUganVzdCBnZXR0ZXJzIGR1cmluZyBTU1IKCiAgdmFyIGlzU1NSID0gaXNTZXJ2ZXJSZW5kZXJpbmcoKTsKCiAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICB2YXIgdXNlckRlZiA9IGNvbXB1dGVkW2tleV07CiAgICB2YXIgZ2V0dGVyID0gdHlwZW9mIHVzZXJEZWYgPT09ICdmdW5jdGlvbicgPyB1c2VyRGVmIDogdXNlckRlZi5nZXQ7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgZ2V0dGVyID09IG51bGwpIHsKICAgICAgd2FybigiR2V0dGVyIGlzIG1pc3NpbmcgZm9yIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIi4iLCB2bSk7CiAgICB9CgogICAgaWYgKCFpc1NTUikgewogICAgICAvLyBjcmVhdGUgaW50ZXJuYWwgd2F0Y2hlciBmb3IgdGhlIGNvbXB1dGVkIHByb3BlcnR5LgogICAgICB3YXRjaGVyc1trZXldID0gbmV3IFdhdGNoZXIodm0sIGdldHRlciB8fCBub29wLCBub29wLCBjb21wdXRlZFdhdGNoZXJPcHRpb25zKTsKICAgIH0gLy8gY29tcG9uZW50LWRlZmluZWQgY29tcHV0ZWQgcHJvcGVydGllcyBhcmUgYWxyZWFkeSBkZWZpbmVkIG9uIHRoZQogICAgLy8gY29tcG9uZW50IHByb3RvdHlwZS4gV2Ugb25seSBuZWVkIHRvIGRlZmluZSBjb21wdXRlZCBwcm9wZXJ0aWVzIGRlZmluZWQKICAgIC8vIGF0IGluc3RhbnRpYXRpb24gaGVyZS4KCgogICAgaWYgKCEoa2V5IGluIHZtKSkgewogICAgICBkZWZpbmVDb21wdXRlZCh2bSwga2V5LCB1c2VyRGVmKTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAoa2V5IGluIHZtLiRkYXRhKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgaW4gZGF0YS4iLCB2bSk7CiAgICAgIH0gZWxzZSBpZiAodm0uJG9wdGlvbnMucHJvcHMgJiYga2V5IGluIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICAgICAgd2FybigiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgYXMgYSBwcm9wLiIsIHZtKTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gZGVmaW5lQ29tcHV0ZWQodGFyZ2V0LCBrZXksIHVzZXJEZWYpIHsKICB2YXIgc2hvdWxkQ2FjaGUgPSAhaXNTZXJ2ZXJSZW5kZXJpbmcoKTsKCiAgaWYgKHR5cGVvZiB1c2VyRGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gc2hvdWxkQ2FjaGUgPyBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpIDogY3JlYXRlR2V0dGVySW52b2tlcih1c2VyRGVmKTsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBub29wOwogIH0gZWxzZSB7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gdXNlckRlZi5nZXQgPyBzaG91bGRDYWNoZSAmJiB1c2VyRGVmLmNhY2hlICE9PSBmYWxzZSA/IGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgOiBjcmVhdGVHZXR0ZXJJbnZva2VyKHVzZXJEZWYuZ2V0KSA6IG5vb3A7CiAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gdXNlckRlZi5zZXQgfHwgbm9vcDsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPT09IG5vb3ApIHsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4oIkNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiB3YXMgYXNzaWduZWQgdG8gYnV0IGl0IGhhcyBubyBzZXR0ZXIuIiwgdGhpcyk7CiAgICB9OwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24pOwp9CgpmdW5jdGlvbiBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpIHsKICByZXR1cm4gZnVuY3Rpb24gY29tcHV0ZWRHZXR0ZXIoKSB7CiAgICB2YXIgd2F0Y2hlciA9IHRoaXMuX2NvbXB1dGVkV2F0Y2hlcnMgJiYgdGhpcy5fY29tcHV0ZWRXYXRjaGVyc1trZXldOwoKICAgIGlmICh3YXRjaGVyKSB7CiAgICAgIGlmICh3YXRjaGVyLmRpcnR5KSB7CiAgICAgICAgd2F0Y2hlci5ldmFsdWF0ZSgpOwogICAgICB9CgogICAgICBpZiAoRGVwLnRhcmdldCkgewogICAgICAgIHdhdGNoZXIuZGVwZW5kKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3YXRjaGVyLnZhbHVlOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUdldHRlckludm9rZXIoZm4pIHsKICByZXR1cm4gZnVuY3Rpb24gY29tcHV0ZWRHZXR0ZXIoKSB7CiAgICByZXR1cm4gZm4uY2FsbCh0aGlzLCB0aGlzKTsKICB9Owp9CgpmdW5jdGlvbiBpbml0TWV0aG9kcyh2bSwgbWV0aG9kcykgewogIHZhciBwcm9wcyA9IHZtLiRvcHRpb25zLnByb3BzOwoKICBmb3IgKHZhciBrZXkgaW4gbWV0aG9kcykgewogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKHR5cGVvZiBtZXRob2RzW2tleV0gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiICsga2V5ICsgIlwiIGhhcyB0eXBlIFwiIiArIF90eXBlb2YobWV0aG9kc1trZXldKSArICJcIiBpbiB0aGUgY29tcG9uZW50IGRlZmluaXRpb24uICIgKyAiRGlkIHlvdSByZWZlcmVuY2UgdGhlIGZ1bmN0aW9uIGNvcnJlY3RseT8iLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChwcm9wcyAmJiBoYXNPd24ocHJvcHMsIGtleSkpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiICsga2V5ICsgIlwiIGhhcyBhbHJlYWR5IGJlZW4gZGVmaW5lZCBhcyBhIHByb3AuIiwgdm0pOwogICAgICB9CgogICAgICBpZiAoa2V5IGluIHZtICYmIGlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgY29uZmxpY3RzIHdpdGggYW4gZXhpc3RpbmcgVnVlIGluc3RhbmNlIG1ldGhvZC4gIiArICJBdm9pZCBkZWZpbmluZyBjb21wb25lbnQgbWV0aG9kcyB0aGF0IHN0YXJ0IHdpdGggXyBvciAkLiIpOwogICAgICB9CiAgICB9CgogICAgdm1ba2V5XSA9IHR5cGVvZiBtZXRob2RzW2tleV0gIT09ICdmdW5jdGlvbicgPyBub29wIDogYmluZChtZXRob2RzW2tleV0sIHZtKTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRXYXRjaCh2bSwgd2F0Y2gpIHsKICBmb3IgKHZhciBrZXkgaW4gd2F0Y2gpIHsKICAgIHZhciBoYW5kbGVyID0gd2F0Y2hba2V5XTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShoYW5kbGVyKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhbmRsZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICBjcmVhdGVXYXRjaGVyKHZtLCBrZXksIGhhbmRsZXJbaV0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjcmVhdGVXYXRjaGVyKHZtLCBrZXksIGhhbmRsZXIpOwogICAgfQogIH0KfQoKZnVuY3Rpb24gY3JlYXRlV2F0Y2hlcih2bSwgZXhwT3JGbiwgaGFuZGxlciwgb3B0aW9ucykgewogIGlmIChpc1BsYWluT2JqZWN0KGhhbmRsZXIpKSB7CiAgICBvcHRpb25zID0gaGFuZGxlcjsKICAgIGhhbmRsZXIgPSBoYW5kbGVyLmhhbmRsZXI7CiAgfQoKICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdzdHJpbmcnKSB7CiAgICBoYW5kbGVyID0gdm1baGFuZGxlcl07CiAgfQoKICByZXR1cm4gdm0uJHdhdGNoKGV4cE9yRm4sIGhhbmRsZXIsIG9wdGlvbnMpOwp9CgpmdW5jdGlvbiBzdGF0ZU1peGluKFZ1ZSkgewogIC8vIGZsb3cgc29tZWhvdyBoYXMgcHJvYmxlbXMgd2l0aCBkaXJlY3RseSBkZWNsYXJlZCBkZWZpbml0aW9uIG9iamVjdAogIC8vIHdoZW4gdXNpbmcgT2JqZWN0LmRlZmluZVByb3BlcnR5LCBzbyB3ZSBoYXZlIHRvIHByb2NlZHVyYWxseSBidWlsZCB1cAogIC8vIHRoZSBvYmplY3QgaGVyZS4KICB2YXIgZGF0YURlZiA9IHt9OwoKICBkYXRhRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9kYXRhOwogIH07CgogIHZhciBwcm9wc0RlZiA9IHt9OwoKICBwcm9wc0RlZi5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fcHJvcHM7CiAgfTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGRhdGFEZWYuc2V0ID0gZnVuY3Rpb24gKCkgewogICAgICB3YXJuKCdBdm9pZCByZXBsYWNpbmcgaW5zdGFuY2Ugcm9vdCAkZGF0YS4gJyArICdVc2UgbmVzdGVkIGRhdGEgcHJvcGVydGllcyBpbnN0ZWFkLicsIHRoaXMpOwogICAgfTsKCiAgICBwcm9wc0RlZi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4oIiRwcm9wcyBpcyByZWFkb25seS4iLCB0aGlzKTsKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRkYXRhJywgZGF0YURlZik7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZS5wcm90b3R5cGUsICckcHJvcHMnLCBwcm9wc0RlZik7CiAgVnVlLnByb3RvdHlwZS4kc2V0ID0gc2V0OwogIFZ1ZS5wcm90b3R5cGUuJGRlbGV0ZSA9IGRlbDsKCiAgVnVlLnByb3RvdHlwZS4kd2F0Y2ggPSBmdW5jdGlvbiAoZXhwT3JGbiwgY2IsIG9wdGlvbnMpIHsKICAgIHZhciB2bSA9IHRoaXM7CgogICAgaWYgKGlzUGxhaW5PYmplY3QoY2IpKSB7CiAgICAgIHJldHVybiBjcmVhdGVXYXRjaGVyKHZtLCBleHBPckZuLCBjYiwgb3B0aW9ucyk7CiAgICB9CgogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBvcHRpb25zLnVzZXIgPSB0cnVlOwogICAgdmFyIHdhdGNoZXIgPSBuZXcgV2F0Y2hlcih2bSwgZXhwT3JGbiwgY2IsIG9wdGlvbnMpOwoKICAgIGlmIChvcHRpb25zLmltbWVkaWF0ZSkgewogICAgICB0cnkgewogICAgICAgIGNiLmNhbGwodm0sIHdhdGNoZXIudmFsdWUpOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGhhbmRsZUVycm9yKGVycm9yLCB2bSwgImNhbGxiYWNrIGZvciBpbW1lZGlhdGUgd2F0Y2hlciBcIiIgKyB3YXRjaGVyLmV4cHJlc3Npb24gKyAiXCIiKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiB1bndhdGNoRm4oKSB7CiAgICAgIHdhdGNoZXIudGVhcmRvd24oKTsKICAgIH07CiAgfTsKfQovKiAgKi8KCgp2YXIgdWlkJDMgPSAwOwoKZnVuY3Rpb24gaW5pdE1peGluKFZ1ZSkgewogIFZ1ZS5wcm90b3R5cGUuX2luaXQgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdmFyIHZtID0gdGhpczsgLy8gYSB1aWQKCiAgICB2bS5fdWlkID0gdWlkJDMrKzsKICAgIHZhciBzdGFydFRhZywgZW5kVGFnOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgY29uZmlnLnBlcmZvcm1hbmNlICYmIG1hcmspIHsKICAgICAgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6IiArIHZtLl91aWQ7CiAgICAgIGVuZFRhZyA9ICJ2dWUtcGVyZi1lbmQ6IiArIHZtLl91aWQ7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwogICAgfSAvLyBhIGZsYWcgdG8gYXZvaWQgdGhpcyBiZWluZyBvYnNlcnZlZAoKCiAgICB2bS5faXNWdWUgPSB0cnVlOyAvLyBtZXJnZSBvcHRpb25zCgogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5faXNDb21wb25lbnQpIHsKICAgICAgLy8gb3B0aW1pemUgaW50ZXJuYWwgY29tcG9uZW50IGluc3RhbnRpYXRpb24KICAgICAgLy8gc2luY2UgZHluYW1pYyBvcHRpb25zIG1lcmdpbmcgaXMgcHJldHR5IHNsb3csIGFuZCBub25lIG9mIHRoZQogICAgICAvLyBpbnRlcm5hbCBjb21wb25lbnQgb3B0aW9ucyBuZWVkcyBzcGVjaWFsIHRyZWF0bWVudC4KICAgICAgaW5pdEludGVybmFsQ29tcG9uZW50KHZtLCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHZtLiRvcHRpb25zID0gbWVyZ2VPcHRpb25zKHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnModm0uY29uc3RydWN0b3IpLCBvcHRpb25zIHx8IHt9LCB2bSk7CiAgICB9CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwoKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpbml0UHJveHkodm0pOwogICAgfSBlbHNlIHsKICAgICAgdm0uX3JlbmRlclByb3h5ID0gdm07CiAgICB9IC8vIGV4cG9zZSByZWFsIHNlbGYKCgogICAgdm0uX3NlbGYgPSB2bTsKICAgIGluaXRMaWZlY3ljbGUodm0pOwogICAgaW5pdEV2ZW50cyh2bSk7CiAgICBpbml0UmVuZGVyKHZtKTsKICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlQ3JlYXRlJyk7CiAgICBpbml0SW5qZWN0aW9ucyh2bSk7IC8vIHJlc29sdmUgaW5qZWN0aW9ucyBiZWZvcmUgZGF0YS9wcm9wcwoKICAgIGluaXRTdGF0ZSh2bSk7CiAgICBpbml0UHJvdmlkZSh2bSk7IC8vIHJlc29sdmUgcHJvdmlkZSBhZnRlciBkYXRhL3Byb3BzCgogICAgY2FsbEhvb2sodm0sICdjcmVhdGVkJyk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICB2bS5fbmFtZSA9IGZvcm1hdENvbXBvbmVudE5hbWUodm0sIGZhbHNlKTsKICAgICAgbWFyayhlbmRUYWcpOwogICAgICBtZWFzdXJlKCJ2dWUgIiArIHZtLl9uYW1lICsgIiBpbml0Iiwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICB9CgogICAgaWYgKHZtLiRvcHRpb25zLmVsKSB7CiAgICAgIHZtLiRtb3VudCh2bS4kb3B0aW9ucy5lbCk7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gaW5pdEludGVybmFsQ29tcG9uZW50KHZtLCBvcHRpb25zKSB7CiAgdmFyIG9wdHMgPSB2bS4kb3B0aW9ucyA9IE9iamVjdC5jcmVhdGUodm0uY29uc3RydWN0b3Iub3B0aW9ucyk7IC8vIGRvaW5nIHRoaXMgYmVjYXVzZSBpdCdzIGZhc3RlciB0aGFuIGR5bmFtaWMgZW51bWVyYXRpb24uCgogIHZhciBwYXJlbnRWbm9kZSA9IG9wdGlvbnMuX3BhcmVudFZub2RlOwogIG9wdHMucGFyZW50ID0gb3B0aW9ucy5wYXJlbnQ7CiAgb3B0cy5fcGFyZW50Vm5vZGUgPSBwYXJlbnRWbm9kZTsKICB2YXIgdm5vZGVDb21wb25lbnRPcHRpb25zID0gcGFyZW50Vm5vZGUuY29tcG9uZW50T3B0aW9uczsKICBvcHRzLnByb3BzRGF0YSA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGE7CiAgb3B0cy5fcGFyZW50TGlzdGVuZXJzID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmxpc3RlbmVyczsKICBvcHRzLl9yZW5kZXJDaGlsZHJlbiA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy5jaGlsZHJlbjsKICBvcHRzLl9jb21wb25lbnRUYWcgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMudGFnOwoKICBpZiAob3B0aW9ucy5yZW5kZXIpIHsKICAgIG9wdHMucmVuZGVyID0gb3B0aW9ucy5yZW5kZXI7CiAgICBvcHRzLnN0YXRpY1JlbmRlckZucyA9IG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yKSB7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CgogIGlmIChDdG9yWyJzdXBlciJdKSB7CiAgICB2YXIgc3VwZXJPcHRpb25zID0gcmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyhDdG9yWyJzdXBlciJdKTsKICAgIHZhciBjYWNoZWRTdXBlck9wdGlvbnMgPSBDdG9yLnN1cGVyT3B0aW9uczsKCiAgICBpZiAoc3VwZXJPcHRpb25zICE9PSBjYWNoZWRTdXBlck9wdGlvbnMpIHsKICAgICAgLy8gc3VwZXIgb3B0aW9uIGNoYW5nZWQsCiAgICAgIC8vIG5lZWQgdG8gcmVzb2x2ZSBuZXcgb3B0aW9ucy4KICAgICAgQ3Rvci5zdXBlck9wdGlvbnMgPSBzdXBlck9wdGlvbnM7IC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBhbnkgbGF0ZS1tb2RpZmllZC9hdHRhY2hlZCBvcHRpb25zICgjNDk3NikKCiAgICAgIHZhciBtb2RpZmllZE9wdGlvbnMgPSByZXNvbHZlTW9kaWZpZWRPcHRpb25zKEN0b3IpOyAvLyB1cGRhdGUgYmFzZSBleHRlbmQgb3B0aW9ucwoKICAgICAgaWYgKG1vZGlmaWVkT3B0aW9ucykgewogICAgICAgIGV4dGVuZChDdG9yLmV4dGVuZE9wdGlvbnMsIG1vZGlmaWVkT3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoc3VwZXJPcHRpb25zLCBDdG9yLmV4dGVuZE9wdGlvbnMpOwoKICAgICAgaWYgKG9wdGlvbnMubmFtZSkgewogICAgICAgIG9wdGlvbnMuY29tcG9uZW50c1tvcHRpb25zLm5hbWVdID0gQ3RvcjsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIG9wdGlvbnM7Cn0KCmZ1bmN0aW9uIHJlc29sdmVNb2RpZmllZE9wdGlvbnMoQ3RvcikgewogIHZhciBtb2RpZmllZDsKICB2YXIgbGF0ZXN0ID0gQ3Rvci5vcHRpb25zOwogIHZhciBzZWFsZWQgPSBDdG9yLnNlYWxlZE9wdGlvbnM7CgogIGZvciAodmFyIGtleSBpbiBsYXRlc3QpIHsKICAgIGlmIChsYXRlc3Rba2V5XSAhPT0gc2VhbGVkW2tleV0pIHsKICAgICAgaWYgKCFtb2RpZmllZCkgewogICAgICAgIG1vZGlmaWVkID0ge307CiAgICAgIH0KCiAgICAgIG1vZGlmaWVkW2tleV0gPSBsYXRlc3Rba2V5XTsKICAgIH0KICB9CgogIHJldHVybiBtb2RpZmllZDsKfQoKZnVuY3Rpb24gVnVlKG9wdGlvbnMpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAhKHRoaXMgaW5zdGFuY2VvZiBWdWUpKSB7CiAgICB3YXJuKCdWdWUgaXMgYSBjb25zdHJ1Y3RvciBhbmQgc2hvdWxkIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkJyk7CiAgfQoKICB0aGlzLl9pbml0KG9wdGlvbnMpOwp9Cgppbml0TWl4aW4oVnVlKTsKc3RhdGVNaXhpbihWdWUpOwpldmVudHNNaXhpbihWdWUpOwpsaWZlY3ljbGVNaXhpbihWdWUpOwpyZW5kZXJNaXhpbihWdWUpOwovKiAgKi8KCmZ1bmN0aW9uIGluaXRVc2UoVnVlKSB7CiAgVnVlLnVzZSA9IGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgIHZhciBpbnN0YWxsZWRQbHVnaW5zID0gdGhpcy5faW5zdGFsbGVkUGx1Z2lucyB8fCAodGhpcy5faW5zdGFsbGVkUGx1Z2lucyA9IFtdKTsKCiAgICBpZiAoaW5zdGFsbGVkUGx1Z2lucy5pbmRleE9mKHBsdWdpbikgPiAtMSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0gLy8gYWRkaXRpb25hbCBwYXJhbWV0ZXJzCgoKICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgYXJncy51bnNoaWZ0KHRoaXMpOwoKICAgIGlmICh0eXBlb2YgcGx1Z2luLmluc3RhbGwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcGx1Z2luLmluc3RhbGwuYXBwbHkocGx1Z2luLCBhcmdzKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBwbHVnaW4uYXBwbHkobnVsbCwgYXJncyk7CiAgICB9CgogICAgaW5zdGFsbGVkUGx1Z2lucy5wdXNoKHBsdWdpbik7CiAgICByZXR1cm4gdGhpczsKICB9Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRNaXhpbiQxKFZ1ZSkgewogIFZ1ZS5taXhpbiA9IGZ1bmN0aW9uIChtaXhpbikgewogICAgdGhpcy5vcHRpb25zID0gbWVyZ2VPcHRpb25zKHRoaXMub3B0aW9ucywgbWl4aW4pOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0RXh0ZW5kKFZ1ZSkgewogIC8qKgogICAqIEVhY2ggaW5zdGFuY2UgY29uc3RydWN0b3IsIGluY2x1ZGluZyBWdWUsIGhhcyBhIHVuaXF1ZQogICAqIGNpZC4gVGhpcyBlbmFibGVzIHVzIHRvIGNyZWF0ZSB3cmFwcGVkICJjaGlsZAogICAqIGNvbnN0cnVjdG9ycyIgZm9yIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UgYW5kIGNhY2hlIHRoZW0uCiAgICovCiAgVnVlLmNpZCA9IDA7CiAgdmFyIGNpZCA9IDE7CiAgLyoqCiAgICogQ2xhc3MgaW5oZXJpdGFuY2UKICAgKi8KCiAgVnVlLmV4dGVuZCA9IGZ1bmN0aW9uIChleHRlbmRPcHRpb25zKSB7CiAgICBleHRlbmRPcHRpb25zID0gZXh0ZW5kT3B0aW9ucyB8fCB7fTsKICAgIHZhciBTdXBlciA9IHRoaXM7CiAgICB2YXIgU3VwZXJJZCA9IFN1cGVyLmNpZDsKICAgIHZhciBjYWNoZWRDdG9ycyA9IGV4dGVuZE9wdGlvbnMuX0N0b3IgfHwgKGV4dGVuZE9wdGlvbnMuX0N0b3IgPSB7fSk7CgogICAgaWYgKGNhY2hlZEN0b3JzW1N1cGVySWRdKSB7CiAgICAgIHJldHVybiBjYWNoZWRDdG9yc1tTdXBlcklkXTsKICAgIH0KCiAgICB2YXIgbmFtZSA9IGV4dGVuZE9wdGlvbnMubmFtZSB8fCBTdXBlci5vcHRpb25zLm5hbWU7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgbmFtZSkgewogICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSk7CiAgICB9CgogICAgdmFyIFN1YiA9IGZ1bmN0aW9uIFZ1ZUNvbXBvbmVudChvcHRpb25zKSB7CiAgICAgIHRoaXMuX2luaXQob3B0aW9ucyk7CiAgICB9OwoKICAgIFN1Yi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN1cGVyLnByb3RvdHlwZSk7CiAgICBTdWIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3ViOwogICAgU3ViLmNpZCA9IGNpZCsrOwogICAgU3ViLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoU3VwZXIub3B0aW9ucywgZXh0ZW5kT3B0aW9ucyk7CiAgICBTdWJbJ3N1cGVyJ10gPSBTdXBlcjsgLy8gRm9yIHByb3BzIGFuZCBjb21wdXRlZCBwcm9wZXJ0aWVzLCB3ZSBkZWZpbmUgdGhlIHByb3h5IGdldHRlcnMgb24KICAgIC8vIHRoZSBWdWUgaW5zdGFuY2VzIGF0IGV4dGVuc2lvbiB0aW1lLCBvbiB0aGUgZXh0ZW5kZWQgcHJvdG90eXBlLiBUaGlzCiAgICAvLyBhdm9pZHMgT2JqZWN0LmRlZmluZVByb3BlcnR5IGNhbGxzIGZvciBlYWNoIGluc3RhbmNlIGNyZWF0ZWQuCgogICAgaWYgKFN1Yi5vcHRpb25zLnByb3BzKSB7CiAgICAgIGluaXRQcm9wcyQxKFN1Yik7CiAgICB9CgogICAgaWYgKFN1Yi5vcHRpb25zLmNvbXB1dGVkKSB7CiAgICAgIGluaXRDb21wdXRlZCQxKFN1Yik7CiAgICB9IC8vIGFsbG93IGZ1cnRoZXIgZXh0ZW5zaW9uL21peGluL3BsdWdpbiB1c2FnZQoKCiAgICBTdWIuZXh0ZW5kID0gU3VwZXIuZXh0ZW5kOwogICAgU3ViLm1peGluID0gU3VwZXIubWl4aW47CiAgICBTdWIudXNlID0gU3VwZXIudXNlOyAvLyBjcmVhdGUgYXNzZXQgcmVnaXN0ZXJzLCBzbyBleHRlbmRlZCBjbGFzc2VzCiAgICAvLyBjYW4gaGF2ZSB0aGVpciBwcml2YXRlIGFzc2V0cyB0b28uCgogICAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICBTdWJbdHlwZV0gPSBTdXBlclt0eXBlXTsKICAgIH0pOyAvLyBlbmFibGUgcmVjdXJzaXZlIHNlbGYtbG9va3VwCgogICAgaWYgKG5hbWUpIHsKICAgICAgU3ViLm9wdGlvbnMuY29tcG9uZW50c1tuYW1lXSA9IFN1YjsKICAgIH0gLy8ga2VlcCBhIHJlZmVyZW5jZSB0byB0aGUgc3VwZXIgb3B0aW9ucyBhdCBleHRlbnNpb24gdGltZS4KICAgIC8vIGxhdGVyIGF0IGluc3RhbnRpYXRpb24gd2UgY2FuIGNoZWNrIGlmIFN1cGVyJ3Mgb3B0aW9ucyBoYXZlCiAgICAvLyBiZWVuIHVwZGF0ZWQuCgoKICAgIFN1Yi5zdXBlck9wdGlvbnMgPSBTdXBlci5vcHRpb25zOwogICAgU3ViLmV4dGVuZE9wdGlvbnMgPSBleHRlbmRPcHRpb25zOwogICAgU3ViLnNlYWxlZE9wdGlvbnMgPSBleHRlbmQoe30sIFN1Yi5vcHRpb25zKTsgLy8gY2FjaGUgY29uc3RydWN0b3IKCiAgICBjYWNoZWRDdG9yc1tTdXBlcklkXSA9IFN1YjsKICAgIHJldHVybiBTdWI7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdFByb3BzJDEoQ29tcCkgewogIHZhciBwcm9wcyA9IENvbXAub3B0aW9ucy5wcm9wczsKCiAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICBwcm94eShDb21wLnByb3RvdHlwZSwgIl9wcm9wcyIsIGtleSk7CiAgfQp9CgpmdW5jdGlvbiBpbml0Q29tcHV0ZWQkMShDb21wKSB7CiAgdmFyIGNvbXB1dGVkID0gQ29tcC5vcHRpb25zLmNvbXB1dGVkOwoKICBmb3IgKHZhciBrZXkgaW4gY29tcHV0ZWQpIHsKICAgIGRlZmluZUNvbXB1dGVkKENvbXAucHJvdG90eXBlLCBrZXksIGNvbXB1dGVkW2tleV0pOwogIH0KfQovKiAgKi8KCgpmdW5jdGlvbiBpbml0QXNzZXRSZWdpc3RlcnMoVnVlKSB7CiAgLyoqCiAgICogQ3JlYXRlIGFzc2V0IHJlZ2lzdHJhdGlvbiBtZXRob2RzLgogICAqLwogIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgIFZ1ZVt0eXBlXSA9IGZ1bmN0aW9uIChpZCwgZGVmaW5pdGlvbikgewogICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlID09PSAnY29tcG9uZW50JykgewogICAgICAgICAgdmFsaWRhdGVDb21wb25lbnROYW1lKGlkKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnY29tcG9uZW50JyAmJiBpc1BsYWluT2JqZWN0KGRlZmluaXRpb24pKSB7CiAgICAgICAgICBkZWZpbml0aW9uLm5hbWUgPSBkZWZpbml0aW9uLm5hbWUgfHwgaWQ7CiAgICAgICAgICBkZWZpbml0aW9uID0gdGhpcy5vcHRpb25zLl9iYXNlLmV4dGVuZChkZWZpbml0aW9uKTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlID09PSAnZGlyZWN0aXZlJyAmJiB0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgZGVmaW5pdGlvbiA9IHsKICAgICAgICAgICAgYmluZDogZGVmaW5pdGlvbiwKICAgICAgICAgICAgdXBkYXRlOiBkZWZpbml0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXSA9IGRlZmluaXRpb247CiAgICAgICAgcmV0dXJuIGRlZmluaXRpb247CiAgICAgIH0KICAgIH07CiAgfSk7Cn0KLyogICovCgoKZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShvcHRzKSB7CiAgcmV0dXJuIG9wdHMgJiYgKG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcpOwp9CgpmdW5jdGlvbiBtYXRjaGVzKHBhdHRlcm4sIG5hbWUpIHsKICBpZiAoQXJyYXkuaXNBcnJheShwYXR0ZXJuKSkgewogICAgcmV0dXJuIHBhdHRlcm4uaW5kZXhPZihuYW1lKSA+IC0xOwogIH0gZWxzZSBpZiAodHlwZW9mIHBhdHRlcm4gPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gcGF0dGVybi5zcGxpdCgnLCcpLmluZGV4T2YobmFtZSkgPiAtMTsKICB9IGVsc2UgaWYgKGlzUmVnRXhwKHBhdHRlcm4pKSB7CiAgICByZXR1cm4gcGF0dGVybi50ZXN0KG5hbWUpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBwcnVuZUNhY2hlKGtlZXBBbGl2ZUluc3RhbmNlLCBmaWx0ZXIpIHsKICB2YXIgY2FjaGUgPSBrZWVwQWxpdmVJbnN0YW5jZS5jYWNoZTsKICB2YXIga2V5cyA9IGtlZXBBbGl2ZUluc3RhbmNlLmtleXM7CiAgdmFyIF92bm9kZSA9IGtlZXBBbGl2ZUluc3RhbmNlLl92bm9kZTsKCiAgZm9yICh2YXIga2V5IGluIGNhY2hlKSB7CiAgICB2YXIgY2FjaGVkTm9kZSA9IGNhY2hlW2tleV07CgogICAgaWYgKGNhY2hlZE5vZGUpIHsKICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGNhY2hlZE5vZGUuY29tcG9uZW50T3B0aW9ucyk7CgogICAgICBpZiAobmFtZSAmJiAhZmlsdGVyKG5hbWUpKSB7CiAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIF92bm9kZSk7CiAgICAgIH0KICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHBydW5lQ2FjaGVFbnRyeShjYWNoZSwga2V5LCBrZXlzLCBjdXJyZW50KSB7CiAgdmFyIGNhY2hlZCQkMSA9IGNhY2hlW2tleV07CgogIGlmIChjYWNoZWQkJDEgJiYgKCFjdXJyZW50IHx8IGNhY2hlZCQkMS50YWcgIT09IGN1cnJlbnQudGFnKSkgewogICAgY2FjaGVkJCQxLmNvbXBvbmVudEluc3RhbmNlLiRkZXN0cm95KCk7CiAgfQoKICBjYWNoZVtrZXldID0gbnVsbDsKICByZW1vdmUoa2V5cywga2V5KTsKfQoKdmFyIHBhdHRlcm5UeXBlcyA9IFtTdHJpbmcsIFJlZ0V4cCwgQXJyYXldOwp2YXIgS2VlcEFsaXZlID0gewogIG5hbWU6ICdrZWVwLWFsaXZlJywKICAiYWJzdHJhY3QiOiB0cnVlLAogIHByb3BzOiB7CiAgICBpbmNsdWRlOiBwYXR0ZXJuVHlwZXMsCiAgICBleGNsdWRlOiBwYXR0ZXJuVHlwZXMsCiAgICBtYXg6IFtTdHJpbmcsIE51bWJlcl0KICB9LAogIGNyZWF0ZWQ6IGZ1bmN0aW9uIGNyZWF0ZWQoKSB7CiAgICB0aGlzLmNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMua2V5cyA9IFtdOwogIH0sCiAgZGVzdHJveWVkOiBmdW5jdGlvbiBkZXN0cm95ZWQoKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jYWNoZSkgewogICAgICBwcnVuZUNhY2hlRW50cnkodGhpcy5jYWNoZSwga2V5LCB0aGlzLmtleXMpOwogICAgfQogIH0sCiAgbW91bnRlZDogZnVuY3Rpb24gbW91bnRlZCgpIHsKICAgIHZhciB0aGlzJDEgPSB0aGlzOwogICAgdGhpcy4kd2F0Y2goJ2luY2x1ZGUnLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgIHBydW5lQ2FjaGUodGhpcyQxLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBtYXRjaGVzKHZhbCwgbmFtZSk7CiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLiR3YXRjaCgnZXhjbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgcHJ1bmVDYWNoZSh0aGlzJDEsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuICFtYXRjaGVzKHZhbCwgbmFtZSk7CiAgICAgIH0pOwogICAgfSk7CiAgfSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgIHZhciBzbG90ID0gdGhpcy4kc2xvdHNbImRlZmF1bHQiXTsKICAgIHZhciB2bm9kZSA9IGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoc2xvdCk7CiAgICB2YXIgY29tcG9uZW50T3B0aW9ucyA9IHZub2RlICYmIHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CgogICAgaWYgKGNvbXBvbmVudE9wdGlvbnMpIHsKICAgICAgLy8gY2hlY2sgcGF0dGVybgogICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoY29tcG9uZW50T3B0aW9ucyk7CiAgICAgIHZhciByZWYgPSB0aGlzOwogICAgICB2YXIgaW5jbHVkZSA9IHJlZi5pbmNsdWRlOwogICAgICB2YXIgZXhjbHVkZSA9IHJlZi5leGNsdWRlOwoKICAgICAgaWYgKCAvLyBub3QgaW5jbHVkZWQKICAgICAgaW5jbHVkZSAmJiAoIW5hbWUgfHwgIW1hdGNoZXMoaW5jbHVkZSwgbmFtZSkpIHx8IC8vIGV4Y2x1ZGVkCiAgICAgIGV4Y2x1ZGUgJiYgbmFtZSAmJiBtYXRjaGVzKGV4Y2x1ZGUsIG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHZub2RlOwogICAgICB9CgogICAgICB2YXIgcmVmJDEgPSB0aGlzOwogICAgICB2YXIgY2FjaGUgPSByZWYkMS5jYWNoZTsKICAgICAgdmFyIGtleXMgPSByZWYkMS5rZXlzOwogICAgICB2YXIga2V5ID0gdm5vZGUua2V5ID09IG51bGwgLy8gc2FtZSBjb25zdHJ1Y3RvciBtYXkgZ2V0IHJlZ2lzdGVyZWQgYXMgZGlmZmVyZW50IGxvY2FsIGNvbXBvbmVudHMKICAgICAgLy8gc28gY2lkIGFsb25lIGlzIG5vdCBlbm91Z2ggKCMzMjY5KQogICAgICA/IGNvbXBvbmVudE9wdGlvbnMuQ3Rvci5jaWQgKyAoY29tcG9uZW50T3B0aW9ucy50YWcgPyAiOjoiICsgY29tcG9uZW50T3B0aW9ucy50YWcgOiAnJykgOiB2bm9kZS5rZXk7CgogICAgICBpZiAoY2FjaGVba2V5XSkgewogICAgICAgIHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gY2FjaGVba2V5XS5jb21wb25lbnRJbnN0YW5jZTsgLy8gbWFrZSBjdXJyZW50IGtleSBmcmVzaGVzdAoKICAgICAgICByZW1vdmUoa2V5cywga2V5KTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWNoZVtrZXldID0gdm5vZGU7CiAgICAgICAga2V5cy5wdXNoKGtleSk7IC8vIHBydW5lIG9sZGVzdCBlbnRyeQoKICAgICAgICBpZiAodGhpcy5tYXggJiYga2V5cy5sZW5ndGggPiBwYXJzZUludCh0aGlzLm1heCkpIHsKICAgICAgICAgIHBydW5lQ2FjaGVFbnRyeShjYWNoZSwga2V5c1swXSwga2V5cywgdGhpcy5fdm5vZGUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdm5vZGUuZGF0YS5rZWVwQWxpdmUgPSB0cnVlOwogICAgfQoKICAgIHJldHVybiB2bm9kZSB8fCBzbG90ICYmIHNsb3RbMF07CiAgfQp9Owp2YXIgYnVpbHRJbkNvbXBvbmVudHMgPSB7CiAgS2VlcEFsaXZlOiBLZWVwQWxpdmUKfTsKLyogICovCgpmdW5jdGlvbiBpbml0R2xvYmFsQVBJKFZ1ZSkgewogIC8vIGNvbmZpZwogIHZhciBjb25maWdEZWYgPSB7fTsKCiAgY29uZmlnRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25maWc7CiAgfTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNvbmZpZ0RlZi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4oJ0RvIG5vdCByZXBsYWNlIHRoZSBWdWUuY29uZmlnIG9iamVjdCwgc2V0IGluZGl2aWR1YWwgZmllbGRzIGluc3RlYWQuJyk7CiAgICB9OwogIH0KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZSwgJ2NvbmZpZycsIGNvbmZpZ0RlZik7IC8vIGV4cG9zZWQgdXRpbCBtZXRob2RzLgogIC8vIE5PVEU6IHRoZXNlIGFyZSBub3QgY29uc2lkZXJlZCBwYXJ0IG9mIHRoZSBwdWJsaWMgQVBJIC0gYXZvaWQgcmVseWluZyBvbgogIC8vIHRoZW0gdW5sZXNzIHlvdSBhcmUgYXdhcmUgb2YgdGhlIHJpc2suCgogIFZ1ZS51dGlsID0gewogICAgd2Fybjogd2FybiwKICAgIGV4dGVuZDogZXh0ZW5kLAogICAgbWVyZ2VPcHRpb25zOiBtZXJnZU9wdGlvbnMsCiAgICBkZWZpbmVSZWFjdGl2ZTogZGVmaW5lUmVhY3RpdmUkJDEKICB9OwogIFZ1ZS5zZXQgPSBzZXQ7CiAgVnVlWyJkZWxldGUiXSA9IGRlbDsKICBWdWUubmV4dFRpY2sgPSBuZXh0VGljazsgLy8gMi42IGV4cGxpY2l0IG9ic2VydmFibGUgQVBJCgogIFZ1ZS5vYnNlcnZhYmxlID0gZnVuY3Rpb24gKG9iaikgewogICAgb2JzZXJ2ZShvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwoKICBWdWUub3B0aW9ucyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgVnVlLm9wdGlvbnNbdHlwZSArICdzJ10gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIH0pOyAvLyB0aGlzIGlzIHVzZWQgdG8gaWRlbnRpZnkgdGhlICJiYXNlIiBjb25zdHJ1Y3RvciB0byBleHRlbmQgYWxsIHBsYWluLW9iamVjdAogIC8vIGNvbXBvbmVudHMgd2l0aCBpbiBXZWV4J3MgbXVsdGktaW5zdGFuY2Ugc2NlbmFyaW9zLgoKICBWdWUub3B0aW9ucy5fYmFzZSA9IFZ1ZTsKICBleHRlbmQoVnVlLm9wdGlvbnMuY29tcG9uZW50cywgYnVpbHRJbkNvbXBvbmVudHMpOwogIGluaXRVc2UoVnVlKTsKICBpbml0TWl4aW4kMShWdWUpOwogIGluaXRFeHRlbmQoVnVlKTsKICBpbml0QXNzZXRSZWdpc3RlcnMoVnVlKTsKfQoKaW5pdEdsb2JhbEFQSShWdWUpOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRpc1NlcnZlcicsIHsKICBnZXQ6IGlzU2VydmVyUmVuZGVyaW5nCn0pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRzc3JDb250ZXh0JywgewogIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIHJldHVybiB0aGlzLiR2bm9kZSAmJiB0aGlzLiR2bm9kZS5zc3JDb250ZXh0OwogIH0KfSk7IC8vIGV4cG9zZSBGdW5jdGlvbmFsUmVuZGVyQ29udGV4dCBmb3Igc3NyIHJ1bnRpbWUgaGVscGVyIGluc3RhbGxhdGlvbgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFZ1ZSwgJ0Z1bmN0aW9uYWxSZW5kZXJDb250ZXh0JywgewogIHZhbHVlOiBGdW5jdGlvbmFsUmVuZGVyQ29udGV4dAp9KTsKVnVlLnZlcnNpb24gPSAnMi42LjEyJzsKLyogICovCi8vIHRoZXNlIGFyZSByZXNlcnZlZCBmb3Igd2ViIGJlY2F1c2UgdGhleSBhcmUgZGlyZWN0bHkgY29tcGlsZWQgYXdheQovLyBkdXJpbmcgdGVtcGxhdGUgY29tcGlsYXRpb24KCnZhciBpc1Jlc2VydmVkQXR0ciA9IG1ha2VNYXAoJ3N0eWxlLGNsYXNzJyk7IC8vIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgdXNpbmcgcHJvcHMgZm9yIGJpbmRpbmcKCnZhciBhY2NlcHRWYWx1ZSA9IG1ha2VNYXAoJ2lucHV0LHRleHRhcmVhLG9wdGlvbixzZWxlY3QscHJvZ3Jlc3MnKTsKCnZhciBtdXN0VXNlUHJvcCA9IGZ1bmN0aW9uIG11c3RVc2VQcm9wKHRhZywgdHlwZSwgYXR0cikgewogIHJldHVybiBhdHRyID09PSAndmFsdWUnICYmIGFjY2VwdFZhbHVlKHRhZykgJiYgdHlwZSAhPT0gJ2J1dHRvbicgfHwgYXR0ciA9PT0gJ3NlbGVjdGVkJyAmJiB0YWcgPT09ICdvcHRpb24nIHx8IGF0dHIgPT09ICdjaGVja2VkJyAmJiB0YWcgPT09ICdpbnB1dCcgfHwgYXR0ciA9PT0gJ211dGVkJyAmJiB0YWcgPT09ICd2aWRlbyc7Cn07Cgp2YXIgaXNFbnVtZXJhdGVkQXR0ciA9IG1ha2VNYXAoJ2NvbnRlbnRlZGl0YWJsZSxkcmFnZ2FibGUsc3BlbGxjaGVjaycpOwp2YXIgaXNWYWxpZENvbnRlbnRFZGl0YWJsZVZhbHVlID0gbWFrZU1hcCgnZXZlbnRzLGNhcmV0LHR5cGluZyxwbGFpbnRleHQtb25seScpOwoKdmFyIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUgPSBmdW5jdGlvbiBjb252ZXJ0RW51bWVyYXRlZFZhbHVlKGtleSwgdmFsdWUpIHsKICByZXR1cm4gaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkgfHwgdmFsdWUgPT09ICdmYWxzZScgPyAnZmFsc2UnIC8vIGFsbG93IGFyYml0cmFyeSBzdHJpbmcgdmFsdWUgZm9yIGNvbnRlbnRlZGl0YWJsZQogIDoga2V5ID09PSAnY29udGVudGVkaXRhYmxlJyAmJiBpc1ZhbGlkQ29udGVudEVkaXRhYmxlVmFsdWUodmFsdWUpID8gdmFsdWUgOiAndHJ1ZSc7Cn07Cgp2YXIgaXNCb29sZWFuQXR0ciA9IG1ha2VNYXAoJ2FsbG93ZnVsbHNjcmVlbixhc3luYyxhdXRvZm9jdXMsYXV0b3BsYXksY2hlY2tlZCxjb21wYWN0LGNvbnRyb2xzLGRlY2xhcmUsJyArICdkZWZhdWx0LGRlZmF1bHRjaGVja2VkLGRlZmF1bHRtdXRlZCxkZWZhdWx0c2VsZWN0ZWQsZGVmZXIsZGlzYWJsZWQsJyArICdlbmFibGVkLGZvcm1ub3ZhbGlkYXRlLGhpZGRlbixpbmRldGVybWluYXRlLGluZXJ0LGlzbWFwLGl0ZW1zY29wZSxsb29wLG11bHRpcGxlLCcgKyAnbXV0ZWQsbm9ocmVmLG5vcmVzaXplLG5vc2hhZGUsbm92YWxpZGF0ZSxub3dyYXAsb3BlbixwYXVzZW9uZXhpdCxyZWFkb25seSwnICsgJ3JlcXVpcmVkLHJldmVyc2VkLHNjb3BlZCxzZWFtbGVzcyxzZWxlY3RlZCxzb3J0YWJsZSx0cmFuc2xhdGUsJyArICd0cnVlc3BlZWQsdHlwZW11c3RtYXRjaCx2aXNpYmxlJyk7CnZhciB4bGlua05TID0gJ2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsnOwoKdmFyIGlzWGxpbmsgPSBmdW5jdGlvbiBpc1hsaW5rKG5hbWUpIHsKICByZXR1cm4gbmFtZS5jaGFyQXQoNSkgPT09ICc6JyAmJiBuYW1lLnNsaWNlKDAsIDUpID09PSAneGxpbmsnOwp9OwoKdmFyIGdldFhsaW5rUHJvcCA9IGZ1bmN0aW9uIGdldFhsaW5rUHJvcChuYW1lKSB7CiAgcmV0dXJuIGlzWGxpbmsobmFtZSkgPyBuYW1lLnNsaWNlKDYsIG5hbWUubGVuZ3RoKSA6ICcnOwp9OwoKdmFyIGlzRmFsc3lBdHRyVmFsdWUgPSBmdW5jdGlvbiBpc0ZhbHN5QXR0clZhbHVlKHZhbCkgewogIHJldHVybiB2YWwgPT0gbnVsbCB8fCB2YWwgPT09IGZhbHNlOwp9OwovKiAgKi8KCgpmdW5jdGlvbiBnZW5DbGFzc0ZvclZub2RlKHZub2RlKSB7CiAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogIHZhciBwYXJlbnROb2RlID0gdm5vZGU7CiAgdmFyIGNoaWxkTm9kZSA9IHZub2RlOwoKICB3aGlsZSAoaXNEZWYoY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgY2hpbGROb2RlID0gY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKCiAgICBpZiAoY2hpbGROb2RlICYmIGNoaWxkTm9kZS5kYXRhKSB7CiAgICAgIGRhdGEgPSBtZXJnZUNsYXNzRGF0YShjaGlsZE5vZGUuZGF0YSwgZGF0YSk7CiAgICB9CiAgfQoKICB3aGlsZSAoaXNEZWYocGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50KSkgewogICAgaWYgKHBhcmVudE5vZGUgJiYgcGFyZW50Tm9kZS5kYXRhKSB7CiAgICAgIGRhdGEgPSBtZXJnZUNsYXNzRGF0YShkYXRhLCBwYXJlbnROb2RlLmRhdGEpOwogICAgfQogIH0KCiAgcmV0dXJuIHJlbmRlckNsYXNzKGRhdGEuc3RhdGljQ2xhc3MsIGRhdGFbImNsYXNzIl0pOwp9CgpmdW5jdGlvbiBtZXJnZUNsYXNzRGF0YShjaGlsZCwgcGFyZW50KSB7CiAgcmV0dXJuIHsKICAgIHN0YXRpY0NsYXNzOiBjb25jYXQoY2hpbGQuc3RhdGljQ2xhc3MsIHBhcmVudC5zdGF0aWNDbGFzcyksCiAgICAiY2xhc3MiOiBpc0RlZihjaGlsZFsiY2xhc3MiXSkgPyBbY2hpbGRbImNsYXNzIl0sIHBhcmVudFsiY2xhc3MiXV0gOiBwYXJlbnRbImNsYXNzIl0KICB9Owp9CgpmdW5jdGlvbiByZW5kZXJDbGFzcyhzdGF0aWNDbGFzcywgZHluYW1pY0NsYXNzKSB7CiAgaWYgKGlzRGVmKHN0YXRpY0NsYXNzKSB8fCBpc0RlZihkeW5hbWljQ2xhc3MpKSB7CiAgICByZXR1cm4gY29uY2F0KHN0YXRpY0NsYXNzLCBzdHJpbmdpZnlDbGFzcyhkeW5hbWljQ2xhc3MpKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgogIHJldHVybiAnJzsKfQoKZnVuY3Rpb24gY29uY2F0KGEsIGIpIHsKICByZXR1cm4gYSA/IGIgPyBhICsgJyAnICsgYiA6IGEgOiBiIHx8ICcnOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlDbGFzcyh2YWx1ZSkgewogIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgcmV0dXJuIHN0cmluZ2lmeUFycmF5KHZhbHVlKTsKICB9CgogIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgIHJldHVybiBzdHJpbmdpZnlPYmplY3QodmFsdWUpOwogIH0KCiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgogIHJldHVybiAnJzsKfQoKZnVuY3Rpb24gc3RyaW5naWZ5QXJyYXkodmFsdWUpIHsKICB2YXIgcmVzID0gJyc7CiAgdmFyIHN0cmluZ2lmaWVkOwoKICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgaWYgKGlzRGVmKHN0cmluZ2lmaWVkID0gc3RyaW5naWZ5Q2xhc3ModmFsdWVbaV0pKSAmJiBzdHJpbmdpZmllZCAhPT0gJycpIHsKICAgICAgaWYgKHJlcykgewogICAgICAgIHJlcyArPSAnICc7CiAgICAgIH0KCiAgICAgIHJlcyArPSBzdHJpbmdpZmllZDsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIHN0cmluZ2lmeU9iamVjdCh2YWx1ZSkgewogIHZhciByZXMgPSAnJzsKCiAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICBpZiAodmFsdWVba2V5XSkgewogICAgICBpZiAocmVzKSB7CiAgICAgICAgcmVzICs9ICcgJzsKICAgICAgfQoKICAgICAgcmVzICs9IGtleTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKdmFyIG5hbWVzcGFjZU1hcCA9IHsKICBzdmc6ICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycsCiAgbWF0aDogJ2h0dHA6Ly93d3cudzMub3JnLzE5OTgvTWF0aC9NYXRoTUwnCn07CnZhciBpc0hUTUxUYWcgPSBtYWtlTWFwKCdodG1sLGJvZHksYmFzZSxoZWFkLGxpbmssbWV0YSxzdHlsZSx0aXRsZSwnICsgJ2FkZHJlc3MsYXJ0aWNsZSxhc2lkZSxmb290ZXIsaGVhZGVyLGgxLGgyLGgzLGg0LGg1LGg2LGhncm91cCxuYXYsc2VjdGlvbiwnICsgJ2RpdixkZCxkbCxkdCxmaWdjYXB0aW9uLGZpZ3VyZSxwaWN0dXJlLGhyLGltZyxsaSxtYWluLG9sLHAscHJlLHVsLCcgKyAnYSxiLGFiYnIsYmRpLGJkbyxicixjaXRlLGNvZGUsZGF0YSxkZm4sZW0saSxrYmQsbWFyayxxLHJwLHJ0LHJ0YyxydWJ5LCcgKyAncyxzYW1wLHNtYWxsLHNwYW4sc3Ryb25nLHN1YixzdXAsdGltZSx1LHZhcix3YnIsYXJlYSxhdWRpbyxtYXAsdHJhY2ssdmlkZW8sJyArICdlbWJlZCxvYmplY3QscGFyYW0sc291cmNlLGNhbnZhcyxzY3JpcHQsbm9zY3JpcHQsZGVsLGlucywnICsgJ2NhcHRpb24sY29sLGNvbGdyb3VwLHRhYmxlLHRoZWFkLHRib2R5LHRkLHRoLHRyLCcgKyAnYnV0dG9uLGRhdGFsaXN0LGZpZWxkc2V0LGZvcm0saW5wdXQsbGFiZWwsbGVnZW5kLG1ldGVyLG9wdGdyb3VwLG9wdGlvbiwnICsgJ291dHB1dCxwcm9ncmVzcyxzZWxlY3QsdGV4dGFyZWEsJyArICdkZXRhaWxzLGRpYWxvZyxtZW51LG1lbnVpdGVtLHN1bW1hcnksJyArICdjb250ZW50LGVsZW1lbnQsc2hhZG93LHRlbXBsYXRlLGJsb2NrcXVvdGUsaWZyYW1lLHRmb290Jyk7IC8vIHRoaXMgbWFwIGlzIGludGVudGlvbmFsbHkgc2VsZWN0aXZlLCBvbmx5IGNvdmVyaW5nIFNWRyBlbGVtZW50cyB0aGF0IG1heQovLyBjb250YWluIGNoaWxkIGVsZW1lbnRzLgoKdmFyIGlzU1ZHID0gbWFrZU1hcCgnc3ZnLGFuaW1hdGUsY2lyY2xlLGNsaXBwYXRoLGN1cnNvcixkZWZzLGRlc2MsZWxsaXBzZSxmaWx0ZXIsZm9udC1mYWNlLCcgKyAnZm9yZWlnbk9iamVjdCxnLGdseXBoLGltYWdlLGxpbmUsbWFya2VyLG1hc2ssbWlzc2luZy1nbHlwaCxwYXRoLHBhdHRlcm4sJyArICdwb2x5Z29uLHBvbHlsaW5lLHJlY3Qsc3dpdGNoLHN5bWJvbCx0ZXh0LHRleHRwYXRoLHRzcGFuLHVzZSx2aWV3JywgdHJ1ZSk7Cgp2YXIgaXNSZXNlcnZlZFRhZyA9IGZ1bmN0aW9uIGlzUmVzZXJ2ZWRUYWcodGFnKSB7CiAgcmV0dXJuIGlzSFRNTFRhZyh0YWcpIHx8IGlzU1ZHKHRhZyk7Cn07CgpmdW5jdGlvbiBnZXRUYWdOYW1lc3BhY2UodGFnKSB7CiAgaWYgKGlzU1ZHKHRhZykpIHsKICAgIHJldHVybiAnc3ZnJzsKICB9IC8vIGJhc2ljIHN1cHBvcnQgZm9yIE1hdGhNTAogIC8vIG5vdGUgaXQgZG9lc24ndCBzdXBwb3J0IG90aGVyIE1hdGhNTCBlbGVtZW50cyBiZWluZyBjb21wb25lbnQgcm9vdHMKCgogIGlmICh0YWcgPT09ICdtYXRoJykgewogICAgcmV0dXJuICdtYXRoJzsKICB9Cn0KCnZhciB1bmtub3duRWxlbWVudENhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCmZ1bmN0aW9uIGlzVW5rbm93bkVsZW1lbnQodGFnKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKCFpbkJyb3dzZXIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgaWYgKGlzUmVzZXJ2ZWRUYWcodGFnKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdGFnID0gdGFnLnRvTG93ZXJDYXNlKCk7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gIT0gbnVsbCkgewogICAgcmV0dXJuIHVua25vd25FbGVtZW50Q2FjaGVbdGFnXTsKICB9CgogIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTsKCiAgaWYgKHRhZy5pbmRleE9mKCctJykgPiAtMSkgewogICAgLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjgyMTAzNjQvMTA3MDI0NAogICAgcmV0dXJuIHVua25vd25FbGVtZW50Q2FjaGVbdGFnXSA9IGVsLmNvbnN0cnVjdG9yID09PSB3aW5kb3cuSFRNTFVua25vd25FbGVtZW50IHx8IGVsLmNvbnN0cnVjdG9yID09PSB3aW5kb3cuSFRNTEVsZW1lbnQ7CiAgfSBlbHNlIHsKICAgIHJldHVybiB1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSAvSFRNTFVua25vd25FbGVtZW50Ly50ZXN0KGVsLnRvU3RyaW5nKCkpOwogIH0KfQoKdmFyIGlzVGV4dElucHV0VHlwZSA9IG1ha2VNYXAoJ3RleHQsbnVtYmVyLHBhc3N3b3JkLHNlYXJjaCxlbWFpbCx0ZWwsdXJsJyk7Ci8qICAqLwoKLyoqCiAqIFF1ZXJ5IGFuIGVsZW1lbnQgc2VsZWN0b3IgaWYgaXQncyBub3QgYW4gZWxlbWVudCBhbHJlYWR5LgogKi8KCmZ1bmN0aW9uIHF1ZXJ5KGVsKSB7CiAgaWYgKHR5cGVvZiBlbCA9PT0gJ3N0cmluZycpIHsKICAgIHZhciBzZWxlY3RlZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZWwpOwoKICAgIGlmICghc2VsZWN0ZWQpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdDYW5ub3QgZmluZCBlbGVtZW50OiAnICsgZWwpOwogICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB9CgogICAgcmV0dXJuIHNlbGVjdGVkOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZWw7CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQkMSh0YWdOYW1lLCB2bm9kZSkgewogIHZhciBlbG0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwoKICBpZiAodGFnTmFtZSAhPT0gJ3NlbGVjdCcpIHsKICAgIHJldHVybiBlbG07CiAgfSAvLyBmYWxzZSBvciBudWxsIHdpbGwgcmVtb3ZlIHRoZSBhdHRyaWJ1dGUgYnV0IHVuZGVmaW5lZCB3aWxsIG5vdAoKCiAgaWYgKHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS5hdHRycyAmJiB2bm9kZS5kYXRhLmF0dHJzLm11bHRpcGxlICE9PSB1bmRlZmluZWQpIHsKICAgIGVsbS5zZXRBdHRyaWJ1dGUoJ211bHRpcGxlJywgJ211bHRpcGxlJyk7CiAgfQoKICByZXR1cm4gZWxtOwp9CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlLCB0YWdOYW1lKSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VNYXBbbmFtZXNwYWNlXSwgdGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQpIHsKICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbW1lbnQodGV4dCkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVDb21tZW50KHRleHQpOwp9CgpmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50Tm9kZSwgbmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSkgewogIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5ld05vZGUsIHJlZmVyZW5jZU5vZGUpOwp9CgpmdW5jdGlvbiByZW1vdmVDaGlsZChub2RlLCBjaGlsZCkgewogIG5vZGUucmVtb3ZlQ2hpbGQoY2hpbGQpOwp9CgpmdW5jdGlvbiBhcHBlbmRDaGlsZChub2RlLCBjaGlsZCkgewogIG5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwp9CgpmdW5jdGlvbiBwYXJlbnROb2RlKG5vZGUpIHsKICByZXR1cm4gbm9kZS5wYXJlbnROb2RlOwp9CgpmdW5jdGlvbiBuZXh0U2libGluZyhub2RlKSB7CiAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7Cn0KCmZ1bmN0aW9uIHRhZ05hbWUobm9kZSkgewogIHJldHVybiBub2RlLnRhZ05hbWU7Cn0KCmZ1bmN0aW9uIHNldFRleHRDb250ZW50KG5vZGUsIHRleHQpIHsKICBub2RlLnRleHRDb250ZW50ID0gdGV4dDsKfQoKZnVuY3Rpb24gc2V0U3R5bGVTY29wZShub2RlLCBzY29wZUlkKSB7CiAgbm9kZS5zZXRBdHRyaWJ1dGUoc2NvcGVJZCwgJycpOwp9Cgp2YXIgbm9kZU9wcyA9IC8qI19fUFVSRV9fKi9PYmplY3QuZnJlZXplKHsKICBjcmVhdGVFbGVtZW50OiBjcmVhdGVFbGVtZW50JDEsCiAgY3JlYXRlRWxlbWVudE5TOiBjcmVhdGVFbGVtZW50TlMsCiAgY3JlYXRlVGV4dE5vZGU6IGNyZWF0ZVRleHROb2RlLAogIGNyZWF0ZUNvbW1lbnQ6IGNyZWF0ZUNvbW1lbnQsCiAgaW5zZXJ0QmVmb3JlOiBpbnNlcnRCZWZvcmUsCiAgcmVtb3ZlQ2hpbGQ6IHJlbW92ZUNoaWxkLAogIGFwcGVuZENoaWxkOiBhcHBlbmRDaGlsZCwKICBwYXJlbnROb2RlOiBwYXJlbnROb2RlLAogIG5leHRTaWJsaW5nOiBuZXh0U2libGluZywKICB0YWdOYW1lOiB0YWdOYW1lLAogIHNldFRleHRDb250ZW50OiBzZXRUZXh0Q29udGVudCwKICBzZXRTdHlsZVNjb3BlOiBzZXRTdHlsZVNjb3BlCn0pOwovKiAgKi8KCnZhciByZWYgPSB7CiAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUoXywgdm5vZGUpIHsKICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsKICB9LAogIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9sZFZub2RlLCB2bm9kZSkgewogICAgaWYgKG9sZFZub2RlLmRhdGEucmVmICE9PSB2bm9kZS5kYXRhLnJlZikgewogICAgICByZWdpc3RlclJlZihvbGRWbm9kZSwgdHJ1ZSk7CiAgICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsKICAgIH0KICB9LAogIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3kodm5vZGUpIHsKICAgIHJlZ2lzdGVyUmVmKHZub2RlLCB0cnVlKTsKICB9Cn07CgpmdW5jdGlvbiByZWdpc3RlclJlZih2bm9kZSwgaXNSZW1vdmFsKSB7CiAgdmFyIGtleSA9IHZub2RlLmRhdGEucmVmOwoKICBpZiAoIWlzRGVmKGtleSkpIHsKICAgIHJldHVybjsKICB9CgogIHZhciB2bSA9IHZub2RlLmNvbnRleHQ7CiAgdmFyIHJlZiA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlIHx8IHZub2RlLmVsbTsKICB2YXIgcmVmcyA9IHZtLiRyZWZzOwoKICBpZiAoaXNSZW1vdmFsKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShyZWZzW2tleV0pKSB7CiAgICAgIHJlbW92ZShyZWZzW2tleV0sIHJlZik7CiAgICB9IGVsc2UgaWYgKHJlZnNba2V5XSA9PT0gcmVmKSB7CiAgICAgIHJlZnNba2V5XSA9IHVuZGVmaW5lZDsKICAgIH0KICB9IGVsc2UgewogICAgaWYgKHZub2RlLmRhdGEucmVmSW5Gb3IpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlZnNba2V5XSkpIHsKICAgICAgICByZWZzW2tleV0gPSBbcmVmXTsKICAgICAgfSBlbHNlIGlmIChyZWZzW2tleV0uaW5kZXhPZihyZWYpIDwgMCkgewogICAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICAgIHJlZnNba2V5XS5wdXNoKHJlZik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlZnNba2V5XSA9IHJlZjsKICAgIH0KICB9Cn0KLyoqCiAqIFZpcnR1YWwgRE9NIHBhdGNoaW5nIGFsZ29yaXRobSBiYXNlZCBvbiBTbmFiYmRvbSBieQogKiBTaW1vbiBGcmlpcyBWaW5kdW0gKEBwYWxkZXBpbmQpCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZQogKiBodHRwczovL2dpdGh1Yi5jb20vcGFsZGVwaW5kL3NuYWJiZG9tL2Jsb2IvbWFzdGVyL0xJQ0VOU0UKICoKICogbW9kaWZpZWQgYnkgRXZhbiBZb3UgKEB5eXg5OTA4MDMpCiAqCiAqIE5vdCB0eXBlLWNoZWNraW5nIHRoaXMgYmVjYXVzZSB0aGlzIGZpbGUgaXMgcGVyZi1jcml0aWNhbCBhbmQgdGhlIGNvc3QKICogb2YgbWFraW5nIGZsb3cgdW5kZXJzdGFuZCBpdCBpcyBub3Qgd29ydGggaXQuCiAqLwoKCnZhciBlbXB0eU5vZGUgPSBuZXcgVk5vZGUoJycsIHt9LCBbXSk7CnZhciBob29rcyA9IFsnY3JlYXRlJywgJ2FjdGl2YXRlJywgJ3VwZGF0ZScsICdyZW1vdmUnLCAnZGVzdHJveSddOwoKZnVuY3Rpb24gc2FtZVZub2RlKGEsIGIpIHsKICByZXR1cm4gYS5rZXkgPT09IGIua2V5ICYmIChhLnRhZyA9PT0gYi50YWcgJiYgYS5pc0NvbW1lbnQgPT09IGIuaXNDb21tZW50ICYmIGlzRGVmKGEuZGF0YSkgPT09IGlzRGVmKGIuZGF0YSkgJiYgc2FtZUlucHV0VHlwZShhLCBiKSB8fCBpc1RydWUoYS5pc0FzeW5jUGxhY2Vob2xkZXIpICYmIGEuYXN5bmNGYWN0b3J5ID09PSBiLmFzeW5jRmFjdG9yeSAmJiBpc1VuZGVmKGIuYXN5bmNGYWN0b3J5LmVycm9yKSk7Cn0KCmZ1bmN0aW9uIHNhbWVJbnB1dFR5cGUoYSwgYikgewogIGlmIChhLnRhZyAhPT0gJ2lucHV0JykgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgaTsKICB2YXIgdHlwZUEgPSBpc0RlZihpID0gYS5kYXRhKSAmJiBpc0RlZihpID0gaS5hdHRycykgJiYgaS50eXBlOwogIHZhciB0eXBlQiA9IGlzRGVmKGkgPSBiLmRhdGEpICYmIGlzRGVmKGkgPSBpLmF0dHJzKSAmJiBpLnR5cGU7CiAgcmV0dXJuIHR5cGVBID09PSB0eXBlQiB8fCBpc1RleHRJbnB1dFR5cGUodHlwZUEpICYmIGlzVGV4dElucHV0VHlwZSh0eXBlQik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUtleVRvT2xkSWR4KGNoaWxkcmVuLCBiZWdpbklkeCwgZW5kSWR4KSB7CiAgdmFyIGksIGtleTsKICB2YXIgbWFwID0ge307CgogIGZvciAoaSA9IGJlZ2luSWR4OyBpIDw9IGVuZElkeDsgKytpKSB7CiAgICBrZXkgPSBjaGlsZHJlbltpXS5rZXk7CgogICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgbWFwW2tleV0gPSBpOwogICAgfQogIH0KCiAgcmV0dXJuIG1hcDsKfQoKZnVuY3Rpb24gY3JlYXRlUGF0Y2hGdW5jdGlvbihiYWNrZW5kKSB7CiAgdmFyIGksIGo7CiAgdmFyIGNicyA9IHt9OwogIHZhciBtb2R1bGVzID0gYmFja2VuZC5tb2R1bGVzOwogIHZhciBub2RlT3BzID0gYmFja2VuZC5ub2RlT3BzOwoKICBmb3IgKGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyArK2kpIHsKICAgIGNic1tob29rc1tpXV0gPSBbXTsKCiAgICBmb3IgKGogPSAwOyBqIDwgbW9kdWxlcy5sZW5ndGg7ICsraikgewogICAgICBpZiAoaXNEZWYobW9kdWxlc1tqXVtob29rc1tpXV0pKSB7CiAgICAgICAgY2JzW2hvb2tzW2ldXS5wdXNoKG1vZHVsZXNbal1baG9va3NbaV1dKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZW1wdHlOb2RlQXQoZWxtKSB7CiAgICByZXR1cm4gbmV3IFZOb2RlKG5vZGVPcHMudGFnTmFtZShlbG0pLnRvTG93ZXJDYXNlKCksIHt9LCBbXSwgdW5kZWZpbmVkLCBlbG0pOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlUm1DYihjaGlsZEVsbSwgbGlzdGVuZXJzKSB7CiAgICBmdW5jdGlvbiByZW1vdmUkJDEoKSB7CiAgICAgIGlmICgtLXJlbW92ZSQkMS5saXN0ZW5lcnMgPT09IDApIHsKICAgICAgICByZW1vdmVOb2RlKGNoaWxkRWxtKTsKICAgICAgfQogICAgfQoKICAgIHJlbW92ZSQkMS5saXN0ZW5lcnMgPSBsaXN0ZW5lcnM7CiAgICByZXR1cm4gcmVtb3ZlJCQxOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlTm9kZShlbCkgewogICAgdmFyIHBhcmVudCA9IG5vZGVPcHMucGFyZW50Tm9kZShlbCk7IC8vIGVsZW1lbnQgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQgZHVlIHRvIHYtaHRtbCAvIHYtdGV4dAoKICAgIGlmIChpc0RlZihwYXJlbnQpKSB7CiAgICAgIG5vZGVPcHMucmVtb3ZlQ2hpbGQocGFyZW50LCBlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50JCQxKHZub2RlLCBpblZQcmUpIHsKICAgIHJldHVybiAhaW5WUHJlICYmICF2bm9kZS5ucyAmJiAhKGNvbmZpZy5pZ25vcmVkRWxlbWVudHMubGVuZ3RoICYmIGNvbmZpZy5pZ25vcmVkRWxlbWVudHMuc29tZShmdW5jdGlvbiAoaWdub3JlKSB7CiAgICAgIHJldHVybiBpc1JlZ0V4cChpZ25vcmUpID8gaWdub3JlLnRlc3Qodm5vZGUudGFnKSA6IGlnbm9yZSA9PT0gdm5vZGUudGFnOwogICAgfSkpICYmIGNvbmZpZy5pc1Vua25vd25FbGVtZW50KHZub2RlLnRhZyk7CiAgfQoKICB2YXIgY3JlYXRpbmdFbG1JblZQcmUgPSAwOwoKICBmdW5jdGlvbiBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0sIG5lc3RlZCwgb3duZXJBcnJheSwgaW5kZXgpIHsKICAgIGlmIChpc0RlZih2bm9kZS5lbG0pICYmIGlzRGVmKG93bmVyQXJyYXkpKSB7CiAgICAgIC8vIFRoaXMgdm5vZGUgd2FzIHVzZWQgaW4gYSBwcmV2aW91cyByZW5kZXIhCiAgICAgIC8vIG5vdyBpdCdzIHVzZWQgYXMgYSBuZXcgbm9kZSwgb3ZlcndyaXRpbmcgaXRzIGVsbSB3b3VsZCBjYXVzZQogICAgICAvLyBwb3RlbnRpYWwgcGF0Y2ggZXJyb3JzIGRvd24gdGhlIHJvYWQgd2hlbiBpdCdzIHVzZWQgYXMgYW4gaW5zZXJ0aW9uCiAgICAgIC8vIHJlZmVyZW5jZSBub2RlLiBJbnN0ZWFkLCB3ZSBjbG9uZSB0aGUgbm9kZSBvbi1kZW1hbmQgYmVmb3JlIGNyZWF0aW5nCiAgICAgIC8vIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgZm9yIGl0LgogICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICB9CgogICAgdm5vZGUuaXNSb290SW5zZXJ0ID0gIW5lc3RlZDsgLy8gZm9yIHRyYW5zaXRpb24gZW50ZXIgY2hlY2sKCiAgICBpZiAoY3JlYXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIGNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICB2YXIgdGFnID0gdm5vZGUudGFnOwoKICAgIGlmIChpc0RlZih0YWcpKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlKys7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgY3JlYXRpbmdFbG1JblZQcmUpKSB7CiAgICAgICAgICB3YXJuKCdVbmtub3duIGN1c3RvbSBlbGVtZW50OiA8JyArIHRhZyArICc+IC0gZGlkIHlvdSAnICsgJ3JlZ2lzdGVyIHRoZSBjb21wb25lbnQgY29ycmVjdGx5PyBGb3IgcmVjdXJzaXZlIGNvbXBvbmVudHMsICcgKyAnbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhlICJuYW1lIiBvcHRpb24uJywgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2bm9kZS5lbG0gPSB2bm9kZS5ucyA/IG5vZGVPcHMuY3JlYXRlRWxlbWVudE5TKHZub2RlLm5zLCB0YWcpIDogbm9kZU9wcy5jcmVhdGVFbGVtZW50KHRhZywgdm5vZGUpOwogICAgICBzZXRTY29wZSh2bm9kZSk7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgICAgewogICAgICAgIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKCiAgICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICB9CgogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgfQoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgZGF0YSAmJiBkYXRhLnByZSkgewogICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlLS07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkpIHsKICAgICAgdm5vZGUuZWxtID0gbm9kZU9wcy5jcmVhdGVDb21tZW50KHZub2RlLnRleHQpOwogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICB9IGVsc2UgewogICAgICB2bm9kZS5lbG0gPSBub2RlT3BzLmNyZWF0ZVRleHROb2RlKHZub2RlLnRleHQpOwogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgIHZhciBpID0gdm5vZGUuZGF0YTsKCiAgICBpZiAoaXNEZWYoaSkpIHsKICAgICAgdmFyIGlzUmVhY3RpdmF0ZWQgPSBpc0RlZih2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkgJiYgaS5rZWVwQWxpdmU7CgogICAgICBpZiAoaXNEZWYoaSA9IGkuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIHsKICAgICAgICBpKHZub2RlLCBmYWxzZQogICAgICAgIC8qIGh5ZHJhdGluZyAqLwogICAgICAgICk7CiAgICAgIH0gLy8gYWZ0ZXIgY2FsbGluZyB0aGUgaW5pdCBob29rLCBpZiB0aGUgdm5vZGUgaXMgYSBjaGlsZCBjb21wb25lbnQKICAgICAgLy8gaXQgc2hvdWxkJ3ZlIGNyZWF0ZWQgYSBjaGlsZCBpbnN0YW5jZSBhbmQgbW91bnRlZCBpdC4gdGhlIGNoaWxkCiAgICAgIC8vIGNvbXBvbmVudCBhbHNvIGhhcyBzZXQgdGhlIHBsYWNlaG9sZGVyIHZub2RlJ3MgZWxtLgogICAgICAvLyBpbiB0aGF0IGNhc2Ugd2UgY2FuIGp1c3QgcmV0dXJuIHRoZSBlbGVtZW50IGFuZCBiZSBkb25lLgoKCiAgICAgIGlmIChpc0RlZih2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKCiAgICAgICAgaWYgKGlzVHJ1ZShpc1JlYWN0aXZhdGVkKSkgewogICAgICAgICAgcmVhY3RpdmF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdENvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBpZiAoaXNEZWYodm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KSkgewogICAgICBpbnNlcnRlZFZub2RlUXVldWUucHVzaC5hcHBseShpbnNlcnRlZFZub2RlUXVldWUsIHZub2RlLmRhdGEucGVuZGluZ0luc2VydCk7CiAgICAgIHZub2RlLmRhdGEucGVuZGluZ0luc2VydCA9IG51bGw7CiAgICB9CgogICAgdm5vZGUuZWxtID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuJGVsOwoKICAgIGlmIChpc1BhdGNoYWJsZSh2bm9kZSkpIHsKICAgICAgaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgIHNldFNjb3BlKHZub2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGVtcHR5IGNvbXBvbmVudCByb290LgogICAgICAvLyBza2lwIGFsbCBlbGVtZW50LXJlbGF0ZWQgbW9kdWxlcyBleGNlcHQgZm9yIHJlZiAoIzM0NTUpCiAgICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsgLy8gbWFrZSBzdXJlIHRvIGludm9rZSB0aGUgaW5zZXJ0IGhvb2sKCiAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlYWN0aXZhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgIHZhciBpOyAvLyBoYWNrIGZvciAjNDMzOTogYSByZWFjdGl2YXRlZCBjb21wb25lbnQgd2l0aCBpbm5lciB0cmFuc2l0aW9uCiAgICAvLyBkb2VzIG5vdCB0cmlnZ2VyIGJlY2F1c2UgdGhlIGlubmVyIG5vZGUncyBjcmVhdGVkIGhvb2tzIGFyZSBub3QgY2FsbGVkCiAgICAvLyBhZ2Fpbi4gSXQncyBub3QgaWRlYWwgdG8gaW52b2x2ZSBtb2R1bGUtc3BlY2lmaWMgbG9naWMgaW4gaGVyZSBidXQKICAgIC8vIHRoZXJlIGRvZXNuJ3Qgc2VlbSB0byBiZSBhIGJldHRlciB3YXkgdG8gZG8gaXQuCgogICAgdmFyIGlubmVyTm9kZSA9IHZub2RlOwoKICAgIHdoaWxlIChpbm5lck5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgaW5uZXJOb2RlID0gaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKCiAgICAgIGlmIChpc0RlZihpID0gaW5uZXJOb2RlLmRhdGEpICYmIGlzRGVmKGkgPSBpLnRyYW5zaXRpb24pKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5hY3RpdmF0ZS5sZW5ndGg7ICsraSkgewogICAgICAgICAgY2JzLmFjdGl2YXRlW2ldKGVtcHR5Tm9kZSwgaW5uZXJOb2RlKTsKICAgICAgICB9CgogICAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKGlubmVyTm9kZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0gLy8gdW5saWtlIGEgbmV3bHkgY3JlYXRlZCBjb21wb25lbnQsCiAgICAvLyBhIHJlYWN0aXZhdGVkIGtlZXAtYWxpdmUgY29tcG9uZW50IGRvZXNuJ3QgaW5zZXJ0IGl0c2VsZgoKCiAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgfQoKICBmdW5jdGlvbiBpbnNlcnQocGFyZW50LCBlbG0sIHJlZiQkMSkgewogICAgaWYgKGlzRGVmKHBhcmVudCkpIHsKICAgICAgaWYgKGlzRGVmKHJlZiQkMSkpIHsKICAgICAgICBpZiAobm9kZU9wcy5wYXJlbnROb2RlKHJlZiQkMSkgPT09IHBhcmVudCkgewogICAgICAgICAgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50LCBlbG0sIHJlZiQkMSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQocGFyZW50LCBlbG0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgIGNyZWF0ZUVsbShjaGlsZHJlbltpXSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB2bm9kZS5lbG0sIG51bGwsIHRydWUsIGNoaWxkcmVuLCBpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2bm9kZS50ZXh0KSkgewogICAgICBub2RlT3BzLmFwcGVuZENoaWxkKHZub2RlLmVsbSwgbm9kZU9wcy5jcmVhdGVUZXh0Tm9kZShTdHJpbmcodm5vZGUudGV4dCkpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzUGF0Y2hhYmxlKHZub2RlKSB7CiAgICB3aGlsZSAodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgdm5vZGUgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICB9CgogICAgcmV0dXJuIGlzRGVmKHZub2RlLnRhZyk7CiAgfQoKICBmdW5jdGlvbiBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBjYnMuY3JlYXRlLmxlbmd0aDsgKytpJDEpIHsKICAgICAgY2JzLmNyZWF0ZVtpJDFdKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgfQoKICAgIGkgPSB2bm9kZS5kYXRhLmhvb2s7IC8vIFJldXNlIHZhcmlhYmxlCgogICAgaWYgKGlzRGVmKGkpKSB7CiAgICAgIGlmIChpc0RlZihpLmNyZWF0ZSkpIHsKICAgICAgICBpLmNyZWF0ZShlbXB0eU5vZGUsIHZub2RlKTsKICAgICAgfQoKICAgICAgaWYgKGlzRGVmKGkuaW5zZXJ0KSkgewogICAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsKICAgICAgfQogICAgfQogIH0gLy8gc2V0IHNjb3BlIGlkIGF0dHJpYnV0ZSBmb3Igc2NvcGVkIENTUy4KICAvLyB0aGlzIGlzIGltcGxlbWVudGVkIGFzIGEgc3BlY2lhbCBjYXNlIHRvIGF2b2lkIHRoZSBvdmVyaGVhZAogIC8vIG9mIGdvaW5nIHRocm91Z2ggdGhlIG5vcm1hbCBhdHRyaWJ1dGUgcGF0Y2hpbmcgcHJvY2Vzcy4KCgogIGZ1bmN0aW9uIHNldFNjb3BlKHZub2RlKSB7CiAgICB2YXIgaTsKCiAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmZuU2NvcGVJZCkpIHsKICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYW5jZXN0b3IgPSB2bm9kZTsKCiAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgIGlmIChpc0RlZihpID0gYW5jZXN0b3IuY29udGV4dCkgJiYgaXNEZWYoaSA9IGkuJG9wdGlvbnMuX3Njb3BlSWQpKSB7CiAgICAgICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgICAgICB9CgogICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICB9CiAgICB9IC8vIGZvciBzbG90IGNvbnRlbnQgdGhleSBzaG91bGQgYWxzbyBnZXQgdGhlIHNjb3BlSWQgZnJvbSB0aGUgaG9zdCBpbnN0YW5jZS4KCgogICAgaWYgKGlzRGVmKGkgPSBhY3RpdmVJbnN0YW5jZSkgJiYgaSAhPT0gdm5vZGUuY29udGV4dCAmJiBpICE9PSB2bm9kZS5mbkNvbnRleHQgJiYgaXNEZWYoaSA9IGkuJG9wdGlvbnMuX3Njb3BlSWQpKSB7CiAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCB2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgZm9yICg7IHN0YXJ0SWR4IDw9IGVuZElkeDsgKytzdGFydElkeCkgewogICAgICBjcmVhdGVFbG0odm5vZGVzW3N0YXJ0SWR4XSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSwgZmFsc2UsIHZub2Rlcywgc3RhcnRJZHgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52b2tlRGVzdHJveUhvb2sodm5vZGUpIHsKICAgIHZhciBpLCBqOwogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuZGVzdHJveSkpIHsKICAgICAgICBpKHZub2RlKTsKICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5kZXN0cm95Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgY2JzLmRlc3Ryb3lbaV0odm5vZGUpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgZm9yIChqID0gMDsgaiA8IHZub2RlLmNoaWxkcmVuLmxlbmd0aDsgKytqKSB7CiAgICAgICAgaW52b2tlRGVzdHJveUhvb2sodm5vZGUuY2hpbGRyZW5bal0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVWbm9kZXModm5vZGVzLCBzdGFydElkeCwgZW5kSWR4KSB7CiAgICBmb3IgKDsgc3RhcnRJZHggPD0gZW5kSWR4OyArK3N0YXJ0SWR4KSB7CiAgICAgIHZhciBjaCA9IHZub2Rlc1tzdGFydElkeF07CgogICAgICBpZiAoaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKGlzRGVmKGNoLnRhZykpIHsKICAgICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soY2gpOwogICAgICAgICAgaW52b2tlRGVzdHJveUhvb2soY2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBUZXh0IG5vZGUKICAgICAgICAgIHJlbW92ZU5vZGUoY2guZWxtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2sodm5vZGUsIHJtKSB7CiAgICBpZiAoaXNEZWYocm0pIHx8IGlzRGVmKHZub2RlLmRhdGEpKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgbGlzdGVuZXJzID0gY2JzLnJlbW92ZS5sZW5ndGggKyAxOwoKICAgICAgaWYgKGlzRGVmKHJtKSkgewogICAgICAgIC8vIHdlIGhhdmUgYSByZWN1cnNpdmVseSBwYXNzZWQgZG93biBybSBjYWxsYmFjawogICAgICAgIC8vIGluY3JlYXNlIHRoZSBsaXN0ZW5lcnMgY291bnQKICAgICAgICBybS5saXN0ZW5lcnMgKz0gbGlzdGVuZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGRpcmVjdGx5IHJlbW92aW5nCiAgICAgICAgcm0gPSBjcmVhdGVSbUNiKHZub2RlLmVsbSwgbGlzdGVuZXJzKTsKICAgICAgfSAvLyByZWN1cnNpdmVseSBpbnZva2UgaG9va3Mgb24gY2hpbGQgY29tcG9uZW50IHJvb3Qgbm9kZQoKCiAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UpICYmIGlzRGVmKGkgPSBpLl92bm9kZSkgJiYgaXNEZWYoaS5kYXRhKSkgewogICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soaSwgcm0pOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLnJlbW92ZS5sZW5ndGg7ICsraSkgewogICAgICAgIGNicy5yZW1vdmVbaV0odm5vZGUsIHJtKTsKICAgICAgfQoKICAgICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5kYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnJlbW92ZSkpIHsKICAgICAgICBpKHZub2RlLCBybSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm0oKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmVtb3ZlTm9kZSh2bm9kZS5lbG0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdXBkYXRlQ2hpbGRyZW4ocGFyZW50RWxtLCBvbGRDaCwgbmV3Q2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSkgewogICAgdmFyIG9sZFN0YXJ0SWR4ID0gMDsKICAgIHZhciBuZXdTdGFydElkeCA9IDA7CiAgICB2YXIgb2xkRW5kSWR4ID0gb2xkQ2gubGVuZ3RoIC0gMTsKICAgIHZhciBvbGRTdGFydFZub2RlID0gb2xkQ2hbMF07CiAgICB2YXIgb2xkRW5kVm5vZGUgPSBvbGRDaFtvbGRFbmRJZHhdOwogICAgdmFyIG5ld0VuZElkeCA9IG5ld0NoLmxlbmd0aCAtIDE7CiAgICB2YXIgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWzBdOwogICAgdmFyIG5ld0VuZFZub2RlID0gbmV3Q2hbbmV3RW5kSWR4XTsKICAgIHZhciBvbGRLZXlUb0lkeCwgaWR4SW5PbGQsIHZub2RlVG9Nb3ZlLCByZWZFbG07IC8vIHJlbW92ZU9ubHkgaXMgYSBzcGVjaWFsIGZsYWcgdXNlZCBvbmx5IGJ5IDx0cmFuc2l0aW9uLWdyb3VwPgogICAgLy8gdG8gZW5zdXJlIHJlbW92ZWQgZWxlbWVudHMgc3RheSBpbiBjb3JyZWN0IHJlbGF0aXZlIHBvc2l0aW9ucwogICAgLy8gZHVyaW5nIGxlYXZpbmcgdHJhbnNpdGlvbnMKCiAgICB2YXIgY2FuTW92ZSA9ICFyZW1vdmVPbmx5OwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGNoZWNrRHVwbGljYXRlS2V5cyhuZXdDaCk7CiAgICB9CgogICAgd2hpbGUgKG9sZFN0YXJ0SWR4IDw9IG9sZEVuZElkeCAmJiBuZXdTdGFydElkeCA8PSBuZXdFbmRJZHgpIHsKICAgICAgaWYgKGlzVW5kZWYob2xkU3RhcnRWbm9kZSkpIHsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07IC8vIFZub2RlIGhhcyBiZWVuIG1vdmVkIGxlZnQKICAgICAgfSBlbHNlIGlmIChpc1VuZGVmKG9sZEVuZFZub2RlKSkgewogICAgICAgIG9sZEVuZFZub2RlID0gb2xkQ2hbLS1vbGRFbmRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRTdGFydFZub2RlLCBuZXdTdGFydFZub2RlKSkgewogICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgIG9sZFN0YXJ0Vm5vZGUgPSBvbGRDaFsrK29sZFN0YXJ0SWR4XTsKICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZEVuZFZub2RlLCBuZXdFbmRWbm9kZSkpIHsKICAgICAgICBwYXRjaFZub2RlKG9sZEVuZFZub2RlLCBuZXdFbmRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3RW5kSWR4KTsKICAgICAgICBvbGRFbmRWbm9kZSA9IG9sZENoWy0tb2xkRW5kSWR4XTsKICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3RW5kVm5vZGUpKSB7CiAgICAgICAgLy8gVm5vZGUgbW92ZWQgcmlnaHQKICAgICAgICBwYXRjaFZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld0VuZFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdFbmRJZHgpOwogICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgbm9kZU9wcy5uZXh0U2libGluZyhvbGRFbmRWbm9kZS5lbG0pKTsKICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgbmV3RW5kVm5vZGUgPSBuZXdDaFstLW5ld0VuZElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZEVuZFZub2RlLCBuZXdTdGFydFZub2RlKSkgewogICAgICAgIC8vIFZub2RlIG1vdmVkIGxlZnQKICAgICAgICBwYXRjaFZub2RlKG9sZEVuZFZub2RlLCBuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgY2FuTW92ZSAmJiBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnRFbG0sIG9sZEVuZFZub2RlLmVsbSwgb2xkU3RhcnRWbm9kZS5lbG0pOwogICAgICAgIG9sZEVuZFZub2RlID0gb2xkQ2hbLS1vbGRFbmRJZHhdOwogICAgICAgIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFsrK25ld1N0YXJ0SWR4XTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNVbmRlZihvbGRLZXlUb0lkeCkpIHsKICAgICAgICAgIG9sZEtleVRvSWR4ID0gY3JlYXRlS2V5VG9PbGRJZHgob2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgICAgIH0KCiAgICAgICAgaWR4SW5PbGQgPSBpc0RlZihuZXdTdGFydFZub2RlLmtleSkgPyBvbGRLZXlUb0lkeFtuZXdTdGFydFZub2RlLmtleV0gOiBmaW5kSWR4SW5PbGQobmV3U3RhcnRWbm9kZSwgb2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwoKICAgICAgICBpZiAoaXNVbmRlZihpZHhJbk9sZCkpIHsKICAgICAgICAgIC8vIE5ldyBlbGVtZW50CiAgICAgICAgICBjcmVhdGVFbG0obmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtLCBmYWxzZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdm5vZGVUb01vdmUgPSBvbGRDaFtpZHhJbk9sZF07CgogICAgICAgICAgaWYgKHNhbWVWbm9kZSh2bm9kZVRvTW92ZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAgICAgcGF0Y2hWbm9kZSh2bm9kZVRvTW92ZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgICBvbGRDaFtpZHhJbk9sZF0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGNhbk1vdmUgJiYgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50RWxtLCB2bm9kZVRvTW92ZS5lbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHNhbWUga2V5IGJ1dCBkaWZmZXJlbnQgZWxlbWVudC4gdHJlYXQgYXMgbmV3IGVsZW1lbnQKICAgICAgICAgICAgY3JlYXRlRWxtKG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCBvbGRTdGFydFZub2RlLmVsbSwgZmFsc2UsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgIH0KICAgIH0KCiAgICBpZiAob2xkU3RhcnRJZHggPiBvbGRFbmRJZHgpIHsKICAgICAgcmVmRWxtID0gaXNVbmRlZihuZXdDaFtuZXdFbmRJZHggKyAxXSkgPyBudWxsIDogbmV3Q2hbbmV3RW5kSWR4ICsgMV0uZWxtOwogICAgICBhZGRWbm9kZXMocGFyZW50RWxtLCByZWZFbG0sIG5ld0NoLCBuZXdTdGFydElkeCwgbmV3RW5kSWR4LCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgfSBlbHNlIGlmIChuZXdTdGFydElkeCA+IG5ld0VuZElkeCkgewogICAgICByZW1vdmVWbm9kZXMob2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKSB7CiAgICB2YXIgc2VlbktleXMgPSB7fTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciB2bm9kZSA9IGNoaWxkcmVuW2ldOwogICAgICB2YXIga2V5ID0gdm5vZGUua2V5OwoKICAgICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgICBpZiAoc2VlbktleXNba2V5XSkgewogICAgICAgICAgd2FybigiRHVwbGljYXRlIGtleXMgZGV0ZWN0ZWQ6ICciICsga2V5ICsgIicuIFRoaXMgbWF5IGNhdXNlIGFuIHVwZGF0ZSBlcnJvci4iLCB2bm9kZS5jb250ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VlbktleXNba2V5XSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5kSWR4SW5PbGQobm9kZSwgb2xkQ2gsIHN0YXJ0LCBlbmQpIHsKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgaSsrKSB7CiAgICAgIHZhciBjID0gb2xkQ2hbaV07CgogICAgICBpZiAoaXNEZWYoYykgJiYgc2FtZVZub2RlKG5vZGUsIGMpKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHBhdGNoVm5vZGUob2xkVm5vZGUsIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG93bmVyQXJyYXksIGluZGV4LCByZW1vdmVPbmx5KSB7CiAgICBpZiAob2xkVm5vZGUgPT09IHZub2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoaXNEZWYodm5vZGUuZWxtKSAmJiBpc0RlZihvd25lckFycmF5KSkgewogICAgICAvLyBjbG9uZSByZXVzZWQgdm5vZGUKICAgICAgdm5vZGUgPSBvd25lckFycmF5W2luZGV4XSA9IGNsb25lVk5vZGUodm5vZGUpOwogICAgfQoKICAgIHZhciBlbG0gPSB2bm9kZS5lbG0gPSBvbGRWbm9kZS5lbG07CgogICAgaWYgKGlzVHJ1ZShvbGRWbm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIpKSB7CiAgICAgIGlmIChpc0RlZih2bm9kZS5hc3luY0ZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgaHlkcmF0ZShvbGRWbm9kZS5lbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHZub2RlLmlzQXN5bmNQbGFjZWhvbGRlciA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0gLy8gcmV1c2UgZWxlbWVudCBmb3Igc3RhdGljIHRyZWVzLgogICAgLy8gbm90ZSB3ZSBvbmx5IGRvIHRoaXMgaWYgdGhlIHZub2RlIGlzIGNsb25lZCAtCiAgICAvLyBpZiB0aGUgbmV3IG5vZGUgaXMgbm90IGNsb25lZCBpdCBtZWFucyB0aGUgcmVuZGVyIGZ1bmN0aW9ucyBoYXZlIGJlZW4KICAgIC8vIHJlc2V0IGJ5IHRoZSBob3QtcmVsb2FkLWFwaSBhbmQgd2UgbmVlZCB0byBkbyBhIHByb3BlciByZS1yZW5kZXIuCgoKICAgIGlmIChpc1RydWUodm5vZGUuaXNTdGF0aWMpICYmIGlzVHJ1ZShvbGRWbm9kZS5pc1N0YXRpYykgJiYgdm5vZGUua2V5ID09PSBvbGRWbm9kZS5rZXkgJiYgKGlzVHJ1ZSh2bm9kZS5pc0Nsb25lZCkgfHwgaXNUcnVlKHZub2RlLmlzT25jZSkpKSB7CiAgICAgIHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgaTsKICAgIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKCiAgICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucHJlcGF0Y2gpKSB7CiAgICAgIGkob2xkVm5vZGUsIHZub2RlKTsKICAgIH0KCiAgICB2YXIgb2xkQ2ggPSBvbGRWbm9kZS5jaGlsZHJlbjsKICAgIHZhciBjaCA9IHZub2RlLmNoaWxkcmVuOwoKICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc1BhdGNoYWJsZSh2bm9kZSkpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy51cGRhdGUubGVuZ3RoOyArK2kpIHsKICAgICAgICBjYnMudXBkYXRlW2ldKG9sZFZub2RlLCB2bm9kZSk7CiAgICAgIH0KCiAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS51cGRhdGUpKSB7CiAgICAgICAgaShvbGRWbm9kZSwgdm5vZGUpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzVW5kZWYodm5vZGUudGV4dCkpIHsKICAgICAgaWYgKGlzRGVmKG9sZENoKSAmJiBpc0RlZihjaCkpIHsKICAgICAgICBpZiAob2xkQ2ggIT09IGNoKSB7CiAgICAgICAgICB1cGRhdGVDaGlsZHJlbihlbG0sIG9sZENoLCBjaCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCByZW1vdmVPbmx5KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIGNoZWNrRHVwbGljYXRlS2V5cyhjaCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWYob2xkVm5vZGUudGV4dCkpIHsKICAgICAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCAnJyk7CiAgICAgICAgfQoKICAgICAgICBhZGRWbm9kZXMoZWxtLCBudWxsLCBjaCwgMCwgY2gubGVuZ3RoIC0gMSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRDaCkpIHsKICAgICAgICByZW1vdmVWbm9kZXMob2xkQ2gsIDAsIG9sZENoLmxlbmd0aCAtIDEpOwogICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7CiAgICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sICcnKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChvbGRWbm9kZS50ZXh0ICE9PSB2bm9kZS50ZXh0KSB7CiAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCB2bm9kZS50ZXh0KTsKICAgIH0KCiAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnBvc3RwYXRjaCkpIHsKICAgICAgICBpKG9sZFZub2RlLCB2bm9kZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGludm9rZUluc2VydEhvb2sodm5vZGUsIHF1ZXVlLCBpbml0aWFsKSB7CiAgICAvLyBkZWxheSBpbnNlcnQgaG9va3MgZm9yIGNvbXBvbmVudCByb290IG5vZGVzLCBpbnZva2UgdGhlbSBhZnRlciB0aGUKICAgIC8vIGVsZW1lbnQgaXMgcmVhbGx5IGluc2VydGVkCiAgICBpZiAoaXNUcnVlKGluaXRpYWwpICYmIGlzRGVmKHZub2RlLnBhcmVudCkpIHsKICAgICAgdm5vZGUucGFyZW50LmRhdGEucGVuZGluZ0luc2VydCA9IHF1ZXVlOwogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7ICsraSkgewogICAgICAgIHF1ZXVlW2ldLmRhdGEuaG9vay5pbnNlcnQocXVldWVbaV0pOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgaHlkcmF0aW9uQmFpbGVkID0gZmFsc2U7IC8vIGxpc3Qgb2YgbW9kdWxlcyB0aGF0IGNhbiBza2lwIGNyZWF0ZSBob29rIGR1cmluZyBoeWRyYXRpb24gYmVjYXVzZSB0aGV5CiAgLy8gYXJlIGFscmVhZHkgcmVuZGVyZWQgb24gdGhlIGNsaWVudCBvciBoYXMgbm8gbmVlZCBmb3IgaW5pdGlhbGl6YXRpb24KICAvLyBOb3RlOiBzdHlsZSBpcyBleGNsdWRlZCBiZWNhdXNlIGl0IHJlbGllcyBvbiBpbml0aWFsIGNsb25lIGZvciBmdXR1cmUKICAvLyBkZWVwIHVwZGF0ZXMgKCM3MDYzKS4KCiAgdmFyIGlzUmVuZGVyZWRNb2R1bGUgPSBtYWtlTWFwKCdhdHRycyxjbGFzcyxzdGF0aWNDbGFzcyxzdGF0aWNTdHlsZSxrZXknKTsgLy8gTm90ZTogdGhpcyBpcyBhIGJyb3dzZXItb25seSBmdW5jdGlvbiBzbyB3ZSBjYW4gYXNzdW1lIGVsbXMgYXJlIERPTSBub2Rlcy4KCiAgZnVuY3Rpb24gaHlkcmF0ZShlbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIGluVlByZSkgewogICAgdmFyIGk7CiAgICB2YXIgdGFnID0gdm5vZGUudGFnOwogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIGNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICBpblZQcmUgPSBpblZQcmUgfHwgZGF0YSAmJiBkYXRhLnByZTsKICAgIHZub2RlLmVsbSA9IGVsbTsKCiAgICBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkgJiYgaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5KSkgewogICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gLy8gYXNzZXJ0IG5vZGUgbWF0Y2gKCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKCFhc3NlcnROb2RlTWF0Y2goZWxtLCB2bm9kZSwgaW5WUHJlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIHsKICAgICAgICBpKHZub2RlLCB0cnVlCiAgICAgICAgLyogaHlkcmF0aW5nICovCiAgICAgICAgKTsKICAgICAgfQoKICAgICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgICAgICAvLyBjaGlsZCBjb21wb25lbnQuIGl0IHNob3VsZCBoYXZlIGh5ZHJhdGVkIGl0cyBvd24gdHJlZS4KICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgaWYgKGlzRGVmKGNoaWxkcmVuKSkgewogICAgICAgIC8vIGVtcHR5IGVsZW1lbnQsIGFsbG93IGNsaWVudCB0byBwaWNrIHVwIGFuZCBwb3B1bGF0ZSBjaGlsZHJlbgogICAgICAgIGlmICghZWxtLmhhc0NoaWxkTm9kZXMoKSkgewogICAgICAgICAgY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyB2LWh0bWwgYW5kIGRvbVByb3BzOiBpbm5lckhUTUwKICAgICAgICAgIGlmIChpc0RlZihpID0gZGF0YSkgJiYgaXNEZWYoaSA9IGkuZG9tUHJvcHMpICYmIGlzRGVmKGkgPSBpLmlubmVySFRNTCkpIHsKICAgICAgICAgICAgaWYgKGkgIT09IGVsbS5pbm5lckhUTUwpIHsKICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWh5ZHJhdGlvbkJhaWxlZCkgewogICAgICAgICAgICAgICAgaHlkcmF0aW9uQmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdzZXJ2ZXIgaW5uZXJIVE1MOiAnLCBpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignY2xpZW50IGlubmVySFRNTDogJywgZWxtLmlubmVySFRNTCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGl0ZXJhdGUgYW5kIGNvbXBhcmUgY2hpbGRyZW4gbGlzdHMKICAgICAgICAgICAgdmFyIGNoaWxkcmVuTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICB2YXIgY2hpbGROb2RlID0gZWxtLmZpcnN0Q2hpbGQ7CgogICAgICAgICAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBjaGlsZHJlbi5sZW5ndGg7IGkkMSsrKSB7CiAgICAgICAgICAgICAgaWYgKCFjaGlsZE5vZGUgfHwgIWh5ZHJhdGUoY2hpbGROb2RlLCBjaGlsZHJlbltpJDFdLCBpbnNlcnRlZFZub2RlUXVldWUsIGluVlByZSkpIHsKICAgICAgICAgICAgICAgIGNoaWxkcmVuTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9IC8vIGlmIGNoaWxkTm9kZSBpcyBub3QgbnVsbCwgaXQgbWVhbnMgdGhlIGFjdHVhbCBjaGlsZE5vZGVzIGxpc3QgaXMKICAgICAgICAgICAgLy8gbG9uZ2VyIHRoYW4gdGhlIHZpcnR1YWwgY2hpbGRyZW4gbGlzdC4KCgogICAgICAgICAgICBpZiAoIWNoaWxkcmVuTWF0Y2ggfHwgY2hpbGROb2RlKSB7CiAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmICFoeWRyYXRpb25CYWlsZWQpIHsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvbkJhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BhcmVudDogJywgZWxtKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignTWlzbWF0Y2hpbmcgY2hpbGROb2RlcyB2cy4gVk5vZGVzOiAnLCBlbG0uY2hpbGROb2RlcywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICB2YXIgZnVsbEludm9rZSA9IGZhbHNlOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgaWYgKCFpc1JlbmRlcmVkTW9kdWxlKGtleSkpIHsKICAgICAgICAgICAgZnVsbEludm9rZSA9IHRydWU7CiAgICAgICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghZnVsbEludm9rZSAmJiBkYXRhWydjbGFzcyddKSB7CiAgICAgICAgICAvLyBlbnN1cmUgY29sbGVjdGluZyBkZXBzIGZvciBkZWVwIGNsYXNzIGJpbmRpbmdzIGZvciBmdXR1cmUgdXBkYXRlcwogICAgICAgICAgdHJhdmVyc2UoZGF0YVsnY2xhc3MnXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGVsbS5kYXRhICE9PSB2bm9kZS50ZXh0KSB7CiAgICAgIGVsbS5kYXRhID0gdm5vZGUudGV4dDsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGFzc2VydE5vZGVNYXRjaChub2RlLCB2bm9kZSwgaW5WUHJlKSB7CiAgICBpZiAoaXNEZWYodm5vZGUudGFnKSkgewogICAgICByZXR1cm4gdm5vZGUudGFnLmluZGV4T2YoJ3Z1ZS1jb21wb25lbnQnKSA9PT0gMCB8fCAhaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgaW5WUHJlKSAmJiB2bm9kZS50YWcudG9Mb3dlckNhc2UoKSA9PT0gKG5vZGUudGFnTmFtZSAmJiBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gKHZub2RlLmlzQ29tbWVudCA/IDggOiAzKTsKICAgIH0KICB9CgogIHJldHVybiBmdW5jdGlvbiBwYXRjaChvbGRWbm9kZSwgdm5vZGUsIGh5ZHJhdGluZywgcmVtb3ZlT25seSkgewogICAgaWYgKGlzVW5kZWYodm5vZGUpKSB7CiAgICAgIGlmIChpc0RlZihvbGRWbm9kZSkpIHsKICAgICAgICBpbnZva2VEZXN0cm95SG9vayhvbGRWbm9kZSk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgaXNJbml0aWFsUGF0Y2ggPSBmYWxzZTsKICAgIHZhciBpbnNlcnRlZFZub2RlUXVldWUgPSBbXTsKCiAgICBpZiAoaXNVbmRlZihvbGRWbm9kZSkpIHsKICAgICAgLy8gZW1wdHkgbW91bnQgKGxpa2VseSBhcyBjb21wb25lbnQpLCBjcmVhdGUgbmV3IHJvb3QgZWxlbWVudAogICAgICBpc0luaXRpYWxQYXRjaCA9IHRydWU7CiAgICAgIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBpc1JlYWxFbGVtZW50ID0gaXNEZWYob2xkVm5vZGUubm9kZVR5cGUpOwoKICAgICAgaWYgKCFpc1JlYWxFbGVtZW50ICYmIHNhbWVWbm9kZShvbGRWbm9kZSwgdm5vZGUpKSB7CiAgICAgICAgLy8gcGF0Y2ggZXhpc3Rpbmcgcm9vdCBub2RlCiAgICAgICAgcGF0Y2hWbm9kZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbnVsbCwgbnVsbCwgcmVtb3ZlT25seSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzUmVhbEVsZW1lbnQpIHsKICAgICAgICAgIC8vIG1vdW50aW5nIHRvIGEgcmVhbCBlbGVtZW50CiAgICAgICAgICAvLyBjaGVjayBpZiB0aGlzIGlzIHNlcnZlci1yZW5kZXJlZCBjb250ZW50IGFuZCBpZiB3ZSBjYW4gcGVyZm9ybQogICAgICAgICAgLy8gYSBzdWNjZXNzZnVsIGh5ZHJhdGlvbi4KICAgICAgICAgIGlmIChvbGRWbm9kZS5ub2RlVHlwZSA9PT0gMSAmJiBvbGRWbm9kZS5oYXNBdHRyaWJ1dGUoU1NSX0FUVFIpKSB7CiAgICAgICAgICAgIG9sZFZub2RlLnJlbW92ZUF0dHJpYnV0ZShTU1JfQVRUUik7CiAgICAgICAgICAgIGh5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzVHJ1ZShoeWRyYXRpbmcpKSB7CiAgICAgICAgICAgIGlmIChoeWRyYXRlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSkgewogICAgICAgICAgICAgIGludm9rZUluc2VydEhvb2sodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIG9sZFZub2RlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgICAgICB3YXJuKCdUaGUgY2xpZW50LXNpZGUgcmVuZGVyZWQgdmlydHVhbCBET00gdHJlZSBpcyBub3QgbWF0Y2hpbmcgJyArICdzZXJ2ZXItcmVuZGVyZWQgY29udGVudC4gVGhpcyBpcyBsaWtlbHkgY2F1c2VkIGJ5IGluY29ycmVjdCAnICsgJ0hUTUwgbWFya3VwLCBmb3IgZXhhbXBsZSBuZXN0aW5nIGJsb2NrLWxldmVsIGVsZW1lbnRzIGluc2lkZSAnICsgJzxwPiwgb3IgbWlzc2luZyA8dGJvZHk+LiBCYWlsaW5nIGh5ZHJhdGlvbiBhbmQgcGVyZm9ybWluZyAnICsgJ2Z1bGwgY2xpZW50LXNpZGUgcmVuZGVyLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IC8vIGVpdGhlciBub3Qgc2VydmVyLXJlbmRlcmVkLCBvciBoeWRyYXRpb24gZmFpbGVkLgogICAgICAgICAgLy8gY3JlYXRlIGFuIGVtcHR5IG5vZGUgYW5kIHJlcGxhY2UgaXQKCgogICAgICAgICAgb2xkVm5vZGUgPSBlbXB0eU5vZGVBdChvbGRWbm9kZSk7CiAgICAgICAgfSAvLyByZXBsYWNpbmcgZXhpc3RpbmcgZWxlbWVudAoKCiAgICAgICAgdmFyIG9sZEVsbSA9IG9sZFZub2RlLmVsbTsKICAgICAgICB2YXIgcGFyZW50RWxtID0gbm9kZU9wcy5wYXJlbnROb2RlKG9sZEVsbSk7IC8vIGNyZWF0ZSBuZXcgbm9kZQoKICAgICAgICBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgLy8gZXh0cmVtZWx5IHJhcmUgZWRnZSBjYXNlOiBkbyBub3QgaW5zZXJ0IGlmIG9sZCBlbGVtZW50IGlzIGluIGEKICAgICAgICAvLyBsZWF2aW5nIHRyYW5zaXRpb24uIE9ubHkgaGFwcGVucyB3aGVuIGNvbWJpbmluZyB0cmFuc2l0aW9uICsKICAgICAgICAvLyBrZWVwLWFsaXZlICsgSE9Dcy4gKCM0NTkwKQogICAgICAgIG9sZEVsbS5fbGVhdmVDYiA/IG51bGwgOiBwYXJlbnRFbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRWxtKSk7IC8vIHVwZGF0ZSBwYXJlbnQgcGxhY2Vob2xkZXIgbm9kZSBlbGVtZW50LCByZWN1cnNpdmVseQoKICAgICAgICBpZiAoaXNEZWYodm5vZGUucGFyZW50KSkgewogICAgICAgICAgdmFyIGFuY2VzdG9yID0gdm5vZGUucGFyZW50OwogICAgICAgICAgdmFyIHBhdGNoYWJsZSA9IGlzUGF0Y2hhYmxlKHZub2RlKTsKCiAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYnMuZGVzdHJveS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIGNicy5kZXN0cm95W2ldKGFuY2VzdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYW5jZXN0b3IuZWxtID0gdm5vZGUuZWxtOwoKICAgICAgICAgICAgaWYgKHBhdGNoYWJsZSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2kkMSkgewogICAgICAgICAgICAgICAgY2JzLmNyZWF0ZVtpJDFdKGVtcHR5Tm9kZSwgYW5jZXN0b3IpOwogICAgICAgICAgICAgIH0gLy8gIzY1MTMKICAgICAgICAgICAgICAvLyBpbnZva2UgaW5zZXJ0IGhvb2tzIHRoYXQgbWF5IGhhdmUgYmVlbiBtZXJnZWQgYnkgY3JlYXRlIGhvb2tzLgogICAgICAgICAgICAgIC8vIGUuZy4gZm9yIGRpcmVjdGl2ZXMgdGhhdCB1c2VzIHRoZSAiaW5zZXJ0ZWQiIGhvb2suCgoKICAgICAgICAgICAgICB2YXIgaW5zZXJ0ID0gYW5jZXN0b3IuZGF0YS5ob29rLmluc2VydDsKCiAgICAgICAgICAgICAgaWYgKGluc2VydC5tZXJnZWQpIHsKICAgICAgICAgICAgICAgIC8vIHN0YXJ0IGF0IGluZGV4IDEgdG8gYXZvaWQgcmUtaW52b2tpbmcgY29tcG9uZW50IG1vdW50ZWQgaG9vawogICAgICAgICAgICAgICAgZm9yICh2YXIgaSQyID0gMTsgaSQyIDwgaW5zZXJ0LmZucy5sZW5ndGg7IGkkMisrKSB7CiAgICAgICAgICAgICAgICAgIGluc2VydC5mbnNbaSQyXSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWdpc3RlclJlZihhbmNlc3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICAgICAgfQogICAgICAgIH0gLy8gZGVzdHJveSBvbGQgbm9kZQoKCiAgICAgICAgaWYgKGlzRGVmKHBhcmVudEVsbSkpIHsKICAgICAgICAgIHJlbW92ZVZub2Rlcyhbb2xkVm5vZGVdLCAwLCAwKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRhZykpIHsKICAgICAgICAgIGludm9rZURlc3Ryb3lIb29rKG9sZFZub2RlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpbnZva2VJbnNlcnRIb29rKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIGlzSW5pdGlhbFBhdGNoKTsKICAgIHJldHVybiB2bm9kZS5lbG07CiAgfTsKfQovKiAgKi8KCgp2YXIgZGlyZWN0aXZlcyA9IHsKICBjcmVhdGU6IHVwZGF0ZURpcmVjdGl2ZXMsCiAgdXBkYXRlOiB1cGRhdGVEaXJlY3RpdmVzLAogIGRlc3Ryb3k6IGZ1bmN0aW9uIHVuYmluZERpcmVjdGl2ZXModm5vZGUpIHsKICAgIHVwZGF0ZURpcmVjdGl2ZXModm5vZGUsIGVtcHR5Tm9kZSk7CiAgfQp9OwoKZnVuY3Rpb24gdXBkYXRlRGlyZWN0aXZlcyhvbGRWbm9kZSwgdm5vZGUpIHsKICBpZiAob2xkVm5vZGUuZGF0YS5kaXJlY3RpdmVzIHx8IHZub2RlLmRhdGEuZGlyZWN0aXZlcykgewogICAgX3VwZGF0ZShvbGRWbm9kZSwgdm5vZGUpOwogIH0KfQoKZnVuY3Rpb24gX3VwZGF0ZShvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgaXNDcmVhdGUgPSBvbGRWbm9kZSA9PT0gZW1wdHlOb2RlOwogIHZhciBpc0Rlc3Ryb3kgPSB2bm9kZSA9PT0gZW1wdHlOb2RlOwogIHZhciBvbGREaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyQxKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcywgb2xkVm5vZGUuY29udGV4dCk7CiAgdmFyIG5ld0RpcnMgPSBub3JtYWxpemVEaXJlY3RpdmVzJDEodm5vZGUuZGF0YS5kaXJlY3RpdmVzLCB2bm9kZS5jb250ZXh0KTsKICB2YXIgZGlyc1dpdGhJbnNlcnQgPSBbXTsKICB2YXIgZGlyc1dpdGhQb3N0cGF0Y2ggPSBbXTsKICB2YXIga2V5LCBvbGREaXIsIGRpcjsKCiAgZm9yIChrZXkgaW4gbmV3RGlycykgewogICAgb2xkRGlyID0gb2xkRGlyc1trZXldOwogICAgZGlyID0gbmV3RGlyc1trZXldOwoKICAgIGlmICghb2xkRGlyKSB7CiAgICAgIC8vIG5ldyBkaXJlY3RpdmUsIGJpbmQKICAgICAgY2FsbEhvb2skMShkaXIsICdiaW5kJywgdm5vZGUsIG9sZFZub2RlKTsKCiAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuaW5zZXJ0ZWQpIHsKICAgICAgICBkaXJzV2l0aEluc2VydC5wdXNoKGRpcik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIGV4aXN0aW5nIGRpcmVjdGl2ZSwgdXBkYXRlCiAgICAgIGRpci5vbGRWYWx1ZSA9IG9sZERpci52YWx1ZTsKICAgICAgZGlyLm9sZEFyZyA9IG9sZERpci5hcmc7CiAgICAgIGNhbGxIb29rJDEoZGlyLCAndXBkYXRlJywgdm5vZGUsIG9sZFZub2RlKTsKCiAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuY29tcG9uZW50VXBkYXRlZCkgewogICAgICAgIGRpcnNXaXRoUG9zdHBhdGNoLnB1c2goZGlyKTsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKGRpcnNXaXRoSW5zZXJ0Lmxlbmd0aCkgewogICAgdmFyIGNhbGxJbnNlcnQgPSBmdW5jdGlvbiBjYWxsSW5zZXJ0KCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpcnNXaXRoSW5zZXJ0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbEhvb2skMShkaXJzV2l0aEluc2VydFtpXSwgJ2luc2VydGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgfQogICAgfTsKCiAgICBpZiAoaXNDcmVhdGUpIHsKICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdpbnNlcnQnLCBjYWxsSW5zZXJ0KTsKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxJbnNlcnQoKTsKICAgIH0KICB9CgogIGlmIChkaXJzV2l0aFBvc3RwYXRjaC5sZW5ndGgpIHsKICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAncG9zdHBhdGNoJywgZnVuY3Rpb24gKCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY2FsbEhvb2skMShkaXJzV2l0aFBvc3RwYXRjaFtpXSwgJ2NvbXBvbmVudFVwZGF0ZWQnLCB2bm9kZSwgb2xkVm5vZGUpOwogICAgICB9CiAgICB9KTsKICB9CgogIGlmICghaXNDcmVhdGUpIHsKICAgIGZvciAoa2V5IGluIG9sZERpcnMpIHsKICAgICAgaWYgKCFuZXdEaXJzW2tleV0pIHsKICAgICAgICAvLyBubyBsb25nZXIgcHJlc2VudCwgdW5iaW5kCiAgICAgICAgY2FsbEhvb2skMShvbGREaXJzW2tleV0sICd1bmJpbmQnLCBvbGRWbm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSk7CiAgICAgIH0KICAgIH0KICB9Cn0KCnZhciBlbXB0eU1vZGlmaWVycyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgpmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzJDEoZGlycywgdm0pIHsKICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCiAgaWYgKCFkaXJzKSB7CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIHJldHVybiByZXM7CiAgfQoKICB2YXIgaSwgZGlyOwoKICBmb3IgKGkgPSAwOyBpIDwgZGlycy5sZW5ndGg7IGkrKykgewogICAgZGlyID0gZGlyc1tpXTsKCiAgICBpZiAoIWRpci5tb2RpZmllcnMpIHsKICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgIGRpci5tb2RpZmllcnMgPSBlbXB0eU1vZGlmaWVyczsKICAgIH0KCiAgICByZXNbZ2V0UmF3RGlyTmFtZShkaXIpXSA9IGRpcjsKICAgIGRpci5kZWYgPSByZXNvbHZlQXNzZXQodm0uJG9wdGlvbnMsICdkaXJlY3RpdmVzJywgZGlyLm5hbWUsIHRydWUpOwogIH0gLy8gJGZsb3ctZGlzYWJsZS1saW5lCgoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBnZXRSYXdEaXJOYW1lKGRpcikgewogIHJldHVybiBkaXIucmF3TmFtZSB8fCBkaXIubmFtZSArICIuIiArIE9iamVjdC5rZXlzKGRpci5tb2RpZmllcnMgfHwge30pLmpvaW4oJy4nKTsKfQoKZnVuY3Rpb24gY2FsbEhvb2skMShkaXIsIGhvb2ssIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KSB7CiAgdmFyIGZuID0gZGlyLmRlZiAmJiBkaXIuZGVmW2hvb2tdOwoKICBpZiAoZm4pIHsKICAgIHRyeSB7CiAgICAgIGZuKHZub2RlLmVsbSwgZGlyLCB2bm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGhhbmRsZUVycm9yKGUsIHZub2RlLmNvbnRleHQsICJkaXJlY3RpdmUgIiArIGRpci5uYW1lICsgIiAiICsgaG9vayArICIgaG9vayIpOwogICAgfQogIH0KfQoKdmFyIGJhc2VNb2R1bGVzID0gW3JlZiwgZGlyZWN0aXZlc107Ci8qICAqLwoKZnVuY3Rpb24gdXBkYXRlQXR0cnMob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIG9wdHMgPSB2bm9kZS5jb21wb25lbnRPcHRpb25zOwoKICBpZiAoaXNEZWYob3B0cykgJiYgb3B0cy5DdG9yLm9wdGlvbnMuaW5oZXJpdEF0dHJzID09PSBmYWxzZSkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5hdHRycykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmF0dHJzKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGtleSwgY3VyLCBvbGQ7CiAgdmFyIGVsbSA9IHZub2RlLmVsbTsKICB2YXIgb2xkQXR0cnMgPSBvbGRWbm9kZS5kYXRhLmF0dHJzIHx8IHt9OwogIHZhciBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgfHwge307IC8vIGNsb25lIG9ic2VydmVkIG9iamVjdHMsIGFzIHRoZSB1c2VyIHByb2JhYmx5IHdhbnRzIHRvIG11dGF0ZSBpdAoKICBpZiAoaXNEZWYoYXR0cnMuX19vYl9fKSkgewogICAgYXR0cnMgPSB2bm9kZS5kYXRhLmF0dHJzID0gZXh0ZW5kKHt9LCBhdHRycyk7CiAgfQoKICBmb3IgKGtleSBpbiBhdHRycykgewogICAgY3VyID0gYXR0cnNba2V5XTsKICAgIG9sZCA9IG9sZEF0dHJzW2tleV07CgogICAgaWYgKG9sZCAhPT0gY3VyKSB7CiAgICAgIHNldEF0dHIoZWxtLCBrZXksIGN1cik7CiAgICB9CiAgfSAvLyAjNDM5MTogaW4gSUU5LCBzZXR0aW5nIHR5cGUgY2FuIHJlc2V0IHZhbHVlIGZvciBpbnB1dFt0eXBlPXJhZGlvXQogIC8vICM2NjY2OiBJRS9FZGdlIGZvcmNlcyBwcm9ncmVzcyB2YWx1ZSBkb3duIHRvIDEgYmVmb3JlIHNldHRpbmcgYSBtYXgKCiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoKGlzSUUgfHwgaXNFZGdlKSAmJiBhdHRycy52YWx1ZSAhPT0gb2xkQXR0cnMudmFsdWUpIHsKICAgIHNldEF0dHIoZWxtLCAndmFsdWUnLCBhdHRycy52YWx1ZSk7CiAgfQoKICBmb3IgKGtleSBpbiBvbGRBdHRycykgewogICAgaWYgKGlzVW5kZWYoYXR0cnNba2V5XSkpIHsKICAgICAgaWYgKGlzWGxpbmsoa2V5KSkgewogICAgICAgIGVsbS5yZW1vdmVBdHRyaWJ1dGVOUyh4bGlua05TLCBnZXRYbGlua1Byb3Aoa2V5KSk7CiAgICAgIH0gZWxzZSBpZiAoIWlzRW51bWVyYXRlZEF0dHIoa2V5KSkgewogICAgICAgIGVsbS5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gc2V0QXR0cihlbCwga2V5LCB2YWx1ZSkgewogIGlmIChlbC50YWdOYW1lLmluZGV4T2YoJy0nKSA+IC0xKSB7CiAgICBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSk7CiAgfSBlbHNlIGlmIChpc0Jvb2xlYW5BdHRyKGtleSkpIHsKICAgIC8vIHNldCBhdHRyaWJ1dGUgZm9yIGJsYW5rIHZhbHVlCiAgICAvLyBlLmcuIDxvcHRpb24gZGlzYWJsZWQ+U2VsZWN0IG9uZTwvb3B0aW9uPgogICAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdGVjaG5pY2FsbHkgYWxsb3dmdWxsc2NyZWVuIGlzIGEgYm9vbGVhbiBhdHRyaWJ1dGUgZm9yIDxpZnJhbWU+LAogICAgICAvLyBidXQgRmxhc2ggZXhwZWN0cyBhIHZhbHVlIG9mICJ0cnVlIiB3aGVuIHVzZWQgb24gPGVtYmVkPiB0YWcKICAgICAgdmFsdWUgPSBrZXkgPT09ICdhbGxvd2Z1bGxzY3JlZW4nICYmIGVsLnRhZ05hbWUgPT09ICdFTUJFRCcgPyAndHJ1ZScgOiBrZXk7CiAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICAgIH0KICB9IGVsc2UgaWYgKGlzRW51bWVyYXRlZEF0dHIoa2V5KSkgewogICAgZWwuc2V0QXR0cmlidXRlKGtleSwgY29udmVydEVudW1lcmF0ZWRWYWx1ZShrZXksIHZhbHVlKSk7CiAgfSBlbHNlIGlmIChpc1hsaW5rKGtleSkpIHsKICAgIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGVOUyh4bGlua05TLCBnZXRYbGlua1Byb3Aoa2V5KSk7CiAgICB9IGVsc2UgewogICAgICBlbC5zZXRBdHRyaWJ1dGVOUyh4bGlua05TLCBrZXksIHZhbHVlKTsKICAgIH0KICB9IGVsc2UgewogICAgYmFzZVNldEF0dHIoZWwsIGtleSwgdmFsdWUpOwogIH0KfQoKZnVuY3Rpb24gYmFzZVNldEF0dHIoZWwsIGtleSwgdmFsdWUpIHsKICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogIH0gZWxzZSB7CiAgICAvLyAjNzEzODogSUUxMCAmIDExIGZpcmVzIGlucHV0IGV2ZW50IHdoZW4gc2V0dGluZyBwbGFjZWhvbGRlciBvbgogICAgLy8gPHRleHRhcmVhPi4uLiBibG9jayB0aGUgZmlyc3QgaW5wdXQgZXZlbnQgYW5kIHJlbW92ZSB0aGUgYmxvY2tlcgogICAgLy8gaW1tZWRpYXRlbHkuCgogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoaXNJRSAmJiAhaXNJRTkgJiYgZWwudGFnTmFtZSA9PT0gJ1RFWFRBUkVBJyAmJiBrZXkgPT09ICdwbGFjZWhvbGRlcicgJiYgdmFsdWUgIT09ICcnICYmICFlbC5fX2llcGgpIHsKICAgICAgdmFyIGJsb2NrZXIgPSBmdW5jdGlvbiBibG9ja2VyKGUpIHsKICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2lucHV0JywgYmxvY2tlcik7CiAgICAgIH07CgogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIGJsb2NrZXIpOyAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCiAgICAgIGVsLl9faWVwaCA9IHRydWU7CiAgICAgIC8qIElFIHBsYWNlaG9sZGVyIHBhdGNoZWQgKi8KICAgIH0KCiAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgfQp9Cgp2YXIgYXR0cnMgPSB7CiAgY3JlYXRlOiB1cGRhdGVBdHRycywKICB1cGRhdGU6IHVwZGF0ZUF0dHJzCn07Ci8qICAqLwoKZnVuY3Rpb24gdXBkYXRlQ2xhc3Mob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIGVsID0gdm5vZGUuZWxtOwogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgb2xkRGF0YSA9IG9sZFZub2RlLmRhdGE7CgogIGlmIChpc1VuZGVmKGRhdGEuc3RhdGljQ2xhc3MpICYmIGlzVW5kZWYoZGF0YVsiY2xhc3MiXSkgJiYgKGlzVW5kZWYob2xkRGF0YSkgfHwgaXNVbmRlZihvbGREYXRhLnN0YXRpY0NsYXNzKSAmJiBpc1VuZGVmKG9sZERhdGFbImNsYXNzIl0pKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGNscyA9IGdlbkNsYXNzRm9yVm5vZGUodm5vZGUpOyAvLyBoYW5kbGUgdHJhbnNpdGlvbiBjbGFzc2VzCgogIHZhciB0cmFuc2l0aW9uQ2xhc3MgPSBlbC5fdHJhbnNpdGlvbkNsYXNzZXM7CgogIGlmIChpc0RlZih0cmFuc2l0aW9uQ2xhc3MpKSB7CiAgICBjbHMgPSBjb25jYXQoY2xzLCBzdHJpbmdpZnlDbGFzcyh0cmFuc2l0aW9uQ2xhc3MpKTsKICB9IC8vIHNldCB0aGUgY2xhc3MKCgogIGlmIChjbHMgIT09IGVsLl9wcmV2Q2xhc3MpIHsKICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjbHMpOwogICAgZWwuX3ByZXZDbGFzcyA9IGNsczsKICB9Cn0KCnZhciBrbGFzcyA9IHsKICBjcmVhdGU6IHVwZGF0ZUNsYXNzLAogIHVwZGF0ZTogdXBkYXRlQ2xhc3MKfTsKLyogICovCgovKiAgKi8KCi8qICAqLwoKLyogICovCi8vIGluIHNvbWUgY2FzZXMsIHRoZSBldmVudCB1c2VkIGhhcyB0byBiZSBkZXRlcm1pbmVkIGF0IHJ1bnRpbWUKLy8gc28gd2UgdXNlZCBzb21lIHJlc2VydmVkIHRva2VucyBkdXJpbmcgY29tcGlsZS4KCnZhciBSQU5HRV9UT0tFTiA9ICdfX3InOwp2YXIgQ0hFQ0tCT1hfUkFESU9fVE9LRU4gPSAnX19jJzsKLyogICovCi8vIG5vcm1hbGl6ZSB2LW1vZGVsIGV2ZW50IHRva2VucyB0aGF0IGNhbiBvbmx5IGJlIGRldGVybWluZWQgYXQgcnVudGltZS4KLy8gaXQncyBpbXBvcnRhbnQgdG8gcGxhY2UgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBpbiB0aGUgYXJyYXkgYmVjYXVzZQovLyB0aGUgd2hvbGUgcG9pbnQgaXMgZW5zdXJpbmcgdGhlIHYtbW9kZWwgY2FsbGJhY2sgZ2V0cyBjYWxsZWQgYmVmb3JlCi8vIHVzZXItYXR0YWNoZWQgaGFuZGxlcnMuCgpmdW5jdGlvbiBub3JtYWxpemVFdmVudHMob24pIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoaXNEZWYob25bUkFOR0VfVE9LRU5dKSkgewogICAgLy8gSUUgaW5wdXRbdHlwZT1yYW5nZV0gb25seSBzdXBwb3J0cyBgY2hhbmdlYCBldmVudAogICAgdmFyIGV2ZW50ID0gaXNJRSA/ICdjaGFuZ2UnIDogJ2lucHV0JzsKICAgIG9uW2V2ZW50XSA9IFtdLmNvbmNhdChvbltSQU5HRV9UT0tFTl0sIG9uW2V2ZW50XSB8fCBbXSk7CiAgICBkZWxldGUgb25bUkFOR0VfVE9LRU5dOwogIH0gLy8gVGhpcyB3YXMgb3JpZ2luYWxseSBpbnRlbmRlZCB0byBmaXggIzQ1MjEgYnV0IG5vIGxvbmdlciBuZWNlc3NhcnkKICAvLyBhZnRlciAyLjUuIEtlZXBpbmcgaXQgZm9yIGJhY2t3YXJkcyBjb21wYXQgd2l0aCBnZW5lcmF0ZWQgY29kZSBmcm9tIDwgMi40CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKGlzRGVmKG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXSkpIHsKICAgIG9uLmNoYW5nZSA9IFtdLmNvbmNhdChvbltDSEVDS0JPWF9SQURJT19UT0tFTl0sIG9uLmNoYW5nZSB8fCBbXSk7CiAgICBkZWxldGUgb25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dOwogIH0KfQoKdmFyIHRhcmdldCQxOwoKZnVuY3Rpb24gY3JlYXRlT25jZUhhbmRsZXIkMShldmVudCwgaGFuZGxlciwgY2FwdHVyZSkgewogIHZhciBfdGFyZ2V0ID0gdGFyZ2V0JDE7IC8vIHNhdmUgY3VycmVudCB0YXJnZXQgZWxlbWVudCBpbiBjbG9zdXJlCgogIHJldHVybiBmdW5jdGlvbiBvbmNlSGFuZGxlcigpIHsKICAgIHZhciByZXMgPSBoYW5kbGVyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CgogICAgaWYgKHJlcyAhPT0gbnVsbCkgewogICAgICByZW1vdmUkMihldmVudCwgb25jZUhhbmRsZXIsIGNhcHR1cmUsIF90YXJnZXQpOwogICAgfQogIH07Cn0gLy8gIzk0NDY6IEZpcmVmb3ggPD0gNTMgKGluIHBhcnRpY3VsYXIsIEVTUiA1MikgaGFzIGluY29ycmVjdCBFdmVudC50aW1lU3RhbXAKLy8gaW1wbGVtZW50YXRpb24gYW5kIGRvZXMgbm90IGZpcmUgbWljcm90YXNrcyBpbiBiZXR3ZWVuIGV2ZW50IHByb3BhZ2F0aW9uLCBzbwovLyBzYWZlIHRvIGV4Y2x1ZGUuCgoKdmFyIHVzZU1pY3JvdGFza0ZpeCA9IGlzVXNpbmdNaWNyb1Rhc2sgJiYgIShpc0ZGICYmIE51bWJlcihpc0ZGWzFdKSA8PSA1Myk7CgpmdW5jdGlvbiBhZGQkMShuYW1lLCBoYW5kbGVyLCBjYXB0dXJlLCBwYXNzaXZlKSB7CiAgLy8gYXN5bmMgZWRnZSBjYXNlICM2NTY2OiBpbm5lciBjbGljayBldmVudCB0cmlnZ2VycyBwYXRjaCwgZXZlbnQgaGFuZGxlcgogIC8vIGF0dGFjaGVkIHRvIG91dGVyIGVsZW1lbnQgZHVyaW5nIHBhdGNoLCBhbmQgdHJpZ2dlcmVkIGFnYWluLiBUaGlzCiAgLy8gaGFwcGVucyBiZWNhdXNlIGJyb3dzZXJzIGZpcmUgbWljcm90YXNrIHRpY2tzIGJldHdlZW4gZXZlbnQgcHJvcGFnYXRpb24uCiAgLy8gdGhlIHNvbHV0aW9uIGlzIHNpbXBsZTogd2Ugc2F2ZSB0aGUgdGltZXN0YW1wIHdoZW4gYSBoYW5kbGVyIGlzIGF0dGFjaGVkLAogIC8vIGFuZCB0aGUgaGFuZGxlciB3b3VsZCBvbmx5IGZpcmUgaWYgdGhlIGV2ZW50IHBhc3NlZCB0byBpdCB3YXMgZmlyZWQKICAvLyBBRlRFUiBpdCB3YXMgYXR0YWNoZWQuCiAgaWYgKHVzZU1pY3JvdGFza0ZpeCkgewogICAgdmFyIGF0dGFjaGVkVGltZXN0YW1wID0gY3VycmVudEZsdXNoVGltZXN0YW1wOwogICAgdmFyIG9yaWdpbmFsID0gaGFuZGxlcjsKCiAgICBoYW5kbGVyID0gb3JpZ2luYWwuX3dyYXBwZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoIC8vIG5vIGJ1YmJsaW5nLCBzaG91bGQgYWx3YXlzIGZpcmUuCiAgICAgIC8vIHRoaXMgaXMganVzdCBhIHNhZmV0eSBuZXQgaW4gY2FzZSBldmVudC50aW1lU3RhbXAgaXMgdW5yZWxpYWJsZSBpbgogICAgICAvLyBjZXJ0YWluIHdlaXJkIGVudmlyb25tZW50cy4uLgogICAgICBlLnRhcmdldCA9PT0gZS5jdXJyZW50VGFyZ2V0IHx8IC8vIGV2ZW50IGlzIGZpcmVkIGFmdGVyIGhhbmRsZXIgYXR0YWNobWVudAogICAgICBlLnRpbWVTdGFtcCA+PSBhdHRhY2hlZFRpbWVzdGFtcCB8fCAvLyBiYWlsIGZvciBlbnZpcm9ubWVudHMgdGhhdCBoYXZlIGJ1Z2d5IGV2ZW50LnRpbWVTdGFtcCBpbXBsZW1lbnRhdGlvbnMKICAgICAgLy8gIzk0NjIgaU9TIDkgYnVnOiBldmVudC50aW1lU3RhbXAgaXMgMCBhZnRlciBoaXN0b3J5LnB1c2hTdGF0ZQogICAgICAvLyAjOTY4MSBRdFdlYkVuZ2luZSBldmVudC50aW1lU3RhbXAgaXMgbmVnYXRpdmUgdmFsdWUKICAgICAgZS50aW1lU3RhbXAgPD0gMCB8fCAvLyAjOTQ0OCBiYWlsIGlmIGV2ZW50IGlzIGZpcmVkIGluIGFub3RoZXIgZG9jdW1lbnQgaW4gYSBtdWx0aS1wYWdlCiAgICAgIC8vIGVsZWN0cm9uL253LmpzIGFwcCwgc2luY2UgZXZlbnQudGltZVN0YW1wIHdpbGwgYmUgdXNpbmcgYSBkaWZmZXJlbnQKICAgICAgLy8gc3RhcnRpbmcgcmVmZXJlbmNlCiAgICAgIGUudGFyZ2V0Lm93bmVyRG9jdW1lbnQgIT09IGRvY3VtZW50KSB7CiAgICAgICAgcmV0dXJuIG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQoKICB0YXJnZXQkMS5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGhhbmRsZXIsIHN1cHBvcnRzUGFzc2l2ZSA/IHsKICAgIGNhcHR1cmU6IGNhcHR1cmUsCiAgICBwYXNzaXZlOiBwYXNzaXZlCiAgfSA6IGNhcHR1cmUpOwp9CgpmdW5jdGlvbiByZW1vdmUkMihuYW1lLCBoYW5kbGVyLCBjYXB0dXJlLCBfdGFyZ2V0KSB7CiAgKF90YXJnZXQgfHwgdGFyZ2V0JDEpLnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgaGFuZGxlci5fd3JhcHBlciB8fCBoYW5kbGVyLCBjYXB0dXJlKTsKfQoKZnVuY3Rpb24gdXBkYXRlRE9NTGlzdGVuZXJzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChpc1VuZGVmKG9sZFZub2RlLmRhdGEub24pICYmIGlzVW5kZWYodm5vZGUuZGF0YS5vbikpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBvbiA9IHZub2RlLmRhdGEub24gfHwge307CiAgdmFyIG9sZE9uID0gb2xkVm5vZGUuZGF0YS5vbiB8fCB7fTsKICB0YXJnZXQkMSA9IHZub2RlLmVsbTsKICBub3JtYWxpemVFdmVudHMob24pOwogIHVwZGF0ZUxpc3RlbmVycyhvbiwgb2xkT24sIGFkZCQxLCByZW1vdmUkMiwgY3JlYXRlT25jZUhhbmRsZXIkMSwgdm5vZGUuY29udGV4dCk7CiAgdGFyZ2V0JDEgPSB1bmRlZmluZWQ7Cn0KCnZhciBldmVudHMgPSB7CiAgY3JlYXRlOiB1cGRhdGVET01MaXN0ZW5lcnMsCiAgdXBkYXRlOiB1cGRhdGVET01MaXN0ZW5lcnMKfTsKLyogICovCgp2YXIgc3ZnQ29udGFpbmVyOwoKZnVuY3Rpb24gdXBkYXRlRE9NUHJvcHMob2xkVm5vZGUsIHZub2RlKSB7CiAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5kb21Qcm9wcykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmRvbVByb3BzKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGtleSwgY3VyOwogIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgdmFyIG9sZFByb3BzID0gb2xkVm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsKICB2YXIgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzIHx8IHt9OyAvLyBjbG9uZSBvYnNlcnZlZCBvYmplY3RzLCBhcyB0aGUgdXNlciBwcm9iYWJseSB3YW50cyB0byBtdXRhdGUgaXQKCiAgaWYgKGlzRGVmKHByb3BzLl9fb2JfXykpIHsKICAgIHByb3BzID0gdm5vZGUuZGF0YS5kb21Qcm9wcyA9IGV4dGVuZCh7fSwgcHJvcHMpOwogIH0KCiAgZm9yIChrZXkgaW4gb2xkUHJvcHMpIHsKICAgIGlmICghKGtleSBpbiBwcm9wcykpIHsKICAgICAgZWxtW2tleV0gPSAnJzsKICAgIH0KICB9CgogIGZvciAoa2V5IGluIHByb3BzKSB7CiAgICBjdXIgPSBwcm9wc1trZXldOyAvLyBpZ25vcmUgY2hpbGRyZW4gaWYgdGhlIG5vZGUgaGFzIHRleHRDb250ZW50IG9yIGlubmVySFRNTCwKICAgIC8vIGFzIHRoZXNlIHdpbGwgdGhyb3cgYXdheSBleGlzdGluZyBET00gbm9kZXMgYW5kIGNhdXNlIHJlbW92YWwgZXJyb3JzCiAgICAvLyBvbiBzdWJzZXF1ZW50IHBhdGNoZXMgKCMzMzYwKQoKICAgIGlmIChrZXkgPT09ICd0ZXh0Q29udGVudCcgfHwga2V5ID09PSAnaW5uZXJIVE1MJykgewogICAgICBpZiAodm5vZGUuY2hpbGRyZW4pIHsKICAgICAgICB2bm9kZS5jaGlsZHJlbi5sZW5ndGggPSAwOwogICAgICB9CgogICAgICBpZiAoY3VyID09PSBvbGRQcm9wc1trZXldKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0gLy8gIzY2MDEgd29yayBhcm91bmQgQ2hyb21lIHZlcnNpb24gPD0gNTUgYnVnIHdoZXJlIHNpbmdsZSB0ZXh0Tm9kZQogICAgICAvLyByZXBsYWNlZCBieSBpbm5lckhUTUwvdGV4dENvbnRlbnQgcmV0YWlucyBpdHMgcGFyZW50Tm9kZSBwcm9wZXJ0eQoKCiAgICAgIGlmIChlbG0uY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBlbG0ucmVtb3ZlQ2hpbGQoZWxtLmNoaWxkTm9kZXNbMF0pOwogICAgICB9CiAgICB9CgogICAgaWYgKGtleSA9PT0gJ3ZhbHVlJyAmJiBlbG0udGFnTmFtZSAhPT0gJ1BST0dSRVNTJykgewogICAgICAvLyBzdG9yZSB2YWx1ZSBhcyBfdmFsdWUgYXMgd2VsbCBzaW5jZQogICAgICAvLyBub24tc3RyaW5nIHZhbHVlcyB3aWxsIGJlIHN0cmluZ2lmaWVkCiAgICAgIGVsbS5fdmFsdWUgPSBjdXI7IC8vIGF2b2lkIHJlc2V0dGluZyBjdXJzb3IgcG9zaXRpb24gd2hlbiB2YWx1ZSBpcyB0aGUgc2FtZQoKICAgICAgdmFyIHN0ckN1ciA9IGlzVW5kZWYoY3VyKSA/ICcnIDogU3RyaW5nKGN1cik7CgogICAgICBpZiAoc2hvdWxkVXBkYXRlVmFsdWUoZWxtLCBzdHJDdXIpKSB7CiAgICAgICAgZWxtLnZhbHVlID0gc3RyQ3VyOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ2lubmVySFRNTCcgJiYgaXNTVkcoZWxtLnRhZ05hbWUpICYmIGlzVW5kZWYoZWxtLmlubmVySFRNTCkpIHsKICAgICAgLy8gSUUgZG9lc24ndCBzdXBwb3J0IGlubmVySFRNTCBmb3IgU1ZHIGVsZW1lbnRzCiAgICAgIHN2Z0NvbnRhaW5lciA9IHN2Z0NvbnRhaW5lciB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgc3ZnQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBjdXIgKyAiPC9zdmc+IjsKICAgICAgdmFyIHN2ZyA9IHN2Z0NvbnRhaW5lci5maXJzdENoaWxkOwoKICAgICAgd2hpbGUgKGVsbS5maXJzdENoaWxkKSB7CiAgICAgICAgZWxtLnJlbW92ZUNoaWxkKGVsbS5maXJzdENoaWxkKTsKICAgICAgfQoKICAgICAgd2hpbGUgKHN2Zy5maXJzdENoaWxkKSB7CiAgICAgICAgZWxtLmFwcGVuZENoaWxkKHN2Zy5maXJzdENoaWxkKTsKICAgICAgfQogICAgfSBlbHNlIGlmICggLy8gc2tpcCB0aGUgdXBkYXRlIGlmIG9sZCBhbmQgbmV3IFZET00gc3RhdGUgaXMgdGhlIHNhbWUuCiAgICAvLyBgdmFsdWVgIGlzIGhhbmRsZWQgc2VwYXJhdGVseSBiZWNhdXNlIHRoZSBET00gdmFsdWUgbWF5IGJlIHRlbXBvcmFyaWx5CiAgICAvLyBvdXQgb2Ygc3luYyB3aXRoIFZET00gc3RhdGUgZHVlIHRvIGZvY3VzLCBjb21wb3NpdGlvbiBhbmQgbW9kaWZpZXJzLgogICAgLy8gVGhpcyAgIzQ1MjEgYnkgc2tpcHBpbmcgdGhlIHVubmVjZXNzYXJ5IGBjaGVja2VkYCB1cGRhdGUuCiAgICBjdXIgIT09IG9sZFByb3BzW2tleV0pIHsKICAgICAgLy8gc29tZSBwcm9wZXJ0eSB1cGRhdGVzIGNhbiB0aHJvdwogICAgICAvLyBlLmcuIGB2YWx1ZWAgb24gPHByb2dyZXNzPiB3LyBub24tZmluaXRlIHZhbHVlCiAgICAgIHRyeSB7CiAgICAgICAgZWxtW2tleV0gPSBjdXI7CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9CiAgfQp9IC8vIGNoZWNrIHBsYXRmb3Jtcy93ZWIvdXRpbC9hdHRycy5qcyBhY2NlcHRWYWx1ZQoKCmZ1bmN0aW9uIHNob3VsZFVwZGF0ZVZhbHVlKGVsbSwgY2hlY2tWYWwpIHsKICByZXR1cm4gIWVsbS5jb21wb3NpbmcgJiYgKGVsbS50YWdOYW1lID09PSAnT1BUSU9OJyB8fCBpc05vdEluRm9jdXNBbmREaXJ0eShlbG0sIGNoZWNrVmFsKSB8fCBpc0RpcnR5V2l0aE1vZGlmaWVycyhlbG0sIGNoZWNrVmFsKSk7Cn0KCmZ1bmN0aW9uIGlzTm90SW5Gb2N1c0FuZERpcnR5KGVsbSwgY2hlY2tWYWwpIHsKICAvLyByZXR1cm4gdHJ1ZSB3aGVuIHRleHRib3ggKC5udW1iZXIgYW5kIC50cmltKSBsb3NlcyBmb2N1cyBhbmQgaXRzIHZhbHVlIGlzCiAgLy8gbm90IGVxdWFsIHRvIHRoZSB1cGRhdGVkIHZhbHVlCiAgdmFyIG5vdEluRm9jdXMgPSB0cnVlOyAvLyAjNjE1NwogIC8vIHdvcmsgYXJvdW5kIElFIGJ1ZyB3aGVuIGFjY2Vzc2luZyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGluIGFuIGlmcmFtZQoKICB0cnkgewogICAgbm90SW5Gb2N1cyA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IGVsbTsKICB9IGNhdGNoIChlKSB7fQoKICByZXR1cm4gbm90SW5Gb2N1cyAmJiBlbG0udmFsdWUgIT09IGNoZWNrVmFsOwp9CgpmdW5jdGlvbiBpc0RpcnR5V2l0aE1vZGlmaWVycyhlbG0sIG5ld1ZhbCkgewogIHZhciB2YWx1ZSA9IGVsbS52YWx1ZTsKICB2YXIgbW9kaWZpZXJzID0gZWxtLl92TW9kaWZpZXJzOyAvLyBpbmplY3RlZCBieSB2LW1vZGVsIHJ1bnRpbWUKCiAgaWYgKGlzRGVmKG1vZGlmaWVycykpIHsKICAgIGlmIChtb2RpZmllcnMubnVtYmVyKSB7CiAgICAgIHJldHVybiB0b051bWJlcih2YWx1ZSkgIT09IHRvTnVtYmVyKG5ld1ZhbCk7CiAgICB9CgogICAgaWYgKG1vZGlmaWVycy50cmltKSB7CiAgICAgIHJldHVybiB2YWx1ZS50cmltKCkgIT09IG5ld1ZhbC50cmltKCk7CiAgICB9CiAgfQoKICByZXR1cm4gdmFsdWUgIT09IG5ld1ZhbDsKfQoKdmFyIGRvbVByb3BzID0gewogIGNyZWF0ZTogdXBkYXRlRE9NUHJvcHMsCiAgdXBkYXRlOiB1cGRhdGVET01Qcm9wcwp9OwovKiAgKi8KCnZhciBwYXJzZVN0eWxlVGV4dCA9IGNhY2hlZChmdW5jdGlvbiAoY3NzVGV4dCkgewogIHZhciByZXMgPSB7fTsKICB2YXIgbGlzdERlbGltaXRlciA9IC87KD8hW14oXSpcKSkvZzsKICB2YXIgcHJvcGVydHlEZWxpbWl0ZXIgPSAvOiguKykvOwogIGNzc1RleHQuc3BsaXQobGlzdERlbGltaXRlcikuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgaWYgKGl0ZW0pIHsKICAgICAgdmFyIHRtcCA9IGl0ZW0uc3BsaXQocHJvcGVydHlEZWxpbWl0ZXIpOwogICAgICB0bXAubGVuZ3RoID4gMSAmJiAocmVzW3RtcFswXS50cmltKCldID0gdG1wWzFdLnRyaW0oKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHJlczsKfSk7IC8vIG1lcmdlIHN0YXRpYyBhbmQgZHluYW1pYyBzdHlsZSBkYXRhIG9uIHRoZSBzYW1lIHZub2RlCgpmdW5jdGlvbiBub3JtYWxpemVTdHlsZURhdGEoZGF0YSkgewogIHZhciBzdHlsZSA9IG5vcm1hbGl6ZVN0eWxlQmluZGluZyhkYXRhLnN0eWxlKTsgLy8gc3RhdGljIHN0eWxlIGlzIHByZS1wcm9jZXNzZWQgaW50byBhbiBvYmplY3QgZHVyaW5nIGNvbXBpbGF0aW9uCiAgLy8gYW5kIGlzIGFsd2F5cyBhIGZyZXNoIG9iamVjdCwgc28gaXQncyBzYWZlIHRvIG1lcmdlIGludG8gaXQKCiAgcmV0dXJuIGRhdGEuc3RhdGljU3R5bGUgPyBleHRlbmQoZGF0YS5zdGF0aWNTdHlsZSwgc3R5bGUpIDogc3R5bGU7Cn0gLy8gbm9ybWFsaXplIHBvc3NpYmxlIGFycmF5IC8gc3RyaW5nIHZhbHVlcyBpbnRvIE9iamVjdAoKCmZ1bmN0aW9uIG5vcm1hbGl6ZVN0eWxlQmluZGluZyhiaW5kaW5nU3R5bGUpIHsKICBpZiAoQXJyYXkuaXNBcnJheShiaW5kaW5nU3R5bGUpKSB7CiAgICByZXR1cm4gdG9PYmplY3QoYmluZGluZ1N0eWxlKTsKICB9CgogIGlmICh0eXBlb2YgYmluZGluZ1N0eWxlID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIHBhcnNlU3R5bGVUZXh0KGJpbmRpbmdTdHlsZSk7CiAgfQoKICByZXR1cm4gYmluZGluZ1N0eWxlOwp9Ci8qKgogKiBwYXJlbnQgY29tcG9uZW50IHN0eWxlIHNob3VsZCBiZSBhZnRlciBjaGlsZCdzCiAqIHNvIHRoYXQgcGFyZW50IGNvbXBvbmVudCdzIHN0eWxlIGNvdWxkIG92ZXJyaWRlIGl0CiAqLwoKCmZ1bmN0aW9uIGdldFN0eWxlKHZub2RlLCBjaGVja0NoaWxkKSB7CiAgdmFyIHJlcyA9IHt9OwogIHZhciBzdHlsZURhdGE7CgogIGlmIChjaGVja0NoaWxkKSB7CiAgICB2YXIgY2hpbGROb2RlID0gdm5vZGU7CgogICAgd2hpbGUgKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICBjaGlsZE5vZGUgPSBjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwoKICAgICAgaWYgKGNoaWxkTm9kZSAmJiBjaGlsZE5vZGUuZGF0YSAmJiAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKGNoaWxkTm9kZS5kYXRhKSkpIHsKICAgICAgICBleHRlbmQocmVzLCBzdHlsZURhdGEpOwogICAgICB9CiAgICB9CiAgfQoKICBpZiAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKHZub2RlLmRhdGEpKSB7CiAgICBleHRlbmQocmVzLCBzdHlsZURhdGEpOwogIH0KCiAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKCiAgd2hpbGUgKHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLnBhcmVudCkgewogICAgaWYgKHBhcmVudE5vZGUuZGF0YSAmJiAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKHBhcmVudE5vZGUuZGF0YSkpKSB7CiAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCnZhciBjc3NWYXJSRSA9IC9eLS0vOwp2YXIgaW1wb3J0YW50UkUgPSAvXHMqIWltcG9ydGFudCQvOwoKdmFyIHNldFByb3AgPSBmdW5jdGlvbiBzZXRQcm9wKGVsLCBuYW1lLCB2YWwpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoY3NzVmFyUkUudGVzdChuYW1lKSkgewogICAgZWwuc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsKTsKICB9IGVsc2UgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgewogICAgZWwuc3R5bGUuc2V0UHJvcGVydHkoaHlwaGVuYXRlKG5hbWUpLCB2YWwucmVwbGFjZShpbXBvcnRhbnRSRSwgJycpLCAnaW1wb3J0YW50Jyk7CiAgfSBlbHNlIHsKICAgIHZhciBub3JtYWxpemVkTmFtZSA9IG5vcm1hbGl6ZShuYW1lKTsKCiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgIC8vIFN1cHBvcnQgdmFsdWVzIGFycmF5IGNyZWF0ZWQgYnkgYXV0b3ByZWZpeGVyLCBlLmcuCiAgICAgIC8vIHtkaXNwbGF5OiBbIi13ZWJraXQtYm94IiwgIi1tcy1mbGV4Ym94IiwgImZsZXgiXX0KICAgICAgLy8gU2V0IHRoZW0gb25lIGJ5IG9uZSwgYW5kIHRoZSBicm93c2VyIHdpbGwgb25seSBzZXQgdGhvc2UgaXQgY2FuIHJlY29nbml6ZQogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdmFsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgZWwuc3R5bGVbbm9ybWFsaXplZE5hbWVdID0gdmFsW2ldOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZVtub3JtYWxpemVkTmFtZV0gPSB2YWw7CiAgICB9CiAgfQp9OwoKdmFyIHZlbmRvck5hbWVzID0gWydXZWJraXQnLCAnTW96JywgJ21zJ107CnZhciBlbXB0eVN0eWxlOwp2YXIgbm9ybWFsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChwcm9wKSB7CiAgZW1wdHlTdHlsZSA9IGVtcHR5U3R5bGUgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jykuc3R5bGU7CiAgcHJvcCA9IGNhbWVsaXplKHByb3ApOwoKICBpZiAocHJvcCAhPT0gJ2ZpbHRlcicgJiYgcHJvcCBpbiBlbXB0eVN0eWxlKSB7CiAgICByZXR1cm4gcHJvcDsKICB9CgogIHZhciBjYXBOYW1lID0gcHJvcC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHByb3Auc2xpY2UoMSk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgdmVuZG9yTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBuYW1lID0gdmVuZG9yTmFtZXNbaV0gKyBjYXBOYW1lOwoKICAgIGlmIChuYW1lIGluIGVtcHR5U3R5bGUpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgfQp9KTsKCmZ1bmN0aW9uIHVwZGF0ZVN0eWxlKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBkYXRhID0gdm5vZGUuZGF0YTsKICB2YXIgb2xkRGF0YSA9IG9sZFZub2RlLmRhdGE7CgogIGlmIChpc1VuZGVmKGRhdGEuc3RhdGljU3R5bGUpICYmIGlzVW5kZWYoZGF0YS5zdHlsZSkgJiYgaXNVbmRlZihvbGREYXRhLnN0YXRpY1N0eWxlKSAmJiBpc1VuZGVmKG9sZERhdGEuc3R5bGUpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY3VyLCBuYW1lOwogIHZhciBlbCA9IHZub2RlLmVsbTsKICB2YXIgb2xkU3RhdGljU3R5bGUgPSBvbGREYXRhLnN0YXRpY1N0eWxlOwogIHZhciBvbGRTdHlsZUJpbmRpbmcgPSBvbGREYXRhLm5vcm1hbGl6ZWRTdHlsZSB8fCBvbGREYXRhLnN0eWxlIHx8IHt9OyAvLyBpZiBzdGF0aWMgc3R5bGUgZXhpc3RzLCBzdHlsZWJpbmRpbmcgYWxyZWFkeSBtZXJnZWQgaW50byBpdCB3aGVuIGRvaW5nIG5vcm1hbGl6ZVN0eWxlRGF0YQoKICB2YXIgb2xkU3R5bGUgPSBvbGRTdGF0aWNTdHlsZSB8fCBvbGRTdHlsZUJpbmRpbmc7CiAgdmFyIHN0eWxlID0gbm9ybWFsaXplU3R5bGVCaW5kaW5nKHZub2RlLmRhdGEuc3R5bGUpIHx8IHt9OyAvLyBzdG9yZSBub3JtYWxpemVkIHN0eWxlIHVuZGVyIGEgZGlmZmVyZW50IGtleSBmb3IgbmV4dCBkaWZmCiAgLy8gbWFrZSBzdXJlIHRvIGNsb25lIGl0IGlmIGl0J3MgcmVhY3RpdmUsIHNpbmNlIHRoZSB1c2VyIGxpa2VseSB3YW50cwogIC8vIHRvIG11dGF0ZSBpdC4KCiAgdm5vZGUuZGF0YS5ub3JtYWxpemVkU3R5bGUgPSBpc0RlZihzdHlsZS5fX29iX18pID8gZXh0ZW5kKHt9LCBzdHlsZSkgOiBzdHlsZTsKICB2YXIgbmV3U3R5bGUgPSBnZXRTdHlsZSh2bm9kZSwgdHJ1ZSk7CgogIGZvciAobmFtZSBpbiBvbGRTdHlsZSkgewogICAgaWYgKGlzVW5kZWYobmV3U3R5bGVbbmFtZV0pKSB7CiAgICAgIHNldFByb3AoZWwsIG5hbWUsICcnKTsKICAgIH0KICB9CgogIGZvciAobmFtZSBpbiBuZXdTdHlsZSkgewogICAgY3VyID0gbmV3U3R5bGVbbmFtZV07CgogICAgaWYgKGN1ciAhPT0gb2xkU3R5bGVbbmFtZV0pIHsKICAgICAgLy8gaWU5IHNldHRpbmcgdG8gbnVsbCBoYXMgbm8gZWZmZWN0LCBtdXN0IHVzZSBlbXB0eSBzdHJpbmcKICAgICAgc2V0UHJvcChlbCwgbmFtZSwgY3VyID09IG51bGwgPyAnJyA6IGN1cik7CiAgICB9CiAgfQp9Cgp2YXIgc3R5bGUgPSB7CiAgY3JlYXRlOiB1cGRhdGVTdHlsZSwKICB1cGRhdGU6IHVwZGF0ZVN0eWxlCn07Ci8qICAqLwoKdmFyIHdoaXRlc3BhY2VSRSA9IC9ccysvOwovKioKICogQWRkIGNsYXNzIHdpdGggY29tcGF0aWJpbGl0eSBmb3IgU1ZHIHNpbmNlIGNsYXNzTGlzdCBpcyBub3Qgc3VwcG9ydGVkIG9uCiAqIFNWRyBlbGVtZW50cyBpbiBJRQogKi8KCmZ1bmN0aW9uIGFkZENsYXNzKGVsLCBjbHMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoIWNscyB8fCAhKGNscyA9IGNscy50cmltKCkpKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICBpZiAoY2xzLmluZGV4T2YoJyAnKSA+IC0xKSB7CiAgICAgIGNscy5zcGxpdCh3aGl0ZXNwYWNlUkUpLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgICByZXR1cm4gZWwuY2xhc3NMaXN0LmFkZChjKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc0xpc3QuYWRkKGNscyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBjdXIgPSAiICIgKyAoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIjsKCiAgICBpZiAoY3VyLmluZGV4T2YoJyAnICsgY2xzICsgJyAnKSA8IDApIHsKICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIChjdXIgKyBjbHMpLnRyaW0oKSk7CiAgICB9CiAgfQp9Ci8qKgogKiBSZW1vdmUgY2xhc3Mgd2l0aCBjb21wYXRpYmlsaXR5IGZvciBTVkcgc2luY2UgY2xhc3NMaXN0IGlzIG5vdCBzdXBwb3J0ZWQgb24KICogU1ZHIGVsZW1lbnRzIGluIElFCiAqLwoKCmZ1bmN0aW9uIHJlbW92ZUNsYXNzKGVsLCBjbHMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoIWNscyB8fCAhKGNscyA9IGNscy50cmltKCkpKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICBpZiAoY2xzLmluZGV4T2YoJyAnKSA+IC0xKSB7CiAgICAgIGNscy5zcGxpdCh3aGl0ZXNwYWNlUkUpLmZvckVhY2goZnVuY3Rpb24gKGMpIHsKICAgICAgICByZXR1cm4gZWwuY2xhc3NMaXN0LnJlbW92ZShjKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNscyk7CiAgICB9CgogICAgaWYgKCFlbC5jbGFzc0xpc3QubGVuZ3RoKSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGN1ciA9ICIgIiArIChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgIiAiOwogICAgdmFyIHRhciA9ICcgJyArIGNscyArICcgJzsKCiAgICB3aGlsZSAoY3VyLmluZGV4T2YodGFyKSA+PSAwKSB7CiAgICAgIGN1ciA9IGN1ci5yZXBsYWNlKHRhciwgJyAnKTsKICAgIH0KCiAgICBjdXIgPSBjdXIudHJpbSgpOwoKICAgIGlmIChjdXIpIHsKICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIGN1cik7CiAgICB9IGVsc2UgewogICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICB9CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uKGRlZiQkMSkgewogIGlmICghZGVmJCQxKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoX3R5cGVvZihkZWYkJDEpID09PSAnb2JqZWN0JykgewogICAgdmFyIHJlcyA9IHt9OwoKICAgIGlmIChkZWYkJDEuY3NzICE9PSBmYWxzZSkgewogICAgICBleHRlbmQocmVzLCBhdXRvQ3NzVHJhbnNpdGlvbihkZWYkJDEubmFtZSB8fCAndicpKTsKICAgIH0KCiAgICBleHRlbmQocmVzLCBkZWYkJDEpOwogICAgcmV0dXJuIHJlczsKICB9IGVsc2UgaWYgKHR5cGVvZiBkZWYkJDEgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gYXV0b0Nzc1RyYW5zaXRpb24oZGVmJCQxKTsKICB9Cn0KCnZhciBhdXRvQ3NzVHJhbnNpdGlvbiA9IGNhY2hlZChmdW5jdGlvbiAobmFtZSkgewogIHJldHVybiB7CiAgICBlbnRlckNsYXNzOiBuYW1lICsgIi1lbnRlciIsCiAgICBlbnRlclRvQ2xhc3M6IG5hbWUgKyAiLWVudGVyLXRvIiwKICAgIGVudGVyQWN0aXZlQ2xhc3M6IG5hbWUgKyAiLWVudGVyLWFjdGl2ZSIsCiAgICBsZWF2ZUNsYXNzOiBuYW1lICsgIi1sZWF2ZSIsCiAgICBsZWF2ZVRvQ2xhc3M6IG5hbWUgKyAiLWxlYXZlLXRvIiwKICAgIGxlYXZlQWN0aXZlQ2xhc3M6IG5hbWUgKyAiLWxlYXZlLWFjdGl2ZSIKICB9Owp9KTsKdmFyIGhhc1RyYW5zaXRpb24gPSBpbkJyb3dzZXIgJiYgIWlzSUU5Owp2YXIgVFJBTlNJVElPTiA9ICd0cmFuc2l0aW9uJzsKdmFyIEFOSU1BVElPTiA9ICdhbmltYXRpb24nOyAvLyBUcmFuc2l0aW9uIHByb3BlcnR5L2V2ZW50IHNuaWZmaW5nCgp2YXIgdHJhbnNpdGlvblByb3AgPSAndHJhbnNpdGlvbic7CnZhciB0cmFuc2l0aW9uRW5kRXZlbnQgPSAndHJhbnNpdGlvbmVuZCc7CnZhciBhbmltYXRpb25Qcm9wID0gJ2FuaW1hdGlvbic7CnZhciBhbmltYXRpb25FbmRFdmVudCA9ICdhbmltYXRpb25lbmQnOwoKaWYgKGhhc1RyYW5zaXRpb24pIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgdHJhbnNpdGlvblByb3AgPSAnV2Via2l0VHJhbnNpdGlvbic7CiAgICB0cmFuc2l0aW9uRW5kRXZlbnQgPSAnd2Via2l0VHJhbnNpdGlvbkVuZCc7CiAgfQoKICBpZiAod2luZG93Lm9uYW5pbWF0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgIGFuaW1hdGlvblByb3AgPSAnV2Via2l0QW5pbWF0aW9uJzsKICAgIGFuaW1hdGlvbkVuZEV2ZW50ID0gJ3dlYmtpdEFuaW1hdGlvbkVuZCc7CiAgfQp9IC8vIGJpbmRpbmcgdG8gd2luZG93IGlzIG5lY2Vzc2FyeSB0byBtYWtlIGhvdCByZWxvYWQgd29yayBpbiBJRSBpbiBzdHJpY3QgbW9kZQoKCnZhciByYWYgPSBpbkJyb3dzZXIgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdykgOiBzZXRUaW1lb3V0IDoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KZnVuY3Rpb24gKGZuKSB7CiAgcmV0dXJuIGZuKCk7Cn07CgpmdW5jdGlvbiBuZXh0RnJhbWUoZm4pIHsKICByYWYoZnVuY3Rpb24gKCkgewogICAgcmFmKGZuKTsKICB9KTsKfQoKZnVuY3Rpb24gYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBjbHMpIHsKICB2YXIgdHJhbnNpdGlvbkNsYXNzZXMgPSBlbC5fdHJhbnNpdGlvbkNsYXNzZXMgfHwgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcyA9IFtdKTsKCiAgaWYgKHRyYW5zaXRpb25DbGFzc2VzLmluZGV4T2YoY2xzKSA8IDApIHsKICAgIHRyYW5zaXRpb25DbGFzc2VzLnB1c2goY2xzKTsKICAgIGFkZENsYXNzKGVsLCBjbHMpOwogIH0KfQoKZnVuY3Rpb24gcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBjbHMpIHsKICBpZiAoZWwuX3RyYW5zaXRpb25DbGFzc2VzKSB7CiAgICByZW1vdmUoZWwuX3RyYW5zaXRpb25DbGFzc2VzLCBjbHMpOwogIH0KCiAgcmVtb3ZlQ2xhc3MoZWwsIGNscyk7Cn0KCmZ1bmN0aW9uIHdoZW5UcmFuc2l0aW9uRW5kcyhlbCwgZXhwZWN0ZWRUeXBlLCBjYikgewogIHZhciByZWYgPSBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKTsKICB2YXIgdHlwZSA9IHJlZi50eXBlOwogIHZhciB0aW1lb3V0ID0gcmVmLnRpbWVvdXQ7CiAgdmFyIHByb3BDb3VudCA9IHJlZi5wcm9wQ291bnQ7CgogIGlmICghdHlwZSkgewogICAgcmV0dXJuIGNiKCk7CiAgfQoKICB2YXIgZXZlbnQgPSB0eXBlID09PSBUUkFOU0lUSU9OID8gdHJhbnNpdGlvbkVuZEV2ZW50IDogYW5pbWF0aW9uRW5kRXZlbnQ7CiAgdmFyIGVuZGVkID0gMDsKCiAgdmFyIGVuZCA9IGZ1bmN0aW9uIGVuZCgpIHsKICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIG9uRW5kKTsKICAgIGNiKCk7CiAgfTsKCiAgdmFyIG9uRW5kID0gZnVuY3Rpb24gb25FbmQoZSkgewogICAgaWYgKGUudGFyZ2V0ID09PSBlbCkgewogICAgICBpZiAoKytlbmRlZCA+PSBwcm9wQ291bnQpIHsKICAgICAgICBlbmQoKTsKICAgICAgfQogICAgfQogIH07CgogIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgaWYgKGVuZGVkIDwgcHJvcENvdW50KSB7CiAgICAgIGVuZCgpOwogICAgfQogIH0sIHRpbWVvdXQgKyAxKTsKICBlbC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBvbkVuZCk7Cn0KCnZhciB0cmFuc2Zvcm1SRSA9IC9cYih0cmFuc2Zvcm18YWxsKSgsfCQpLzsKCmZ1bmN0aW9uIGdldFRyYW5zaXRpb25JbmZvKGVsLCBleHBlY3RlZFR5cGUpIHsKICB2YXIgc3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpOyAvLyBKU0RPTSBtYXkgcmV0dXJuIHVuZGVmaW5lZCBmb3IgdHJhbnNpdGlvbiBwcm9wZXJ0aWVzCgogIHZhciB0cmFuc2l0aW9uRGVsYXlzID0gKHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdEZWxheSddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9ucyA9IChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnRHVyYXRpb24nXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIHRyYW5zaXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dCh0cmFuc2l0aW9uRGVsYXlzLCB0cmFuc2l0aW9uRHVyYXRpb25zKTsKICB2YXIgYW5pbWF0aW9uRGVsYXlzID0gKHN0eWxlc1thbmltYXRpb25Qcm9wICsgJ0RlbGF5J10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciBhbmltYXRpb25EdXJhdGlvbnMgPSAoc3R5bGVzW2FuaW1hdGlvblByb3AgKyAnRHVyYXRpb24nXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIGFuaW1hdGlvblRpbWVvdXQgPSBnZXRUaW1lb3V0KGFuaW1hdGlvbkRlbGF5cywgYW5pbWF0aW9uRHVyYXRpb25zKTsKICB2YXIgdHlwZTsKICB2YXIgdGltZW91dCA9IDA7CiAgdmFyIHByb3BDb3VudCA9IDA7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChleHBlY3RlZFR5cGUgPT09IFRSQU5TSVRJT04pIHsKICAgIGlmICh0cmFuc2l0aW9uVGltZW91dCA+IDApIHsKICAgICAgdHlwZSA9IFRSQU5TSVRJT047CiAgICAgIHRpbWVvdXQgPSB0cmFuc2l0aW9uVGltZW91dDsKICAgICAgcHJvcENvdW50ID0gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGg7CiAgICB9CiAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09IEFOSU1BVElPTikgewogICAgaWYgKGFuaW1hdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgIHR5cGUgPSBBTklNQVRJT047CiAgICAgIHRpbWVvdXQgPSBhbmltYXRpb25UaW1lb3V0OwogICAgICBwcm9wQ291bnQgPSBhbmltYXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgfQogIH0gZWxzZSB7CiAgICB0aW1lb3V0ID0gTWF0aC5tYXgodHJhbnNpdGlvblRpbWVvdXQsIGFuaW1hdGlvblRpbWVvdXQpOwogICAgdHlwZSA9IHRpbWVvdXQgPiAwID8gdHJhbnNpdGlvblRpbWVvdXQgPiBhbmltYXRpb25UaW1lb3V0ID8gVFJBTlNJVElPTiA6IEFOSU1BVElPTiA6IG51bGw7CiAgICBwcm9wQ291bnQgPSB0eXBlID8gdHlwZSA9PT0gVFJBTlNJVElPTiA/IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoIDogYW5pbWF0aW9uRHVyYXRpb25zLmxlbmd0aCA6IDA7CiAgfQoKICB2YXIgaGFzVHJhbnNmb3JtID0gdHlwZSA9PT0gVFJBTlNJVElPTiAmJiB0cmFuc2Zvcm1SRS50ZXN0KHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdQcm9wZXJ0eSddKTsKICByZXR1cm4gewogICAgdHlwZTogdHlwZSwKICAgIHRpbWVvdXQ6IHRpbWVvdXQsCiAgICBwcm9wQ291bnQ6IHByb3BDb3VudCwKICAgIGhhc1RyYW5zZm9ybTogaGFzVHJhbnNmb3JtCiAgfTsKfQoKZnVuY3Rpb24gZ2V0VGltZW91dChkZWxheXMsIGR1cmF0aW9ucykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgd2hpbGUgKGRlbGF5cy5sZW5ndGggPCBkdXJhdGlvbnMubGVuZ3RoKSB7CiAgICBkZWxheXMgPSBkZWxheXMuY29uY2F0KGRlbGF5cyk7CiAgfQoKICByZXR1cm4gTWF0aC5tYXguYXBwbHkobnVsbCwgZHVyYXRpb25zLm1hcChmdW5jdGlvbiAoZCwgaSkgewogICAgcmV0dXJuIHRvTXMoZCkgKyB0b01zKGRlbGF5c1tpXSk7CiAgfSkpOwp9IC8vIE9sZCB2ZXJzaW9ucyBvZiBDaHJvbWl1bSAoYmVsb3cgNjEuMC4zMTYzLjEwMCkgZm9ybWF0cyBmbG9hdGluZyBwb2ludGVyIG51bWJlcnMKLy8gaW4gYSBsb2NhbGUtZGVwZW5kZW50IHdheSwgdXNpbmcgYSBjb21tYSBpbnN0ZWFkIG9mIGEgZG90LgovLyBJZiBjb21tYSBpcyBub3QgcmVwbGFjZWQgd2l0aCBhIGRvdCwgdGhlIGlucHV0IHdpbGwgYmUgcm91bmRlZCBkb3duIChpLmUuIGFjdGluZwovLyBhcyBhIGZsb29yIGZ1bmN0aW9uKSBjYXVzaW5nIHVuZXhwZWN0ZWQgYmVoYXZpb3JzCgoKZnVuY3Rpb24gdG9NcyhzKSB7CiAgcmV0dXJuIE51bWJlcihzLnNsaWNlKDAsIC0xKS5yZXBsYWNlKCcsJywgJy4nKSkgKiAxMDAwOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGVudGVyKHZub2RlLCB0b2dnbGVEaXNwbGF5KSB7CiAgdmFyIGVsID0gdm5vZGUuZWxtOyAvLyBjYWxsIGxlYXZlIGNhbGxiYWNrIG5vdwoKICBpZiAoaXNEZWYoZWwuX2xlYXZlQ2IpKSB7CiAgICBlbC5fbGVhdmVDYi5jYW5jZWxsZWQgPSB0cnVlOwoKICAgIGVsLl9sZWF2ZUNiKCk7CiAgfQoKICB2YXIgZGF0YSA9IHJlc29sdmVUcmFuc2l0aW9uKHZub2RlLmRhdGEudHJhbnNpdGlvbik7CgogIGlmIChpc1VuZGVmKGRhdGEpKSB7CiAgICByZXR1cm47CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKGlzRGVmKGVsLl9lbnRlckNiKSB8fCBlbC5ub2RlVHlwZSAhPT0gMSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGNzcyA9IGRhdGEuY3NzOwogIHZhciB0eXBlID0gZGF0YS50eXBlOwogIHZhciBlbnRlckNsYXNzID0gZGF0YS5lbnRlckNsYXNzOwogIHZhciBlbnRlclRvQ2xhc3MgPSBkYXRhLmVudGVyVG9DbGFzczsKICB2YXIgZW50ZXJBY3RpdmVDbGFzcyA9IGRhdGEuZW50ZXJBY3RpdmVDbGFzczsKICB2YXIgYXBwZWFyQ2xhc3MgPSBkYXRhLmFwcGVhckNsYXNzOwogIHZhciBhcHBlYXJUb0NsYXNzID0gZGF0YS5hcHBlYXJUb0NsYXNzOwogIHZhciBhcHBlYXJBY3RpdmVDbGFzcyA9IGRhdGEuYXBwZWFyQWN0aXZlQ2xhc3M7CiAgdmFyIGJlZm9yZUVudGVyID0gZGF0YS5iZWZvcmVFbnRlcjsKICB2YXIgZW50ZXIgPSBkYXRhLmVudGVyOwogIHZhciBhZnRlckVudGVyID0gZGF0YS5hZnRlckVudGVyOwogIHZhciBlbnRlckNhbmNlbGxlZCA9IGRhdGEuZW50ZXJDYW5jZWxsZWQ7CiAgdmFyIGJlZm9yZUFwcGVhciA9IGRhdGEuYmVmb3JlQXBwZWFyOwogIHZhciBhcHBlYXIgPSBkYXRhLmFwcGVhcjsKICB2YXIgYWZ0ZXJBcHBlYXIgPSBkYXRhLmFmdGVyQXBwZWFyOwogIHZhciBhcHBlYXJDYW5jZWxsZWQgPSBkYXRhLmFwcGVhckNhbmNlbGxlZDsKICB2YXIgZHVyYXRpb24gPSBkYXRhLmR1cmF0aW9uOyAvLyBhY3RpdmVJbnN0YW5jZSB3aWxsIGFsd2F5cyBiZSB0aGUgPHRyYW5zaXRpb24+IGNvbXBvbmVudCBtYW5hZ2luZyB0aGlzCiAgLy8gdHJhbnNpdGlvbi4gT25lIGVkZ2UgY2FzZSB0byBjaGVjayBpcyB3aGVuIHRoZSA8dHJhbnNpdGlvbj4gaXMgcGxhY2VkCiAgLy8gYXMgdGhlIHJvb3Qgbm9kZSBvZiBhIGNoaWxkIGNvbXBvbmVudC4gSW4gdGhhdCBjYXNlIHdlIG5lZWQgdG8gY2hlY2sKICAvLyA8dHJhbnNpdGlvbj4ncyBwYXJlbnQgZm9yIGFwcGVhciBjaGVjay4KCiAgdmFyIGNvbnRleHQgPSBhY3RpdmVJbnN0YW5jZTsKICB2YXIgdHJhbnNpdGlvbk5vZGUgPSBhY3RpdmVJbnN0YW5jZS4kdm5vZGU7CgogIHdoaWxlICh0cmFuc2l0aW9uTm9kZSAmJiB0cmFuc2l0aW9uTm9kZS5wYXJlbnQpIHsKICAgIGNvbnRleHQgPSB0cmFuc2l0aW9uTm9kZS5jb250ZXh0OwogICAgdHJhbnNpdGlvbk5vZGUgPSB0cmFuc2l0aW9uTm9kZS5wYXJlbnQ7CiAgfQoKICB2YXIgaXNBcHBlYXIgPSAhY29udGV4dC5faXNNb3VudGVkIHx8ICF2bm9kZS5pc1Jvb3RJbnNlcnQ7CgogIGlmIChpc0FwcGVhciAmJiAhYXBwZWFyICYmIGFwcGVhciAhPT0gJycpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBzdGFydENsYXNzID0gaXNBcHBlYXIgJiYgYXBwZWFyQ2xhc3MgPyBhcHBlYXJDbGFzcyA6IGVudGVyQ2xhc3M7CiAgdmFyIGFjdGl2ZUNsYXNzID0gaXNBcHBlYXIgJiYgYXBwZWFyQWN0aXZlQ2xhc3MgPyBhcHBlYXJBY3RpdmVDbGFzcyA6IGVudGVyQWN0aXZlQ2xhc3M7CiAgdmFyIHRvQ2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJUb0NsYXNzID8gYXBwZWFyVG9DbGFzcyA6IGVudGVyVG9DbGFzczsKICB2YXIgYmVmb3JlRW50ZXJIb29rID0gaXNBcHBlYXIgPyBiZWZvcmVBcHBlYXIgfHwgYmVmb3JlRW50ZXIgOiBiZWZvcmVFbnRlcjsKICB2YXIgZW50ZXJIb29rID0gaXNBcHBlYXIgPyB0eXBlb2YgYXBwZWFyID09PSAnZnVuY3Rpb24nID8gYXBwZWFyIDogZW50ZXIgOiBlbnRlcjsKICB2YXIgYWZ0ZXJFbnRlckhvb2sgPSBpc0FwcGVhciA/IGFmdGVyQXBwZWFyIHx8IGFmdGVyRW50ZXIgOiBhZnRlckVudGVyOwogIHZhciBlbnRlckNhbmNlbGxlZEhvb2sgPSBpc0FwcGVhciA/IGFwcGVhckNhbmNlbGxlZCB8fCBlbnRlckNhbmNlbGxlZCA6IGVudGVyQ2FuY2VsbGVkOwogIHZhciBleHBsaWNpdEVudGVyRHVyYXRpb24gPSB0b051bWJlcihpc09iamVjdChkdXJhdGlvbikgPyBkdXJhdGlvbi5lbnRlciA6IGR1cmF0aW9uKTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgZXhwbGljaXRFbnRlckR1cmF0aW9uICE9IG51bGwpIHsKICAgIGNoZWNrRHVyYXRpb24oZXhwbGljaXRFbnRlckR1cmF0aW9uLCAnZW50ZXInLCB2bm9kZSk7CiAgfQoKICB2YXIgZXhwZWN0c0NTUyA9IGNzcyAhPT0gZmFsc2UgJiYgIWlzSUU5OwogIHZhciB1c2VyV2FudHNDb250cm9sID0gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aChlbnRlckhvb2spOwogIHZhciBjYiA9IGVsLl9lbnRlckNiID0gb25jZShmdW5jdGlvbiAoKSB7CiAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHRvQ2xhc3MpOwogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGFjdGl2ZUNsYXNzKTsKICAgIH0KCiAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKICAgICAgfQoKICAgICAgZW50ZXJDYW5jZWxsZWRIb29rICYmIGVudGVyQ2FuY2VsbGVkSG9vayhlbCk7CiAgICB9IGVsc2UgewogICAgICBhZnRlckVudGVySG9vayAmJiBhZnRlckVudGVySG9vayhlbCk7CiAgICB9CgogICAgZWwuX2VudGVyQ2IgPSBudWxsOwogIH0pOwoKICBpZiAoIXZub2RlLmRhdGEuc2hvdykgewogICAgLy8gcmVtb3ZlIHBlbmRpbmcgbGVhdmUgZWxlbWVudCBvbiBlbnRlciBieSBpbmplY3RpbmcgYW4gaW5zZXJ0IGhvb2sKICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgcGFyZW50ID0gZWwucGFyZW50Tm9kZTsKICAgICAgdmFyIHBlbmRpbmdOb2RlID0gcGFyZW50ICYmIHBhcmVudC5fcGVuZGluZyAmJiBwYXJlbnQuX3BlbmRpbmdbdm5vZGUua2V5XTsKCiAgICAgIGlmIChwZW5kaW5nTm9kZSAmJiBwZW5kaW5nTm9kZS50YWcgPT09IHZub2RlLnRhZyAmJiBwZW5kaW5nTm9kZS5lbG0uX2xlYXZlQ2IpIHsKICAgICAgICBwZW5kaW5nTm9kZS5lbG0uX2xlYXZlQ2IoKTsKICAgICAgfQoKICAgICAgZW50ZXJIb29rICYmIGVudGVySG9vayhlbCwgY2IpOwogICAgfSk7CiAgfSAvLyBzdGFydCBlbnRlciB0cmFuc2l0aW9uCgoKICBiZWZvcmVFbnRlckhvb2sgJiYgYmVmb3JlRW50ZXJIb29rKGVsKTsKCiAgaWYgKGV4cGVjdHNDU1MpIHsKICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGFjdGl2ZUNsYXNzKTsKICAgIG5leHRGcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CgogICAgICBpZiAoIWNiLmNhbmNlbGxlZCkgewogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgdG9DbGFzcyk7CgogICAgICAgIGlmICghdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgICAgaWYgKGlzVmFsaWREdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24pKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0RW50ZXJEdXJhdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGNiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCiAgaWYgKHZub2RlLmRhdGEuc2hvdykgewogICAgdG9nZ2xlRGlzcGxheSAmJiB0b2dnbGVEaXNwbGF5KCk7CiAgICBlbnRlckhvb2sgJiYgZW50ZXJIb29rKGVsLCBjYik7CiAgfQoKICBpZiAoIWV4cGVjdHNDU1MgJiYgIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgIGNiKCk7CiAgfQp9CgpmdW5jdGlvbiBsZWF2ZSh2bm9kZSwgcm0pIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07IC8vIGNhbGwgZW50ZXIgY2FsbGJhY2sgbm93CgogIGlmIChpc0RlZihlbC5fZW50ZXJDYikpIHsKICAgIGVsLl9lbnRlckNiLmNhbmNlbGxlZCA9IHRydWU7CgogICAgZWwuX2VudGVyQ2IoKTsKICB9CgogIHZhciBkYXRhID0gcmVzb2x2ZVRyYW5zaXRpb24odm5vZGUuZGF0YS50cmFuc2l0aW9uKTsKCiAgaWYgKGlzVW5kZWYoZGF0YSkgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgIHJldHVybiBybSgpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChpc0RlZihlbC5fbGVhdmVDYikpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjc3MgPSBkYXRhLmNzczsKICB2YXIgdHlwZSA9IGRhdGEudHlwZTsKICB2YXIgbGVhdmVDbGFzcyA9IGRhdGEubGVhdmVDbGFzczsKICB2YXIgbGVhdmVUb0NsYXNzID0gZGF0YS5sZWF2ZVRvQ2xhc3M7CiAgdmFyIGxlYXZlQWN0aXZlQ2xhc3MgPSBkYXRhLmxlYXZlQWN0aXZlQ2xhc3M7CiAgdmFyIGJlZm9yZUxlYXZlID0gZGF0YS5iZWZvcmVMZWF2ZTsKICB2YXIgbGVhdmUgPSBkYXRhLmxlYXZlOwogIHZhciBhZnRlckxlYXZlID0gZGF0YS5hZnRlckxlYXZlOwogIHZhciBsZWF2ZUNhbmNlbGxlZCA9IGRhdGEubGVhdmVDYW5jZWxsZWQ7CiAgdmFyIGRlbGF5TGVhdmUgPSBkYXRhLmRlbGF5TGVhdmU7CiAgdmFyIGR1cmF0aW9uID0gZGF0YS5kdXJhdGlvbjsKICB2YXIgZXhwZWN0c0NTUyA9IGNzcyAhPT0gZmFsc2UgJiYgIWlzSUU5OwogIHZhciB1c2VyV2FudHNDb250cm9sID0gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aChsZWF2ZSk7CiAgdmFyIGV4cGxpY2l0TGVhdmVEdXJhdGlvbiA9IHRvTnVtYmVyKGlzT2JqZWN0KGR1cmF0aW9uKSA/IGR1cmF0aW9uLmxlYXZlIDogZHVyYXRpb24pOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBpc0RlZihleHBsaWNpdExlYXZlRHVyYXRpb24pKSB7CiAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0TGVhdmVEdXJhdGlvbiwgJ2xlYXZlJywgdm5vZGUpOwogIH0KCiAgdmFyIGNiID0gZWwuX2xlYXZlQ2IgPSBvbmNlKGZ1bmN0aW9uICgpIHsKICAgIGlmIChlbC5wYXJlbnROb2RlICYmIGVsLnBhcmVudE5vZGUuX3BlbmRpbmcpIHsKICAgICAgZWwucGFyZW50Tm9kZS5fcGVuZGluZ1t2bm9kZS5rZXldID0gbnVsbDsKICAgIH0KCiAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICB9CgogICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CiAgICAgIH0KCiAgICAgIGxlYXZlQ2FuY2VsbGVkICYmIGxlYXZlQ2FuY2VsbGVkKGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHJtKCk7CiAgICAgIGFmdGVyTGVhdmUgJiYgYWZ0ZXJMZWF2ZShlbCk7CiAgICB9CgogICAgZWwuX2xlYXZlQ2IgPSBudWxsOwogIH0pOwoKICBpZiAoZGVsYXlMZWF2ZSkgewogICAgZGVsYXlMZWF2ZShwZXJmb3JtTGVhdmUpOwogIH0gZWxzZSB7CiAgICBwZXJmb3JtTGVhdmUoKTsKICB9CgogIGZ1bmN0aW9uIHBlcmZvcm1MZWF2ZSgpIHsKICAgIC8vIHRoZSBkZWxheWVkIGxlYXZlIG1heSBoYXZlIGFscmVhZHkgYmVlbiBjYW5jZWxsZWQKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyByZWNvcmQgbGVhdmluZyBlbGVtZW50CgoKICAgIGlmICghdm5vZGUuZGF0YS5zaG93ICYmIGVsLnBhcmVudE5vZGUpIHsKICAgICAgKGVsLnBhcmVudE5vZGUuX3BlbmRpbmcgfHwgKGVsLnBhcmVudE5vZGUuX3BlbmRpbmcgPSB7fSkpW3Zub2RlLmtleV0gPSB2bm9kZTsKICAgIH0KCiAgICBiZWZvcmVMZWF2ZSAmJiBiZWZvcmVMZWF2ZShlbCk7CgogICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsKICAgICAgbmV4dEZyYW1lKGZ1bmN0aW9uICgpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwoKICAgICAgICBpZiAoIWNiLmNhbmNlbGxlZCkgewogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOwoKICAgICAgICAgIGlmICghdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgICAgICBpZiAoaXNWYWxpZER1cmF0aW9uKGV4cGxpY2l0TGVhdmVEdXJhdGlvbikpIHsKICAgICAgICAgICAgICBzZXRUaW1lb3V0KGNiLCBleHBsaWNpdExlYXZlRHVyYXRpb24pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdoZW5UcmFuc2l0aW9uRW5kcyhlbCwgdHlwZSwgY2IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBsZWF2ZSAmJiBsZWF2ZShlbCwgY2IpOwoKICAgIGlmICghZXhwZWN0c0NTUyAmJiAhdXNlcldhbnRzQ29udHJvbCkgewogICAgICBjYigpOwogICAgfQogIH0KfSAvLyBvbmx5IHVzZWQgaW4gZGV2IG1vZGUKCgpmdW5jdGlvbiBjaGVja0R1cmF0aW9uKHZhbCwgbmFtZSwgdm5vZGUpIHsKICBpZiAodHlwZW9mIHZhbCAhPT0gJ251bWJlcicpIHsKICAgIHdhcm4oIjx0cmFuc2l0aW9uPiBleHBsaWNpdCAiICsgbmFtZSArICIgZHVyYXRpb24gaXMgbm90IGEgdmFsaWQgbnVtYmVyIC0gIiArICJnb3QgIiArIEpTT04uc3RyaW5naWZ5KHZhbCkgKyAiLiIsIHZub2RlLmNvbnRleHQpOwogIH0gZWxzZSBpZiAoaXNOYU4odmFsKSkgewogICAgd2FybigiPHRyYW5zaXRpb24+IGV4cGxpY2l0ICIgKyBuYW1lICsgIiBkdXJhdGlvbiBpcyBOYU4gLSAiICsgJ3RoZSBkdXJhdGlvbiBleHByZXNzaW9uIG1pZ2h0IGJlIGluY29ycmVjdC4nLCB2bm9kZS5jb250ZXh0KTsKICB9Cn0KCmZ1bmN0aW9uIGlzVmFsaWREdXJhdGlvbih2YWwpIHsKICByZXR1cm4gdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgJiYgIWlzTmFOKHZhbCk7Cn0KLyoqCiAqIE5vcm1hbGl6ZSBhIHRyYW5zaXRpb24gaG9vaydzIGFyZ3VtZW50IGxlbmd0aC4gVGhlIGhvb2sgbWF5IGJlOgogKiAtIGEgbWVyZ2VkIGhvb2sgKGludm9rZXIpIHdpdGggdGhlIG9yaWdpbmFsIGluIC5mbnMKICogLSBhIHdyYXBwZWQgY29tcG9uZW50IG1ldGhvZCAoY2hlY2sgLl9sZW5ndGgpCiAqIC0gYSBwbGFpbiBmdW5jdGlvbiAoLmxlbmd0aCkKICovCgoKZnVuY3Rpb24gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aChmbikgewogIGlmIChpc1VuZGVmKGZuKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIGludm9rZXJGbnMgPSBmbi5mbnM7CgogIGlmIChpc0RlZihpbnZva2VyRm5zKSkgewogICAgLy8gaW52b2tlcgogICAgcmV0dXJuIGdldEhvb2tBcmd1bWVudHNMZW5ndGgoQXJyYXkuaXNBcnJheShpbnZva2VyRm5zKSA/IGludm9rZXJGbnNbMF0gOiBpbnZva2VyRm5zKTsKICB9IGVsc2UgewogICAgcmV0dXJuIChmbi5fbGVuZ3RoIHx8IGZuLmxlbmd0aCkgPiAxOwogIH0KfQoKZnVuY3Rpb24gX2VudGVyKF8sIHZub2RlKSB7CiAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgZW50ZXIodm5vZGUpOwogIH0KfQoKdmFyIHRyYW5zaXRpb24gPSBpbkJyb3dzZXIgPyB7CiAgY3JlYXRlOiBfZW50ZXIsCiAgYWN0aXZhdGU6IF9lbnRlciwKICByZW1vdmU6IGZ1bmN0aW9uIHJlbW92ZSQkMSh2bm9kZSwgcm0pIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAodm5vZGUuZGF0YS5zaG93ICE9PSB0cnVlKSB7CiAgICAgIGxlYXZlKHZub2RlLCBybSk7CiAgICB9IGVsc2UgewogICAgICBybSgpOwogICAgfQogIH0KfSA6IHt9Owp2YXIgcGxhdGZvcm1Nb2R1bGVzID0gW2F0dHJzLCBrbGFzcywgZXZlbnRzLCBkb21Qcm9wcywgc3R5bGUsIHRyYW5zaXRpb25dOwovKiAgKi8KLy8gdGhlIGRpcmVjdGl2ZSBtb2R1bGUgc2hvdWxkIGJlIGFwcGxpZWQgbGFzdCwgYWZ0ZXIgYWxsCi8vIGJ1aWx0LWluIG1vZHVsZXMgaGF2ZSBiZWVuIGFwcGxpZWQuCgp2YXIgbW9kdWxlcyA9IHBsYXRmb3JtTW9kdWxlcy5jb25jYXQoYmFzZU1vZHVsZXMpOwp2YXIgcGF0Y2ggPSBjcmVhdGVQYXRjaEZ1bmN0aW9uKHsKICBub2RlT3BzOiBub2RlT3BzLAogIG1vZHVsZXM6IG1vZHVsZXMKfSk7Ci8qKgogKiBOb3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgbGlrZSBhdHRhY2hpbmcKICogcHJvcGVydGllcyB0byBFbGVtZW50cy4KICovCgovKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCmlmIChpc0lFOSkgewogIC8vIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3QvaW50ZXJuZXQtZXhwbG9yZXItOS1vbmlucHV0LwogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgIHZhciBlbCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CgogICAgaWYgKGVsICYmIGVsLnZtb2RlbCkgewogICAgICB0cmlnZ2VyKGVsLCAnaW5wdXQnKTsKICAgIH0KICB9KTsKfQoKdmFyIGRpcmVjdGl2ZSA9IHsKICBpbnNlcnRlZDogZnVuY3Rpb24gaW5zZXJ0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLCBvbGRWbm9kZSkgewogICAgaWYgKHZub2RlLnRhZyA9PT0gJ3NlbGVjdCcpIHsKICAgICAgLy8gIzY5MDMKICAgICAgaWYgKG9sZFZub2RlLmVsbSAmJiAhb2xkVm5vZGUuZWxtLl92T3B0aW9ucykgewogICAgICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAncG9zdHBhdGNoJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgZGlyZWN0aXZlLmNvbXBvbmVudFVwZGF0ZWQoZWwsIGJpbmRpbmcsIHZub2RlKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm5vZGUuY29udGV4dCk7CiAgICAgIH0KCiAgICAgIGVsLl92T3B0aW9ucyA9IFtdLm1hcC5jYWxsKGVsLm9wdGlvbnMsIGdldFZhbHVlKTsKICAgIH0gZWxzZSBpZiAodm5vZGUudGFnID09PSAndGV4dGFyZWEnIHx8IGlzVGV4dElucHV0VHlwZShlbC50eXBlKSkgewogICAgICBlbC5fdk1vZGlmaWVycyA9IGJpbmRpbmcubW9kaWZpZXJzOwoKICAgICAgaWYgKCFiaW5kaW5nLm1vZGlmaWVycy5sYXp5KSB7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY29tcG9zaXRpb25zdGFydCcsIG9uQ29tcG9zaXRpb25TdGFydCk7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY29tcG9zaXRpb25lbmQnLCBvbkNvbXBvc2l0aW9uRW5kKTsgLy8gU2FmYXJpIDwgMTAuMiAmIFVJV2ViVmlldyBkb2Vzbid0IGZpcmUgY29tcG9zaXRpb25lbmQgd2hlbgogICAgICAgIC8vIHN3aXRjaGluZyBmb2N1cyBiZWZvcmUgY29uZmlybWluZyBjb21wb3NpdGlvbiBjaG9pY2UKICAgICAgICAvLyB0aGlzIGFsc28gZml4ZXMgdGhlIGlzc3VlIHdoZXJlIHNvbWUgYnJvd3NlcnMgZS5nLiBpT1MgQ2hyb21lCiAgICAgICAgLy8gZmlyZXMgImNoYW5nZSIgaW5zdGVhZCBvZiAiaW5wdXQiIG9uIGF1dG9jb21wbGV0ZS4KCiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgb25Db21wb3NpdGlvbkVuZCk7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgICAgIGlmIChpc0lFOSkgewogICAgICAgICAgZWwudm1vZGVsID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAogIGNvbXBvbmVudFVwZGF0ZWQ6IGZ1bmN0aW9uIGNvbXBvbmVudFVwZGF0ZWQoZWwsIGJpbmRpbmcsIHZub2RlKSB7CiAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm5vZGUuY29udGV4dCk7IC8vIGluIGNhc2UgdGhlIG9wdGlvbnMgcmVuZGVyZWQgYnkgdi1mb3IgaGF2ZSBjaGFuZ2VkLAogICAgICAvLyBpdCdzIHBvc3NpYmxlIHRoYXQgdGhlIHZhbHVlIGlzIG91dC1vZi1zeW5jIHdpdGggdGhlIHJlbmRlcmVkIG9wdGlvbnMuCiAgICAgIC8vIGRldGVjdCBzdWNoIGNhc2VzIGFuZCBmaWx0ZXIgb3V0IHZhbHVlcyB0aGF0IG5vIGxvbmdlciBoYXMgYSBtYXRjaGluZwogICAgICAvLyBvcHRpb24gaW4gdGhlIERPTS4KCiAgICAgIHZhciBwcmV2T3B0aW9ucyA9IGVsLl92T3B0aW9uczsKICAgICAgdmFyIGN1ck9wdGlvbnMgPSBlbC5fdk9wdGlvbnMgPSBbXS5tYXAuY2FsbChlbC5vcHRpb25zLCBnZXRWYWx1ZSk7CgogICAgICBpZiAoY3VyT3B0aW9ucy5zb21lKGZ1bmN0aW9uIChvLCBpKSB7CiAgICAgICAgcmV0dXJuICFsb29zZUVxdWFsKG8sIHByZXZPcHRpb25zW2ldKTsKICAgICAgfSkpIHsKICAgICAgICAvLyB0cmlnZ2VyIGNoYW5nZSBldmVudCBpZgogICAgICAgIC8vIG5vIG1hdGNoaW5nIG9wdGlvbiBmb3VuZCBmb3IgYXQgbGVhc3Qgb25lIHZhbHVlCiAgICAgICAgdmFyIG5lZWRSZXNldCA9IGVsLm11bHRpcGxlID8gYmluZGluZy52YWx1ZS5zb21lKGZ1bmN0aW9uICh2KSB7CiAgICAgICAgICByZXR1cm4gaGFzTm9NYXRjaGluZ09wdGlvbih2LCBjdXJPcHRpb25zKTsKICAgICAgICB9KSA6IGJpbmRpbmcudmFsdWUgIT09IGJpbmRpbmcub2xkVmFsdWUgJiYgaGFzTm9NYXRjaGluZ09wdGlvbihiaW5kaW5nLnZhbHVlLCBjdXJPcHRpb25zKTsKCiAgICAgICAgaWYgKG5lZWRSZXNldCkgewogICAgICAgICAgdHJpZ2dlcihlbCwgJ2NoYW5nZScpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIHNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSkgewogIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKTsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgaWYgKGlzSUUgfHwgaXNFZGdlKSB7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgYWN0dWFsbHlTZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pOwogICAgfSwgMCk7CiAgfQp9CgpmdW5jdGlvbiBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSkgewogIHZhciB2YWx1ZSA9IGJpbmRpbmcudmFsdWU7CiAgdmFyIGlzTXVsdGlwbGUgPSBlbC5tdWx0aXBsZTsKCiAgaWYgKGlzTXVsdGlwbGUgJiYgIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIjxzZWxlY3QgbXVsdGlwbGUgdi1tb2RlbD1cIiIgKyBiaW5kaW5nLmV4cHJlc3Npb24gKyAiXCI+ICIgKyAiZXhwZWN0cyBhbiBBcnJheSB2YWx1ZSBmb3IgaXRzIGJpbmRpbmcsIGJ1dCBnb3QgIiArIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpLCB2bSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc2VsZWN0ZWQsIG9wdGlvbjsKCiAgZm9yICh2YXIgaSA9IDAsIGwgPSBlbC5vcHRpb25zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgb3B0aW9uID0gZWwub3B0aW9uc1tpXTsKCiAgICBpZiAoaXNNdWx0aXBsZSkgewogICAgICBzZWxlY3RlZCA9IGxvb3NlSW5kZXhPZih2YWx1ZSwgZ2V0VmFsdWUob3B0aW9uKSkgPiAtMTsKCiAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChsb29zZUVxdWFsKGdldFZhbHVlKG9wdGlvbiksIHZhbHVlKSkgewogICAgICAgIGlmIChlbC5zZWxlY3RlZEluZGV4ICE9PSBpKSB7CiAgICAgICAgICBlbC5zZWxlY3RlZEluZGV4ID0gaTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KCiAgaWYgKCFpc011bHRpcGxlKSB7CiAgICBlbC5zZWxlY3RlZEluZGV4ID0gLTE7CiAgfQp9CgpmdW5jdGlvbiBoYXNOb01hdGNoaW5nT3B0aW9uKHZhbHVlLCBvcHRpb25zKSB7CiAgcmV0dXJuIG9wdGlvbnMuZXZlcnkoZnVuY3Rpb24gKG8pIHsKICAgIHJldHVybiAhbG9vc2VFcXVhbChvLCB2YWx1ZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldFZhbHVlKG9wdGlvbikgewogIHJldHVybiAnX3ZhbHVlJyBpbiBvcHRpb24gPyBvcHRpb24uX3ZhbHVlIDogb3B0aW9uLnZhbHVlOwp9CgpmdW5jdGlvbiBvbkNvbXBvc2l0aW9uU3RhcnQoZSkgewogIGUudGFyZ2V0LmNvbXBvc2luZyA9IHRydWU7Cn0KCmZ1bmN0aW9uIG9uQ29tcG9zaXRpb25FbmQoZSkgewogIC8vIHByZXZlbnQgdHJpZ2dlcmluZyBhbiBpbnB1dCBldmVudCBmb3Igbm8gcmVhc29uCiAgaWYgKCFlLnRhcmdldC5jb21wb3NpbmcpIHsKICAgIHJldHVybjsKICB9CgogIGUudGFyZ2V0LmNvbXBvc2luZyA9IGZhbHNlOwogIHRyaWdnZXIoZS50YXJnZXQsICdpbnB1dCcpOwp9CgpmdW5jdGlvbiB0cmlnZ2VyKGVsLCB0eXBlKSB7CiAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogIGUuaW5pdEV2ZW50KHR5cGUsIHRydWUsIHRydWUpOwogIGVsLmRpc3BhdGNoRXZlbnQoZSk7Cn0KLyogICovCi8vIHJlY3Vyc2l2ZWx5IHNlYXJjaCBmb3IgcG9zc2libGUgdHJhbnNpdGlvbiBkZWZpbmVkIGluc2lkZSB0aGUgY29tcG9uZW50IHJvb3QKCgpmdW5jdGlvbiBsb2NhdGVOb2RlKHZub2RlKSB7CiAgcmV0dXJuIHZub2RlLmNvbXBvbmVudEluc3RhbmNlICYmICghdm5vZGUuZGF0YSB8fCAhdm5vZGUuZGF0YS50cmFuc2l0aW9uKSA/IGxvY2F0ZU5vZGUodm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlKSA6IHZub2RlOwp9Cgp2YXIgc2hvdyA9IHsKICBiaW5kOiBmdW5jdGlvbiBiaW5kKGVsLCByZWYsIHZub2RlKSB7CiAgICB2YXIgdmFsdWUgPSByZWYudmFsdWU7CiAgICB2bm9kZSA9IGxvY2F0ZU5vZGUodm5vZGUpOwogICAgdmFyIHRyYW5zaXRpb24kJDEgPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKICAgIHZhciBvcmlnaW5hbERpc3BsYXkgPSBlbC5fX3ZPcmlnaW5hbERpc3BsYXkgPSBlbC5zdHlsZS5kaXNwbGF5ID09PSAnbm9uZScgPyAnJyA6IGVsLnN0eWxlLmRpc3BsYXk7CgogICAgaWYgKHZhbHVlICYmIHRyYW5zaXRpb24kJDEpIHsKICAgICAgdm5vZGUuZGF0YS5zaG93ID0gdHJ1ZTsKICAgICAgZW50ZXIodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gb3JpZ2luYWxEaXNwbGF5OwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZSA/IG9yaWdpbmFsRGlzcGxheSA6ICdub25lJzsKICAgIH0KICB9LAogIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKGVsLCByZWYsIHZub2RlKSB7CiAgICB2YXIgdmFsdWUgPSByZWYudmFsdWU7CiAgICB2YXIgb2xkVmFsdWUgPSByZWYub2xkVmFsdWU7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAoIXZhbHVlID09PSAhb2xkVmFsdWUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZub2RlID0gbG9jYXRlTm9kZSh2bm9kZSk7CiAgICB2YXIgdHJhbnNpdGlvbiQkMSA9IHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS50cmFuc2l0aW9uOwoKICAgIGlmICh0cmFuc2l0aW9uJCQxKSB7CiAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CgogICAgICBpZiAodmFsdWUpIHsKICAgICAgICBlbnRlcih2bm9kZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsZWF2ZSh2bm9kZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gZWwuX192T3JpZ2luYWxEaXNwbGF5IDogJ25vbmUnOwogICAgfQogIH0sCiAgdW5iaW5kOiBmdW5jdGlvbiB1bmJpbmQoZWwsIGJpbmRpbmcsIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KSB7CiAgICBpZiAoIWlzRGVzdHJveSkgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5OwogICAgfQogIH0KfTsKdmFyIHBsYXRmb3JtRGlyZWN0aXZlcyA9IHsKICBtb2RlbDogZGlyZWN0aXZlLAogIHNob3c6IHNob3cKfTsKLyogICovCgp2YXIgdHJhbnNpdGlvblByb3BzID0gewogIG5hbWU6IFN0cmluZywKICBhcHBlYXI6IEJvb2xlYW4sCiAgY3NzOiBCb29sZWFuLAogIG1vZGU6IFN0cmluZywKICB0eXBlOiBTdHJpbmcsCiAgZW50ZXJDbGFzczogU3RyaW5nLAogIGxlYXZlQ2xhc3M6IFN0cmluZywKICBlbnRlclRvQ2xhc3M6IFN0cmluZywKICBsZWF2ZVRvQ2xhc3M6IFN0cmluZywKICBlbnRlckFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgbGVhdmVBY3RpdmVDbGFzczogU3RyaW5nLAogIGFwcGVhckNsYXNzOiBTdHJpbmcsCiAgYXBwZWFyQWN0aXZlQ2xhc3M6IFN0cmluZywKICBhcHBlYXJUb0NsYXNzOiBTdHJpbmcsCiAgZHVyYXRpb246IFtOdW1iZXIsIFN0cmluZywgT2JqZWN0XQp9OyAvLyBpbiBjYXNlIHRoZSBjaGlsZCBpcyBhbHNvIGFuIGFic3RyYWN0IGNvbXBvbmVudCwgZS5nLiA8a2VlcC1hbGl2ZT4KLy8gd2Ugd2FudCB0byByZWN1cnNpdmVseSByZXRyaWV2ZSB0aGUgcmVhbCBjb21wb25lbnQgdG8gYmUgcmVuZGVyZWQKCmZ1bmN0aW9uIGdldFJlYWxDaGlsZCh2bm9kZSkgewogIHZhciBjb21wT3B0aW9ucyA9IHZub2RlICYmIHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CgogIGlmIChjb21wT3B0aW9ucyAmJiBjb21wT3B0aW9ucy5DdG9yLm9wdGlvbnNbImFic3RyYWN0Il0pIHsKICAgIHJldHVybiBnZXRSZWFsQ2hpbGQoZ2V0Rmlyc3RDb21wb25lbnRDaGlsZChjb21wT3B0aW9ucy5jaGlsZHJlbikpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdm5vZGU7CiAgfQp9CgpmdW5jdGlvbiBleHRyYWN0VHJhbnNpdGlvbkRhdGEoY29tcCkgewogIHZhciBkYXRhID0ge307CiAgdmFyIG9wdGlvbnMgPSBjb21wLiRvcHRpb25zOyAvLyBwcm9wcwoKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5wcm9wc0RhdGEpIHsKICAgIGRhdGFba2V5XSA9IGNvbXBba2V5XTsKICB9IC8vIGV2ZW50cy4KICAvLyBleHRyYWN0IGxpc3RlbmVycyBhbmQgcGFzcyB0aGVtIGRpcmVjdGx5IHRvIHRoZSB0cmFuc2l0aW9uIG1ldGhvZHMKCgogIHZhciBsaXN0ZW5lcnMgPSBvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CgogIGZvciAodmFyIGtleSQxIGluIGxpc3RlbmVycykgewogICAgZGF0YVtjYW1lbGl6ZShrZXkkMSldID0gbGlzdGVuZXJzW2tleSQxXTsKICB9CgogIHJldHVybiBkYXRhOwp9CgpmdW5jdGlvbiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCkgewogIGlmICgvXGQta2VlcC1hbGl2ZSQvLnRlc3QocmF3Q2hpbGQudGFnKSkgewogICAgcmV0dXJuIGgoJ2tlZXAtYWxpdmUnLCB7CiAgICAgIHByb3BzOiByYXdDaGlsZC5jb21wb25lbnRPcHRpb25zLnByb3BzRGF0YQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBoYXNQYXJlbnRUcmFuc2l0aW9uKHZub2RlKSB7CiAgd2hpbGUgKHZub2RlID0gdm5vZGUucGFyZW50KSB7CiAgICBpZiAodm5vZGUuZGF0YS50cmFuc2l0aW9uKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gaXNTYW1lQ2hpbGQoY2hpbGQsIG9sZENoaWxkKSB7CiAgcmV0dXJuIG9sZENoaWxkLmtleSA9PT0gY2hpbGQua2V5ICYmIG9sZENoaWxkLnRhZyA9PT0gY2hpbGQudGFnOwp9Cgp2YXIgaXNOb3RUZXh0Tm9kZSA9IGZ1bmN0aW9uIGlzTm90VGV4dE5vZGUoYykgewogIHJldHVybiBjLnRhZyB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYyk7Cn07Cgp2YXIgaXNWU2hvd0RpcmVjdGl2ZSA9IGZ1bmN0aW9uIGlzVlNob3dEaXJlY3RpdmUoZCkgewogIHJldHVybiBkLm5hbWUgPT09ICdzaG93JzsKfTsKCnZhciBUcmFuc2l0aW9uID0gewogIG5hbWU6ICd0cmFuc2l0aW9uJywKICBwcm9wczogdHJhbnNpdGlvblByb3BzLAogICJhYnN0cmFjdCI6IHRydWUsCiAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoaCkgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLiRzbG90c1siZGVmYXVsdCJdOwoKICAgIGlmICghY2hpbGRyZW4pIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBmaWx0ZXIgb3V0IHRleHQgbm9kZXMgKHBvc3NpYmxlIHdoaXRlc3BhY2VzKQoKCiAgICBjaGlsZHJlbiA9IGNoaWxkcmVuLmZpbHRlcihpc05vdFRleHROb2RlKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gd2FybiBtdWx0aXBsZSBlbGVtZW50cwoKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgIHdhcm4oJzx0cmFuc2l0aW9uPiBjYW4gb25seSBiZSB1c2VkIG9uIGEgc2luZ2xlIGVsZW1lbnQuIFVzZSAnICsgJzx0cmFuc2l0aW9uLWdyb3VwPiBmb3IgbGlzdHMuJywgdGhpcy4kcGFyZW50KTsKICAgIH0KCiAgICB2YXIgbW9kZSA9IHRoaXMubW9kZTsgLy8gd2FybiBpbnZhbGlkIG1vZGUKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBtb2RlICYmIG1vZGUgIT09ICdpbi1vdXQnICYmIG1vZGUgIT09ICdvdXQtaW4nKSB7CiAgICAgIHdhcm4oJ2ludmFsaWQgPHRyYW5zaXRpb24+IG1vZGU6ICcgKyBtb2RlLCB0aGlzLiRwYXJlbnQpOwogICAgfQoKICAgIHZhciByYXdDaGlsZCA9IGNoaWxkcmVuWzBdOyAvLyBpZiB0aGlzIGlzIGEgY29tcG9uZW50IHJvb3Qgbm9kZSBhbmQgdGhlIGNvbXBvbmVudCdzCiAgICAvLyBwYXJlbnQgY29udGFpbmVyIG5vZGUgYWxzbyBoYXMgdHJhbnNpdGlvbiwgc2tpcC4KCiAgICBpZiAoaGFzUGFyZW50VHJhbnNpdGlvbih0aGlzLiR2bm9kZSkpIHsKICAgICAgcmV0dXJuIHJhd0NoaWxkOwogICAgfSAvLyBhcHBseSB0cmFuc2l0aW9uIGRhdGEgdG8gY2hpbGQKICAgIC8vIHVzZSBnZXRSZWFsQ2hpbGQoKSB0byBpZ25vcmUgYWJzdHJhY3QgY29tcG9uZW50cyBlLmcuIGtlZXAtYWxpdmUKCgogICAgdmFyIGNoaWxkID0gZ2V0UmVhbENoaWxkKHJhd0NoaWxkKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmICghY2hpbGQpIHsKICAgICAgcmV0dXJuIHJhd0NoaWxkOwogICAgfQoKICAgIGlmICh0aGlzLl9sZWF2aW5nKSB7CiAgICAgIHJldHVybiBwbGFjZWhvbGRlcihoLCByYXdDaGlsZCk7CiAgICB9IC8vIGVuc3VyZSBhIGtleSB0aGF0IGlzIHVuaXF1ZSB0byB0aGUgdm5vZGUgdHlwZSBhbmQgdG8gdGhpcyB0cmFuc2l0aW9uCiAgICAvLyBjb21wb25lbnQgaW5zdGFuY2UuIFRoaXMga2V5IHdpbGwgYmUgdXNlZCB0byByZW1vdmUgcGVuZGluZyBsZWF2aW5nIG5vZGVzCiAgICAvLyBkdXJpbmcgZW50ZXJpbmcuCgoKICAgIHZhciBpZCA9ICJfX3RyYW5zaXRpb24tIiArIHRoaXMuX3VpZCArICItIjsKICAgIGNoaWxkLmtleSA9IGNoaWxkLmtleSA9PSBudWxsID8gY2hpbGQuaXNDb21tZW50ID8gaWQgKyAnY29tbWVudCcgOiBpZCArIGNoaWxkLnRhZyA6IGlzUHJpbWl0aXZlKGNoaWxkLmtleSkgPyBTdHJpbmcoY2hpbGQua2V5KS5pbmRleE9mKGlkKSA9PT0gMCA/IGNoaWxkLmtleSA6IGlkICsgY2hpbGQua2V5IDogY2hpbGQua2V5OwogICAgdmFyIGRhdGEgPSAoY2hpbGQuZGF0YSB8fCAoY2hpbGQuZGF0YSA9IHt9KSkudHJhbnNpdGlvbiA9IGV4dHJhY3RUcmFuc2l0aW9uRGF0YSh0aGlzKTsKICAgIHZhciBvbGRSYXdDaGlsZCA9IHRoaXMuX3Zub2RlOwogICAgdmFyIG9sZENoaWxkID0gZ2V0UmVhbENoaWxkKG9sZFJhd0NoaWxkKTsgLy8gbWFyayB2LXNob3cKICAgIC8vIHNvIHRoYXQgdGhlIHRyYW5zaXRpb24gbW9kdWxlIGNhbiBoYW5kIG92ZXIgdGhlIGNvbnRyb2wgdG8gdGhlIGRpcmVjdGl2ZQoKICAgIGlmIChjaGlsZC5kYXRhLmRpcmVjdGl2ZXMgJiYgY2hpbGQuZGF0YS5kaXJlY3RpdmVzLnNvbWUoaXNWU2hvd0RpcmVjdGl2ZSkpIHsKICAgICAgY2hpbGQuZGF0YS5zaG93ID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAob2xkQ2hpbGQgJiYgb2xkQ2hpbGQuZGF0YSAmJiAhaXNTYW1lQ2hpbGQoY2hpbGQsIG9sZENoaWxkKSAmJiAhaXNBc3luY1BsYWNlaG9sZGVyKG9sZENoaWxkKSAmJiAvLyAjNjY4NyBjb21wb25lbnQgcm9vdCBpcyBhIGNvbW1lbnQgbm9kZQogICAgIShvbGRDaGlsZC5jb21wb25lbnRJbnN0YW5jZSAmJiBvbGRDaGlsZC5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGUuaXNDb21tZW50KSkgewogICAgICAvLyByZXBsYWNlIG9sZCBjaGlsZCB0cmFuc2l0aW9uIGRhdGEgd2l0aCBmcmVzaCBvbmUKICAgICAgLy8gaW1wb3J0YW50IGZvciBkeW5hbWljIHRyYW5zaXRpb25zIQogICAgICB2YXIgb2xkRGF0YSA9IG9sZENoaWxkLmRhdGEudHJhbnNpdGlvbiA9IGV4dGVuZCh7fSwgZGF0YSk7IC8vIGhhbmRsZSB0cmFuc2l0aW9uIG1vZGUKCiAgICAgIGlmIChtb2RlID09PSAnb3V0LWluJykgewogICAgICAgIC8vIHJldHVybiBwbGFjZWhvbGRlciBub2RlIGFuZCBxdWV1ZSB1cGRhdGUgd2hlbiBsZWF2ZSBmaW5pc2hlcwogICAgICAgIHRoaXMuX2xlYXZpbmcgPSB0cnVlOwogICAgICAgIG1lcmdlVk5vZGVIb29rKG9sZERhdGEsICdhZnRlckxlYXZlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhpcyQxLl9sZWF2aW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzJDEuJGZvcmNlVXBkYXRlKCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyKGgsIHJhd0NoaWxkKTsKICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnaW4tb3V0JykgewogICAgICAgIGlmIChpc0FzeW5jUGxhY2Vob2xkZXIoY2hpbGQpKSB7CiAgICAgICAgICByZXR1cm4gb2xkUmF3Q2hpbGQ7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGVsYXllZExlYXZlOwoKICAgICAgICB2YXIgcGVyZm9ybUxlYXZlID0gZnVuY3Rpb24gcGVyZm9ybUxlYXZlKCkgewogICAgICAgICAgZGVsYXllZExlYXZlKCk7CiAgICAgICAgfTsKCiAgICAgICAgbWVyZ2VWTm9kZUhvb2soZGF0YSwgJ2FmdGVyRW50ZXInLCBwZXJmb3JtTGVhdmUpOwogICAgICAgIG1lcmdlVk5vZGVIb29rKGRhdGEsICdlbnRlckNhbmNlbGxlZCcsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sob2xkRGF0YSwgJ2RlbGF5TGVhdmUnLCBmdW5jdGlvbiAobGVhdmUpIHsKICAgICAgICAgIGRlbGF5ZWRMZWF2ZSA9IGxlYXZlOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJhd0NoaWxkOwogIH0KfTsKLyogICovCgp2YXIgcHJvcHMgPSBleHRlbmQoewogIHRhZzogU3RyaW5nLAogIG1vdmVDbGFzczogU3RyaW5nCn0sIHRyYW5zaXRpb25Qcm9wcyk7CmRlbGV0ZSBwcm9wcy5tb2RlOwp2YXIgVHJhbnNpdGlvbkdyb3VwID0gewogIHByb3BzOiBwcm9wcywKICBiZWZvcmVNb3VudDogZnVuY3Rpb24gYmVmb3JlTW91bnQoKSB7CiAgICB2YXIgdGhpcyQxID0gdGhpczsKICAgIHZhciB1cGRhdGUgPSB0aGlzLl91cGRhdGU7CgogICAgdGhpcy5fdXBkYXRlID0gZnVuY3Rpb24gKHZub2RlLCBoeWRyYXRpbmcpIHsKICAgICAgdmFyIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSA9IHNldEFjdGl2ZUluc3RhbmNlKHRoaXMkMSk7IC8vIGZvcmNlIHJlbW92aW5nIHBhc3MKCiAgICAgIHRoaXMkMS5fX3BhdGNoX18odGhpcyQxLl92bm9kZSwgdGhpcyQxLmtlcHQsIGZhbHNlLCAvLyBoeWRyYXRpbmcKICAgICAgdHJ1ZSAvLyByZW1vdmVPbmx5ICghaW1wb3J0YW50LCBhdm9pZHMgdW5uZWNlc3NhcnkgbW92ZXMpCiAgICAgICk7CgogICAgICB0aGlzJDEuX3Zub2RlID0gdGhpcyQxLmtlcHQ7CiAgICAgIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSgpOwogICAgICB1cGRhdGUuY2FsbCh0aGlzJDEsIHZub2RlLCBoeWRyYXRpbmcpOwogICAgfTsKICB9LAogIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKGgpIHsKICAgIHZhciB0YWcgPSB0aGlzLnRhZyB8fCB0aGlzLiR2bm9kZS5kYXRhLnRhZyB8fCAnc3Bhbic7CiAgICB2YXIgbWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBwcmV2Q2hpbGRyZW4gPSB0aGlzLnByZXZDaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICB2YXIgcmF3Q2hpbGRyZW4gPSB0aGlzLiRzbG90c1siZGVmYXVsdCJdIHx8IFtdOwogICAgdmFyIGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbiA9IFtdOwogICAgdmFyIHRyYW5zaXRpb25EYXRhID0gZXh0cmFjdFRyYW5zaXRpb25EYXRhKHRoaXMpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmF3Q2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGMgPSByYXdDaGlsZHJlbltpXTsKCiAgICAgIGlmIChjLnRhZykgewogICAgICAgIGlmIChjLmtleSAhPSBudWxsICYmIFN0cmluZyhjLmtleSkuaW5kZXhPZignX192bGlzdCcpICE9PSAwKSB7CiAgICAgICAgICBjaGlsZHJlbi5wdXNoKGMpOwogICAgICAgICAgbWFwW2Mua2V5XSA9IGM7CiAgICAgICAgICAoYy5kYXRhIHx8IChjLmRhdGEgPSB7fSkpLnRyYW5zaXRpb24gPSB0cmFuc2l0aW9uRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgIHZhciBvcHRzID0gYy5jb21wb25lbnRPcHRpb25zOwogICAgICAgICAgdmFyIG5hbWUgPSBvcHRzID8gb3B0cy5DdG9yLm9wdGlvbnMubmFtZSB8fCBvcHRzLnRhZyB8fCAnJyA6IGMudGFnOwogICAgICAgICAgd2FybigiPHRyYW5zaXRpb24tZ3JvdXA+IGNoaWxkcmVuIG11c3QgYmUga2V5ZWQ6IDwiICsgbmFtZSArICI+Iik7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHByZXZDaGlsZHJlbikgewogICAgICB2YXIga2VwdCA9IFtdOwogICAgICB2YXIgcmVtb3ZlZCA9IFtdOwoKICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgcHJldkNoaWxkcmVuLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICB2YXIgYyQxID0gcHJldkNoaWxkcmVuW2kkMV07CiAgICAgICAgYyQxLmRhdGEudHJhbnNpdGlvbiA9IHRyYW5zaXRpb25EYXRhOwogICAgICAgIGMkMS5kYXRhLnBvcyA9IGMkMS5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgICAgIGlmIChtYXBbYyQxLmtleV0pIHsKICAgICAgICAgIGtlcHQucHVzaChjJDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZW1vdmVkLnB1c2goYyQxKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMua2VwdCA9IGgodGFnLCBudWxsLCBrZXB0KTsKICAgICAgdGhpcy5yZW1vdmVkID0gcmVtb3ZlZDsKICAgIH0KCiAgICByZXR1cm4gaCh0YWcsIG51bGwsIGNoaWxkcmVuKTsKICB9LAogIHVwZGF0ZWQ6IGZ1bmN0aW9uIHVwZGF0ZWQoKSB7CiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLnByZXZDaGlsZHJlbjsKICAgIHZhciBtb3ZlQ2xhc3MgPSB0aGlzLm1vdmVDbGFzcyB8fCAodGhpcy5uYW1lIHx8ICd2JykgKyAnLW1vdmUnOwoKICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoIHx8ICF0aGlzLmhhc01vdmUoY2hpbGRyZW5bMF0uZWxtLCBtb3ZlQ2xhc3MpKSB7CiAgICAgIHJldHVybjsKICAgIH0gLy8gd2UgZGl2aWRlIHRoZSB3b3JrIGludG8gdGhyZWUgbG9vcHMgdG8gYXZvaWQgbWl4aW5nIERPTSByZWFkcyBhbmQgd3JpdGVzCiAgICAvLyBpbiBlYWNoIGl0ZXJhdGlvbiAtIHdoaWNoIGhlbHBzIHByZXZlbnQgbGF5b3V0IHRocmFzaGluZy4KCgogICAgY2hpbGRyZW4uZm9yRWFjaChjYWxsUGVuZGluZ0Nicyk7CiAgICBjaGlsZHJlbi5mb3JFYWNoKHJlY29yZFBvc2l0aW9uKTsKICAgIGNoaWxkcmVuLmZvckVhY2goYXBwbHlUcmFuc2xhdGlvbik7IC8vIGZvcmNlIHJlZmxvdyB0byBwdXQgZXZlcnl0aGluZyBpbiBwb3NpdGlvbgogICAgLy8gYXNzaWduIHRvIHRoaXMgdG8gYXZvaWQgYmVpbmcgcmVtb3ZlZCBpbiB0cmVlLXNoYWtpbmcKICAgIC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgIHRoaXMuX3JlZmxvdyA9IGRvY3VtZW50LmJvZHkub2Zmc2V0SGVpZ2h0OwogICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbiAoYykgewogICAgICBpZiAoYy5kYXRhLm1vdmVkKSB7CiAgICAgICAgdmFyIGVsID0gYy5lbG07CiAgICAgICAgdmFyIHMgPSBlbC5zdHlsZTsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIG1vdmVDbGFzcyk7CiAgICAgICAgcy50cmFuc2Zvcm0gPSBzLldlYmtpdFRyYW5zZm9ybSA9IHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJyc7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcih0cmFuc2l0aW9uRW5kRXZlbnQsIGVsLl9tb3ZlQ2IgPSBmdW5jdGlvbiBjYihlKSB7CiAgICAgICAgICBpZiAoZSAmJiBlLnRhcmdldCAhPT0gZWwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghZSB8fCAvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpIHsKICAgICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcih0cmFuc2l0aW9uRW5kRXZlbnQsIGNiKTsKICAgICAgICAgICAgZWwuX21vdmVDYiA9IG51bGw7CiAgICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfSwKICBtZXRob2RzOiB7CiAgICBoYXNNb3ZlOiBmdW5jdGlvbiBoYXNNb3ZlKGVsLCBtb3ZlQ2xhc3MpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICghaGFzVHJhbnNpdGlvbikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogICAgICBpZiAodGhpcy5faGFzTW92ZSkgewogICAgICAgIHJldHVybiB0aGlzLl9oYXNNb3ZlOwogICAgICB9IC8vIERldGVjdCB3aGV0aGVyIGFuIGVsZW1lbnQgd2l0aCB0aGUgbW92ZSBjbGFzcyBhcHBsaWVkIGhhcwogICAgICAvLyBDU1MgdHJhbnNpdGlvbnMuIFNpbmNlIHRoZSBlbGVtZW50IG1heSBiZSBpbnNpZGUgYW4gZW50ZXJpbmcKICAgICAgLy8gdHJhbnNpdGlvbiBhdCB0aGlzIHZlcnkgbW9tZW50LCB3ZSBtYWtlIGEgY2xvbmUgb2YgaXQgYW5kIHJlbW92ZQogICAgICAvLyBhbGwgb3RoZXIgdHJhbnNpdGlvbiBjbGFzc2VzIGFwcGxpZWQgdG8gZW5zdXJlIG9ubHkgdGhlIG1vdmUgY2xhc3MKICAgICAgLy8gaXMgYXBwbGllZC4KCgogICAgICB2YXIgY2xvbmUgPSBlbC5jbG9uZU5vZGUoKTsKCiAgICAgIGlmIChlbC5fdHJhbnNpdGlvbkNsYXNzZXMpIHsKICAgICAgICBlbC5fdHJhbnNpdGlvbkNsYXNzZXMuZm9yRWFjaChmdW5jdGlvbiAoY2xzKSB7CiAgICAgICAgICByZW1vdmVDbGFzcyhjbG9uZSwgY2xzKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgYWRkQ2xhc3MoY2xvbmUsIG1vdmVDbGFzcyk7CiAgICAgIGNsb25lLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIHRoaXMuJGVsLmFwcGVuZENoaWxkKGNsb25lKTsKICAgICAgdmFyIGluZm8gPSBnZXRUcmFuc2l0aW9uSW5mbyhjbG9uZSk7CiAgICAgIHRoaXMuJGVsLnJlbW92ZUNoaWxkKGNsb25lKTsKICAgICAgcmV0dXJuIHRoaXMuX2hhc01vdmUgPSBpbmZvLmhhc1RyYW5zZm9ybTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBjYWxsUGVuZGluZ0NicyhjKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgaWYgKGMuZWxtLl9tb3ZlQ2IpIHsKICAgIGMuZWxtLl9tb3ZlQ2IoKTsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoYy5lbG0uX2VudGVyQ2IpIHsKICAgIGMuZWxtLl9lbnRlckNiKCk7CiAgfQp9CgpmdW5jdGlvbiByZWNvcmRQb3NpdGlvbihjKSB7CiAgYy5kYXRhLm5ld1BvcyA9IGMuZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwp9CgpmdW5jdGlvbiBhcHBseVRyYW5zbGF0aW9uKGMpIHsKICB2YXIgb2xkUG9zID0gYy5kYXRhLnBvczsKICB2YXIgbmV3UG9zID0gYy5kYXRhLm5ld1BvczsKICB2YXIgZHggPSBvbGRQb3MubGVmdCAtIG5ld1Bvcy5sZWZ0OwogIHZhciBkeSA9IG9sZFBvcy50b3AgLSBuZXdQb3MudG9wOwoKICBpZiAoZHggfHwgZHkpIHsKICAgIGMuZGF0YS5tb3ZlZCA9IHRydWU7CiAgICB2YXIgcyA9IGMuZWxtLnN0eWxlOwogICAgcy50cmFuc2Zvcm0gPSBzLldlYmtpdFRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoIiArIGR4ICsgInB4LCIgKyBkeSArICJweCkiOwogICAgcy50cmFuc2l0aW9uRHVyYXRpb24gPSAnMHMnOwogIH0KfQoKdmFyIHBsYXRmb3JtQ29tcG9uZW50cyA9IHsKICBUcmFuc2l0aW9uOiBUcmFuc2l0aW9uLAogIFRyYW5zaXRpb25Hcm91cDogVHJhbnNpdGlvbkdyb3VwCn07Ci8qICAqLwovLyBpbnN0YWxsIHBsYXRmb3JtIHNwZWNpZmljIHV0aWxzCgpWdWUuY29uZmlnLm11c3RVc2VQcm9wID0gbXVzdFVzZVByb3A7ClZ1ZS5jb25maWcuaXNSZXNlcnZlZFRhZyA9IGlzUmVzZXJ2ZWRUYWc7ClZ1ZS5jb25maWcuaXNSZXNlcnZlZEF0dHIgPSBpc1Jlc2VydmVkQXR0cjsKVnVlLmNvbmZpZy5nZXRUYWdOYW1lc3BhY2UgPSBnZXRUYWdOYW1lc3BhY2U7ClZ1ZS5jb25maWcuaXNVbmtub3duRWxlbWVudCA9IGlzVW5rbm93bkVsZW1lbnQ7IC8vIGluc3RhbGwgcGxhdGZvcm0gcnVudGltZSBkaXJlY3RpdmVzICYgY29tcG9uZW50cwoKZXh0ZW5kKFZ1ZS5vcHRpb25zLmRpcmVjdGl2ZXMsIHBsYXRmb3JtRGlyZWN0aXZlcyk7CmV4dGVuZChWdWUub3B0aW9ucy5jb21wb25lbnRzLCBwbGF0Zm9ybUNvbXBvbmVudHMpOyAvLyBpbnN0YWxsIHBsYXRmb3JtIHBhdGNoIGZ1bmN0aW9uCgpWdWUucHJvdG90eXBlLl9fcGF0Y2hfXyA9IGluQnJvd3NlciA/IHBhdGNoIDogbm9vcDsgLy8gcHVibGljIG1vdW50IG1ldGhvZAoKVnVlLnByb3RvdHlwZS4kbW91bnQgPSBmdW5jdGlvbiAoZWwsIGh5ZHJhdGluZykgewogIGVsID0gZWwgJiYgaW5Ccm93c2VyID8gcXVlcnkoZWwpIDogdW5kZWZpbmVkOwogIHJldHVybiBtb3VudENvbXBvbmVudCh0aGlzLCBlbCwgaHlkcmF0aW5nKTsKfTsgLy8gZGV2dG9vbHMgZ2xvYmFsIGhvb2sKCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKaWYgKGluQnJvd3NlcikgewogIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgaWYgKGNvbmZpZy5kZXZ0b29scykgewogICAgICBpZiAoZGV2dG9vbHMpIHsKICAgICAgICBkZXZ0b29scy5lbWl0KCdpbml0JywgVnVlKTsKICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAndGVzdCcpIHsKICAgICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXSgnRG93bmxvYWQgdGhlIFZ1ZSBEZXZ0b29scyBleHRlbnNpb24gZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6XG4nICsgJ2h0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUtZGV2dG9vbHMnKTsKICAgICAgfQogICAgfQoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAndGVzdCcgJiYgY29uZmlnLnByb2R1Y3Rpb25UaXAgIT09IGZhbHNlICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgICBjb25zb2xlW2NvbnNvbGUuaW5mbyA/ICdpbmZvJyA6ICdsb2cnXSgiWW91IGFyZSBydW5uaW5nIFZ1ZSBpbiBkZXZlbG9wbWVudCBtb2RlLlxuIiArICJNYWtlIHN1cmUgdG8gdHVybiBvbiBwcm9kdWN0aW9uIG1vZGUgd2hlbiBkZXBsb3lpbmcgZm9yIHByb2R1Y3Rpb24uXG4iICsgIlNlZSBtb3JlIHRpcHMgYXQgaHR0cHM6Ly92dWVqcy5vcmcvZ3VpZGUvZGVwbG95bWVudC5odG1sIik7CiAgICB9CiAgfSwgMCk7Cn0KLyogICovCgoKZXhwb3J0IGRlZmF1bHQgVnVlOw=="},null]}